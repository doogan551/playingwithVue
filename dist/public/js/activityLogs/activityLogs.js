"use strict";function initPage(a){var b="#timeDateFilters",c="#userFilters",d=$(b+" .filterIcon"),e=$(c+" .filterIcon"),f=$(".bodyMask"),g=$("#pointFilterModal"),h=function(a){var b=$(a+" .dropdown-menu"),c=$(a+" .filterIcon"),d=b.is(":visible");d?c.removeClass("open"):(c.addClass("open"),f.show()),b.toggle()},i=function(){var a=$(b+" .dropdown-menu"),e=$(c+" .dropdown-menu"),g=$(c+" .filterIcon");a.hide(),e.hide(),d.removeClass("open"),g.removeClass("open"),f.hide()};$(".time").timepicker({timeFormat:"H:i:s",disableTimeRanges:[["24:00:00","25:00:00"]]}),$(".date").datepicker({format:"D, m/d/yyyy",todayHighlight:!0,clearBtn:!0,autoclose:!0,appendTo:"#timeDateFilters .dropdown-menu"}),$(".header > .colSelect").click(function(a){a.stopPropagation(),"INPUT"!==a.srcElement.tagName&&$(".header > .colSelect .dropdown-toggle").dropdown("toggle")}),d.click(function(a){h(b)}),e.click(function(a){h(c)}),$(".dropdown-menu .closeIt").click(function(){i()}),$(".bodyMask").click(function(){i()}),g.find(".closeIt").click(function(){g.modal("toggle")}),g.on("shown.bs.modal",function(a){$("#pointLookup")[0].contentWindow.$("#listSearch").find("input:first").focus()}),window.top.location.href===window.location.href&&($(".popOut").addClass("hidden"),$(".popIn").removeClass("hidden")),$("#activityLogRows").on("click","a",function(){var a=ko.contextFor(this);a.$parent.showPointReview(this,a.$data)})}function applyBindings(){void 0===window.opener?window.setTimeout(applyBindings,2):(window.manager=new ActivityLogsManager({}),ko.applyBindings(window.manager))}var ActivityLogsManager=function(a){var b,c=this,d="Activity Logs",e=window.opener.workspaceManager,f=e.sessionId(),g=e.user(),h="activityLogs_"+g._id,i=e.openWindowPositioned,j="activitylog"+window.location.search.slice(1),k="activityFilters",l=$("#dateFrom"),m=$("#timeFrom"),n=$("#dateTo"),o=$("#timeTo"),p=200,q=10,r={rateLimit:{timeout:q,method:"notifyWhenChangesStop"}},s=0,t=e.config.Utility.pointTypes.getAllowedPointTypes().length,u=ko.observableArray([]),v=!0,w={name1:"",name2:"",name3:"",name4:"",pointTypes:[]},x=function(a,b){var d,f,h,i=e.config.Enums["Point Types"],j=0,k=0,l=a.numberOfPages.peek();if(b.itemsPerPage=p,b.sort=c.sortAscending()?"asc":"desc",b.currentPage=v?c.sortAscending()?1:l:c.pageNumber(),b.usernames=c.getFilteredUsers(),void 0===c.name1()&&(c.name1(""),c.name2(""),c.name3(""),c.name4("")),b.name1=c.name1(),b.name2=c.name2(),b.name3=c.name3(),b.name4=c.name4(),d=c.pointTypes(),d.length>0&&d.length!==t)for(b.pointTypes=[],h=0;h<d.length;h++)d[h].length>0&&b.pointTypes.push(i[d[h]]["enum"]);c.dateFrom()&&(j=Date.parse(c.dateFrom()+" "+(c.timeFrom()||"00:00")).getTime(),j=null===j?0:j),c.dateTo()&&(k=Date.parse(c.dateTo()+" "+(c.timeTo()||"00:00")).getTime(),k=null===k?0:k),b.startDate=j,b.endDate=k,b.user={},f=b.user,f["System Admin"]=g["System Admin"],f._id=g._id,f.groups=g.groups},y=function(a){c.name1(a.name1),c.name2(a.name2),c.name3(a.name3),c.name4(a.name4),a.pointTypes.length===t?c.pointTypes([]):c.pointTypes(a.pointTypes)},z=function(){b.pointLookup.init(y,w)},A=function(){b=i("/pointLookup?mode=filter","activityfilter","activityfilter","activityfilter","activityfilter",{callback:z})},B=function(a,b){var c=new Date(a),d=c.clone().clearTime(),e=Date.today(),f="";return b=b||!1,f=!b&&d.equals(e)?"Today":!b&&d.equals(e.addDays(-1))?"Yesterday":c.toString("M/d/yyyy")},C=function(a){var b=new Date(a);return b.toString("HH:mm:ss")},D=function(a){var b=!1;a.isSelected=ko.observable(b),a.prettyDate=B(a.timestamp),a.prettyTime=C(a.timestamp)},E=function(a,b){var d=c.sortAscending(),e=c.pageNumber(),f=b.numberOfPages(),g=parseInt(a/p,10);a%p&&g++,0===g&&(g=1),b.numberOfPages(g),d===!1&&e===f&&c.pageNumber(g)},F=function(a){var b,d;if(void 0!==a.logs){for(b=0;b<a.logs.length;b+=1)D(a.logs[b]);c.activityLogs().list(a.logs),c.activityLogs().count(a.count),E(c.activityLogs().count(),c.activityLogs()),v&&(d=c.sortAscending()?1:c.activityLogs().numberOfPages(),c.pageNumber(d),v=!1)}else console.log(" theLogData.logs = undefined");c.activityLogs().gettingData(!1)},G=function(){var a,b,c=H(),d=[];if(c.hasOwnProperty(k)&&(b=c[k]),void 0!==b)for(a=0;a<b.selectedUsers.length;a+=1)d.push(b.selectedUsers[a]);return d},H=function(){var a=store.get(h)||{};return a.hasOwnProperty("sessionId")&&a.sessionId!==f&&(store.remove(h),a={}),a},I=function(a){var b,d,e=G();if(void 0!==a.Users){for(b=0;b<a.Users.length;b+=1)e.length>0?(d=e.indexOf(a.Users[b].username),a.Users[b].isSelected=ko.observable(d!==-1)):a.Users[b].isSelected=ko.observable(!1);u(a.Users)}else u([]),console.log(" - - - activityLogs processUsers() ==> Unable to get list of Users from server.  Users.length ",new Date);c.refreshActivityLogsData()},J=function(a,b,c){$.ajax({url:b,type:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify(a),success:function(a){return c(a)}})},K=function(){var a,b=new Date,c={};c.reqID=b.getTime(),c.user={},a=c.user,a["System Admin"]=g["System Admin"],a._id=g._id,a.groups=g.groups,J(c,"/api/security/users/getallusers",I)},L=function(a){var b=a.name,c=new Date,d=c.getTime(),e={};a.refresh(!1),a.gettingData(!0),x(a,e),e.reqID=a.reqID=d,console.log("Requesting "+b+" activityLogs from server.",e,c),J(e,"/api/activitylogs/get",F)},M=function(a){a.isSelected(!0),c.selectedRows.push(a)},N=function(a){--s<0&&(s=0),a.isSelected(!1),c.selectedRows.remove(function(b){return b._id===a._id})},O=function(){var a,b=store.get(h);void 0===b&&(b={},b.sessionId=f),void 0===b[k]&&(b[k]={}),a={sortAscending:c.sortAscending(),pageNumber:c.pageNumber(),dateFrom:c.dateFrom(),timeFrom:c.timeFrom(),dateTo:c.dateTo(),timeTo:c.timeTo(),name1:c.name1(),name2:c.name2(),name3:c.name3(),name4:c.name4(),pointTypes:c.pointTypes(),selectedUsers:c.getFilteredUsers(),gotoPageOne:v},b[k]=ko.toJS(a),store.set(h,b)},P=function(){var a,b,d=H();if(d.hasOwnProperty(k)){b=d[k],c.sortAscending(b.sortAscending),c.pageNumber(b.pageNumber),c.dateFrom(b.dateFrom),c.dtFilterPlaceholder.dateFrom=b.dateFrom,c.timeFrom(b.timeFrom),c.dtFilterPlaceholder.timeFrom=b.timeFrom,c.dateTo(b.dateTo),c.dtFilterPlaceholder.dateTo=b.dateTo,c.timeTo(b.timeTo),c.dtFilterPlaceholder.timeTo=b.timeTo,c.name1(b.name1),w.name1=b.name1,c.name2(b.name2),w.name2=b.name2,c.name3(b.name3),w.name3=b.name3,c.name4(b.name4),w.name4=b.name4;for(a in b.pointTypes)c.pointTypes().push(b.pointTypes[a]);w.pointTypes=c.pointTypes(),v=b.gotoPageOne}},Q={name:"All",list:ko.observableArray([]),count:ko.observable(0),gettingData:ko.observable(!1),refresh:ko.observable(!1),numberOfPages:ko.observable(1),timeout:ko.observable(!1),timeoutID:0,reqID:0,view:"",stickyScrollBar:!1};c.togglePop=function(){var a={width:1024,height:768};window.top.location.href===window.location.href?i(window.location.href,"Activities","activitylog","mainWindow",j):i(window.location.href,"Activities","activitylog","",j,a)},c.refreshActivityLogsData=function(){var a=c.activityLogs();L(a)},c.refreshUsersData=function(){K()},c.showPointReview=function(a,b){var c,d,f,g=e.config.Utility.pointTypes,h={width:850,height:600};c=g.getPointTypeNameFromEnum(b.pointType),d=g.getUIEndpoint(c,b.upi),d?i(d.review.url,b.Name,c,d.review.target,b.upi,h):(f=a.text,$(a).stop().fadeOut("4000",function(){a.text=" * Point not found *",$(a).css("background","#F26060").fadeIn(500)}),setTimeout(function(){$(a).stop().fadeOut("500",function(){$(a).css("background","#FFFFFF").fadeIn(500),a.text=f})},3e3))},c.selectAll=function(){var a,b,d=c.activityLogs().list(),e=d.length,f=e>200?200:e;for(b=0;b<f;b++)a=d[b],a.isSelected()||M(a);return s=f,!0},c.selectAllNames=function(){var a,b,d=c.users(),e=d.length;for(b=0;b<e;b+=1)a=d[b],a.isSelected()||a.isSelected(!0);return!0},c.deselectAll=function(){var a,b=c.activityLogs().list(),d=b.length;for(a=0;a<d;a+=1)b[a].isSelected(!1);c.selectedRows.removeAll(),s=0},c.deselectAllNames=function(){var a,b=c.users(),d=b.length;for(a=0;a<d;a+=1)b[a].isSelected(!1)},c.selectNone=function(){var a,b,d=c.activityLogs().list(),e=d.length,f=e>p?p:e;for(b=0;b<f;b+=1)a=d[b],a.isSelected()&&N(a)},c.resetFilters=function(){c.clearUsernameFilter(),c.clearPointNameFilter(),c.clearDateTimeFilter(!0)},c.clearUsernameFilter=function(a){c.deselectAllNames(),a&&(O(),c.refreshActivityLogsData())},c.clearPointNameFilter=function(a){c.name1(""),w.name1="",c.name2(""),w.name2="",c.name3(""),w.name3="",c.name4(""),w.name4="",c.pointTypes([]),w.pointTypes=[],a&&(O(),c.refreshActivityLogsData()),z()},c.clearDateTimeFilter=function(a){c.dateFrom(null),c.dtFilterPlaceholder.dateFrom="",l.val("").datepicker("update"),c.timeFrom(null),c.dtFilterPlaceholder.timeFrom="",m.val("").timepicker("setTime",null),c.dateTo(null),c.dtFilterPlaceholder.dateTo="",n.val("").datepicker("update"),c.timeTo(null),c.dtFilterPlaceholder.timeTo="",o.val("").timepicker("setTime",null),a&&(O(),c.refreshActivityLogsData())},c.applyPointNameFilter=function(){v=!0,O(),c.refreshActivityLogsData()},c.applyUserNameFilter=function(){v=!0,O(),c.refreshActivityLogsData()},c.cancelUserNameFilter=function(){var a,b,d=c.users(),e=G();for(a=0;a<d.length;a+=1)e.length>0?(b=e.indexOf(d[a].username),d[a].isSelected(b!==-1)):d[a].isSelected(!1)},c.cancelPointNameFilter=function(){var a,b,d=H();if(d.hasOwnProperty(k)){b=d[k],c.name1(b.name1),w.name1=b.name1,c.name2(b.name2),w.name2=b.name2,c.name3(b.name3),w.name3=b.name3,c.name4(b.name4),w.name4=b.name4;for(a in b.pointTypes)c.pointTypes().push(b.pointTypes[a]);w.pointTypes=c.pointTypes(),z()}},c.applyDateTimeFilter=function(){c.dateFrom(c.dtFilterPlaceholder.dateFrom),c.timeFrom(c.dtFilterPlaceholder.timeFrom),c.dateTo(c.dtFilterPlaceholder.dateTo),c.timeTo(c.dtFilterPlaceholder.timeTo),v=!0,O(),c.refreshActivityLogsData()},c.cancelDateTimeFilter=function(){c.dtFilterPlaceholder.dateFrom=c.dateFrom(),l.val(c.dtFilterPlaceholder.dateFrom).datepicker("setDate",c.dtFilterPlaceholder.dateFrom),c.dtFilterPlaceholder.timeFrom=c.timeFrom(),m.val(c.dtFilterPlaceholder.timeFrom).timepicker("setTime",c.dtFilterPlaceholder.timeFrom),c.dtFilterPlaceholder.dateTo=c.dateTo(),n.val(c.dtFilterPlaceholder.dateTo).datepicker("setDate",c.dtFilterPlaceholder.dateFrom),c.dtFilterPlaceholder.timeTo=c.timeTo(),o.val(c.dtFilterPlaceholder.timeTo).timepicker("setTime",c.dtFilterPlaceholder.timeTo)},c.toggleDateTimeSort=function(){var a=c.sortAscending();c.sortAscending(!a),O(),c.refreshActivityLogsData()},c.changePage=function(a){var b,d=c.activityLogs();"begin"===a?a=1-c.pageNumber():"end"===a&&(a=d.numberOfPages()-c.pageNumber()),b=c.pageNumber()+a,c.pageNumber(b),O(),d.refresh(!0),c.refreshActivityLogsData()},c.getFilteredUsers=function(){var a,b=c.users(),d=[];for(a=0;a<b.length;a+=1)b[a].isSelected()&&d.push(b[a].username);return d},c.printLogs=function(){$(".activityLogs").css("overflow","visible"),$(".activityLogs").printArea({mode:"iframe"}),$(".activityLogs").css("overflow","auto")},c.dtFilterPlaceholder={dateFrom:"",timeFrom:"",dateTo:"",timeTo:""},c.sortAscending=ko.observable(!0),c.pageNumber=ko.observable(1),c.dateFrom=ko.observable(),c.timeFrom=ko.observable(),c.dateTo=ko.observable(),c.timeTo=ko.observable(),c.name1=ko.observable(),c.name2=ko.observable(),c.name3=ko.observable(),c.name4=ko.observable(),c.pointTypes=ko.observableArray([]),c.pageTitle=ko.observable(d),c.selectedRows=ko.observableArray([]),c.activityLogs=ko.computed(function(){return Q},c),c.activityLogsForPageSize=ko.computed(function(){return c.activityLogs().list().slice(0,p)},c),c.users=ko.computed(function(){return u()},c),c.allSelected=ko.computed(function(){var a,b=c.activityLogs().list(),d=b.length,e=d>200?200:d;if(0===e)return!1;for(a=0;a<e;a+=1)if(b[a].isSelected()===!1)return!1;return!0},c).extend(r),c.allSelectedNames=ko.computed(function(){var a,b=c.users(),d=b.length;if(0===d)return!1;for(a=0;a<d;a++)if(b[a].isSelected()===!1)return!1;return!0},c).extend(r),c.checkAll=ko.computed({read:function(){return c.allSelected()},write:function(a){return a?c.selectAll():c.deselectAll()}}),c.checkAllNames=ko.computed({read:function(){return c.allSelectedNames()},write:function(a){return a?c.selectAllNames():c.deselectAllNames()}}),c.pointTypeNameFilterIsSet=ko.computed(function(){var a=c.pointTypes();return""!==c.name1()||""!==c.name2()||""!==c.name3()||""!==c.name4()||a.length>0&&a.length!==t}),c.datetimeFilterIsSet=ko.computed(function(){return c.dateFrom()||c.timeFrom()||c.dateTo()||c.timeTo()}),c.usersFilterIsSet=ko.computed(function(){var a,b=c.users();for(a=0;a<b.length;a++)if(b[a].isSelected())return!0;return!1}),c.filterIsSet=ko.computed(function(){var a=!1;return a||(a=c.usersFilterIsSet()),a||(a=c.pointTypeNameFilterIsSet()),a||(a=c.datetimeFilterIsSet()),a},c).extend(r),P(),A()};$(function(){applyBindings(),initPage(window.manager),window.manager.refreshUsersData()});
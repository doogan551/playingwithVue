"use strict";function initPage(a){var b="#timeDateFilters",c=$(b+" .filterIcon"),d=$(".bodyMask"),e=$("#pointFilterModal"),f=$(".alarms"),g=$(".newAlarmTop"),h=$(".newAlarmBottom"),i=function(a){var b=($(a),$(a+" .dropdown-menu")),c=$(a+" .filterIcon"),e=b.is(":visible");e?c.removeClass("open"):(c.addClass("open"),d.show()),b.toggle()},j=function(){var a=$(b+" .dropdown-menu");a.hide(),c.removeClass("open"),d.hide()};$(".time").timepicker({timeFormat:"H:i:s",disableTimeRanges:[["24:00:00","25:00:00"]]}),$(".date").datepicker({format:"D, m/d/yyyy",todayHighlight:!0,clearBtn:!0,autoclose:!0,appendTo:"#timeDateFilters .dropdown-menu"}),$(".header > .colSelect").click(function(a){a.stopPropagation(),"INPUT"!==a.srcElement.tagName&&$(".header > .colSelect .dropdown-toggle").dropdown("toggle")}),c.click(function(a){i(b)}),$(".dropdown-menu .closeIt").click(function(){j()}),$(".bodyMask").click(function(){j()}),e.find(".closeIt").click(function(){e.modal("toggle")}),e.on("hide.bs.modal",function(b){a.applyNameFilter()}),e.on("shown.bs.modal",function(a){$("#pointLookup")[0].contentWindow.$("#listSearch").find("input:first").focus()}),g.mouseover(function(){g.stop(!1,!0),g.fadeIn(0)}),g.mouseout(function(){g.fadeOut(500)}),g.click(function(){f.scrollTop(0),g.fadeOut(0)}),h.mouseover(function(){h.stop(!1,!0),h.fadeIn(0)}),h.mouseout(function(){h.fadeOut(500)}),h.click(function(){f.scrollTop(99999),h.fadeOut(0)}),window.top.location.href===window.location.href&&($(".popOut").addClass("hidden"),$(".popIn").removeClass("hidden"))}function applyBindings(){void 0===window.opener?window.setTimeout(applyBindings,2):(window.manager=new AlarmManager({}),ko.applyBindings(window.manager))}ko.bindingHandlers.dataSrc={update:function(a,b){var c=b(),d=$(a),e=d.parent();$.ajax({url:"/img/thumbs/"+c+".txt",dataType:"text",type:"get"}).done(function(a){var b=a.split("||"),c=b[0],f=b[1];d.attr("src",f),"undefined"!=c&&e.css("background-color",c)}).fail(function(){d.hide()})}};var AlarmManager=function(a){var b,c=this,d=io.connect(window.location.origin),e=window.opener.workspaceManager,f=e.sessionId(),g=e.user(),h={systemAdmin:g["System Admin"].Value,groups:g.groups},i="alarms_"+g._id,j=e.openWindowPositioned,k="alarm"+window.location.search.slice(1),l=$(".alarms"),m=$(".newAlarmTop"),n=$(".newAlarmBottom"),o=28,p=$(".content"),q=$(".detailContainer"),r=($(".detailContent"),$("#dateFrom")),s=$("#timeFrom"),t=$("#dateTo"),u=$("#timeTo"),v=q.outerWidth(),w=0,x=1.5,y=2,z=-1,A=3,B=5e3,C=15e3,D=300,E=400,F=200,G=10,H=6e3,I={rateLimit:{timeout:G,method:"notifyWhenChangesStop"}},J=!1,K=(new Date).getTime(),L=!1,M={},N={},O={Recent:[],Active:[],Unacknowledged:[]},P={Emergency:2,2:"Emergency",Critical:1,1:"Critical",Urgent:3,3:"Urgent",Default:0,0:"Default"},Q={Events:0,0:"Events",Alarms:1,1:"Alarms",Return:2,2:"Return",Maintenance:3,3:"Maintenance"},R={name1:"",name2:"",name3:"",name4:"",pointTypes:[]},S=e.config.Utility.pointTypes.getAllowedPointTypes().length,T=0,U={CONTROL:2,ACKNOWLEDGE:4,WRITE:8},V=function(){},W=function(a){if(null===a||"object"!=typeof a)return a;var b=a.constructor();for(var c in a)b[c]=W(a[c]);return b},X=function(a,b){for(var c=0,d=h.groups.filter(function(b){return!!~a.indexOf(b._id)}),e=0,f=d.length;e<f;e++)c|=d[e]._pAccess;return!!(c&b)},Y=function(a,b){var c,d,e;if(typeof a!=typeof b)return!0;if("object"!=typeof a||null===a)return a!==b;if(d=a.length,e=b.length,d!==e)return!0;for(c=0;c<d;c++)if(a[c]!==b[c])return!0;return!1},Z=function(a,b){var c={right:{stop:a,time:0,duration:.2,units:"px",effect:"circIn"}};p.tween(c),c.right.stop=b,q.tween(c),$.play()},_=function(a,b){var d,e,f,g,h,i=c.filters.nameSegment.options;for(c.nameFilterPaused(!0),e=b||4,d=e+1;d<4;d++)i["name"+d].value("");for(e;e>0;e--)g="name"+e,h="Name"+e,f="function"==typeof a[h]?a[h]():a[h],i[g].value(f.length?f:void 0);c.nameFilterPaused(!1),Aa(!0),ca(c.currentView())},aa=function(a){var b,c,d,f=!1,g=e.windows(),h=g.length;for(b=0;b<h&&!f;b++)c=g[b],c.upi()===k&&(d=a.title+" Alarms",c.title(d),window.top.location.href===window.location.href&&(window.document.title=d),f=!0)},ba=function(a){var b,c;for(b=1;b<5;b++)c="name"+b,R[c]=a.hasOwnProperty(c)?a[c]:void 0;a.pointTypes.length===S&&(a.pointTypes=[]),R.pointTypes=a.pointTypes},ca=function(a){a=a||c.currentView(),b.pointLookup.init(ba,a.filters.nameSegment.options)},da=function(){b=j("/pointLookup?mode=filter","filter","filter","filter","filter",{callback:ca})},ea=function(a,b){var c=new Date(1e3*a),d=c.clone().clearTime(),e=Date.today(),f="";return b=b||!1,f=!b&&d.equals(e)?"Today":!b&&d.equals(e.addDays(-1))?"Yesterday":c.toString("M/d/yyyy")},fa=function(a){var b=new Date(1e3*a);return b.toString("HH:mm:ss")},ga=function(a){var b,c=(new Date).getTime(),e=function(a){var b,c=a.ids,d=c.length;for(b=0;b<d;b++)la({_id:c[b],ackStatus:z});delete N[a.reqID]};V("Sending alarm acknowledge:",a,new Date),b=N[c]={},b.reqID=c,b.ids=a,b.username=g.username,d.emit("sendAcknowledge",JSON.stringify(b)),b.timeoutID=window.setTimeout(function(){e(b)},B)},ha=function(a,b){var c={Recent:"getRecentAlarms",Active:"getActiveAlarms",Unacknowledged:"getUnacknowledged"};0===b.user.groups.length&&(b.user.groups=[]),d.emit(c[a],JSON.stringify(b))},ia=function(a){var b=ea(a.ackTime),c=fa(a.ackTime),d=a.ackUser()+" acknowledged this alarm ";return isNaN(parseInt(b[0],10))||(d+="on "),d+=b+" at "+c},ja=function(a){1===++T&&c.openAlarmDetail(a),a.isSelected(!0),c.selectedRows.push(a)},ka=function(a){--T<0&&(T=0),a.isSelected(!1),c.selectedRows.remove(function(b){return b._id===a._id}),a._id===c.alarmDetail.alarm()._id?c.closeAlarmDetail():1===T&&c.openAlarmDetail(a)},la=function(a,b){var c,d,e,f,g,h,i=a.ackStatus?"function"==typeof a.ackStatus?a.ackStatus():a.ackStatus:null,j=a.ackUser?"function"==typeof a.ackUser?a.ackUser():a.ackUser:null,k=a.ackTime?a.ackTime:null;for(f in Ka)if(d=Ka[f],d.name!==b)for(e=d.list(),h=e.length,g=0;g<h;g++)if(c=e[g],c._id===a._id){i&&c.ackStatus(i),j&&c.ackUser(j),i===y&&k&&(c.ackTime=k,c.ackInfo(ia(c)));break}},ma=function(a,b,d,e){if(!d.view.paused()||"Unacknowledged"===d.name&&"ADD"!==b){if(a.reqID!==d.reqID)return V("receiveAlarmUpdate() Throwing away "+d.name+" alarm "+b+" update (request id mismatch).",a,new Date),void V(" ---------   data.reqID = "+a.reqID+"     alarmTable.reqID = "+d.reqID);if(d.gettingData())return V("Queueing "+d.name+" alarm "+b+" update",a,new Date),void O[d.name].push({data:a,action:b});var f,g,h,i,j,k,p,q,r={},s=0,t=!1,u=!1,v=d.name,w=d.list(),x=d.count(),y=d.view,z=y.sortAscending(),A=y.id===c.currentView().id,B=function(a,b){for(var c=0,d=w.length;c<d;c++)if(w[c][a]===b)return{index:c,alarm:w[c]};return null},C=function(){k=!1,p=l.scrollTop(),z?i||(k=!0,p+=o,m.fadeIn(0),m.fadeOut(H)):(k=!0,j?p=99999:(p-=o,n.fadeIn(0),n.fadeOut(H))),k&&l.scrollTop(p)},D=function(){return w.sort(function(a,b){return z?b.msgTime-a.msgTime:a.msgTime-b.msgTime})};return V("Received "+v+" alarms "+b+" update",ko.toJS(a),new Date),"ADD"===b?(e&&"Active"!==v&&B("_id",a.newAlarm._id)&&(t=!0),"Active"===v&&(q=B("upi",a.newAlarm.upi),q&&d.list().splice(q.index,1)),t||(s=1,z?(r.add="unshift",r.del="pop",i=0===l.scrollTop()):(r.add="push",r.del="shift",j=l[0].clientHeight===l[0].scrollHeight-l[0].scrollTop),pa(a.newAlarm,!0),w[r.add](a.newAlarm),(g=w.length)>1&&(z?w[0].msgTime<w[1].msgTime&&(u=!0):w[g-1].msgTime<w[g-2].msgTime&&(u=!0),u&&D()),A&&C(),w.length>E&&w[r.del](),d.list.valueHasMutated())):(h=a._id?"_id":"upi",f=d.list.remove(function(b){return b[h]===a[h]})[0],void 0!==f&&(s=-1),"Unacknowledged"===v&&la(a,d.name)),s&&(d.count(x+s),na(d.count(),d),s===-1&&w.length<F&&d.count()-(y.pageNumber()-1)*F>=F&&(A&&(d.stickyScrollBar=!0),d.refresh(!0))),f}},na=function(a,b){var c=b.view,d=c.sortAscending(),e=c.pageNumber(),f=b.numberOfPages(),g=parseInt(a/F,10);a%F&&g++,0===g&&(g=1),b.numberOfPages(g),d===!1&&e===f&&c.pageNumber(g)},oa=function(a){var b,d=c.selectedRows(),e=d.length;for(b=0;b<e;b++)if(d[b]._id===a._id)return!0;return!1},pa=function(a,b){var c,d,e=!1,f=a.Name1;for(b||(e=oa(a)),a.isSelected=ko.observable(e),a.ackStatus=ko.observable(a.ackStatus).extend({rateLimit:100}),a.ackUser=ko.observable(a.ackUser),a.prettyDate=ko.observable(ea(a.msgTime)),a.prettyTime=fa(a.msgTime),a.alarmClass=P[a.almClass],a.ackInfo=ko.observable(""),a.ackStatus()===y&&a.ackInfo(ia(a)),a.displayId||(a.displayId=0),d=2;d<5&&(c="Name"+d,""!==a[c]);d++)f+="_"+a[c];a.Name=f},qa=function(a,b){if(a.reqID&&a.reqID!==b.reqID)return V("receiveAlarms() Throwing away "+b.name+" alarms from server (reqID mismatch)",a,new Date),void V(" ---------   data.reqID = "+a.reqID+"     alarmTable.reqID = "+b.reqID);var d,e,f,g=a.alarms?a.alarms.length:0,h=b.view,i=h.sortAscending(),j=O[b.name];for(V("Receiving "+b.name+" alarms from server",a,new Date),window.clearTimeout(b.timeoutID),b.timeout(!1),f=0;f<g;f++)pa(a.alarms[f]);if(b.list(g?a.alarms:[]),b.count(a.count),b.gettingData(!1),g=j.length){for(f=0;f<g;f++)e=j[f],ma(e.data,e.action,b,!0);j.splice(0,g)}na(a.count,b),b.view.id===c.currentView().id&&(h.gotoPageOne&&(d=i?1:b.numberOfPages(),h.pageNumber(d),h.gotoPageOne=!1),Ia(),b.stickyScrollBar?b.stickyScrollBar=!1:i?l.scrollTop(0):l.scrollTop(99999))},ra=function(a){var b=a.name,c=new Date,d=c.getTime(),e={},f=function(a){a.gettingData(!1),a.timeout(!0)};a.refresh(!1),sa(a,e),e.reqID=a.reqID=d,a.gettingData(!0),V("requestAlarms() Requesting "+b+" alarms from server.  uniqueID = ",d,e,c),ha(b,e),a.timeout(!1),window.clearTimeout(a.timeoutID),a.timeoutID=window.setTimeout(function(){f(a)},C)},sa=function(a,b){var c,d,f,h,i,j,k,l,m,n,o=e.config.Enums["Point Types"],p=0,q=0,r=a.view,s=r.filters,t=r.sortAscending.peek(),u=a.numberOfPages.peek();b.itemsPerPage=F,b.numberItems=E,b.sort=t?"asc":"desc",b.currentPage=r.gotoPageOne?t?1:u:r.pageNumber.peek(),c=s.nameSegment.options;for(l in c)if("pointTypes"===l){if(c[l].length>0){b[l]=[];for(m in c[l])b[l].push(o[c[l][m]]["enum"])}}else n=c[l],void 0===n?b[l]=null:""!==n&&(b[l]=n);if(f=s.alarmClass.options,k=f.length,k<4)for(b.almClass=[],j=0,k=f.length;j<k;j++)b.almClass.push(P[f[j]]);if(h=s.alarmCategory.options,k=h.length,k<4)for(b.msgCat=[],j=0;j<k;j++)b.msgCat.push(Q[h[j]]);d=s.dateTime.options,L||(p=Date.parse(d.dateFrom+" "+d.timeFrom),p=null===p?0:Math.floor(p/1e3),q=Date.parse(d.dateTo+" "+d.timeTo),q=null===q?0:Math.floor(q/1e3)),b.startDate=p,b.endDate=q,b.user={},i=b.user,i["System Admin"]=g["System Admin"],i._id=g._id,i.groups=g.groups},ta=function(){var a=store.get(i)||{};return a.hasOwnProperty("sessionId")&&a.sessionId!==f&&(store.remove(i),a={}),a},ua=function(a){var b=store.get(i),c=ko.toJS(a);void 0===b&&(b={},b.sessionId=f),void 0===b[k]&&(b[k]={}),delete c.alarmTable,delete c.alarmTableName,delete c.children,delete c.defaultFilters,delete c.group,b[k].currentViewId=a.id,b[k][a.id]=c,store.set(i,b)},va=function(a){var b,d,e,f,g,h,i,j,k;for(b in c.filters)for(d=c.filters[b],e=a.filters[b],d.visible(e.visible),k=d.options.length,j=0;j<k;j++)f=d.options[j],g=e.options,"dateTime"===b||"nameSegment"===b?g[f.text]=f.value():(h=(i=g.indexOf(f.text))>-1,f.isActive()&&!h?g.push(f.text):!f.isActive()&&h&&g.splice(i,1));ua(a)},wa=function(a){a.filters=W(a.defaultFilters)},xa=function(a){var b,d,e,f,g,h,i=c[a],j=ta(),l=function(b){if(b.group=a,b.alarmTable=Ka[b.alarmTableName()],j.hasOwnProperty(k)&&j[k].hasOwnProperty(b.id)){var c=j[k][b.id];b.sortAscending=ko.observable(c.sortAscending),b.pageNumber=ko.observable(c.pageNumber),b.gotoPageOne=c.gotoPageOne,b.forceRefresh=c.forceRefresh,b.paused=ko.observable(c.paused),b.filters=c.filters}else b.sortAscending=ko.observable(!0),b.pageNumber=ko.observable(1),b.gotoPageOne=!1,b.forceRefresh=!1,b.paused=ko.observable(!1),b.filters={},wa(b)};for(e=0,f=i.length;e<f;e++)for(d=i[e],l(d),g=0,h=d.children.length;g<h;g++)b=d.children[g],b.daddy=d,l(b)},ya=function(a,b){var c;return this.text=b.text,this.id=b.text,"dateTime"===a||"nameSegment"===a?"object"==typeof b.value?this.value=ko.observableArray(b.value):this.value=ko.observable(b.value):(c=b.test,this.active=ko.observable(!0),this.shortText=b.shortText,this.category=a,this.buildOption=function(a,c){this.active.peek()&&(void 0!==b.almClass?a.push(b.almClass):void 0!==b.msgCat&&c.push(b.msgCat))},this.isActive=function(){return this.active()},this.set=function(){this.active(!0)},this.clr=function(){this.active(!1)},this.toggle=function(){this.active(!this.active())},this.test=function(a){return!!this.active()||!c(a)}),this},za=function(){var a,b,d,e,f,g=W(Ja);c.filters={};for(a in g){c.filters[a]={},e=c.filters[a],e.visible=ko.observable(),e.options=[],f=e.options,b=g[a];for(d in b)f.push(new ya(a,b[d])),f[d]=f[f.length-1]}},Aa=function(a){var b=c.alarms.peek(),d=b.view,e=function(a){va(a),K=(new Date).getTime(),c.alarms().refresh(!0)};V("applyFilter() Received filter request",new Date),b.gettingData(!0),d.gotoPageOne=!0,a?e(d):setTimeout(function(){e(d)},D)},Ba=function(a){var d,e,f,g,h,i,j,k,m,n,o=c.currentView(),p=o.group,q=o.alarmTableName(),r=a.group,s=a.alarmTable,t=s.name,u=a.forceRefresh,v=function(a,b){var c,d,e=a.children,f=e.length;for(c=0;c<f;c++)d=e[c],d.title!==b&&(d.forceRefresh=!0)};c.nameFilterPaused(!0),c.dateTimeFilterPaused(!0);for(e in c.filters)for(f=c.filters[e],g=a.filters[e],f.visible(g.visible),k=f.options.length,j=0;j<k;j++)if(h=f.options[j],i=g.options,"dateTime"===e){var w,x,y=$("#"+h.id),z=Date.parse(i[h.text].value);h.value(i[h.text]),"dateFrom"===h.text||"dateTo"===h.text?(w="datepicker",x="setDate"):(w="timepicker",x="setTime"),null!==z&&y[w](x,z)}else"nameSegment"===e?h.value(i[h.text]):h.active(i.indexOf(h.text)>-1);if(b.pointLookup&&b.pointLookup.init&&ca(a),o.scrollPosition=l.scrollTop(),s.view=a,c.currentView(a),d=a.sortAscending()?a.scrollPosition||0:a.scrollPosition||99999,l.scrollTop(d),c.viewTitle(a.pageTitle?a.pageTitle:a.title),u||p!==r||"customViews"===r||q===t)c.alarms().refresh(!0),u&&(a.forceRefresh=!1);else for(m=c.alarms().list(),k=m.length,T=0,j=0;j<k;j++)n=m[j],oa(n)===!0?(n.isSelected(!0),T++):n.isSelected(!1);"defaultViews"===r&&"Active"===t&&("Active"===a.title?v(a):(a.daddy.forceRefresh=!0,v(a.daddy,a.title))),c.nameFilterPaused(!1),c.dateTimeFilterPaused(!1)},Ca=function(){var a,b;Ka.Recent.view=c.defaultViews[0],Ka.Active.view=c.defaultViews[1],Ka.Unacknowledged.view=c.defaultViews[2];for(a in Ka)b=Ka[a],b.name!==c.currentView().alarmTableName()&&b.refresh(!0)},Da=function(){for(var a in Ka)Ka[a].refresh(!0)},Ea=function(){var a,b,c,d,e;for(c in Ka)for(e=Ka[c].list(),b=e.length,a=0;a<b;a++)d=e[a],d.prettyDate(ea(d.msgTime)),d.ackStatus===y&&d.ackInfo(ia(d));Fa()},Fa=function(){var a=new Date,b=Date.today().addDays(1);window.setTimeout(Ea,b-a)},Ga=function(a){var b=e.config.Utility.pointTypes,c=b.getPointTypeNameFromEnum(a.PointType),d=b.getUIEndpoint(c,a.upi),f={width:850,height:600};j(d.review.url,a.Name,c,d.review.target,a.upi,f)},Ha=function(a,b){var d,e,f,g,h=[c.defaultViews,c.customViews];for(e=h.length,d=0;d<e;d++){var i=h[d];for(g=i.length,f=0;f<g;f++){var j=i[f];if(j.hasOwnProperty(a)&&j[a]===b)return j}}return null},Ia=function(){var a=c.currentView(),b=a.sortAscending(),d=a.pageNumber(),e=c.alarms().numberOfPages(),f=!1;d>1&&d<e?f=!0:1===d?b||(f=!0):b&&(f=!0),a.paused(f),ua(a)},Ja={alarmClass:{Emergency:{text:"Emergency",shortText:"Emer",almClass:P.Emergency,test:function(a){return 2===a.almClass}},Critical:{text:"Critical",shortText:"Crit",almClass:P.Critical,test:function(a){return 1===a.almClass}},Urgent:{text:"Urgent",shortText:"Urg",almClass:P.Urgent,test:function(a){return 3===a.almClass}},Default:{text:"Default",shortText:"Def",almClass:P.Default,test:function(a){return 0===a.almClass}}},alarmCategory:{Events:{text:"Events",shortText:"Evts",msgCat:Q.Events,test:function(a){return 0===a.msgCat}},Alarms:{text:"Alarms",shortText:"Alms",msgCat:Q.Alarms,test:function(a){return 1===a.msgCat}},Return:{text:"Return",shortText:"Ret",msgCat:Q.Return,test:function(a){return 2===a.msgCat}},Maintenance:{text:"Maintenance",shortText:"Maint",msgCat:Q.Maintenance,test:function(a){return 3===a.msgCat}}},other:{Acknowledge:{text:"Requires Acknowledgement",shortText:"Ack",test:function(a){return 1!==a.ackStatus()}}},dateTime:{dateFrom:{text:"dateFrom",value:""},dateTo:{text:"dateTo",value:""},timeFrom:{text:"timeFrom",value:""},timeTo:{text:"timeTo",value:""}},nameSegment:{name1:{text:"name1",value:""},name2:{text:"name2",value:""},name3:{text:"name3",value:""},name4:{text:"name4",value:""},pointTypes:{text:"pointTypes",value:[]}}},Ka={Recent:{name:"Recent",list:ko.observableArray([]),count:ko.observable(0),gettingData:ko.observable(!1),refresh:ko.observable(!1),numberOfPages:ko.observable(1),timeout:ko.observable(!1),timeoutID:0,reqID:0,view:"",stickyScrollBar:!1},Active:{name:"Active",list:ko.observableArray([]),count:ko.observable(0),gettingData:ko.observable(!1),refresh:ko.observable(!1),numberOfPages:ko.observable(1),timeout:ko.observable(!1),timeoutID:0,reqID:0,view:"",stickyScrollBar:!1},Unacknowledged:{name:"Unacknowledged",list:ko.observableArray([]),count:ko.observable(0),gettingData:ko.observable(!1),refresh:ko.observable(!1),numberOfPages:ko.observable(1),timeout:ko.observable(!1),timeoutID:0,reqID:0,view:"",stickyScrollBar:!1}};c.filtersPlaceHolder=W(Ja),c.defaultViews=[{title:"Recent",id:0,alarmTableName:ko.observable("Recent"),defaultFilters:{alarmClass:{visible:!0,options:["Emergency","Critical","Urgent","Default"]},alarmCategory:{visible:!0,options:["Events","Alarms","Return","Maintenance"]},other:{visible:!1,options:[]},dateTime:{visible:!0,options:{dateFrom:"",dateTo:"",timeFrom:"",timeTo:""}},nameSegment:{visible:!0,options:{name1:"",name2:"",name3:"",name4:"",pointTypes:[]}}},children:[]},{title:"Active",id:1,alarmTableName:ko.observable("Active"),defaultFilters:{alarmClass:{visible:!0,options:["Emergency","Critical","Urgent","Default"]},alarmCategory:{visible:!1,options:["Alarms"]},other:{visible:!1,options:[]},dateTime:{visible:!1,options:{dateFrom:"",dateTo:"",timeFrom:"",timeTo:""}},nameSegment:{visible:!0,options:{name1:"",name2:"",name3:"",name4:"",pointTypes:[]}}},children:[]},{title:"Unacknowledged",id:2,alarmTableName:ko.observable("Unacknowledged"),defaultFilters:{alarmClass:{visible:!0,options:["Emergency","Critical","Urgent","Default"]},alarmCategory:{visible:!0,options:["Alarms","Return"]},other:{visible:!1,options:[]},dateTime:{visible:!1,options:{dateFrom:"",dateTo:"",timeFrom:"",timeTo:""}},nameSegment:{visible:!0,options:{name1:"",name2:"",name3:"",name4:"",pointTypes:[]}}},children:[]}],c.customViews=[];var La=null,Ma=ta();Ma.hasOwnProperty(k)&&(La=Ha("id",Ma[k].currentViewId)),null===La&&(La=c.defaultViews[0]),c.currentView=ko.observable(La),c.viewTitle=ko.observable(),c.selectedRows=ko.observableArray([]),c.currentPage=ko.observable(1),d.on("acknowledgeResponse",function(a){var b,c,d,e=a.result;if(V("Received ack response:",a,new Date),N.hasOwnProperty[a.reqID]===!1)return V("Unexpected response. This request has already timed out. Forcing alarms refresh."),void Da();if(window.clearTimeout(N[a.reqID].timeoutID),c=N[a.reqID].ids,d=c.length,!e)for(b=0;b<d;b++)la({_id:c[b],ackStatus:z});delete N[a.reqID]}),d.on("unacknowledged",function(a){qa(a,Ka.Unacknowledged)}),d.on("activeAlarms",function(a){qa(a,Ka.Active)}),d.on("recentAlarms",function(a){qa(a,Ka.Recent)}),d.on("removingActiveAlarm",function(a){ma(a,"DELETE",Ka.Active)}),d.on("removingUnackAlarm",function(a){ma(a,"DELETE",Ka.Unacknowledged)}),d.on("newRecentAlarm",function(a){ma(a,"ADD",Ka.Recent)}),d.on("newUnackAlarm",function(a){ma(a,"ADD",Ka.Unacknowledged)}),d.on("addingActiveAlarm",function(a){ma(a,"ADD",Ka.Active)}),d.on("connect",function(){}),d.on("reconnect",function(){Da()}),d.on("reconnecting",function(){var a=0,b=function(){$.ajax({url:"/home"}).done(function(a){J=!1,V("reconnected",new Date)}).fail(function(c){a++,a<2?(V("retrying reconnect"),b()):J=!1})};J||(J=!0,V("reconnecting",new Date),b())}),c.togglePop=function(){var a=c.alarms().name+" Alarms",b={width:1024,heigth:768};window.top.location.href===window.location.href?j(window.location.href,a,"alarm","mainWindow",k):j(window.location.href,a,"alarm","",k,b)},c.toHexColor=function(a){return"#"+a},c.toggleOption=function(a,b){var d,e,f,g,h,i;if("click"===b.type)a.toggle();else{if(f=a.active(),a.set(),d="alarmClass"===a.category?c.filters.alarmClass.options:c.filters.alarmCategory.options,h=d.length,f){for(g=!0,i=0;i<h;i++)if(e=d[i],e.text!==a.text&&e.isActive()){g=!1;break}}else g=!1;for(i=0;i<h;i++)e=d[i],e.text!==a.text&&e.active(g)}Aa()},c.userHasPermissionToAck=function(a){var b=h.systemAdmin||X(a.Security,U.ACKNOWLEDGE);return b},c.ackAlarm=function(a,b){c.ackRequired(a)&&(a.ackStatus(x),la(a,c.alarms().name),ga([a._id]))},c.ackAlarms=function(){var a,b,d=c.alarms().list(),e=d.length,f=e>200?200:e,g=[];for(a=0;a<f;a++)b=d[a],b.isSelected()&&c.ackRequired(b)&&(b.ackStatus(x),la(b,c.alarms().name),g.push(b._id));g.length&&ga(g)},c.ackRequired=function(a){var b=a.ackStatus();return b&&b!==y&&b!==A},c.openDisplay=function(a){var b=e.config.Utility.pointTypes.getUIEndpoint("Display",a._id),c=a.Name||"",d={width:850,height:600};j(b.review.url,c,"Display","",a._id,d)},c.refreshAlarms=function(){c.alarms().refresh(!0)},c.selectRow=function(a,b){var d=b.srcElement.classList,e=(a.ackStatus(),function(a){for(var b=0,c=d.length;b<c;b++)if(d[b]===a)return!0;return!1});if(e("msgText"))return void("click"===b.type?Ga(a):_(a));if(e("fa-sitemap"))return void c.openDisplay(a);if(!e("tableButton")){var f,g,h,i=c.alarms(),j=i.name,k=i.list(),l=k.length,m=(c.selectedRows,function(a,b,c){return b>c?a<b&&a>c:a<c&&a>b}),n=function(a){for(f=0;f<l;f++)if(k[f]._id===a)return f;return null},o=function(a,b,c){var d,e,f;for(b<c?(e=b,f=c):(e=c,f=b),d=e;d<=f;d++){var g=k[d],h=g.isSelected();a&&!h?ja(g):!a&&h&&ka(g)}};if(!M.hasOwnProperty(j)){var p=M[j]={};p.lastClickId=null,p.lastShiftClickId=null,p.shiftRelease=!0}if(h=M[j],"INPUT"===b.srcElement.tagName?(g=!a.isSelected(),b.shiftKey||(b.ctrlKey=!0)):g=a.isSelected(),b.shiftKey&&null!==h.lastClickId){if(null!==h.lastClickId){var q=n(h.lastClickId),r=k.indexOf(a),s=n(h.lastShiftClickId);null!==q&&(h.shiftRelease?o(!g,q,r):null!==s&&(m(r,q,s)?o(!g,r,s):s<q&&r>q||s>q&&r<q?(o(!k[q].isSelected(),q,s),o(!g,q,r)):o(!g,r,s)))}h.lastShiftClickId=a._id,h.shiftRelease=!1}else b.ctrlKey||c.selectNone(),g?ka(a):ja(a),h.lastClickId=a._id,h.shiftRelease=!0;return!0}},c.selectAll=function(a,b){var d,e,f=c.alarms().list(),g=f.length,h=g>200?200:g;if(c.allSelected()===!0)"INPUT"===b.srcElement.tagName&&c.selectNone();else for(e=0;e<h;e++)d=f[e],d.isSelected()||ja(d);return!0},c.selectNone=function(){var a,b,d=c.alarms().list(),e=d.length,f=e>200?200:e;for(b=0;b<f;b++)a=d[b],a.isSelected()&&ka(a)},c.selectUnacknowledged=function(){var a,b,d=c.alarms().list(),e=d.length,f=e>200?200:e;for(b=0;b<f;b++)a=d[b],c.ackRequired(a)&&!a.isSelected()&&ja(a)},c.deselectAll=function(){var a,b=c.alarms().list(),d=b.length;for(a=0;a<d;a++)b[a].isSelected(!1);c.selectedRows.removeAll(),T=0,c.closeAlarmDetail()},c.changeView=function(a){var b=c.currentView();a.id!==b.id&&(aa(a),ua(a),Ba(a))},c.isCurrentView=function(a){return a.title===c.currentView().title},c.toggleViewPaused=function(){var a=c.currentView(),b=a.paused();a.sortAscending();b&&(a.gotoPageOne=!0,c.alarms().refresh(!0)),c.currentView().paused(!b)},c.toggleViewSort=function(){var a=c.currentView().sortAscending,b=!0;a(!a()),Aa(b)},c.changePage=function(a){var b,d=c.alarms(),e=c.currentView(),f=e.pageNumber,g=(c.alarms().numberOfPages(),f());e.sortAscending();"begin"===a?a=1-g:"end"===a&&(a=d.numberOfPages()-g),b=g+a,f(b),ua(e),d.refresh(!0)},c.resetFilters=function(){if(c.dirty()){var a=c.currentView();c.clearDateTimeUIFields(),wa(a),ua(a),ca(a),Ba(a)}},c.clearDateTimeFilter=function(){var a,b,d,e=c.filters.dateTime.options,f=c.filtersPlaceHolder.dateTime,g=e.length,h=!1;for(c.dateTimeFilterPaused(!0),d=0;d<g;d++)a=e[d],b=a.id,""!==a.value()&&(h=!0),a.value(""),f[b].value="";c.clearDateTimeUIFields(),c.dateTimeFilterPaused(!1),h&&(e.dateFrom.value.valueHasMutated(),Aa(!0))},c.clearDateTimeUIFields=function(){var a=c.filtersPlaceHolder.dateTime;a.dateFrom.value="",r.val(a.dateFrom).datepicker("setDate",a.dateFrom.value),a.timeFrom.value="",s.val(a.timeFrom).timepicker("setTime",a.timeFrom.value),a.dateTo.value="",t.val(a.dateTo).datepicker("setDate",a.dateTo.value),a.timeTo.value="",u.val(a.timeTo).timepicker("setTime",a.timeTo.value)},c.cancelDateTimeFilter=function(){var a=c.filters.dateTime.options,b=c.filtersPlaceHolder.dateTime;b.dateFrom.value=a.dateFrom.value(),r.val(b.dateFrom).datepicker("setDate",b.dateFrom.value),b.timeFrom.value=a.timeFrom.value(),s.val(b.timeFrom).timepicker("setTime",b.timeFrom.value),b.dateTo.value=a.dateTo.value(),t.val(b.dateTo).datepicker("setDate",b.dateTo.value),b.timeTo.value=a.timeTo.value(),u.val(b.timeTo).timepicker("setTime",b.timeTo.value)},c.applyNameFilter=function(){var a,b,d,e,f=c.filters.nameSegment.options,g=f.length,h=!1;for(c.nameFilterPaused(!0),e=0;e<g;e++)a=f[e],b=a.value(),d=R[a.text],!h&&Y(b,d)&&(h=!0),a.value(R[a.text]);c.nameFilterPaused(!1),h&&f.name1.value.valueHasMutated()},c.callChangeNameFilter=function(a){_(c.alarmDetail.alarm(),a)},c.closeAlarmDetail=function(a){var b=20,c=-(v+2);a&&ka(a),Z(b,c)},c.alarmDetail={reqID:0,alarm:ko.observable({Name1:"",Name2:"",Name3:"",Name4:""}),gettingData:ko.observable(!1).extend({throttle:100}),error:ko.observable(!1),displays:ko.observableArray([])},c.openAlarmDetail=function(a){var b,d=v+40,e=20,f=c.alarmDetail,g=f.alarm?f.alarm().upi:null;f.alarm(a),(g!==a.upi||f.error())&&(f.reqID=(new Date).getTime(),f.error(!1),f.gettingData(!0),b={reqID:f.reqID,upi:a.upi},V("Requesting display dependencies",b,new Date),$.ajax({type:"POST",url:"/api/points/findAlarmDisplays/",data:b}).done(function(a){f.gettingData(!1),V("Received display dependencies",a,new Date),a.reqID&&a.reqID!==f.reqID?V("Throwing away display dependencies (request ID mismatch)",a,new Date):a.err?(f.gettingData(!1),f.error(!0)):a.displays?f.displays(a.displays):(f.gettingData(!1),f.error(!0))}).fail(function(){f.gettingData(!1),f.error(!0)})),Z(d,e)},c.debug={printAlarmUpdateQueue:function(){V(O)},printReqIds:function(){V(Ka.Recent.reqID,Ka.Unacknowledged.reqID,Ka.Active.reqID)},simulateReceiveAlarms:function(){var a=c.alarms(),b={alarms:ko.toJS(a.list()),count:a.count()};return qa(b,a),!0},addAlarm:function(a,b,c){if(void 0===Ka[a])return void V("Alarms, "+a+", is undefined. Use 'Recent', 'Active', or 'Unacknowledged'.");var d=Ka[a],e={newAlarm:{BackColor:"0000FF",Name1:"DUMMY",Name2:"POINT",Name3:"",Name4:"",Security:[],TextColor:"FFFFFF",ackInfo:"",ackStatus:w,ackTime:0,ackUser:0,displayId:0,alarmClass:"Urgent",almClass:3,msgCat:0,msgTime:Math.floor((new Date).getTime()/1e3)-(c?c:0),msgType:18},reqID:d.reqID};b=b||1,c=c||0;for(var f=0;f<b;f++)e.newAlarm._id=Math.random().toString(36).slice(2),e.newAlarm.upi=parseInt(Math.random().toString().slice(2),10),e.newAlarm.msgText="Dummy Alarm Message "+f,ma(JSON.parse(JSON.stringify(e)),"ADD",d)},deleteAlarm:function(a,b,c){if(void 0===Ka[a])return void V("Alarms, "+a+", is undefined. Use 'Recent', 'Active', or 'Unacknowledged'.");var d=Ka[a],e=d.list(),f={reqID:d.reqID};b=b||1,void 0===c&&(c=!0);for(var g=0;g<b;g++){var h,i=e.length;i&&(h=c?e[0]:i>F?e[F-1]:e[i-1],"Active"===a?f.upi=h.upi:(f._id=h._id,f.ackStatus=2,f.ackUser="NO_USER",f.ackTime=Math.floor((new Date).getTime()/1e3)),ma(f,"DELETE",d))}d.list.valueHasMutated()}},$(window).on("hashchange",function(){var a,b=location.hash.substring(1);a=Ha("title",b),null===a&&(a=c.defaultViews[0]),c.changeView(a)}),xa("defaultViews"),za(),c.alarms=ko.computed(function(){return Ka[c.currentView().alarmTableName()]},c),c.alarms200=ko.computed(function(){return c.alarms().list.slice(0,200)},c),c.dirty=ko.computed(function(){var a,b,d,e,f,g,h,i;for(a in Ja)for(b=c.filters[a],d=c.currentView().defaultFilters[a],i=b.options.length,h=0;h<i;h++)if(e=b.options[h],f=d.options,"dateTime"===a||"nameSegment"===a){if(Y(e.value(),f[e.text]))return!0}else if(g=f.indexOf(e.text)>-1,e.isActive()^g)return!0;return!1},c).extend(I),c.allSelected=ko.computed(function(){var a,b=c.alarms().list(),d=b.length,e=d>200?200:d;if(0===e)return!1;for(a=0;a<e;a++)if(b[a].isSelected()===!1)return!1;return!0},c).extend(I),c.anyAckSelected=ko.computed(function(){var a,b,d,e=c.alarms().list(),f=e.length,g=f>200?200:f;for(a=0;a<g;a++)if(b=e[a],d=b.ackStatus(),b.isSelected()&&d!==w&&d!==y&&d!==A)return!0;return!1},c).extend(I),c.ackInProgress=ko.computed(function(){var a,b,d=c.alarms().list(),e=d.length,f=e>200?200:e;for(a=0;a<f;a++)if(b=d[a],b.ackStatus()===x)return!0;return!1}),c.nameFilterPaused=ko.observable(!0),c.nameFilter=ko.computed(function(){var a,b,d,e=c.nameFilterPaused.peek(),f=c.filters.nameSegment.options,g=f.length,h=!1,i=$("#nameFilters .filterIcon");for(d=0;d<g;d++)a=f[d],b=a.value(),"object"==typeof b?b.length&&(h=!0):""!==b&&(h=!0);h?i.addClass("filterActive"):i.removeClass("filterActive"),e||Aa()},c),c.dateTimeFilterPaused=ko.observable(!0),c.dateFilter=ko.computed(function(){var a,b,d,e,f=(c.dateTimeFilterPaused.peek(),c.filters.dateTime.options),g=f.length,h={},i=!1,j=$("#timeDateFilters .filterIcon");for(L=!1,a=0;a<g;a++)d=f[a],b=d.value(),e=$("#"+d.id),""!==b&&null===Date.parse(b)?(L=!0,e.addClass("inputError")):(e.removeClass("inputError"),h[d.text]=b,""!==b&&(i=!0));L?j.addClass("filterError").removeClass("filterActive"):i?j.addClass("filterActive").removeClass("filterError"):j.removeClass("filterActive").removeClass("filterError")}),c.applyDateTimeFilter=function(){var a,b,d,e=c.filters.dateTime.options,f=c.filtersPlaceHolder.dateTime,g=!0,h=e.length;for(V("applyDateTimeFilter() called.....",new Date),a=0;a<h;a++)d=e[a],b=d.id,d.value(f[b].value);Aa(g)},c.getRecentAlarms=ko.computed(function(){var a=Ka.Recent,b=a.refresh();b&&ra(a)},c),c.getActiveAlarms=ko.computed(function(){var a=Ka.Active,b=a.refresh();b&&ra(a)},c),c.getUnacknowledgedAlarms=ko.computed(function(){var a=Ka.Unacknowledged,b=a.refresh();b&&ra(a)},c),c.printAlarms=function(){$(".alarms").css("overflow","visible"),$(".alarms").printArea({mode:"iframe"}),$(".alarms").css("overflow","auto")},Ca(),da(),Fa(),Ba(c.currentView())};$(function(){applyBindings(),initPage(window.manager)});
function TreeViewModel(){var a,b,c=this,d=[],e=0,f=!1;c.loadTree=function(){c.tree([]),c.networks([]),c.badNetworks([]),$(".loadingIcon").show(),$.getJSON("/api/devicetree/getTree",function(b){var d=ko.viewmodel.fromModel(b);for(c.tree(d.tree()),a=0;a<b.networkNumbers.length;a++)c.networks.push(b.networkNumbers[a]);for(a=0;a<b.badNumbers.length;a++)c.badNetworks.push(b.badNumbers[a]);$(".loadingIcon").hide(),$("#tree2").treed(),$(".fa-refresh").removeClass("fa-spin")})},c.networks=ko.observableArray([]),c.tree=ko.observableArray([]),c.badNetworks=ko.observableArray([]),c.branches=ko.observableArray([]),c.fakeTree=ko.observableArray([]),c.searchValue=ko.observable("").extend({throttle:250}),c.upi=ko.observable(),c.name=ko.observable(""),c.network=ko.observable(""),c.netType=ko.observable(""),c.deviceAddress=ko.observable(""),c.deviceStatus=ko.observable(""),c.lastReportTime=ko.observable(""),c.modelType=ko.observable(""),c.firmwareRevision=ko.observable(""),c.searchValue.subscribe(function(a){e=0,a?c.deviceSearch():c.clearSearch()}),c.devAddress=function(a){return 0===a.uplinkPort()?["(",a.deviceAddress(),":",a.ethIPPort(),")"].join(""):["(",a.deviceAddress(),")"].join("")},c.showDevice=function(a,b,d){var e=$(b.target).offset().left+$(b.target).context.offsetWidth;$.getJSON("/api/points/"+a.upi(),function(a){if(a.err);else{$(".overlay").css({top:mouseY,left:e,display:"block"});var d=document.body.getBoundingClientRect(),f=$(".overlay")[0].getBoundingClientRect();f.bottom>d.bottom?mouseY-=f.bottom-d.bottom-40:mouseY=$(b.target).offset().top,$(".overlay").css({top:mouseY,left:e+25,display:"block"});var g=parseInt(a["Last Report Time"].Value,10),h=moment.unix(g).format("dddd, MMMM Do YYYY, h:mm:ss a");c.upi(a._id),c.name(a.Name),c.network(a["Network Segment"].Value),c.netType(a["Uplink Port"].Value),c.deviceAddress(a["Device Address"].Value),c.deviceStatus(a["Device Status"].Value),c.lastReportTime(h),c.modelType(a["Model Type"].Value),c.firmwareRevision(a["Firmware Version"].Value),$(".deviceStatus").css("background-color",""),$(".deviceStatus").css("color","");var i=[],j="";if(j="Stop Scan"===c.deviceStatus()?stopScanColor:"Normal"!==c.deviceStatus()?inFaultColor:normalColor){$(".deviceStatus").css("background-color","#"+j);for(var k=0;k<6;k+=2)i.push(parseInt(j.substr(k,2),16));var l=.299*i[0]+.587*i[1]+.114*i[2],m=255-l<105?"Black":"White";$(".deviceStatus").css("color",m)}}})},c.hideDevice=function(){$(".overlay").css("display","none")},c.statusColor=function(a){var b;return b=a.badNetwork?"FF0000":"Stop Scan"===a.status()?stopScanColor:"Normal"!==a.status()?inFaultColor:normalColor,b?"#"+b:""},c.deviceSearch=function(){f||(b=new RegExp(".*"+c.searchValue().toString().split(" ").join("_")+".*","i"),c.scrollToElement(b))},c.networkSearch=function(a){f=!0,c.searchValue(a),b=new RegExp("^"+a+"$"),c.scrollToElement(b)},c.scrollToElement=function(a,b){e=void 0!==b?b:e,d=[],c.resetTree(),$("span.searchable").filter(function(){return this.textContent.match(a)&&d.push(this),this.textContent.match(a)}).css("background-color","#86E2D5"),d.length>e&&($scrollTo=$(d[e]),$scrollTo.css("background-color","#FDE3A7"),c.exapandAll(),$(".treePane").animate({scrollTop:$scrollTo.offset().top-$(".treePane").offset().top-135,scrollLeft:0},0),setTimeout(function(){f=!1},250))},c.clearSearch=function(){c.searchValue(""),c.resetTree()},c.resetTree=function(){$(".treePane").scrollTop(0),$("span").css("background-color","")},c.openDevice=function(a,b){var c=workspace.config.Utility.pointTypes.getUIEndpoint("Device",a.upi());workspace.openWindowPositioned(c.review.url,a.text(),"Device","",a.upi(),{width:1250,height:750})},c.searchNext=function(){c.search(1)},c.searchPrev=function(){c.search(-1)},c.search=function(a){var f=e+a;d.length&&(a>0&&f>=d.length?f=0:a<0&&f<0&&(f=d.length-1),c.scrollToElement(b,f))},c.exapandAll=function(){var a=$(".tree");a.find("li").has("ul").each(function(){var a=$(this),b=$(this).children("i:first");b.removeClass(closedClass),b.addClass(openedClass),a.children().children().show()})},c.collapseAll=function(){var a=$(".tree");a.find("li").has("ul").each(function(){var a=$(this),b=$(this).children("i:first");b.removeClass(openedClass),b.addClass(closedClass),a.children().children().hide()})},c.refresh=function(){$(".fa-refresh").addClass("fa-spin"),c.loadTree()},$(".searchArea").on("keydown",function(a){13===a.keyCode&&(a.preventDefault(),a.shiftKey?c.searchPrev():c.searchNext())}),socket.on("updateDeviceStatus",function(a){for(var b=a["Device Status"].Value,d=a.upi,e=function(a){for(var c=0;c<a.branches().length;c++){if(a.branches()[c].upi()===d)return a.branches()[c].status(b),void console.log(a.branches()[c]);for(var f=0;f<a.branches()[c].branches().length;f++)e(a.branches()[c].branches()[f])}},f=0;f<c.tree().length;f++){e(c.tree()[f]);break}}),c.loadTree()}for(var workspace=window.opener&&window.opener.workspaceManager,qualityCodes=workspace.systemEnums.qualityCodes,socket=workspace.socket(),openedClass="glyphicon-minus-sign",closedClass="glyphicon-plus-sign",inFaultColor,stopScanColor,normalColor="008800",i=0;i<qualityCodes.length;i++)"Fault"===qualityCodes[i].label?inFaultColor=qualityCodes[i].color:"Stop Scan"===qualityCodes[i].label&&(stopScanColor=qualityCodes[i].color);var maxSpanLength=0,mouseX,mouseY;$(document).mousemove(function(a){mouseX=a.pageX,mouseY=a.pageY}),ko.applyBindings(new TreeViewModel);
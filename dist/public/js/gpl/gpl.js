var gpl={texts:{},blocks:{},shapes:{},anchors:{},labelCounters:{},eventLog:[],actionLog:[],json:{},eventHandlers:{},destroyFns:[],canvases:{},MAXZOOM:4,MINZOOM:.1,editModeOffset:77,scaleValue:1,defaultLoopDelay:10,resizeDelay:150,itemIdx:0,editVersionStaleTimeout:3e5,gridSize:1,boundingRectTime:0,boundingRectCount:0,logLinePrefix:!0,rendered:!1,poppedIn:window.top.location.href!==window.location.href,idxPrefix:"_gplId_",toolbarFill:"#313131",iconPath:"/img/icons/",pointApiPath:"/api/points/",defaultBackground:"C8BEAA",jqxTheme:"flat",convertProperties:["blockType","left","name","top","upi","label","connectionCount","precision","zIndex","labelVisible","presentValueVisible","connection","presentValueFont","value"],$body:$("body"),$tooltip:$(".gplTooltip"),$fontColorPicker:$("#fontColorPicker"),$bgColorPicker:$("#bgColorPicker"),$saveForLaterConfirmModal:$("#safeForLaterConfirm"),$editTextModal:$("#editTextModal"),$messageModal:$("#gplMessage"),$messageModalBody:$("#gplMessageBody"),$sequencePropertiesModal:$("#gplSequenceProperties"),$editInputOutputModal:$("#editInputOutput"),$editPrecisionModal:$("#editPrecisionModal"),$editVersionModal:$("#editVersionModal"),$colorpickerModal:$("#colorpickerModal"),$editActionButtonModal:$("#editActionButtonModal"),$editActionButtonValueModal:$("#editActionButtonValueModal"),$actionButtonReportParameterModal:$("#actionButtonReportParameterModal"),$useEditVersionButton:$("#useEditVersion"),$discardEditVersionButton:$("#discardEditVersion"),point:window.gplData.point,references:window.gplData.references,upi:window.gplData.upi,DELETEKEY:46,ESCAPEKEY:27,ARROWKEYS:{37:"left",38:"up",39:"right",40:"down"},destroyObject:function(a){var b,c=Object.keys(a);for(b=0;b<c.length;b++)delete a[c[b]]},onDestroy:function(a){gpl.destroyFns.push(a)},captureThumbnail:function(){gpl.workspaceManager.captureThumbnail({upi:gpl.upi,name:gpl.point.Name,type:"sequence"})},emptyFn:function(){},waitForSocketMessage:function(a){gpl.socketWaitFn=a},saveSequence:function(){gpl.point._parentUpi=0,gpl.point["Point Refs"][0].PointName=gpl.devicePoint.Name,gpl.socket.emit("updateSequence",{sequenceName:gpl.point.Name,sequenceData:{sequence:gpl.json}})},isCyclic:function(a){function b(a){var d;if(a&&"object"==typeof a){if(c.indexOf(a)!==-1)return!0;c.push(a);for(d in a)if(a.hasOwnProperty(d)&&b(a[d]))return console.log(a,"cycle at "+d),!0}return!1}var c=[];return b(a)},deStringObject:function(a,b){var c,d,e,f=a||{},g=Object.keys(f),h=g.length,i=null;for(c=0;c<h;c++)i=null,d=f[g[c]],"string"==typeof d?("false"===d.toLowerCase()?i=!1:"true"===d.toLowerCase()?i=!0:b||(d.indexOf(".")>-1?(e=parseFloat(d),isNaN(e)||(i=e)):(e=parseInt(d,10),isNaN(e)||(i=e))),null!==i&&(f[g[c]]=i)):"object"==typeof d&&(d=gpl.deStringObject(d,b));return f},convertBooleanStrings:function(a){return gpl.deStringObject(a,!0)},openWindow:function(){var a,b,c=Array.prototype.slice.apply(arguments).pop(),d=!1,e=!1,f=!1,g=function(){c.gplHandler&&!f&&(f=!0,c.gplHandler.apply(this,arguments)),clearInterval(b)},h=function(){var b=a.onbeforeunload;b===g||d||(d=!0,a.onbeforeunload=function(){e||(e=!0,g(),b.apply(this,arguments))})};return gpl.fire("openwindow"),a=gpl._openWindow.apply(this,arguments),a.onbeforeunload=g,b=setInterval(h,100),a},defaultBlockMessage:"Please Wait...",blockUI:function(a){gpl.log("Blocking UI:",a||gpl.defaultBlockMessage),$.blockUI({message:a||gpl.defaultBlockMessage})},unblockUI:function(){gpl.log("Unblocking UI"),$.unblockUI()},openPointSelector:function(a,b,c,d,e){var f,g,h=b||"/pointLookup",i=function(b,c,d){b&&a(b,c,d)},j=function(){var a=e?{}:{name1:gpl.point.name1,name2:gpl.point.name2,name3:gpl.point.name3,name4:gpl.point.name4};f.pointLookup.MODE="select",d&&(g=gpl.getPointTypes(d),f.pointLookup.POINTTYPES=g),f.pointLookup.init(i,a)};c&&(h+="/"+c+"/"+d),f=gpl.openWindow(h,"Select Point","","","Select Dynamic Point",{callback:j,width:1e3})},initGpl:function(){var a=0,b=0,c=function(){a++,a===b&&(gpl.manager=new gpl.Manager)},d=function(a){b++,a(c)};gpl._origPoint=$.extend(!0,{},window.gplData.point),gpl.point=gpl.convertBooleanStrings(gpl.point),gpl.devicePointRef=gpl.deStringObject(gpl.point["Point Refs"][0]),d(function(a){$.ajax({url:"/api/points/"+gpl.devicePointRef.PointInst}).done(function(b){gpl.devicePoint=b,a()})}),d(function(a){$.ajax({url:"/api/system/qualityCodes"}).done(function(b){gpl._qualityCodes=b,a()}).fail(function(a,b,c){gpl.log("qualityCodes error",JSON.stringify(c))})})},getBlock:function(a){return gpl.blockManager.getBlock(a)},getLabel:function(a,b){var c,d;return b&&gpl.labelCounters[a]++,c=gpl.labelCounters[a],d=a+c},formatValue:function(a,b){var c,d=a.precision||0,e=b;return"string"==typeof b&&(e=parseFloat(b)),isNaN(e)?c=b:(d=10*d%10,c=d>0?e.toFixed(d):parseInt(e,10),c=c.toString()),c},addReferencePoint:function(a,b){$.ajax({url:"/api/points/"+a}).done(function(c){var d;c.err?gpl.showMessage("error getting point data"):c.message?gpl.log("AddReferencePoint error- upi:",a,"--",c.message):(d=gpl.pointUpiMap[a]={Name:c.Name,pointType:c["Point Type"].Value,valueType:5===c.Value.ValueType?"enum":"float"},gpl.pointData[a]=c,b(d,c))})},onRender:function(a){gpl.rendered===!0?a(gpl.boundingBox):gpl.on("rendered",function(){a(gpl.boundingBox)})},forEach:function(a,b){var c,d=Object.keys(a),e=d.length,f=!0;for(c=0;c<e&&f;c++)f=b(a[d[c]],d[c],c),void 0===f&&(f=!0);return f},forEachArray:function(a,b){var c,d=a||[],e=d.length,f=!0;for(c=0;c<e&&f;c++)f=b(d[c],c),void 0===f&&(f=!0);return f},timedEach:function(a){var b=0,c=a.iteratorFn,d=a.list,e=a.delay||gpl.defaultLoopDelay,f=a.cb||null,g=function(){c(d[b]),setTimeout(function(){b++,b<d.length?g():f&&f()},e)};g()},showMessage:function(a){Array.isArray(a)?gpl.$messageModalBody.html("<ul><li>"+a.join("</li><li>")+"</li></ul>"):gpl.$messageModalBody.html(a),gpl.$messageModal.modal("show"),gpl.socketWaitFn&&(gpl.socketWaitFn(),gpl.socketWaitFn=null)},hideMessage:function(){gpl.$messageModal.modal("hide")},on:function(a,b){gpl.eventHandlers[a]=gpl.eventHandlers[a]||[],gpl.eventHandlers[a].push(b)},fire:function(a,b,c){var d,e=gpl.eventHandlers[a]||[],f=e.length;for(gpl.skipEventLog||gpl.eventLog.push({event:a,obj1:b&&b.gplId,obj2:c&&c.gplId}),d=0;d<f;d++)e[d](b||null,c||null)},makeId:function(){return gpl.itemIdx++,gpl.idxPrefix+gpl.itemIdx},makePointRef:function(a,b,c){var d={PropertyName:"",PropertyEnum:0,Value:a,AppIndex:0,isDisplayable:!0,isReadOnly:!0,PointName:b,PointInst:a,DevInst:0,PointType:c&&gpl.pointTypes[c["Point Type"].Value]["enum"]||0};return c&&("Input"===c.blockType?d.DevInst=c.getPointData()["Point Refs"][0].DevInst:d.DevInst=gpl.deviceId),d},isEdit:null!==document.location.href.match("/edit/"),noSocket:null!==document.location.href.match("nosocket"),noLog:null!==document.location.href.match("nolog"),nobg:null!==document.location.href.match("nobg"),skipInit:null!==document.location.href.match("skipinit"),formatDate:function(a,b){var c,d=["Hours","Minutes","Seconds","Milliseconds"],e=[2,2,2,3],f=[":",":",":",""],g=" --",h="";b&&f.push(g),"number"==typeof a&&(a=new Date(a));for(c in d)d.hasOwnProperty(c)&&(h+=("000"+a["get"+d[c]]()).slice(-1*e[c])+f[c]);return h},log:function(){var a,b,c,d,e=(new Date,[].splice.call(arguments,0)),f=function(a){return("    "+a).slice(-4)},g=gpl.formatDate(new Date,!0);gpl.logLinePrefix===!0&&(d=new Error,Error.captureStackTrace&&(Error.captureStackTrace(d),a=d.stack.split("\n")[2],b=a.split(":"),c=b[2],e.unshift("line:"+f(c),g))),gpl.noLog||console.log.apply(console,e)},convertColor:function(a){if(void 0!==a){var b=255&a,c=a>>8&255,d=a>>16&255,e=function(a){return("00"+a.toString(16)).slice(-2)};return e(b)+e(c)+e(d)}},validationMessage:[],validate:{connection:function(a,b,c){var d,e,f,g,h,i,j,k="Control Point"===b.anchorType?b:a,l="Control Point"===b.anchorType?a:b,m=!1,n=function(a,b){var d,e=!1;for(d=0;d<b.length&&!e;d++)b[d].key===a&&(e=!0);return e||c||gpl.log("invalid",a,b),e},o=function(){e=gpl.blockManager.getBlock(k.gplId),f=gpl.blockManager.getBlock(l.gplId),d=l.anchorType,e&&f&&(g=e.pointType,h=f.pointType)},p=function(){var a=l;l=k,k=a};return o(),g&&h&&("ControlBlock"===f.type&&(p(),o()),"Constant"===g&&l.takesConstant===!0?m=!0:(j=d,i=gpl.getPointTypes(j,h),i.error?c||gpl.log("error with",j,h,"--",i.error):n(g,i)&&(m=!0))),m}},checkLineIntersection:function(a,b,c,d,e,f,g,h){var i,j,k,l,m,n={x:null,y:null,onLine1:!1,onLine2:!1};return i=(h-f)*(c-a)-(g-e)*(d-b),0===i?n:(j=b-f,k=a-e,l=(g-e)*j-(h-f)*k,m=(c-a)*j-(d-b)*k,j=l/i,k=m/i,n.x=a+j*(c-a),n.y=b+j*(d-b),j>0&&j<1&&(n.onLine1=!0),k>0&&k<1&&(n.onLine2=!0),n)},findIntersections:function(){var a,b,c,d,e,f,g,h,i,j,k,l,m=new Date,n=[],o={},p=Object.keys(gpl.lineManager.lines),q=gpl.lineManager.lines,r={radius:2,fill:"white",left:null,top:null};for(window.coords=window.coords||{},i=0;i<p.length;i++)for(a=q[p[i]],j=0;j<p.length;j++)if(j!==i&&!o[i+"-"+j]&&!o[j+"-"+i])for(o[i+"-"+j]=!0,b=q[p[j]],d=a.lines,e=b.lines,k=0;k<d.length;k++)for(f=d[k],l=0;l<e.length;l++)g=e[l],h=gpl.checkLineIntersection(f.x1,f.y1,f.x2,f.y2,g.x1,g.y1,g.x2,g.y2),h.onLine1&&h.onLine2&&(window.coords[h.x+","+h.y]||(window.coords[h.x+","+h.y]=!0,r.left=h.x-1,r.top=h.y-1,c=new fabric.Circle(r),gpl.manager.canvas.add(c),n.push(c)));gpl.manager.canvas.renderAll(),gpl.log("Intersections:",n.length,"in",new Date-m,"ms")}};fabric.ExternalMonitorPointShape=fabric.util.createClass(fabric.Object,{type:"ExternalMonitorPointShape",x:0,y:0,initialize:function(a){var b={fill:"#6a6af1"};this.options=$.extend(b,a),this.callSuper("initialize",this.options),this.set("width",this.options.width||20).set("height",this.options.height||20),this.x=this.options.x||0,this.y=this.options.y||0,this.stroke=this.options.stroke||"black"},_render:function(a){var b=this.width/2,c=this.height/2,d=this.x-b,e=this.y-c;a.beginPath(),a.moveTo(d,e),a.lineTo(d+b,e),a.lineTo(d+this.width,e+c),a.lineTo(d+b,e+this.height),a.lineTo(d,e+this.height),a.lineTo(d,e),a.closePath(),this._renderFill(a),this._renderStroke(a)},toObject:function(a){var b=$.extend(this.callSuper("toObject",a),{selectable:!0,hasControls:!1});return b},complexity:function(){return 1}}),fabric.ExternalMonitorPointShape.fromObject=function(a){return new fabric.ExternalMonitorPointShape(a)},fabric.InternalMonitorPointShape=fabric.util.createClass(fabric.Object,{type:"InternalMonitorPointShape",x:0,y:0,fill:"#6a6af1",initialize:function(a){var b={fill:this.fill};this.options=$.extend(b,a),this.callSuper("initialize",this.options),this.set("width",this.options.width||20).set("height",this.options.height||20),this.x=this.options.x||0,this.y=this.options.y||0,this.stroke=this.options.stroke||"black"},_render:function(a){var b=this.width/3,c=this.height/3,d=this.x-this.width/2,e=this.y-this.height/2;a.beginPath(),a.moveTo(d+b,e),a.lineTo(d+2*b,e),a.lineTo(d+this.width,e+c),a.lineTo(d+this.width,e+2*c),a.lineTo(d+2*b,e+this.height),a.lineTo(d+b,e+this.height),a.lineTo(d,e+2*c),a.lineTo(d,e+c),a.lineTo(d+b,e),a.closePath(),this._renderFill(a),this._renderStroke(a)},toObject:function(a){var b=$.extend(this.callSuper("toObject",a),{selectable:!0,hasControls:!1});return b},complexity:function(){return 1}}),fabric.InternalMonitorPointShape.fromObject=function(a){return new fabric.InternalMonitorPointShape(a)},fabric.ExternalControlPointShape=fabric.util.createClass(fabric.ExternalMonitorPointShape,{type:"ExternalControlPointShape",initialize:function(a){var b={flipX:!0,fill:"#2bef30"};this.callSuper("initialize",$.extend(b,a))},toObject:function(){return this.callSuper("toObject")},_render:function(a){return this.callSuper("_render",a)}}),fabric.ExternalControlPointShape.fromObject=function(a){return new fabric.ExternalControlPointShape(a)},fabric.InternalControlPointShape=fabric.util.createClass(fabric.InternalMonitorPointShape,{fill:"#2bef30"}),fabric.InternalControlPointShape.fromObject=function(a){return new fabric.InternalControlPointShape(a)},fabric.ConstantPointShape=fabric.util.createClass(fabric.Rect,{type:"ConstantPointShape",fill:"#FF9600",stroke:"black",initialize:function(a){this.callSuper("initialize",a)},toObject:function(a){var b=$.extend(this.callSuper("toObject",a),{selectable:!0,hasControls:!1});return b}}),fabric.ConstantPointShape.fromObject=function(a){return new fabric.ConstantPointShape(a)},gpl.Anchor=fabric.util.createClass(fabric.Circle,{gplType:"anchor",lockMovementX:!0,lockMovementY:!0,anchorRadius:2.5,hoverRadius:5,hoverCursor:gpl.isEdit?'url("/img/pencil.cur") 0 0, pointer':"default",initialize:function(a){this.config=a,this.initConfig(),this.callSuper("initialize",this.config),this.x=this.config.x||0,this.y=this.config.y||0,this._anchorID=gpl.makeId(),gpl.anchors[this._anchorID]=this},initConfig:function(){this.anchorDefaults={fill:"black",stroke:"blue",borderColor:"black",gplType:"anchor",radius:this.anchorRadius,hasRotatingPoint:!1,hasBorders:!1,hasControls:!1,transparentCorners:!1,selectable:!1,isAnchor:!0},this.attachFn=gpl.emptyFn,this.detachFn=gpl.emptyFn,this.attachedLines={},this.attachedLineCount=0,this.config=$.extend(this.config,this.anchorDefaults),this.config.left=this.config._originalLeft=this.config.leftFn(this.anchorRadius),this.config.top=this.config._originalTop=this.config.topFn(this.anchorRadius)},hover:function(){var a=this.hoverRadius-this.anchorRadius;this._oFill||(this._oFill=this.fill,this._oStroke=this.stroke,this._oRadius=this.radius),this.hovered||(this.hoverLeft=this.left,this.hoverTop=this.top,this.hovered=!0,this.set({fill:"green",stroke:"green",radius:this.hoverRadius,left:this.left-a/2-1,top:this.top-a/2-1}))},clearHover:function(){this.hovered=!1,this.set({radius:this.anchorRadius,left:this._originalLeft,top:this._originalTop,fill:this._oFill,stroke:this._oStroke})},getLines:function(){var a=[];return gpl.forEach(this.attachedLines,function(b){a.push(b)}),a},redrawLine:function(){var a=this;gpl.forEach(a.attachedLines,function(b){b.redrawLine(a.gplId,{x:a.left+a.radius/2,y:a.top+a.radius/2})})},getConnectedBlock:function(){var a,b=this.attachedLines,c=Object.keys(b),d=b[c[0]];return d&&(a=d.endAnchor===this?d.startAnchor:d.endAnchor),a&&(a=gpl.blockManager.getBlock(a.gplId)),a},onAttach:function(a){this.attachFn=a},onDetach:function(a){this.detachFn=a},attach:function(a){this.attachedLines[a.gplId]=a,this.connected=!0,this.attachedLineCount++,this.attachFn(this,a)},detach:function(a){var b=this,c=function(a){var c=b.attachedLines[a.gplId];c.detach(),delete b.attachedLines[a.gplId],b.attachedLineCount--};a?c(a):gpl.forEach(b.attachedLines,function(a,b){c(a)}),b.connected=b.attachedLineCount>0,b.detachFn(b,a)},"delete":function(){gpl.blockManager.canvas.remove(this),delete gpl.anchors[this.gplId]}}),gpl.Block=fabric.util.createClass(fabric.Rect,{opacity:0,labelFontSize:10,labelMargin:5,minLabelWidth:80,valueAnchor:"output",invalidStroke:"red",shadow:{offsetX:1.5,offsetY:1.5},defaultPrecision:3.1,labelFontFamily:"Arial",hasOutput:!0,hasShutdownBlock:!0,hasRotatingPoint:!1,selectable:!1,hasControls:!1,initialized:!1,toolbarHeight:30,toolbarWidth:30,iconExtension:".png",iconSuffix:"Icon",iconOffsetLeft:0,iconOffsetTop:0,gplType:"block",rightAnchor:{anchorType:"Control Point"},getLeftAnchorDefaults:function(a,b){return{isVertical:!1,leftFn:function(a){return-1*a+b.left},topFn:function(c){return a-c/2+b.top-.5}}},getRightAnchorDefaults:function(a,b){return{isVertical:!1,topFn:function(c){return a-c/2+b.top-.5},leftFn:function(a){return b.width-a+b.left}}},_forEachAnchor:function(a){var b,c=this,d=c.inputAnchors||[];for(c.outputAnchor&&a(c.outputAnchor),c.inputAnchor&&a(c.inputAnchor),c.shutdownAnchor&&a(c.shutdownAnchor),b=0;b<d.length;b++)a(d[b])},_createAnchor:function(a){var b,c=this,d=$.extend(!0,{},a);return d.gplId=this.gplId,d.visible=!1,b=new gpl.Anchor(d),b.onAttach(function(a,d){c.handleAnchorAttach(b,d)}),b.onDetach(function(a,d){c.handleAnchorDetach(b,d)}),this.add(b),b},_createLeftAnchor:function(a,b){var c=this,d=$.extend(!0,this.getLeftAnchorDefaults(a,c),b);this.inputAnchors=this.inputAnchors||[],this.inputAnchors.push(this._createAnchor(d))},_createRightAnchor:function(a,b){var c=this,d=$.extend(!0,this.getRightAnchorDefaults(a,c),b);this.outputAnchor=this._createAnchor(d)},_createInputAnchor:function(a){var b=this;b.inputAnchors=b.inputAnchors||[],b.inputAnchors.push(b._createAnchor({inputAnchorIndex:b.inputAnchors.length,anchorType:"input",isVertical:!1,leftFn:function(a){return-1*a+b.left},topFn:function(c){return a-c/2+b.top-.5}}))},_createOutputAnchor:function(a){var b=this;b.outputAnchor=b._createAnchor({anchorType:"output",isVertical:!1,topFn:function(c){return a-c/2+b.top-.5},leftFn:function(a){return b.width-a+b.left}})},_createShutdownAnchor:function(a){var b=this;b.shutdownAnchor=b._createAnchor({anchorType:"Shutdown Point",isVertical:!0,topFn:function(c){return a-c/2+b.top-1.5},leftFn:function(a){return b.width/2-a/2+b.left-1}})},handleAnchorAttach:function(a,b){var c,d,e,f=this,g=b.getOtherAnchor(a),h=gpl.blockManager.getBlock(g.gplId);f.isNonPoint||(h&&(d=h.upi,f.upiList[d]=a,a.attachedUPI=d,gpl.blockManager.addUPIListener(d,a,b,function(){f.processValue.apply(f,arguments)}),e=f._pointRefs[a.anchorType],f.formatPoint(a,b,h)),e&&(h.upi?(c=gpl.pointData[h.upi],c=c&&c.Name):c=h.name,c&&gpl.rendered&&(f.setPointRef(a.anchorType,h.upi,c),gpl.fire("editedblock",f))))},handleAnchorDetach:function(a,b){this.setPointRef(a.anchorType,0,""),"toolbar"!==this.targetCanvas&&this.formatPoint(a,b),gpl.fire("editedblock",this)},_doFormatPoint:function(a,b){if(a.point){var c=gpl.formatPoint(a),d=this;c.err?(gpl.log(d.gplId,d.type,a.property,"error:",c.err),d.setInvalid&&d.setInvalid()):d._pointData=c,b&&b(c)}},formatPoint:function(a,b,c,d){if(gpl.rendered&&!window.destroyed){var e=b&&b.getOtherAnchor(),f=c||gpl.blockManager.getBlock(e&&e.gplId),g={point:d||this.getPointData(),oldPoint:this._origPointData,property:"output"===this.blockType?e.anchorType:a.anchorType,refPoint:f&&f.upi};this._doFormatPoint(g,function(a){d=a})}},formatPointFromData:function(a,b,c,d){if(gpl.rendered){var e=this,f={point:b||e.getPointData(),oldPoint:a||e._origPointData,property:c,refPoint:d};e._doFormatPoint(f,function(a){e.setPointData(a)})}},syncAnchorPoints:function(){var a,b,c=this,d=this.inputAnchors||[],e=c._origPointData,f=c._pointData,g=gpl.formatPoint,h=function(a,d){var h,i,j,k,l,m,n=a.getLines()||[],o=function(){var h;if(m)if(gpl.pointData[m]){try{h={point:f,oldPoint:e,property:"input"===d?a.anchorType:i.anchorType,refPoint:gpl.pointData[m]},b=g(h)}catch(k){gpl.log("error formatting point",k.message)}b.err?(gpl.log(c.gplId,c.type,h.property,"error:",b.err),gpl.isValid=!1,gpl.validationMessage.push('Error with block "'+c.pointType+"-'"+c.label+"'\": "+b.err+" (Property: "+a.anchorType+")"),c.setInvalid()):(c._origPointData=f,c._pointData=b,e=f,f=e)}else gpl.log("no upi data found for",m,j);else gpl.emptyFn()};if(n.length>0)for(k=0;k<n.length;k++)h=n[k],i=h.getOtherAnchor(a),i&&(l=i.gplId,j=gpl.blockManager.getBlock(l),m=j.upi,j&&"Constant"!==j.blockType&&("output"===d&&"ControlBlock"!==j.blockType||o()));else c.setPointRef(a.anchorType,0,""),o()};for(a=0;a<d.length;a++)h(d[a],"input");this.shutdownAnchor&&h(this.shutdownAnchor,"input"),this.outputAnchor&&h(this.outputAnchor,"output")},syncObjects:function(a,b){var c,d,e=a.left,f=a.top;for(b&&(e+=(b.left||0)*gpl.scaleValue,f+=(b.top||0)*gpl.scaleValue),this.left=e,this.top=f,d=0;d<this._shapes.length;d++)c=this._shapes[d],c.left=e+c._shapeOffsetLeft,c.top=f+c._shapeOffsetTop},lock:function(a){var b,c=this._shapes,d=c.length;for(b=0;b<d;b++)c[b].lockMovementX=a,c[b].lockMovementY=a},scale:function(a){var b,c=this._shapes,d=c.length;for(b=0;b<d;b++)c[b].scale(a);this.backgroundImage&&this.backgroundImage.scale(a),this.scaleValue=a},setOffset:function(a){var b,c,d=a.left,e=a.top,f={backgroundimage:!0,value:!0,anchor:!0,label:!0};for(c=0;c<this._shapes.length;c++)b=this._shapes[c],f[b.gplType]&&(b.left=d+b._originalLeft*gpl.scaleValue,b.top=e+b._originalTop*gpl.scaleValue)},resetOffset:function(){var a,b;for(a=0;a<this._shapes.length;a++)b=this._shapes[a],b._originalLeft=b.left,b._originalTop=b.top},calcOffsets:function(){var a,b;for(a=0;a<this._shapes.length;a++)b=this._shapes[a],b._originalLeft=b.left,b._originalTop=b.top,b.setCoords()},resetPosition:function(){var a=this,b=a._shapes[0];b.left=b.originalState.left,b.top=b.originalState.top,a.syncObjects(b),a.calcOffsets(),a.renderAll()},setPosition:function(){var a=this,b=a._shapes[0];b.originalState.left=b.left,b.originalState.top=b.top},nudge:function(a){this.left+=a.left,this.top+=a.top,this.syncObjects(this),this.redrawLines(),this.renderAll()},add:function(a,b){a.offsetLeft=a.left-this.left,a.offsetTop=a.top-this.top,this._shapes.push(a),(this.initialized||this.isNonPoint)&&gpl.blockManager.add(a,this.targetCanvas,b)},getLabel:function(){var a=gpl.getLabel(this.type,!0);this.setLabel(a)},setShowLabel:function(a){this.labelVisible=a,this.labelText.visible=a,this.labelText.opacity=a?1:0,this.renderAll()},setShowValue:function(a){this.presentValueVisible=a,this.valueText.visible=a,this.renderAll()},processValue:gpl.emptyFn,syncAnchorValue:function(a,b){a.anchorType;a.constantProp&&(this._pointData[a.constantProp].Value=b,gpl.fire("editedblock",this))},getReferencePoint:function(a){var b,c=this;c.upi&&(b=gpl.pointUpiMap[c.upi],b?c.setReferencePoint(b,a):(gpl.log("point reference not found, adding new reference"),gpl.addReferencePoint(c.upi,function(b){c.setReferencePoint(b,a)})))},setReferencePoint:function(a,b){this.pointType=a.pointType,this.valueType=a.valueType,this.setPlaceholderText(),b&&(this.label=a.Name.split("_").pop(),this.labelText.setText(this.label),gpl.blockManager.renderAll()),this.tooltip=this.pointName=a.Name},setReferenceType:function(a){this.referenceType=a,this.setVisibleShape(a)},setVisibleShape:function(a){var b=this.fabricShapes;gpl.forEach(b,function(b,c){c===a?(b.visible=!0,b.opacity=1,b.hidden=!1):(b.visible=!1,b.opacity=0,b.hidden=!0)}),this.renderAll()},updatePointRefs:function(a){var b,c=a["Point Refs"],d=c.length;for(b=0;b<d;b++)c[b].isReadOnly=!0;a._parentUpi=gpl.upi},setPointData:function(a,b){var c=a.newPoint||a,d=a.oldPoint||a;this._origPointData||(this._origPointData=$.extend(!0,{},d),this.updatePointRefs(this._origPointData)),this._pointData=$.extend(!0,{},c),gpl.pointData[this.upi]=this._pointData,this.updatePointRefs(this._pointData),b&&(this.processPointData(this._pointData),this.setIconName&&this.setIconName(),this.setLabel(this._pointData.name4)),this.pointName=this._pointData.Name,this.mapPointRefs()},getPointData:function(){return this._pointData},mapPointRefs:function(){var a,b=this._pointData["Point Refs"],c={};for(a=0;a<b.length;a++)c[b[a].PropertyName]=a;this._pointRefs=c},setPointRef:function(a,b,c){var d,e,f,g=this._pointData;g&&(d=this._pointData["Point Refs"],f=this._pointRefs[a],void 0!==f&&(e=d[f],e.Value=e.PointInst=b,"MonitorBlock"===this.type?e.DevInst=d[this._pointRefs["Device Point"]].DevInst:e.DevInst=gpl.deviceId,d[f].PointName=c))},processPointData:function(a){var b=this,c=ko.toJS(gpl.manager.bindings),d={iconType:function(){var c=a["Calculation Type"]||{},d=a["Reverse Action"]||{};c=c.Value,d=d.Value,b.setIconName?b.setIconName():c&&(b.config.iconType=c,b.iconPrefix&&(b.config.iconType=b.iconPrefix+c),b.icon=b.config.iconType+b.iconExtension),b.setIcon()}};gpl.forEach(d,function(a,b){a(b)}),a["Update Interval"].Value=60*c.deviceUpdateIntervalMinutes+c.deviceUpdateIntervalSeconds,a["Show Label"].Value=c.deviceShowLabel,a["Show Value"].Value=c.deviceShowValue,a.Controller.Value=c.deviceControllerName,a.Controller.eValue=c.deviceControllerValue,a._parentUpi=gpl.point._id},setInvalid:function(){var a=this._shapes[0];a._origStroke||(a._origStroke=a.stroke),a.stroke=this.invalidStroke,a.strokeWidth=2},setValid:function(){var a=this._shapes[0];a.stroke=a._origStroke||a.stroke,a.strokeWidth=1},validate:function(){var a,b,c=this,d=c.inputAnchors||[],e=d.length,f=!0,g=function(a){var b,d=!0,e=a.getLines();if(e.length>0)for(b=0;b<e.length&&d;b++)e[b].validate()||(d=!1);else a.required===!0&&(d=!1,gpl.validationMessage.push("No "+a.anchorType+" connection on "+c.type+" block"),gpl.log("no lines associated",a.anchorType,"on",c.type));f=d};for(c.shutdownAnchor&&g(c.shutdownAnchor),c.outputAnchor&&f&&g(c.outputAnchor),a=0;a<e&&f;a++)b=d[a],g(b);return f?c.setValid():c.setInvalid(),f},"delete":function(a){var b,c=this.inputAnchors||[],d=gpl.canvases[this.targetCanvas||"main"],e=c.length,f=function(a){var b,c;if(a){for(b=a.getLines(),c=0;c<b.length;c++)b[c]["delete"]();a.detach(),a["delete"]()}};if(!a){for(b=0;b<e;b++)f(c[b]);f(this.shutdownAnchor),f(this.outputAnchor)}for(e=this._shapes.length,b=0;b<e;b++)d.remove(this._shapes[b]);this.renderAll()},destroy:function(){this["delete"](),gpl.destroyObject(this)},redrawLines:function(){this._forEachAnchor(function(a){a.redrawLine()})},getPointInfo:function(){var a,b=this;b._pointRefs={},b.upi&&(a=gpl.pointData[b.upi],a?b.setPointData(a):(gpl.log(b.name||b.config.label||b.config.name,"adding reference point",b.upi),gpl.addReferencePoint(b.upi,function(a,c){b.setPointData(c)})))},getPlaceholderText:function(){var a,b=this.precision,c=Math.floor(b),d=b%1,e="";if("enum"===this.valueType)e="###";else{for(a=0;a<c;a++)e+="#";for(e+=".",a=0;a<d;a++)e+="#"}return e},setPlaceholderText:function(){var a=this.getPlaceholderText();this.valueText&&(this.valueText.setText(a),this.renderAll())},renderAll:function(){gpl.blockManager.renderAll()},initialize:function(a){this.config=a,this.initConfig(),this.getPointInfo(),this.callSuper("initialize",this.config),this.setShadow(this.shadow),this.x=this.config.x||0,this.y=this.config.y||0,this.initShapes(),gpl.blockManager.registerBlock(this,this.valueText,this.targetCanvas),this.upi&&gpl.pointData[this.upi]&&(this._pointData=gpl.pointData[this.upi]),1!==this.scaleValue&&this.scale(this.scaleValue),this.initialized=!0},initConfig:function(){this.targetCanvas=this.config.targetCanvas||"main",this.gplId=gpl.makeId(),this.precision=this.defaultPrecision,this.upi=+this.config.upi,this.shapes=this.shapes||{},this._shapes=[],this._offsetLeft=0,this._offsetTop=0,this.scaleValue=this.config.scaleValue||1,this.shapeDefaults={hasRotatingPoint:!1,selectable:!!gpl.isEdit,hasControls:!1},this.shapeDefaults.hoverCursor="default",this.anchorDefaults={fill:"black",stroke:"blue",radius:this.anchorRadius,hasRotatingPoint:!1,borderColor:"black",transparentCorners:!1,selectable:!1,isAnchor:!0},this.upiList={},this.upiValues={}},initShapes:function(){this.initFabricShapes(),this.initAnchors(),this.initLabel(),this.initValue(),this.initIcon(),this.postInit()},postInit:function(){var a,b=this._shapes;for(this.config.inactive||this.showShapes(),a=0;a<b.length;a++)b[a]._shapeOffsetLeft=b[a].left-this.left,b[a]._shapeOffsetTop=b[a].top-this.top},initAnchors:function(){this.initInputAnchors(),this.initOutputAnchor(),this.initShutdownAnchor()},initIcon:function(){var a=this;a._icons={},a.noIcon||(a.getIcon?a.icon=a.getIcon():a.icon=a.config.iconType+a.iconExtension,a.setIcon())},initLabel:function(){var a={top:this.top-this.labelFontSize-this.labelMargin,left:this.left+this.width/2,textAlign:"center",originX:"center",fontSize:parseInt(this.labelFontSize,10),fontFamily:this.labelFontFamily,gplType:"label",readOnly:!0,opacity:1,selectable:!1,gplId:this.gplId};0===this.labelVisible?this.labelVisible=gpl.json.Show_Label:void 0===this.labelVisible&&(this.labelVisible=!1),this.labelVisible===!1&&(a.visible=!1,a._wasHidden=!0),this.label=this.label||(this.config.inactive?"":gpl.getLabel(this.type)),this.config.inactive&&(a.visible=!1),this.labelText=new fabric.Text(this.label||"",a),this.labelText.width<this.minLabelWidth&&this.labelText.set("width",this.minLabelWidth),this.labelText._originalTop=a.top,this.labelText._originalLeft=this.labelText.left,this.add(this.labelText)},initValue:function(){var a={textAlign:"left",fontSize:parseInt(this.labelFontSize,10),fontFamily:this.labelFontFamily,gplType:"value",selectable:!1,readOnly:!0,top:this.top-this.labelFontSize+this.height/2-this.labelMargin/2,originX:"left",gplId:this.gplId};"output"===this.valueAnchor?a.left=this.left+this.width+this.labelMargin:(a.left=this.left-this.labelMargin,a.textAlign="right",a.originX="right"),0===this.presentValueVisible?this.presentValueVisible=gpl.json.Show_Value:void 0===this.presentValueVisible&&(this.presentValueVisible=!1),this.presentValueVisible!==!1&&this.config.showValue!==!1||(a.visible=!1),this.valueText=new fabric.Text(this.getPlaceholderText(),a),this.valueText._originalTop=a.top,this.valueText._originalLeft=this.valueText.left,this.add(this.valueText)},initInputAnchors:function(){var a,b,c=10,d=this.numInputs||this.leftAnchors&&this.leftAnchors.length||0,e=[],f=c;if(1===d?f=b=parseInt(this.height/2,10):b=parseInt((this.height-2*c)/(d-1),10),this.leftAnchors)d=this.leftAnchors.length;else{for(a=0;a<d;a++)e.push({anchorType:"Input Point "+(a+1),takesConstant:!0});this.leftAnchors=e}for(a=0;a<d;a++)this.leftAnchors?this._createLeftAnchor(f,this.leftAnchors[a]):this._createInputAnchor(f),f+=b},initOutputAnchor:function(){var a=this.height/2;this.hasOutput&&(this.rightAnchor?this._createRightAnchor(a,this.rightAnchor):this._createOutputAnchor(a))},initShutdownAnchor:function(){var a=this.height;this.hasShutdownBlock===!0&&this._createShutdownAnchor(a)},initFabricShapes:function(){var a,b,c,d,e,f,g=this,h=function(a){return function(){gpl.blockManager.highlight(a)}},i=function(){g.removeShapes()};g.fabricShapes={};for(a in g.shapes)g.shapes.hasOwnProperty(a)&&(b=g.shapes[a],f=$.extend(!0,{},g.shapeDefaults),e=$.extend(!0,f,b.cfg||{}),e.shadow=g.shadow,d=b.cls,e.top=g.top,e.left=g.left,e.gplId=g.gplId,e.gplType="block",e._origFill=e.fill,(e.hidden===!0||g.config.inactive&&g.noIcon!==!0)&&(e.opacity=0,e.visible=!1),gpl.isEdit||(e.selectable=!1,e.draggable=!1,e.hasBorders=!1,e.lockMovementX=!0,e.lockMovementY=!0),c=new d(e),g.add(c),g.fabricShapes[a]=c,c.on("selected",h(c)),c.on("removed",i))},setActive:function(){this.labelVisible=gpl.point["Show Label"].Value,this.bypassSave=!1,this.showShapes(),this.config.inactive=!1},convertIconNames:function(){var a,b=this,c=b.icon.split(".")[0];b.iconMatrix&&(a=b.iconMatrix[c],a&&(b.icon=a+b.iconExtension))},setIcon:function(a){var b=this;a&&(b.icon=a),b.icon?(b.convertIconNames(),void 0===b._icons[b.icon]?fabric.Image.fromURL(gpl.iconPath+b.icon,function(a){var c=a.width,d=a.height,e=b.left+(b.width-c)/2+b.iconOffsetLeft,f=b.top+(b.height-d)/2+b.iconOffsetTop;a.set({left:e,top:f,evented:!1,selectable:!!gpl.isEdit}),b.iconScale&&a.scale(b.iconScale),a._originalLeft=e,a._originalTop=f,a._shapeOffsetLeft=a.left-b.left,a._shapeOffsetTop=a.top-b.top,a.gplId=b.gplId,a.gplType="backgroundimage",b.backgroundImage&&b.backgroundImage.setVisible(!1),b.backgroundImage=a,b._icons[b.icon]=a,b.add(a,!0),b.renderAll()}):(b.backgroundImage&&b.backgroundImage.setVisible(!1),b.backgroundImage=b._icons[b.icon],b.backgroundImage.setVisible(!0),b.renderAll())):gpl.log("no icon for",b.config.iconType)},setLabel:function(a){a&&(this.label=a),this.labelText.setText(a),this.renderAll()},showShapes:function(){var a,b;for(a=0;a<this._shapes.length;a++)b=this._shapes[a],b.readOnly||(b.selectable=!0),b._wasHidden!==!0?(b.opacity=1,b.visible=!0):(b.opacity=0,b.visible=!1),b._originalTop=b.top,b._originalLeft=b.left,b.setCoords();this.config.inactive&&this.getLabel()},removeShapes:function(){var a,b=this._shapes,c=b.length;for(a=0;a<c;a++)gpl.blockManager.remove(b[a])}}),gpl.Block.fromObject=function(a){return new gpl.Block(a)},gpl.blocks.MonitorBlock=fabric.util.createClass(gpl.Block,{height:20,width:20,toolbarHeight:30,toolbarOffsetTop:9,toolbarOffsetLeft:5,proxyOffsetLeft:-5,hasShutdownBlock:!1,noIcon:!0,numInputs:0,isNonPoint:!0,hasReferenceType:!0,type:"MonitorBlock",pointType:"Monitor Point",shapes:{External:{cls:fabric.ExternalMonitorPointShape,cfg:{height:20,width:20}},Internal:{cls:fabric.InternalMonitorPointShape,
cfg:{height:20,width:20}}},initialize:function(a){this.callSuper("initialize",a),this.getReferencePoint()},syncAnchorPoints:gpl.emptyFn,postInit:function(){this.callSuper("postInit"),1===this.referenceType?this.referenceType="Internal":this.referenceType="External",this.setReferenceType(this.referenceType)}}),gpl.blocks.ConstantBlock=fabric.util.createClass(gpl.Block,{height:20,width:20,toolbarHeight:30,toolbarOffsetTop:9,toolbarOffsetLeft:5,proxyOffsetLeft:-5,hasShutdownBlock:!1,noIcon:!0,numInputs:0,isNonPoint:!0,type:"ConstantBlock",pointType:"Constant",shapes:{ConstantPointShape:{cls:fabric.ConstantPointShape,cfg:{height:20,width:20}}},syncAnchorPoints:gpl.emptyFn,postInit:function(){void 0!==this.value&&this.valueText.setText(gpl.formatValue(this,this.value.toString())),this.callSuper("postInit")},setValue:function(a){var b,c,d,e,f;if(this.value!==a){for(this.value=a,this.valueText.setText(gpl.formatValue(this,a)),b=this.outputAnchor.getLines(),f=b.length,e=0;e<f;e++)c=b[e].getOtherAnchor(this.outputAnchor),d=gpl.blockManager.getBlock(c.gplId),d.syncAnchorValue(c,a);this.renderAll(),gpl.manager.bindings.hasEdits(!0)}}}),gpl.blocks.ControlBlock=fabric.util.createClass(gpl.Block,{height:20,width:20,toolbarHeight:30,toolbarOffsetTop:9,toolbarOffsetLeft:5,proxyOffsetLeft:-5,hasShutdownBlock:!1,valueAnchor:"input",noIcon:!0,isNonPoint:!0,hasReferenceType:!0,numInputs:1,hasOutput:!1,type:"ControlBlock",pointType:"Control Point",shapes:{External:{cls:fabric.ExternalControlPointShape,cfg:{height:20,width:20}},Internal:{cls:fabric.InternalControlPointShape,cfg:{height:20,width:20}}},syncAnchorPoints:gpl.emptyFn,initialize:function(a){this.callSuper("initialize",a),this.getReferencePoint()},postInit:function(){this.callSuper("postInit"),1===this.referenceType?this.referenceType="Internal":this.referenceType="External",this.setReferenceType(this.referenceType)}}),gpl.blocks.SPA=fabric.util.createClass(gpl.Block,{width:30,height:40,type:"SPA",pointType:"Setpoint Adjust",valueType:"float",_icon:"SPA.png",icon:"SPA.png",iconOffsetLeft:0,iconOffsetTop:0,leftAnchors:[{anchorType:"Monitor Point",required:!0}],shapes:{Rect:{cls:fabric.Rect,cfg:{fill:"#149e93",stroke:"black",width:30,height:40}}},initialize:function(a){this.callSuper("initialize",a)},postInit:function(){this.setIconName(),this.callSuper("postInit")},setIconName:function(){var a,b,c=this._pointData;c&&(a=c["Reverse Action"].Value,b=this._icon.split("."),b=a?b[0]+"Rev."+b[1]:b.join("."),this.icon=b,this.setIcon())}}),gpl.blocks.Delay=fabric.util.createClass(gpl.Block,{width:30,height:40,type:"Delay",pointType:"Delay",valueType:"enum",iconScale:.9,iconOffsetLeft:2,leftAnchors:[{anchorType:"Monitor Point",required:!0,inputType:"enum"},{anchorType:"Trigger Point",required:!0,inputType:"enum",takesConstant:!0,constantProp:"Trigger Constant"}],shapes:{Rect:{cls:fabric.Rect,cfg:{fill:"#9676c6",stroke:"black",width:30,height:40}}},initialize:function(a){this.callSuper("initialize",a)}}),gpl.blocks.BinarySetPoint=fabric.util.createClass(gpl.Block,{width:30,height:40,icons:{"Single Setpoint":"BINMSingleSP","Dual Setpoint":"BINMDualSP"},type:"BinarySetPoint",pointType:"Binary Selector",valueType:"enum",leftAnchors:[{anchorType:"Monitor Point",required:!0},{anchorType:"Setpoint Input",required:!0,takesConstant:!0,constantProp:"Setpoint Value"}],shapes:{Rect:{cls:fabric.Rect,cfg:{fill:"#fffcb8",stroke:"black",width:30,height:40}}},initialize:function(a){this.callSuper("initialize",a)},setIconName:function(){var a,b,c=this._pointData;c&&(a=c["Calculation Type"].Value,b=this.icons[a],this.icon=b+this.iconExtension,this.setIcon())}}),gpl.blocks.AnalogSetPoint=fabric.util.createClass(gpl.Block,{width:30,height:40,icons:{"Single Setpoint":"AnalogSingleSetPoint","Dual Setpoint":"AnalogDualSetPoint"},type:"AnalogSetPoint",pointType:"Analog Selector",valueType:"float",leftAnchors:[{anchorType:"Monitor Point",required:!0},{anchorType:"Setpoint Input",required:!0,takesConstant:!0,constantProp:"Setpoint Value"}],shapes:{Rect:{cls:fabric.Rect,cfg:{fill:"#fffcb8",stroke:"black",width:30,height:40}}},initialize:function(a){this.callSuper("initialize",a)},setIconName:function(){var a,b,c=this._pointData;c&&(a=c["Calculation Type"].Value,b=this.icons[a],this.icon=b+this.iconExtension,this.setIcon())}}),gpl.blocks.PI=fabric.util.createClass(gpl.Block,{width:30,height:40,type:"PI",pointType:"Proportional",valueType:"float",_icon:"PI",icon:"PI.png",iconOffsetTop:0,iconOffsetLeft:1,leftAnchors:[{anchorType:"Monitor Point",required:!0},{anchorType:"Setpoint Input",required:!0,takesConstant:!0,constantProp:"Setpoint Value"}],shapes:{Rect:{cls:fabric.Rect,cfg:{fill:"#2f2fb4",stroke:"black",width:30,height:40}}},initialize:function(a){"ReverseActingPI"===a.iconType&&(a.iconType="PI"),this.callSuper("initialize",a)},setIconName:function(){var a=this._pointData,b=a["Reverse Action"].Value,c=a["Calculation Type"].Value;c+=b?"Rev"+this.iconExtension:this.iconExtension,this.icon=c,this.setIcon()}}),gpl.blocks.Average=fabric.util.createClass(gpl.Block,{width:30,height:100,toolbarHeight:30,toolbarOffsetTop:-30,numInputs:5,type:"Average",pointType:"Average",valueType:"float",shapes:{Rect:{cls:fabric.Rect,cfg:{fill:"#7FD8C8",stroke:"black",width:30,height:100}}},initialize:function(a){this.callSuper("initialize",a)}}),gpl.blocks.Economizer=fabric.util.createClass(gpl.Block,{width:30,height:60,toolbarHeight:30,toolbarOffsetTop:-10,type:"Economizer",pointType:"Economizer",valueType:"float",leftAnchors:[{anchorType:"Return Air Point",required:!0},{anchorType:"Mixed Air Point",required:!0},{anchorType:"Outside Air Point",required:!0}],shapes:{Rect:{cls:fabric.Rect,cfg:{fill:"#0075a2",stroke:"black",width:30,height:60}}},initialize:function(a){this.callSuper("initialize",a)}}),gpl.blocks.Enthalpy=fabric.util.createClass(gpl.Block,{width:30,height:40,type:"Enthalpy",pointType:"Enthalpy",valueType:"float",leftAnchors:[{anchorType:"Humidity Point",required:!0},{anchorType:"Dry Bulb Point",required:!0}],shapes:{Rect:{cls:fabric.Rect,cfg:{fill:"#87A68A",stroke:"black",width:30,height:40}}},initialize:function(a){this.callSuper("initialize",a)}}),gpl.blocks.SelectValue=fabric.util.createClass(gpl.Block,{width:30,height:100,toolbarHeight:30,toolbarOffsetTop:-30,numInputs:5,type:"SelectValue",pointType:"Select Value",valueType:"float",shapes:{Rect:{cls:fabric.Rect,cfg:{fill:"#f3e35f",stroke:"black",width:30,height:100}}},initialize:function(a){this.callSuper("initialize",a)}}),gpl.blocks.Logic=fabric.util.createClass(gpl.Block,{width:30,height:100,toolbarHeight:30,toolbarOffsetTop:-30,numInputs:5,type:"Logic",pointType:"Logic",valueType:"enum",shapes:{Rect:{cls:fabric.Rect,cfg:{fill:"#bbec08",stroke:"black",width:30,height:100}}},initialize:function(a){this.callSuper("initialize",a)}}),gpl.blocks.Math=fabric.util.createClass(gpl.Block,{width:30,height:40,type:"Math",pointType:"Math",valueType:"float",leftAnchors:[{anchorType:"Input Point 1",required:!0,takesConstant:!0,constantProp:"Input 1 Constant"},{anchorType:"Input Point 2",required:!0,takesConstant:!0,constantProp:"Input 2 Constant"}],shapes:{Rect:{cls:fabric.Rect,cfg:{fill:"#ded5bc",stroke:"black",width:30,height:40}}},initialize:function(a){this.callSuper("initialize",a)}}),gpl.blocks.MUX=fabric.util.createClass(gpl.Block,{width:30,height:60,toolbarHeight:60,toolbarOffsetTop:5,type:"MUX",pointType:"Multiplexer",valueType:"float",icon:"MUX_0.png",iconOffsetLeft:0,iconOffsetTop:2,leftAnchors:[{anchorType:"Input Point 1",required:!0,takesConstant:!0,constantProp:"Input 1 Constant"},{anchorType:"Input Point 2",required:!0,takesConstant:!0,constantProp:"Input 2 Constant"},{anchorType:"Select Input",required:!0,inputType:"enum"}],shapes:{Rect:{cls:fabric.Rect,cfg:{fill:"#d1800b",stroke:"black",width:30,height:60}}},initialize:function(a){this.callSuper("initialize",a)},processValue:function(a,b,c,d){var e=d.eValue;b===this.inputAnchors[2]&&this.setIcon("MUX_"+e+".png")}}),gpl.blocks.DigLogic=fabric.util.createClass(gpl.Block,{width:30,height:40,type:"DigLogic",pointType:"Digital Logic",valueType:"enum",iconPrefix:"DigLogic",iconScale:.8,iconOffsetLeft:3,iconOffsetTop:3,leftAnchors:[{anchorType:"Input Point 1",required:!0,inputType:"enum"},{anchorType:"Input Point 2",required:!0,inputType:"enum"}],shapes:{Rect:{cls:fabric.Rect,cfg:{fill:"#768557",stroke:"black",width:30,height:40}}},initialize:function(a){this.callSuper("initialize",a)}}),gpl.blocks.Ramp=fabric.util.createClass(gpl.Block,{width:30,height:40,type:"Ramp",pointType:"Ramp",valueType:"float",iconOffsetTop:0,iconOffsetLeft:1,leftAnchors:[{anchorType:"Monitor Point",required:!0}],shapes:{Rect:{cls:fabric.Rect,cfg:{fill:"#a47b42",stroke:"black",width:30,height:40}}},initialize:function(a){this.callSuper("initialize",a)}}),gpl.blocks.AlarmStatus=fabric.util.createClass(gpl.Block,{width:30,height:40,numInputs:1,toolbarHeight:30,type:"AlarmStatus",pointType:"Alarm Status",valueType:"enum",iconPrefix:"AlarmStatus_",iconScale:.8,iconOffsetLeft:3,iconOffsetTop:3,leftAnchors:[{anchorType:"Monitor Point",required:!0}],shapes:{Rect:{cls:fabric.Rect,cfg:{fill:"#B81616",stroke:"black",width:30,height:40}}},initialize:function(a){this.setAlarmIcon("1111"),this.callSuper("initialize",a)},postInit:function(){this.setIconName(),this.callSuper("postInit")},setAlarmIcon:function(a){this.icon=this.iconPrefix+a+this.iconExtension},setIconName:function(){var a,b=this.getPointData(),c={inAlarm:"1",inFault:"1",inOutOfService:"1",inOverride:"1"},d="";b?(a={inAlarm:b["In Alarm"].Value,inFault:b["In Fault"].Value,inOutOfService:b["In Out of Service"].Value,inOverride:b["In Override"].Value},gpl.forEach(a,function(a,b){d+=a?c[b]:"0"})):d="1111",this.setAlarmIcon(d),this.setIcon()}}),gpl.blocks.Comparator=fabric.util.createClass(gpl.Block,{width:30,height:40,type:"Comparator",pointType:"Comparator",valueType:"enum",iconMatrix:{"<":"LT",">":"GT","<=":"LTEqual",">=":"GTEqual","=":"Equal"},leftAnchors:[{anchorType:"Input Point 1",required:!0},{anchorType:"Input Point 2",required:!0,takesConstant:!0,constantProp:"Input 2 Constant"}],shapes:{Rect:{cls:fabric.Rect,cfg:{fill:"#DED5BC",stroke:"black",width:30,height:40}}},initialize:function(a){this.callSuper("initialize",a)}}),gpl.blocks.Totalizer=fabric.util.createClass(gpl.Block,{width:30,height:40,type:"Totalizer",pointType:"Totalizer",valueType:"float",iconOffsetTop:2,iconOffsetLeft:1,iconScale:.9,leftAnchors:[{anchorType:"Monitor Point",required:!0}],shapes:{Rect:{cls:fabric.Rect,cfg:{fill:"#d4fbeb",stroke:"black",width:30,height:40}}},initialize:function(a){this.callSuper("initialize",a)}}),fabric.Textbox=gpl.blocks.TextBlock=fabric.util.createClass(fabric.Text,fabric.Observable,{isNonPoint:!0,defaultWeight:"normal",defaultFill:"#000000",borderColor:"#000000",cornerColor:"#000000",defaultFontSize:12,minWidth:30,cornerSize:6,hasRotatingPoint:!1,type:"TextBlock",gplType:"text",initialize:function(a){this.convertConfig(a),this.callSuper("initialize",this.text,this.config),this.set("lockUniScaling",!1),this.set("lockScalingY",!0),this.setControlsVisibility({tl:!1,tr:!1,br:!1,bl:!1,ml:!0,mt:!1,mr:!0,mb:!1,mtr:!1}),this.gplId=gpl.makeId(),gpl.texts[this.gplId]=this,gpl.blockManager.registerBlock(this)},convertConfig:function(a){var b=a,c=b.font,d={1:"right",0:"left"};this.config=a,c?(b.fontWeight=c.bold?"bold":"normal",b.fill="#"+gpl.convertColor(c.color||0),b.fontSize=parseInt(c.size,10)||this.defaultFontSize,b.textDecoration=c.underline?"underline":"",b.fontFamily=c.name||"Arial"):a._v2!==!0&&(b.fontWeight=this.defaultWeight,b.fill=this.defaultFill,b.fontSize=this.defaultFontSize),b.originX="left",b.originY="top",b.Font&&"true"===b.Font.Underline&&(b.textDecoration="underline"),b._v2||(this.config.left+=10,this.config.top+=5),this.config.selectable=!!gpl.isEdit,this.config.width=parseInt(this.config.width,10)||this.minWidth,this.config.height=null,this.config.textAlign=d[b.alignment]||"center",$.extend(this,this.config),this.text=this.config.label||"ABC"},setActive:function(){this.inactive=!1,this.setCoords()},"delete":function(){gpl.manager.canvas.remove(this),delete gpl.texts[this.gplId]},_wrapText:function(a,b){var c,d=b.split(this._reNewline),e=[];for(c=0;c<d.length;c++)e=e.concat(this._wrapLine(a,d[c]+"\n"));return e},_wrapLine:function(a,b){var c,d=this.width,e=b.split(" "),f=[],g="";if(a.measureText(b).width<d)f.push(b);else for(;e.length>0;){if(d<=a.measureText("W").width)return b.split("");for(;Math.ceil(a.measureText(e[0]).width)>=d;)c=e[0],e[0]=c.slice(0,-1),e.length>1?e[1]=c.slice(-1)+e[1]:e.push(c.slice(-1));Math.ceil(a.measureText(g+e[0]).width)<d?g+=e.shift()+" ":(f.push(g),g=""),0===e.length&&f.push(g.substring(0,g.length-1))}return f},_getTextLines:function(a){var b;return a=a||this.ctx,a.save(),this._setTextStyles(a),b=this._wrapText(a,this.text),a.restore(),b},_renderViaNative:function(a){var b;this._setTextStyles(a),b=this._wrapText(a,this.text),this.height=this._getTextHeight(a,b),this.clipTo&&fabric.util.clipContext(this,a),this._renderTextBackground(a,b),this._translateForTextAlign(a),this._renderText(a,b),"left"!==this.textAlign&&"justify"!==this.textAlign&&a.restore(),this._renderTextDecoration(a,b),this.clipTo&&a.restore(),this._setBoundaries(a,b),this._totalLineHeight=0}}),fabric.Textbox.fromObject=function(a){return new fabric.Textbox(a.text,fabric.util.object.clone(a))},fabric.Textbox.instances=[],fabric.Textbox.__setObjectScaleOverridden=fabric.Canvas.prototype._setObjectScale,fabric.Canvas.prototype._setObjectScale=function(a,b,c,d,e,f){var g,h=b.target,i=fabric.Textbox.__setObjectScaleOverridden;"TextBlock"===h.type?(g=h.width*(a.x/b.scaleX/(h.width+h.strokeWidth)),g>=h.minWidth&&h.set("width",g)):i.call(fabric.Canvas.prototype,a,b,c,d,e,f)},fabric.util.object.extend(fabric.Textbox.prototype,{getDownCursorOffset:function(a,b){return this.callSuper("getDownCursorOffset",a,b)-1},getUpCursorOffset:function(a,b){return this.callSuper("getUpCursorOffset",a,b)-1}}),gpl.ActionButton=function(a){var b,c=[{text:"No Action (useless)"},{text:"History Log Plot – No longer supported"},{text:"History Log Report"},{text:"History Log Export"},{text:"Totalizer Plot"},{text:"Totalizer Report"},{text:"Totalizer Export"},{text:"MultiState Value Command",pointType:"MultiState Value"},{text:"Program Start"},{text:"Analog Output Command",pointType:"Analog Output"},{text:"Analog Value Command",pointType:"Analog Value"},{text:"Binary Output Command",pointType:"Binary Output"},{text:"Binary Value Command",pointType:"Binary Value"},{text:"Report Display"},{text:"Verification Report"},{text:"Browse Verify Reports"},{text:"Data Report"}],d={"Command Type":7,upi:"",Value:"",Controller:gpl.workspaceManager.user().controllerId,Relinquish:0,Priority:"",Wait:0,OvrTime:0},e={},f=a.left,g=a.top,h=(a.Height,a.Width,a.type||(void 0!==a.actionCode?"control":"link")),i=function(){b=$('<button data-actionButtonID="'+e.id+'" class="hideLoading btn btn-sm btn-default actionBtn">'+e.text+"</button>").data({origLeft:f,origTop:g}).css({position:"absolute",left:f,top:g}),e.$el=b},j=function(){var a=$.extend(!0,{},d);return a.upi=e.upi,a.Value=e.parameter,a.newValue.Value=e.parameter,a},k=function(a){e.pointData=a,e.pointName=e.pointData.Name,e.pointType=a["Point Type"].Value,d.logData={user:gpl.workspaceManager.user(),point:{_id:a._id,Security:a.Security,Name:a.Name,name1:a.name1,name2:a.name2,name3:a.name3,name4:a.name4,"Point Type":{eValue:a["Point Type"].eValue}},newValue:{Value:""}},m("upi")},l=function(a){void 0!==a&&$.ajax({url:"/api/points/"+a}).done(function(a){k(a)})},m=function(a){var b=e.code&&e.code.pointType;b&&b!==e.pointData["Point Type"]},n=function(){console.log("Send Command",j()),gpl.socket.emit("fieldCommand",JSON.stringify(j()))},o=function(){e.pointType.match("Analog")?($("#actionButtonValue").attr({min:e.pointData["Minimum Value"].Value,max:e.pointData["Maximum Value"].Value}),gpl.$editActionButtonValueModal.modal("show")):n()},p=function(a){e.parameter=a,n()},q=function(a,b){var c,d,f=e.pointType;c=gpl.workspaceManager.config.Utility.pointTypes.getUIEndpoint(f,e.upi),d=c.review.url,a&&(d+=a),gpl.openWindow(d,e.pointData.Name,f,"",e.upi,{callback:b})},r=function(){"control"===e.type?o():e.pointData&&"No Point Found"!==e.pointData.message&&("report"===e.type?gpl.$actionButtonReportParameterModal.modal("show"):q())},s=function(a){var b,c,d,e,f,g=a.reportType,h=a.duration,i=a.fromDate,j=a.fromTime,k=a.toDate,l=a.toTime;"predefined"===g?d={duration:h}:(e=i,f=k,b=j.split(":"),c=b[1],b=b[0],e.setHours(b),e.setMinutes(c),b=l.split(":"),c=b[1],b=b[0],f.setHours(b),f.setMinutes(c),d={startDate:Math.floor(e.getTime()/1e3),endDate:Math.floor(f.getTime()/1e3)}),q("?pause",function(){this.applyBindings(d)}),gpl.$actionButtonReportParameterModal.modal("hide")},t=function(a){e.code=c[a],m("command")},u=function(a){e.parameter=a},v=function(){return e.pointData},w=function(){var a=gpl.isEdit?gpl.editModeOffset:0,b={left:e.left-a,top:e.top,caption:e.text,type:e.type,actionCode:e.code,actionParm:e.parameter,actionPoint:e.upi,actionPriority:16};return b},x=function(a){e.type=a.type||e.type,e.code=a.actionCode||e.code,a.caption&&a.caption!==e.text&&(e.text=a.caption,b&&b.html(e.text)),e.parameter=void 0!==a.actionParm?a.actionParm:e.parameter,a.actionPoint&&e.upi!==a.actionPoint&&l(a.actionPoint),e.pointName=a.pointName,e.upi=a.actionPoint||e.upi,d.Priority=a.actionPriority||d.Priority},y=function(){gpl.isEdit&&e.$el.draggable({cancel:!1,stop:function(a,b){gpl.log("updating position to",b.position.left,",",b.position.top),e.left=b.position.left,e.top=b.position.top}})},z=function(){gpl.destroyObject(e)},A=function(a){e.upi=a,l(a)};return e.id=gpl.makeId(),e.text=a.caption||"Action Button",x(a),i(),e=$.extend(e,{left:f,top:g,type:h,setUPI:A,setCommand:t,setParameter:u,getPointData:v,getExportData:w,updateConfig:x,postInit:y,destroy:z,click:r,sendCommand:o,sendValue:p,openReport:s})},gpl.SchematicLine=function(a,b,c,d,e){var f,g,h,i,j,k=this,l="green",m=d.canvas,n=[],o=[{x:a,y:b}],p=gpl.blockManager.getBlock(c.gplId),q=c,r=!e,s=a,t=b,u={stroke:"#000000",selectable:!1},v={stroke:"grey"},w=function(a){var b;for(b=0;b<n.length;b++)a(n[b]);a(h),a(i)},x=function(a){var b,c=m.getObjects(),d=c.length;for(b=0;b<d;b++)a(c[b])},y=function(){x(function(a){"anchor"!==a.gplType&&(a._prevSelectable=a.selectable,a.selectable=!1)})},z=function(){x(function(a){"anchor"!==a.gplType&&(a.selectable=a._prevSelectable)})};p.lock(!0),k.setColor=function(a){w(function(b){b.setStroke(a||"#000000")})},k.getCoords=function(){return o},k.completeLine=function(a){var b,c;a&&(c={x:a.left+a.width/2,y:a.top+a.height/2},k.handleMouseMove(c)),a.clearHover(),k.addSegment(h,!0),h.off(),m.remove(h),h=new fabric.Line([i.x1,i.y1,i.x2,i.y2],$.extend({},u)),k.addSegment(h,!0),i.off(),m.remove(i),a.set("fill",a._oFill),a.set("stroke",a._oStroke),k.detachEvents(),b=$.extend(!0,[],o),d.shapes.push(new gpl.ConnectionLine($.extend(!0,[],b),m,(!0))),k.clearSegments(),gpl.manager.renderAll()},k.clearSegments=function(){for(;n.length>0;)k.removeSegment(!0);p.lock(!1),gpl.manager.renderAll()},k["delete"]=function(){h.off(),i.off(),m.remove(h),m.remove(i),k.detachEvents(),k.clearSegments(),gpl.manager.renderAll()},k.syncLines=function(){var a,b=o.slice(-1)[0];a=r?{x:i.x1,y:h.y1}:{x:h.x1,y:i.y2},h.set({x1:b.x,y1:b.y,x2:a.x,y2:a.y}),i.set({x1:a.x,y1:a.y}),gpl.manager.renderAll()},k.removeSegment=function(a){var b;return n.length>0&&(o.pop(),b=n.pop(),b.off(),m.remove(b)),r=!r,a||k.syncLines(),b},k.addSegment=function(a,b){n.push(a),o.push({x:a.x2,y:a.y2}),m.add(a),r=!r,b||k.syncLines()},k.swapDirections=function(){f?k.addSegment(f):f=k.removeSegment()},k.handleMouseMove=function(a){var b=a.e?m.getPointer(a.e):a,c=b.x,e=b.y,f=gpl.manager.getObject({left:c,top:e,gplType:"anchor"});d.isEditingLine&&(f?(k.valid=gpl.validate.connection(q,f,!0),k.valid&&f!==q&&(f.hover(),k.setColor(l),g=f)):g&&(g.clearHover(),k.setColor()),r?(h.set({x2:c}),i.set({x1:c,y2:e,x2:c,y1:t})):(h.set({y2:e}),i.set({x1:s,y2:e,x2:c,y1:e})),gpl.manager.renderAll())},k.handleMouseUp=function(a){k.mouseDown=!1,3===a.e.which&&k["delete"]()},k.handleMouseDown=function(a){var b=m.getPointer(a.e),c=b.x,e=b.y,f=h.x2,g=h.y2,j=gpl.manager.getObject({left:c,top:e,gplType:"anchor"});d.isEditingLine&&(j&&k.valid?k.completeLine(j):(s=f,t=g,o.push({x:f,y:g}),n.push(h),h=new fabric.Line([f,g,f,g],$.extend({},u)),i.set({x1:f,y1:g,x2:c,y2:e}),r=!r,m.add(h),gpl.manager.renderAll()))},k.handleEnterKey=function(){k.completeLine()},k.handleSpacebar=function(a){k.swapDirections()},k.handleBackspace=function(a){k.removeSegment()},k.handleKeyUp=function(a){a.which===gpl.ESCAPEKEY&&k["delete"]()},j=[{event:"keyup",handler:k.handleKeyUp,type:"DOM"},{event:"mouse:move",handler:k.handleMouseMove},{event:"mouse:up",handler:k.handleMouseUp},{event:"mouse:down",handler:k.handleMouseDown}],k.detachEvents=function(){m.defaultCursor=k.oldCursor,z(),d.unregisterHandlers(j),setTimeout(function(){d.clearState(),d.isEditingLine=!1},500)},k.attachEvents=function(){k.oldCursor=m.defaultCursor,y(),d.setState("DrawingLine"),d.registerHandlers(j)},h=new fabric.Line([a,b,a,b],$.extend({},u)),i=new fabric.Line([a,b,a,b],$.extend({},v)),m.add(h),m.add(i),gpl.manager.renderAll(),d.isEditingLine=!0,k.attachEvents()},gpl.ConnectionLine=function(a,b,c){var d,e,f,g,h=this,i=[],j=2,k=2,l=3,m=1,n=10,o="#ff0000",p="#000000",q="#3333bb",r={stroke:p,strokeWidth:m,selectable:gpl.isEdit,hasControls:!1,lockMovementX:!0,lockMovementY:!0,gplType:"line"},s={stroke:p,strokeWidth:l,gplType:"line",lockMovementX:!0,lockMovementY:!0,opacity:0,selectable:gpl.isEdit,hasControls:!1},t=function(a,b){var c;for(c=0;c<h.lines.length;c++)a(h.lines[c]);if(b)for(c=0;c<h.wideLines.length;c++)a(h.wideLines[c])},u=function(a,b,c,d,e){var f,g,i,j,k,l,m,o,p,q,r=[],s=function(a,b){f=b.x-a.x,g=b.y-a.y,i=Math.abs(f),j=Math.abs(g),k=[a.x,b.x],l=[a.y,b.y]},t=function(a){o=[(o[0]+1)%2,(o[1]+1)%2]},u=function(){return i>j?(o=[1,0],0===c?d&&t("adx start"):c===h.coords.length-2&&(e||t("adx end"))):(o=[0,1],0===c?d||t("ady start"):c===h.coords.length-2&&e&&t("ady end")),{x:k[o[0]],y:l[o[1]]}};return s(a,b),2===h.coords.length?(p=d?g>0?{x:a.x,y:a.y+n}:{x:a.x,y:a.y-n}:f>0?{x:a.x+n,y:a.y}:{x:a.x-n,y:a.y},r.push(p),p=e?g>0?{x:b.x,y:b.y-n}:{x:b.x,y:b.y+n}:f>0?{x:b.x-n,y:b.y}:{x:b.x+n,y:b.y},r.push(p),s(r[0],r[1]),q=u(),m=[h.coords[0],r[0],q,r[1],h.coords[1]]):(q=u(),m=[q]),m},v=function(){gpl.lineManager.setSelected(h),h.setSelected()},w=function(){var a,c,d,e,f,g,j,k,m,n,o,p;for(a=0;a<i.length-1;a++)c=i[a],d=i[a+1],e=c.x,f=d.x,g=c.y,j=d.y,k=g!==j,m=k?l/2:0,n=k?0:l/2,o=new fabric.Line([e+.5,g-.5,f+.5,j-.5],r),p=new fabric.Line([e+.5-m,g-.5-n,f+.5-m,j-.5-n],s),o.on("selected",v),p.on("selected",v),o.on("removed",h["delete"]),o.gplId=h.gplId,p.gplId=h.gplId,b.add(o),b.add(p),gpl.manager.sendToBack(p),gpl.manager.sendToBack(o),h.lines.push(o),h.wideLines.push(p);gpl.fire("addedLine",h)},x=function(){var a,b,c,d=function(a){var b,c,d=h.coords[a],e=h.coords[a+1],f=!1,g=!1;d.x!==e.x&&d.y!==e.y&&null===location.href.substring(0).match("nomanhattan")?(0===a&&h.startAnchor&&(f=h.startAnchor.isVertical),a===h.coords.length-2&&h.endAnchor&&(g=h.endAnchor.isVertical),b=u(d,e,a,f,g),c=[].concat(b).concat(e)):c=[e],0===a&&c.unshift(d),i=i.concat(c)};for(a=0;a<h.coords.length-1;a++)d(a);i.length>2&&(i[0].x===i[1].x&&i[0].y===i[1].y&&i.shift(),b=i.slice(-2),c=b[0],b=b[1],c.x===b.x&&c.y===b.y&&i.pop()),h.coords=i,w()},y=function(){var a,b,d,e,f=h.coords.length,g=function(a,b,c){var d=a.top+a.radius-.5,e=a.left+a.radius-.5,f=h.coords[b],g=h.coords[c];a.isVertical?e!==f.x&&(f.x=e,g.x=e):d!==f.y&&(f.y=d,g.y=d)};for(c&&gpl.rendered&&(g(h.startAnchor,0,1),g(h.endAnchor,f-1,f-2)),a=0;a<f;a++)b=h.coords[a],d=b.x,e=b.y,d%1!==0&&(b.x=Math.round(b.x)),e%1!==0&&(b.y=Math.round(b.y))};h.coords=$.extend(!0,[],a),h.isNew=c||!1,h.lines=[],h.wideLines=[],h.circles=[],h.state="valid",h.gplId=gpl.makeId(),r.gplId=h.gplId,d=h.coords[0].x,e=h.coords[0].y,f=h.coords[h.coords.length-1].x,g=h.coords[h.coords.length-1].y,h.startAnchor=gpl.manager.getObject({gplType:"anchor",left:d,top:e}),h.endAnchor=gpl.manager.getObject({gplType:"anchor",left:f,top:g}),y(),h.setColor=function(a){t(function(b){b.setStroke(a||"#000000")})},h.detach=function(a){var b,c;a&&(b=gpl.blockManager.getBlock(a.gplId),c=a.anchorType,h.startAnchor===a?h.startAnchor=null:h.endAnchor===a&&(h.endAnchor=null),b.syncAnchorPoints())},h.getOtherAnchor=function(a){var b;return h.startAnchor===a?b=h.endAnchor:h.endAnchor===a&&(b=h.startAnchor),b||{}},h.revertState=function(){var a=h.prevState.charAt(0).toUpperCase()+h.prevState.substring(1);h["set"+a]&&h["set"+a]()},h.setInvalid=function(){h.prevState=h.state||"valid",h.state="invalid",t(function(a){a.set({stroke:o,strokeWidth:j})}),gpl.manager.renderAll()},h.setValid=function(){h.prevState=h.state||"valid","valid"!==h.state&&(h.state="valid",t(function(a){a.set({stroke:p,strokeWidth:m})}),gpl.manager.renderAll())},h.setSelected=function(){h.prevState=h.state||"valid",h.state="selected",gpl.lineManager.selectedLine=h,t(function(a){a.set({stroke:q,strokeWidth:k})})},h.deselect=function(){h.revertState()},h.validate=function(){var a=!1;return h.startAnchor&&h.endAnchor&&(a=gpl.validate.connection(h.startAnchor,h.endAnchor)),a||h.setInvalid(),a},h.removeLines=function(){t(function(a){a.off(),b.remove(a)},!0),b.renderAll(),i=[],h.lines=[],h.wideLines=[]},h["delete"]=function(){"deleting"!==h.state&&"deleted"!==h.state&&(h.state="deleting",h.startAnchor&&(h.startAnchor.detach(h),h.startAnchor=null),h.endAnchor&&(h.endAnchor.detach(h),h.endAnchor=null),h.removeLines(),gpl.lineManager.remove(h.gplId),gpl.manager.renderAll(),h.state="deleted")},h.redrawLine=function(a,b){var c,d,e=function(b){return b.gplId===a},f=h.coords[0],g=h.coords.slice(-1)[0];h.removeLines(),e(h.startAnchor)?(c=b,d=g):e(h.endAnchor)?(c=f,d=b):(c=h.coords[0],d=h.coords.slice(-1)[0]),h.coords=[c,d],y(),x()},x(),h.startAnchor&&h.endAnchor||h.setInvalid(),h.startAnchor&&h.startAnchor.attach(this),h.endAnchor&&h.endAnchor.attach(this)},gpl.Toolbar=function(a){var b,c,d,e,f=this,g=a.blockTypes,h=5,i=30,j=30,k=77,l=2,m=0,n=0,o={opacity:.1,isToolbarProxy:!0,bypassSave:!0,fill:"#f4f4f4",hasBorders:!1,hasControls:!1},p={},q=gpl.toolbarFill,r=gpl.canvases.toolbar,s=gpl.canvases.main,t=r.height,u=h,v=h,w={},x=gpl.makeId,y=function(a){var b,c={},d=["zIndex","blockType","left","top","selectable","evented","hasControls","inactive","showValue","iconType","visible","opacity"];for(b=0;b<d.length;b++)c[d[b]]=a[d[b]];return c},z=function(){gpl.forEach(p,function(a){gpl.manager.bringToFront(a,r)}),r.renderAll()},A=function(){f.background=new fabric.Rect({left:0,top:0,fill:q,width:k,height:t,selectable:!1}),r.add(f.background),r.renderAll()},B=function(){r.setWidth(window.innerWidth),r.setHeight(window.innerHeight)},C=function(){r.setWidth(b),r.setHeight(c)},D=function(b){var c,e=d.gplShape,f=y(e),g=e.constructor,h=b.e.x;b.e.y;h>=gpl.editModeOffset&&(f.isToolbar=!1,f.targetCanvas="main",f.bypassSave=!1,f.left=e.left-gpl.manager.panLeft,f.left=f.left/gpl.scaleValue,f.top=e.top-gpl.manager.panTop,f.top=f.top/gpl.scaleValue,f.calcType=e.calcType,f.labelVisible=gpl.json.Show_Label,delete f.inactive,c=new g(f),a.addNewPoint(c)),e["delete"](),d.gplShape=d.nextShape,d.gplId=d.gplShape.gplId,d.set({left:d._origLeft,top:d._origTop}),d.setCoords(),a.bringToFront(d,r),a.clearState(),this.off("mouseup",D),r.discardActiveObject(),C(),r.renderAll(),s.renderAll()},E=function(b){var c,e,f=w[b.gplId]||gpl.texts[b.gplId],g=f.type,h=x();B(),d=b,a.setState("AddingBlock"),f instanceof gpl.blocks.TextBlock?(e=y(f),e=$.extend(!0,e,f.config),e.left=b.left-8,e.top=b.top+1):e=y(f),e.bypassSave=!0,e.gplId=h,e.isToolbar=!0,e.targetCanvas="toolbar",f.setActive&&f.setActive(),f.scale(gpl.scaleValue),c=new gpl.blocks[g](e),d.nextShape=c,w[h]=c,b.on("mouseup",D),z()},F=function(a,b){var c,d,f,g,k,q,s,t=a.blockType,y=!!a.skipToolbar,z=x(),A=$.extend(!0,{},o),B={left:u,top:v,isToolbar:!0,targetCanvas:"toolbar",gplId:z,inactive:!0,bypassSave:!0,iconType:b,showValue:!1};c=gpl.blocks[t],c?y||(k=c.prototype.toolbarOffsetTop||0,q=c.prototype.toolbarOffsetLeft||0,s=c.prototype.proxyOffsetLeft||0,B.top+=k,B.left+=q,f=new c(B),f.blockType=b,g=f.toolbarHeight||i,n=Math.max(g,n),A.height=g,A.width=j,A.top=A._origTop=v+h,A.left=A._origLeft=u+q+s,A.gplId=z,A.isToolbar=!0,gpl.isEdit||(A.selectable=!1,A.draggable=!1,A.lockMovementX=!0,A.lockMovementY=!0),w[z]=f,z=x(),e=new c({left:u+q,top:v+k,isToolbar:!0,gplId:z,inactive:!0,bypassSave:!0,targetCanvas:"toolbar",iconType:b,showValue:!1}),e.blockType=b,A.gplShape=f,w[z]=e,m++,m%l===0?(v+=n+h,u=h,n=0):u+=f.toolbarWidth+h,d=new fabric.Rect(A),r.add(d),p[A.gplId]=d,d.on("moving",function(){var a=d.gplShape;a.syncObjects?a.syncObjects(d,{top:k}):a.set({top:d.top+a.toolbarOffsetTop,left:d.left+a.toolbarOffsetLeft+a.proxyOffsetLeft})})):gpl.log("Class not found:",t,"-",b)};f.shapes=w,f.proxies=p,A(),gpl.forEach(g,F),m%l===1&&(v+=n+h),z(),f.background.set("height",v+2*h),a.registerHandlers([{canvas:r,event:"object:selected",handler:function(a){var b=a.target;b.isToolbarProxy&&E(b)}}]),c=f.background.height,b=k,C(),r.renderAll()},gpl.LineManager=function(a){var b=this,c=function(a){var b,c=a.lines,d=c.length;for(b=0;b<d;b++)gpl.manager.bringToFront(c[b]);gpl.manager.renderAll()},d=function(a){b.removedLines[a.gplId]=a,delete b.lines[a.gplId]};b.lines={},b.removedLines={},b.setSelected=function(a){b.selectedLine&&b.selectedLine.deselect(),b.selectedLine=a},b.registerLine=function(a){b.lines[a.gplId]=a},b.getLine=function(a){return b.lines[a]},b.deleteLine=function(c){var e;e="string"==typeof c?b.lines[c]:c,e?(e["delete"](),d(e),a.renderAll()):gpl.log("no line to remove")},b.remove=function(a){d(a)},b.convertLine=function(a){var b={handle:a.coords};return b},b.prepSaveData=function(a,c){var d=[];gpl.forEach(b.lines,function(a){var c=b.convertLine(a);"deleted"!==a.state&&(a.isNew&&gpl.isCancel||(c.isNew=a.isNew||!1,d.push(c)))}),a.line=d},gpl.on("addedLine",function(a){b.lines[a.gplId]=a,c(a)}),gpl.on("removeline",function(a){b.lines[a.gplId]&&b.deleteLine(a.gplId)}),gpl.manager.registerHandler({event:"selection:cleared",handler:function(a){b.selectedLine&&(b.selectedLine.revertState(),b.selectedLine=null)}}),gpl.manager.addToBindings({deleteLine:function(){var c=a.contextObject;b.deleteLine(c.gplId)}}),gpl.on("save",function(){b.prepSaveData(gpl.json)}),gpl.on("saveForLater",function(){b.prepSaveData(gpl.json.editVersion,!0)}),gpl.onDestroy(function(){gpl.forEach(b.lines,function(a,c){a["delete"](),delete b.lines[c]}),delete b.lines})},gpl.BlockManager=function(a){var b={blocks:{},upis:{},newBlocks:{},deletedBlocks:{},editedBlocks:{},screenObjects:[],doubleClickDelay:400,lastSelectedBlock:null,highlightFill:"#ffffff",lastSelectedTime:(new Date).getTime(),manager:a,canvas:a.canvas,upiListeners:{},bindings:{blockTitle:ko.observable(),editPointType:ko.observable(),editPointName:ko.observable(),editPointCharacters:ko.observable(),editPointDecimals:ko.observable(),editPointValue:ko.observable(),editPointLabel:ko.observable(),editPointShowValue:ko.observable(),editPointShowLabel:ko.observable(),editText:ko.observable(),editTextBold:ko.observable(),editTextItalic:ko.observable(),editTextFontSize:ko.observable(),editTextColor:ko.observable("ff0000"),actionButtonText:ko.observable(),actionButtonType:ko.observable(),actionButtonParameter:ko.observable(),actionButtonValue:ko.observable(),actionButtonPointName:ko.observable(),actionButtonUpi:ko.observable(),actionButtonPointType:ko.observable(),actionButtonReportType:ko.observable(),reportFromDate:ko.observable(""),reportFromTime:ko.observable(""),reportToDate:ko.observable(""),reportToTime:ko.observable(""),actionButtonReportDuration:ko.observable(),selectedReference:ko.observable(),gridSize:ko.observable(gpl.gridSize),blockReferences:ko.observableArray([]),updateText:function(){var a=b.bindings.editText(),c=b.bindings.editTextFontSize(),d="#"+b.bindings.editTextColor(),e=b.bindings.editTextBold()?"bold":"normal",f=b.bindings.editTextItalic()?"italic":"normal";
b.textEditBlock.set({text:a,fontSize:c,fill:d,fontWeight:e,fontStyle:f}),b.renderAll(),gpl.$editTextModal.modal("hide")},deleteBlock:function(){a.contextObject&&gpl.fire("deleteblock",a.contextObject)},showDevicePoint:function(){b.openPointEditor(!0)},editBlockPrecision:function(){var c=a.contextObject,d=c.precision.toString().split("."),e=parseInt(d[0],10),f=parseInt(d[1],10);b.bindings.editPointCharacters(e),b.bindings.editPointDecimals(f),b.editBlock=c,b.openPrecisionEditor()},showPointEditor:function(){var b=a.contextObject;gpl.blockManager.openPointEditor(b,!0)},updateBlockPrecision:function(){b.editBlock.precision=parseFloat(b.bindings.editPointCharacters()+"."+b.bindings.editPointDecimals()),b.editBlock.setPlaceholderText(),gpl.fire("editedblock",b.editBlock),b.closePrecisionEditor()},editPointReference:function(){var a,c,d="/pointLookup/",e=b.editBlock,f="ControlBlock"===e.type,g=f?gpl.deviceId:null,h=f?"Control Point":"Monitor Point";a=f?e.inputAnchors[0].getConnectedBlock():e.outputAnchor.getConnectedBlock(),a&&(c=a.pointType,d+=c+"/"+h,g&&(d+="/"+g)),b.doOpenPointSelector(d,h)},updatePoint:function(){var a,c,d,e,f,g,h=(b.bindings.editPointLabel(),b.bindings.editPointShowValue()),i=b.bindings.editPointShowLabel(),j={output:"Control Point",input:"Monitor Point"},k=b.editBlock,l=b.upis[k.upi]||[],m=b.upis[b.editBlockUpi]||[];k.hasReferenceType?b.editBlockUpi!==k.upi&&(gpl.forEachArray(l,function(b,c){var d=b.block;if(d.gplId===k.gplId)return a=c,!1}),void 0!==a&&l.splice(a,1),1===l.length&&(c=l[0],c.block.setReferenceType&&c.block.setReferenceType("External")),g=j[k.blockType.toLowerCase()],e="Monitor Point"===g?k.outputAnchor:k.inputAnchor,f=b.bindings.editPointName(),d=e.getConnectedBlock(),d&&(d.setPointRef(g,b.editBlockUpi,f),gpl.fire("editedblock",d)),k.setPointRef(g,b.editBlockUpi,f),k.pointName=f,k.upi=b.editBlockUpi,k.getReferencePoint(),k.setLabel(f.split("_").pop()),k.valueType=gpl.manager.valueTypes[b.editBlockPointType],m.push({block:k,valueText:k.valueText}),m.length>1?gpl.forEachArray(m,function(a,b){var c=a.block;c.hasReferenceType&&c.setReferenceType("Internal")}):k.setReferenceType("External"),gpl.fire("editedblock",b.editBlock)):k.setValue(+b.bindings.editPointValue()),k.precision=parseFloat(b.bindings.editPointCharacters()+"."+b.bindings.editPointDecimals()),k.setShowLabel(i),k.setShowValue(h),gpl.$editInputOutputModal.modal("hide"),gpl.fire("editedblock",b.editBlock)}},forEachBlock:function(a){gpl.forEach(b.blocks,function(b){a(b)})},getActiveBlock:function(){var a=b.canvas.getActiveObject(),c=a&&a.gplId||null,d=b.blocks[c]||null;return{target:a,block:d}},getSaveObject:function(){var a={adds:[],updates:[],deletes:[]},c=[gpl.point["Point Refs"][0]];return gpl.forEach(b.newBlocks,function(b){var c;b.isNonPoint||(c=b.getPointData(),a.adds.push(c))}),gpl.forEach(b.editedBlocks,function(b){var c;b.isNonPoint||(c={oldPoint:b._origPointData,newPoint:b.getPointData()},a.updates.push(c))}),gpl.forEach(b.deletedBlocks,function(b){b.isNonPoint||a.deletes.push(b.upi)}),gpl.forEach(b.blocks,function(a,d,e){if(0!==a.upi){var f=b.pointRefUpiMatrix[a.upi];f&&(f.PropertyName="GPLBlock",f.PropertyEnum=439,c.push(f))}}),gpl.point["Point Refs"]=c,a},useEditVersion:function(){var a=gpl.pointChanges;gpl.forEachArray(a.adds,function(a){var c,d=a._id;c=b.getBlockByUpi(d),c.setPointData(a),b.newBlocks[d]=c}),gpl.forEachArray(a.updates,function(a){var c,d=a.newPoint&&a.newPoint._id;d&&(c=b.getBlockByUpi(d),c._origPointData=a.oldPoint,c.setPointData(a),b.editedBlocks[d]=c)}),b.deletedBlocks={},gpl.forEachArray(a.deletes,function(a){b.deletedBlocks[a]={upi:a}})},resetChanges:function(){b.newBlocks={},b.editedBlocks={},b.deletedBlocks={}},doOpenPointSelector:function(a,c){gpl.openPointSelector(function(a,c,d){b.bindings.editPointName(c),b.editBlockUpi=a,b.editBlockPointType=d,gpl.log(a,c)},a,null,c)},openPrecisionEditor:function(a){gpl.$editPrecisionModal.modal("show")},closePrecisionEditor:function(){gpl.$editPrecisionModal.modal("hide")},openBlockEditor:function(a){var c=a.precision.toString().split("."),d=parseInt(c[0],10),e=parseInt(c[1],10),f=a.value,g=a.label;b.editBlock=a,b.editBlockUpi=a.upi,b.bindings.blockTitle(a.label),b.bindings.editPointType(a.type),b.bindings.editPointName(a.pointName),b.bindings.editPointCharacters(d),b.bindings.editPointDecimals(e),b.bindings.editPointValue(f),b.bindings.editPointLabel(g),b.bindings.editPointShowValue(a.presentValueVisible),b.bindings.editPointShowLabel(a.labelVisible),gpl.$editInputOutputModal.modal("show")},openTextEditor:function(c){var d=c.fill.replace("#","");a.canvas.discardActiveObject(),b.textEditBlock=c,b.bindings.editText(c.text),b.bindings.editTextBold("bold"===c.fontWeight),b.bindings.editTextItalic("italic"===c.fontStyle),b.bindings.editTextFontSize(c.fontSize),b.bindings.editTextColor(d),b.fontColorPicker.updateColor(d),gpl.$editTextModal.modal("show")},convertBlock:function(a){var b,c,d,e={};for(a._shapes&&a._shapes[0]?(c=a._shapes[0],e.left=c.left,e.top=c.top):e={left:a.left,top:a.top,width:a.width,height:a.height,text:a.text,fontWeight:a.fontWeight,fontStyle:a.fontStyle,fontSize:a.fontSize,fontFamily:a.fontFamily,fill:a.fill,blockType:"TextBlock",_v2:!0},d=0;d<gpl.convertProperties.length;d++)b=gpl.convertProperties[d],a[b]&&(e[b]=a[b]);return e},getBlock:function(a){var c=null,d=a;return"string"!=typeof d&&(d=gpl.idxPrefix+parseInt(d,10)),c=b.blocks[d],c||(c=b.newBlocks[d]),c},getBlockByUpi:function(a){var c=null;return gpl.forEach(b.blocks,function(b){var d=b.getPointData&&b.getPointData();d&&d._id===a&&(c=b)}),c},add:function(a,b,c){gpl.canvases[b||"main"].add(a),c&&gpl.canvases[b||"main"].renderAll()},remove:function(a,b){gpl.canvases[b||"main"].remove(a)},renderAll:function(){a.renderAll()},handleTypeChange:function(a,b){gpl.log("type change",arguments)},prepSaveData:function(a){var c=[];gpl.forEach(b.blocks,function(a){a.bypassSave||"toolbar"===a.targetCanvas||(a.syncAnchorPoints&&a.syncAnchorPoints(),c.push(b.convertBlock(a)))}),a.block=c},prepReferences:function(){var a,b,c=gpl.references,d={},e={},f=function(a,b){return e[a._id]=a,{Name:a.Name,pointType:a["Point Type"].Value,valueType:5===a.Value.ValueType?"enum":"float",_idx:b}};for(b=0;b<c.length;b++)a=c[b]._id,d[a]=f(c[b],b);gpl.pointUpiMap=d,gpl.pointData=e},addUPIListener:function(a,c,d,e){b.upiListeners[a]=b.upiListeners[a]||[],b.upiListeners[a].push({fn:e,anchor:c,line:d})},processPointRefs:function(){var a,c,d=gpl.point["Point Refs"],e={};for(a=0;a<d.length;a++)c=d[a].PointInst,e[c]=d[a];b.pointRefUpiMatrix=e,void 0!==gpl.pointChanges&&(gpl.forEachArray(gpl.pointChanges.adds,function(a){var c=gpl.makePointRef(a._id,a.Name,a);b.pointRefUpiMatrix[a._id]=c}),gpl.forEachArray(gpl.pointChanges.updates,function(a){var c=a.newPoint,d=gpl.makePointRef(c._id,c.Name,c);b.pointRefUpiMatrix[c._id]=d})),b.invalidPointRefs={}},isActiveUPI:function(a,c){var d=!0,e=a.upi;return e&&c.prototype.isNonPoint!==!0&&(d=void 0!==b.pointRefUpiMatrix[e]),d||(b.invalidPointRefs[e]={cls:c,cfg:a}),d},init:function(){a.addToBindings(b.bindings),b.processPointRefs(),b.prepReferences()}};return b.bindings.gridSize.subscribe(function(a){var c=parseInt(a,10);isNaN(c)||0===c?b.bindings.gridSize(gpl.gridSize||1):gpl.gridSize=c}),b.handleFontColorChange=function(a){b.bindings.editTextColor(a)},b.fontColorPicker=new CustomColorsPicker(gpl.$fontColorPicker,b.handleFontColorChange,b.bindings.editTextColor()),b.fontColorPicker.render(),b.validateAll=function(){var a=!0,c=function(b){return!b.isToolbar&&b.validate&&(a=b.validate()),a};return gpl.forEach(b.blocks,c),a&&gpl.forEach(b.newBlocks,c),gpl.log("Validate All result:",a),gpl.manager.renderAll(),a},b.highlight=function(a){gpl.isEdit&&(b.highlightedObject&&b.deselect(),b.highlightedObject=a,a._origFill||(a._origFill=a.fill),a.set("fill",b.highlightFill))},b.deselect=function(){var a=b.highlightedObject;a&&a.set("fill",a._origFill),b.highlightedObject=null},gpl.on("newblock",function(a){var c;b.manager.bindings.hasEdits(!0),b.newBlocks[a.upi]=a,b.updateBlockReferences(a),b.pointRefUpiMatrix[a.upi]||(c=gpl.makePointRef(a.upi,a.pointName,a.getPointData()),b.pointRefUpiMatrix[a.upi]=c)}),gpl.on("editedblock",function(a){gpl.rendered&&b.manager.bindings.hasEdits(!0),isNaN(a.upi)||(b.editedBlocks[a.upi]=a)}),gpl.on("deleteblock",function(a,c){var d=b.upis[a.upi]||[];c||(b.manager.bindings.hasEdits(!0),b.deletedBlocks[a.upi]=a),delete b.newBlocks[a.upi],delete b.pointRefUpiMatrix[a.upi],gpl.forEachArray(d,function(b,c){var e=b.block;if(e.gplId===a.gplId)return d.splice(c,1),!1}),d.length<=1&&gpl.forEachArray(d,function(a){var b=a.block;b.hasReferenceType&&b.setReferenceType("External")}),delete b.blocks[a.gplId],a["delete"](),delete b.editedBlocks[a.upi],b.renderAll(),gpl.log("block deleted")}),gpl.on("save",function(){b.prepSaveData(gpl.json)}),gpl.on("saveForLater",function(){void 0===gpl.json.editVersion&&(gpl.json.editVersion={}),b.prepSaveData(gpl.json.editVersion),gpl.json.editVersion.pointChanges=b.getSaveObject()}),b.create=function(a){var b,c=a.cls,d=a.cfg;return delete d.type,b=new c(d)},b.applyUpdateInterval=function(a){gpl.forEach(b.blocks,function(b){b._pointData&&b._pointData["Update Interval"]&&(gpl.fire("editedblock",b),b._pointData["Update Interval"].Value=a)})},b.applyController=function(a,c){gpl.forEach(b.blocks,function(b){b._pointData&&(gpl.fire("editedblock",b),b._pointData.Controller.Value=a,b._pointData.Controller.eValue=c)})},b.applyShowLabel=function(a){gpl.forEach(b.blocks,function(b){b.setShowLabel&&!b.isToolbar&&b.setShowLabel(a)})},b.applyShowValue=function(a){gpl.forEach(b.blocks,function(b){b.setShowValue&&!b.isToolbar&&b.setShowValue(a)})},b.updateBlockReferences=function(a){b.bindings.blockReferences.push({label:a.label,value:a.gplId}),b.bindings.blockReferences.sort(function(a,b){return a.label<b.label?-1:1})},b.registerBlock=function(a,c,d){var e,f,g=a._shapes||[],h=gpl.canvases[d||"main"],i=function(a){var c=b.getActiveBlock(),d=c.target,e=c.block;0!==a.e.movementX||0!==a.e.movementY?(b.movingBlock=!0,e&&e.syncObjects&&"anchor"!==d.gplType&&e.syncObjects(d),gpl.actionLog.push({action:"moved",obj1:e})):b.movingBlock=!1};for(b.blocks[a.gplId]=a,a.config.inactive||gpl.labelCounters[a.type]++,h.add(a),a.upi&&!isNaN(a.upi)&&(b.upis[a.upi]=b.upis[a.upi]||[],b.upis[a.upi].push({block:a,valueText:c}),1===b.upis[a.upi].length?b.screenObjects.push({upi:a.upi,"Quality Label":"",isGplSocket:!0}):gpl.forEachArray(b.upis[a.upi],function(a){var b=a.block;b.hasReferenceType&&b.setReferenceType("Internal")})),gpl.manager.addToBoundingRect(a),f=0;f<g.length;f++)e=g[f],e.canvas&&e.canvas.remove(e),h.add(e),e.on("moving",i);a.isToolbar||b.updateBlockReferences(a),b.renderAll()},b.processValue=function(a,c){var d,e,f,g,h,i=b.upis[a],j=b.upiListeners,k=j[a]||[],l=c.Value,m=c["Quality Label"];for(g=0;g<i.length;g++)h=i[g],e=h.block,f=h.valueText,l=gpl.formatValue(e,c.Value),"none"!==m&&(l+=" "+gpl.qualityCodes[m].text),"none"!==m?f.setFill("#"+gpl.qualityCodes[m].color):f.setFill("#000000"),f.setText(l),e.currValue=c.Value;for(g=0;g<k.length;g++)d=k[g],d.fn(d.upi,d.anchor,d.line,c);b.renderAll()},b.openPointEditor=function(a,c){var d,e,f,g,h,i,j=a&&a.getPointData&&a.getPointData(),k=function(a){e=gpl.openWindow(g,h,i,"",d,{width:820,height:540}),(a||gpl.emptyFn)()};a&&(a instanceof gpl.Block?c||!a.isNonPoint||a.isNonPoint&&!gpl.isEdit?(b.deselect(),d=a.upi,f=gpl.workspaceManager.config.Utility.pointTypes.getUIEndpoint(a.pointType,d),g=f.review.url,h=a.pointName,i=a.pointType,k(function(){gpl.isEdit&&(e.attach={point:j?JSON.stringify(j):null,saveCallback:function(b){var c=b;"string"==typeof c&&(c=JSON.parse(b)),a.setPointData(c,!0),gpl.fire("editedblock",a)}})})):"ConstantBlock"===a.type&&b.openBlockEditor(a):(d=gpl.devicePoint._id,h=gpl.devicePoint.Name,i="Device",f=gpl.workspaceManager.config.Utility.pointTypes.getUIEndpoint(i,d),g=f.review.url,k()))},b.handleMouseUp=function(a){var c=b.getActiveBlock(),d=a.target,e=c.target,f=c.block;b.movingBlock===!0?(b.movingBlock=!1,f&&gpl.isEdit&&f.redrawLines()):(e||(e=d,e&&(f=b.getBlock(e.gplId))),1!==a.e.which||!f||f instanceof gpl.blocks.ConstantBlock||b.handlingDoubleClick||gpl.isEdit||(b.openPointEditor(f),b.deselect())),b.handlingDoubleClick=!1},b.handleDoubleClick=function(a){var c,d,e=a.target,f=(new Date).getTime();e&&gpl.isEdit&&(c=e.gplId,d=b.blocks[c],f-b.lastSelectedTime<b.doubleClickDelay&&d?(b.handlingDoubleClick=!0,b.deselect(),d.isNonPoint?!d.useNativeEdit&&gpl.isEdit&&(d instanceof gpl.Block?b.openBlockEditor(d):b.openTextEditor(d)):b.openPointEditor(d)):(b.lastSelectedTime=f,b.lastSelectedBlock=d))},b.handleKeyUp=function(a){var c,d=a.which,e=gpl.ARROWKEYS[d],f={down:{top:1},left:{left:-1},right:{left:1},up:{top:-1}},g={left:0,top:0};b.highlightedObject&&e&&(c=b.getBlock(b.highlightedObject.gplId),g=$.extend(g,f[e]),c.nudge(g))},b.handleUnload=function(a){},b.destroyBlocks=function(){gpl.forEach(b.blocks,function(a,c){var d,e=a._shapes||[];for(d=0;d<e.length;d++)e[d].off();a.destroy&&a.destroy(),delete b.blocks[c]})},a.registerHandlers([{event:"selection:cleared",handler:b.deselect},{event:"mouse:up",handler:b.handleMouseUp},{event:"mouse:down",handler:b.handleDoubleClick},{event:"keyup",handler:b.handleKeyUp,type:"DOM",window:!0},{event:"unload",handler:b.handleUnload,type:"DOM",window:!0}]),b.init(),gpl.onDestroy(function(){b.destroyBlocks(),delete b.blocks,delete b.screenObjects,delete b.upiListeners,delete b.upis,delete b.manager,delete b.canvas}),b},gpl.Manager=function(){var a=this,b=(new Date).getTime(),c={},d=gpl.log,e=1,f=0,g=["Show Label","Show Value"],h=["initBindings","initCanvas","initManagers","initQualityCodes","initShapes","initEvents","initKnockout","initToolbar","initSocket"],i=function(){var b,c=a.blockTypes;for(b in c)c.hasOwnProperty(b)&&(gpl.labelCounters[c[b].blockType]=0)},j=function(){var a,b,c=[],d=!1;for(a=4;a>0&&!d;a--)""!==gpl.point["name"+a]&&(d=!0);if(d)for(b=a+1,a=1;a<=b;a++)c.push(gpl.point["name"+a]);c=c.join("_")+"_",gpl.pointNamePrefix=c},k=function(a,b){var c,d,e,f=b.line,g=f.length;for(d=0;d<g;d++)for(c=f[d].handle,e=0;e<c.length;e++)c[e].x=+c[e].x+(a?-1*gpl.editModeOffset:gpl.editModeOffset)},l=function(a,b){var c,d=b.block,e=d.length;for(c=0;c<e;c++)d[c].left=+d[c].left+(a?-1*gpl.editModeOffset:gpl.editModeOffset)},m=function(a,b){k(!!a,b||gpl.json),l(!!a,b||gpl.json)},n=function(){var c,i,k=((new Date).getTime(),function(){var c=h[f];void 0!==c?(f++,setTimeout(function(){d("Running next init:"+c),a[c](),k()},e)):(d("Finished init functions"),a.getBoundingBox(),gpl.skipEventLog=!1,gpl.isEdit?$("body").addClass("editMode"):$("body").addClass("viewMode"),d("Finished initializing GPL Manager in",(((new Date).getTime()-b)/1e3).toFixed(3),"seconds"),a.resizeWindow(!0),setTimeout(function(){gpl.rendered=!0,a.resumeRender(),a.bindings.loaded(!0),gpl.fire("rendered"),window.onLoaded?window.onLoaded():window.loaded=!0,a.postInit()},100))});if(a.useEditVersion=function(){gpl.json.block=gpl.json.editVersion.block,gpl.json.line=gpl.json.editVersion.line,gpl.pointChanges=$.extend(!0,{},gpl.json.editVersion.pointChanges),gpl.on("rendered",function(){a.bindings.hasEdits(!0),gpl.blockManager.useEditVersion()}),a.confirmEditVersion()},a.discardEditVersion=function(){a.confirmEditVersion()},a.confirmEditVersion=function(){a.hideEditVersionModal(),delete gpl.json.editVersion,k()},gpl.getPointTypes=(window.opener||window.top)&&(window.opener||window.top).workspaceManager&&(window.opener||window.top).workspaceManager.config.Utility.pointTypes.getAllowedPointTypes,gpl.workspaceManager=(window.opener||window.top)&&(window.opener||window.top).workspaceManager,gpl._openWindow=(window.opener||window.top)&&(window.opener||window.top).workspaceManager&&(window.opener||window.top).workspaceManager.openWindowPositioned,gpl.controllers=gpl.workspaceManager.systemEnums.controllers,gpl.pointTypes=gpl.workspaceManager.config.Enums["Point Types"],gpl.formatPoint=gpl.workspaceManager.config.Update.formatPoint,gpl.point.SequenceData){for(gpl.json=gpl.point.SequenceData.sequence,gpl.json._convertedBG||(gpl.json.backgroundColor?gpl.json.backgroundColor=gpl.convertColor(gpl.json.backgroundColor):gpl.json.backgroundColor=gpl.defaultBackground,gpl.json._convertedBG=!0),gpl.deviceId=gpl.point["Point Refs"][0].DevInst,a.backgroundColor=gpl.json.backgroundColor,a.state=null,a.editMode=!1,a.queueRenders=!0,a.haltRender=!0,a.panLeft=0,a.panTop=0,a.lastRender=(new Date).getTime(),a.gplObjects={},a.actionButtons={},a.eventHandlers={},a.bindings={},a.shapes=[],a.mainCanvasElId="gplCanvas",a.$mainCanvasEl=$("#"+a.mainCanvasElId),a.$saveButton=$("#save"),a.$saveForLaterButton=$("#saveForLater"),a.$editButton=$("#edit"),a.$cancelButton=$("#cancel"),a.$quitButton=$("#quit"),a.$validateButton=$("#validate"),a.$contextMenuList=$("#jqxMenu ul"),a.contextMenu=$("#jqxMenu").jqxMenu({width:"140px",animationShowDuration:0,animationHideDuration:0,animationShowDelay:0,autoOpenPopup:!1,autoCloseOnClick:!0,mode:"popup",theme:gpl.jqxTheme}),a.tooltipFill="#3d3d3d",a.tooltipFontColor="#f4f4f4",a.minX=9999,a.minY=9999,a.maxX=0,a.maxY=0,a.blockTypes={Constant:{blockType:"ConstantBlock"},Output:{blockType:"ControlBlock"},Input:{blockType:"MonitorBlock"},AlarmStat:{blockType:"AlarmStatus"},BINMDualSP:{blockType:"BinarySetPoint"},BINMSingleSP:{blockType:"BinarySetPoint"},Delay:{blockType:"Delay"},OneShot:{blockType:"Delay"},FindLargest:{blockType:"SelectValue"},FindSmallest:{blockType:"SelectValue"},Average:{blockType:"Average"},Sum:{blockType:"Average"},Add:{blockType:"Math"},Divide:{blockType:"Math"},Multiply:{blockType:"Math"},Subtract:{blockType:"Math"},AddSqrt:{blockType:"Math",skipToolbar:!0},DivideSqrt:{blockType:"Math",skipToolbar:!0},MultiplySqrt:{blockType:"Math",skipToolbar:!0},SubtractSqrt:{blockType:"Math",skipToolbar:!0},MUX:{blockType:"MUX"},PI:{blockType:"PI"},Proportional:{blockType:"PI",skipToolbar:!0},ReverseActingPI:{blockType:"PI",skipToolbar:!0},SPA:{blockType:"SPA"},Ramp:{blockType:"Ramp"},Totalizer:{blockType:"Totalizer"},TextBlock:{blockType:"TextBlock",skipToolbar:!0},AnalogDualSetPoint:{blockType:"AnalogSetPoint"},AnalogSingleSetPoint:{blockType:"AnalogSetPoint"},SUMWSingleSP:{blockType:"AnalogSetPoint",skipToolbar:!0},SUMWDualSP:{blockType:"AnalogSetPoint",skipToolbar:!0},Econ:{blockType:"Economizer"},Enthalpy:{blockType:"Enthalpy"},DewPoint:{blockType:"Enthalpy"},WetBulb:{blockType:"Enthalpy"},GT:{blockType:"Comparator"},GTEqual:{blockType:"Comparator"},LT:{blockType:"Comparator"},LTEqual:{blockType:"Comparator"},Equal:{blockType:"Comparator"},NEqual:{blockType:"Comparator"},Logic:{blockType:"Logic"},DigLogicAnd:{blockType:"DigLogic"},DigLogicOr:{blockType:"DigLogic"},DigLogicXOr:{blockType:"DigLogic"}},i=0;i<g.length;i++)c=g[i],gpl.json[c.replace(" ","_")]=gpl.point[c].Value||!1;a.valueTypes={},a.pointTypeLookup={},gpl.forEach(gpl.blocks,function(b,c){a.valueTypes[b.prototype.pointType]=b.prototype.valueType}),document.title=gpl.point.Name,j(),gpl.isEdit?gpl.json.editVersion&&gpl.json.editVersion.block?a.useEditVersion():a.confirmEditVersion():k()}else gpl.showMessage("Sequence data not found")};d("Initializing GPL Manager"),gpl.skipEventLog=!0,a.postInit=function(){a.postInitActionButtons()},a.offsetEverything=function(a,b,c){var d,e,f,g=gpl.json.block;if(c!==!1)for(d=0;d<g.length;d++)g[d].left-=a*gpl.editModeOffset;if(b!==!1)for(g=gpl.json.line,d=0;d<g.length;d++)for(f=g[d].handle,e=0;e<f.length;e++)f[e].x-=a*gpl.editModeOffset},a.addToBindings=function(b){a.bindings=$.extend(a.bindings,b)},a.rebuildBoundingRect=function(){a.minX=9999,a.minY=9999,a.maxX=0,a.maxY=0,gpl.blockManager.forEachBlock(function(b){a.addToBoundingRect(b)})},a.addToBoundingRect=function(b){var c,d,e,f,g,h,i,j,k=b._shapes||[],l=new Date,m=a.canvasHeight,n=a.canvasWidth,o=function(){n<a.maxX&&(n=a.maxX)},p=function(){m<a.maxY&&(m=a.maxY)},q=function(){n===a.canvasWidth&&m===a.canvasHeight||a.resizeCanvas(n,m)},r=function(){d<a.minX&&(a.minX=d),f>a.maxX&&(a.maxX=f,s.push(o)),e<a.minY&&(a.minY=e),g>a.maxY&&(a.maxY=g,s.push(p))},s=[];if(b instanceof gpl.Block||b instanceof gpl.blocks.TextBlock){if(b.isToolbar!==!0){for(i=0;i<k.length;i++)c=k[i],h=c.getBoundingRect(),d=h.left,e=h.top,g=e+h.height,f=d+h.width,b.isToolbar!==!0&&r();if(gpl.rendered===!0&&a.getBoundingBox(),s.length>0){for(j=0;j<s.length;j++)s[j]();q()}}}else d=b.left,e=b.top,g=e+20,f=d+8*b.text,r();gpl.boundingRectTime+=new Date-l,gpl.boundingRectCount++},a.getBoundingBox=function(){var b=a.minY,c=a.maxY,d=a.minX,e=a.maxX;b<0&&(b=0),d<0&&(d=0),gpl.boundingBox={top:b,left:d,bottom:c,right:e}},a.resizeWindow=function(b){var c,d=gpl.boundingBox,e=d.right,f=d.bottom,g=50,h=50,i=750,j=550,k=900,l=e+h,m=70;l<k&&(l=k),gpl.poppedIn||(c=gpl.isEdit?f+g>i?f+g:i:f+g>j?f+g:j,c+=m,a.currWidth=l,a.currHeight=c,window.resizeTo(l,c),b&&a.resizeCanvas(l,c))},a.scale=function(b,c){var d=a.canvasHeight,e=a.canvasWidth;e&&d||(e=a.canvasWidth=parseInt(a.$mainCanvasEl.css("width"),10),d=a.canvasHeight=parseInt(a.$mainCanvasEl.css("height"),10)),b!==gpl.scaleValue&&(a.pauseRender(),gpl.scaleValue=b,a.canvas.setZoom(b),a.canvas.setWidth(e*b),a.canvas.setHeight(d*b),$(".dynamicBtn").each(function(){var a=$(this),c=a.data("origLeft"),d=a.data("origTop");$(this).css({transform:"scale("+b+")",left:c*b,top:d*b})}),c||a.bindings.currentZoom(Math.round(100*b)),a.resumeRender())},a.pan=function(b,c){a.contextMenu.jqxMenu("close"),a.hasPanned=!0,"boolean"==typeof b?(a.panLeft=0,a.panTop=0):(a.panLeft+=b,a.panTop+=c),a.$mainCanvasContainer.css({left:a.panLeft,top:a.panTop})},a.addNewPoint=function(b){var c,e=window.encodeURI(b.pointType),f=(gpl.pointNamePrefix+b.label).split("_"),g=!1,h=f[0],i=f[1],j=f[2],k=f[3]||"",l=function(c){var e=$.extend(!0,{},c);return c&&c.target?void(g||(d("New Point canceled, deleting block"),gpl.fire("deleteblock",b,!0),gpl.labelCounters[b.type]--)):(b.upi=c._id,c["Point Refs"][0].Value=gpl.deviceId,b.formatPointFromData(c,c,"Device Point",gpl.devicePoint),c=b.getPointData(),c["Calculation Type"]&&(c["Calculation Type"].Value=b.iconType,c["Calculation Type"].eValue=c["Calculation Type"].ValueOptions[b.iconType]),b.setPointData(c,!0),d(b.gplId,"save callback",c),gpl.fire("newblock",b),g=!0,void a.socket.emit("updatePoint",JSON.stringify({newPoint:c,oldPoint:e})))};b.isNonPoint===!0||b instanceof gpl.blocks.TextBlock?gpl.fire("newblock",b):(c=gpl.openWindow("/api/points/newPoint/restrictTo/"+e,"New Point","","","newPoint",{width:980,height:280,gplHandler:l}),c.attach={saveCallback:l,point:{name1:h,name2:i,name3:j,name4:k}})},a.afterSave=function(){m(!1),a.resumeRender(),a.bindings.hasEdits(!1),d("save complete"),gpl.captureThumbnail(),setTimeout(function(){a.doCancel()},500)},a.doSave=function(){var b,c,d=function(){delete gpl.json.editVersion,gpl.saveSequence(),1===gpl.point._pStatus?a.socket.emit("addPoint",{point:gpl.point}):a.socket.emit("updatePoint",{oldPoint:gpl._origPoint,newPoint:gpl.point})};gpl.isValid=!0,gpl.validationMessage=[],gpl.blockUI(),gpl.waitForSocketMessage(gpl.unblockUI),a.doCompleteSave=!0,b=gpl.blockManager.getSaveObject(),c=a.validate(),c?(a.pauseRender(),gpl.fire("save"),a.socket.emit("updateSequencePoints",b),a.embedActionButtons(),m(!0),gpl.isValid?d():(gpl.showMessage(gpl.validationMessage),a.resumeRender())):gpl.showMessage(gpl.validationMessage)},a.doSaveForLater=function(){var b=function(){gpl.hideMessage(),gpl.unblockUI(),gpl.$saveForLaterConfirmModal.modal("show")};gpl.blockUI(),gpl.waitForSocketMessage(b),gpl.fire("saveForLater"),a.embedActionButtons(gpl.json.editVersion),m(!0,gpl.json.editVersion),m(!0),gpl.saveSequence(),m(!1,gpl.json.editVersion),m(!1),a.bindings.hasEdits(!1)},a.embedActionButtons=function(b){var c=b||gpl.json,d=[];gpl.forEach(a.actionButtons,function(a,b){d.push(a.getExportData())}),c.dynamic=d},a.postInitActionButtons=function(){gpl.forEach(a.actionButtons,function(a){a.postInit()})},a.doEdit=function(){var a=gpl.workspaceManager.config.Utility.pointTypes.getUIEndpoint("Sequence",gpl.upi),b=a.edit.url;gpl.openWindow(b,gpl.point.Name,"Sequence","",gpl.upi)},a.doCancel=function(){var a=gpl.workspaceManager.config.Utility.pointTypes.getUIEndpoint("Sequence",gpl.upi),b=a.review.url;gpl.openWindow(b,gpl.point.Name,"Sequence","",gpl.upi)},a.popInOut=function(){var a="mainWindow";return gpl.poppedIn&&(a=""),gpl._openWindow(window.location.href,gpl.point.Name,"Sequence",a,gpl.upi),gpl.poppedIn=!gpl.poppedIn,!1},a.popInOutText=function(){return gpl.poppedIn?"Pop Out":"Pop In"},a.popInOutClass=function(){return gpl.poppedIn?"fa-arrow-circle-up":"fa-arrow-circle-down"},a.sequenceLoaded=ko.observable(!1),a.validate=function(){var a=gpl.blockManager.validateAll();return a},a.getObject=function(b){var c,d,e,f,g,h,i,j=(new Date).getTime(),k=b.gplType,l=b.yoffset||0,m=b.xoffset||0,n=b.left+a.panLeft,o=b.top+a.panTop,p=b.multiple||!1,q=a.canvas.getObjects(),r=q.length,s=[],t=!1;for(h=0;h<r&&!t;h++)i=q[h],k&&k!==i.gplType||("line"===i.gplType?(d=Math.ceil(Math.min(i.x1,i.x2)+m),e=Math.ceil(Math.max(i.x2,i.x1)+m),f=Math.ceil(Math.min(i.y1,i.y2)+l),g=Math.ceil(Math.max(i.y2,i.y1)+l),i.strokeWidth>1&&(d===e?(d+=i.strokeWidth,e+=i.strokeWidth):(f+=i.strokeWidth,g+=i.strokeWidth)),n>=d&&n<=e&&o>=f&&o<=g&&(s.push(i),p||(t=!0))):n-a.panLeft>=i.left&&n-a.panLeft<=i.left+i.width&&o-a.panTop>=i.top&&o-a.panTop<=i.top+i.height&&(s.push(i),p||(t=!0)));return c=(new Date).getTime()-j,a._getObjectCount++,a._getObjectTime+=c,p?s:s[0]},a.resizeCanvas=function(b,c,d){var e=(new Date).getTime(),f=gpl.resizeDelay,g=a.lastCanvasResize||e-f,h=function(d){var e=b||window.innerWidth,f=c||window.innerHeight;a.canvasResizing=!0,a.canvasWidth=e,a.canvasHeight=f,a.canvas.setWidth(e),a.canvas.setHeight(f),a.canvas.calcOffset(),a.lastCanvasResize=(new Date).getTime(),a.canvasResizing=!1},i=function(){var b=(new Date).getTime();b-a.lastCanvasResize>=f&&h()};!d&&b<a.canvas.width&&c<a.canvas.height||(a.lastWindowResize=e,e-g>=f&&!a.canvasResizing?h():setTimeout(function(){i()},f))},a.renderAll=function(){var b=(new Date).getTime();a.lastRender=b,a.haltRender||(a.canvas.renderAll(),gpl.isEdit&&gpl.canvases.toolbar.renderAll())},a.pauseRender=function(){a.haltRender=!0},a.resumeRender=function(){a.haltRender=!1,a.renderAll()},a.setState=function(b){a.state=b},a.clearState=function(){a.state=null},a.registerHandler=function(b){var d=b.event,e=b.handler,f=[],g=b.type||"canvas",h=b.canvas||a.canvas,i=b.selector,j=b.state||null,k=b.window?window:document,l=$(k),m=function(a,b){return b?function(c){var d=gpl.manager.state;d===b&&a(c)}:a};a.eventHandlers[d]=a.eventHandlers[d]||[],a.eventHandlers[d].push(m(e,j)),c[d]||(c[d]=!0,"canvas"===g?h.on(d,function(b){a.processEvent(d,b)}):(f=[d,function(b){a.processEvent(d,b)}],i&&f.splice(1,0,i),l.on.apply(l,f)))},a.registerHandlers=function(b){var c,d=b.length;for(c=0;c<d;c++)a.registerHandler(b[c])},a.unregisterHandler=function(b){var c,d=b.event,e=b.handler,f=a.eventHandlers[d]||[];for(c=f.length-1;c>=0;c--)f[c]===e&&f.splice(c,1)},a.unregisterHandlers=function(b){var c,d=b.length;for(c=0;c<d;c++)a.unregisterHandler(b[c])},a.processEvent=function(b,c){var d,e=a.eventHandlers[b]||[],f=e.length;for(d=0;d<f;d++)e[d](c)},a.doAddNewButton=function(b){var c,d=gpl.isEdit?gpl.editModeOffset:0;void 0!==b.caption&&(b.left+=d),c=new gpl.ActionButton(b),a.addToBoundingRect(c),a.actionButtons[c.id]=c,$("body").append(c.$el)},a.deleteButton=function(b){var c=b.$el,d=b.id;b.destroy(),delete a.actionButtons[d],c.remove()},a.handleMouseOut=function(b){a._hoveredTarget&&b.target!==a.tooltip&&(a._hoveredTarget=null)},a.openContextMenu=function(b,c,d){var e,f,g=a.getObject({left:b,top:c,yoffset:5,xoffset:5}),h={line:gpl.lineManager.getLine,block:gpl.blockManager.getBlock,text:function(a){return gpl.texts[a]}};"DrawingLine"===a.state||a.modalOpen||a.hasPanned||(a.$contextMenuList.removeClass("block line default nonPoint"),g?(e=h[g.gplType],e?a.$contextMenuList.addClass(g.gplType):(a.$contextMenuList.addClass("block"),e=h.block),"Constant"===g.blockType&&a.$contextMenuList.addClass("nonPoint"),f=e(g.gplId)):a.$contextMenuList.addClass("default"),a.contextMenu.jqxMenu("open",b-5,c-5),a.contextX=b,a.contextY=c,a.contextObject=f)},a.destroy=function(){var b,c=(gpl.destroyFns||[]).length;if(window.destroyed!==!0){for(window.destroyed=!0,a.toolbar&&(gpl.destroyObject(a.toolbar),delete a.toolbar),gpl.forEach(gpl.eventHandlers,function(a){a=[]}),a.canvas.removeListeners(),a.canvas.dispose(),b=0;b<c;b++)gpl.destroyFns[b]();delete gpl.eventHandlers,delete gpl.blockManager,delete gpl.lineManager,delete window.gplData.upi,delete window.gplData.point,delete window.gplData.references,delete window.gplData,gpl.destroyObject(gpl),gpl={},$(document).off(),$(window).off(),$(a.canvas.wrapperEl).remove(),$("body").html("")}},a.handleNavigateAway=function(b){if(a.bindings.hasEdits())return"You have unsaved changes. Are you sure you want to leave this page?"},a.updateTooltip=function(b,c,d){a.modalOpen||void 0===b?a.clearTooltip():(gpl.$tooltip.html(b),gpl.$tooltip.css({left:c+15,top:d+15,display:"block"}))},a.clearTooltip=function(){gpl.$tooltip.css("display","none")},a.showEditVersionModal=function(){gpl.$editVersionModal.modal({keyboard:!1,backdrop:"static"}),gpl.$editVersionModal.modal("show")},a.hideEditVersionModal=function(){gpl.$editVersionModal.modal("hide")},a.initBindings=function(){var b=function(a,b){var c,d=$.extend(!0,{},gpl.point);d[a].Value=b,c=gpl.formatPoint({point:d,oldPoint:gpl.point,property:a}),c.err?gpl.log("Error with sequence point data:",a,"error:",c.err):(gpl.log("Successfully updated sequence point property",a),gpl.point=c)},c=function(c){var d=+a.bindings.deviceUpdateIntervalMinutes()||0+ +a.bindings.deviceUpdateIntervalSeconds()||0;b("Update Interval",d)};a.addToBindings({isEdit:gpl.isEdit,hasEdits:ko.observable(!1),loaded:a.sequenceLoaded,editVersionAvailable:void 0!==gpl.json.editVersion&&!gpl.isEdit,backgroundColor:ko.observable(a.backgroundColor),deviceBackgroundColor:ko.observable(a.backgroundColor),popInOut:a.popInOut,popInOutText:a.popInOutText,popInOutClass:a.popInOutClass,controllers:gpl.controllers,currentZoom:ko.observable(Math.round(100*gpl.scaleValue)),doCancel:function(){a.doCancel()},resetZoom:function(){a.scale(1),a.pan(!0)},editActionButton:function(){var b=a.editBlock,c=b.pointName,d=b.parameter,e=b.type,f=(b.upi,b.text);a.bindings.actionButtonPointName(c),a.bindings.actionButtonText(f),a.bindings.actionButtonParameter(d),a.bindings.actionButtonType(e),a.bindings.actionButtonPointType(b.pointType),gpl.$editActionButtonModal.modal("show")},sendActionButtonValue:function(){var b=parseFloat(a.bindings.actionButtonValue());a.editBlock.sendValue(b),gpl.$editActionButtonValueModal.modal("hide")},openReport:function(){var b=a.bindings;a.editBlock.openReport({reportType:b.actionButtonReportType(),duration:b.actionButtonReportDuration(),fromDate:b.reportFromDate(),fromTime:b.reportFromTime(),toDate:b.reportToDate(),toTime:b.reportToTime()})},updateActionButton:function(){var b=a.bindings,c=b.actionButtonPointName(),d=b.actionButtonText(),e=b.actionButtonType(),f=parseFloat(b.actionButtonParameter()),g=b.actionButtonUpi();isNaN(f)&&(f=b.actionButtonParameter()),a.editBlock.updateConfig({actionPoint:g,caption:d,actionParm:f,pointName:c,type:e}),gpl.$editActionButtonModal.modal("hide")},deleteActionButton:function(){a.deleteButton(a.editBlock),gpl.$editActionButtonModal.modal("hide")},selectActionButtonPoint:function(){gpl.openPointSelector(function(b,c,d){a.bindings.actionButtonPointName(c),a.bindings.actionButtonUpi(b),a.bindings.actionButtonPointType(d)},null,null,null,!0)},showBackgroundColorModal:function(){gpl.$colorpickerModal.modal("show")},hideBackgroundColorModal:function(){a.bindings.deviceBackgroundColor(a.bindings.backgroundColor()),gpl.$colorpickerModal.modal("hide")},updateBackgroundColor:function(){var b=a.bindings.deviceBackgroundColor();a.bindings.backgroundColor(b),a.canvas.backgroundColor="#"+b,
gpl.json.backgroundColor=b,a.renderAll()},applyShowLabel:function(){var b=a.bindings.deviceShowLabel();a.pauseRender(),gpl.blockManager.applyShowLabel(b),a.resumeRender()},applyShowValue:function(){var b=a.bindings.deviceShowValue();a.pauseRender(),gpl.blockManager.applyShowValue(b),a.resumeRender()},applyUpdateInterval:function(){var b=60*a.bindings.deviceUpdateIntervalMinutes()+a.bindings.deviceUpdateIntervalSeconds();gpl.blockManager.applyUpdateInterval(b)},applyController:function(){var b=a.bindings.deviceControllerValue(),c=gpl.controllers[b].name;gpl.blockManager.applyController(c,b)},sequenceName:gpl.point.Name,deviceName:ko.observable(gpl.devicePoint.Name),deviceUpi:ko.observable(gpl.devicePointRef.PointInst),deviceDescription:ko.observable(gpl.point.Description.Value),deviceControllerName:ko.observable(gpl.point.Controller.Value),deviceControllerValue:ko.observable(gpl.point.Controller.eValue),deviceShowLabel:ko.observable(gpl.point["Show Label"].Value),deviceShowValue:ko.observable(gpl.point["Show Value"].Value),deviceUpdateIntervalSeconds:ko.observable(+gpl.point["Update Interval"].Value%60),deviceUpdateIntervalMinutes:ko.observable(Math.floor(+gpl.point["Update Interval"].Value/60)),updateSequenceProperties:function(){var b=ko.toJS(a.bindings);gpl.point["Update Interval"].Value=60*(+b.deviceUpdateIntervalMinutes||0)+(+b.deviceUpdateIntervalSeconds||0),gpl.point["Show Label"].Value=b.deviceShowLabel,gpl.point["Show Value"].Value=b.deviceShowValue,gpl.point.Description.Value=b.deviceDescription,gpl.point.Controller.Value=b.deviceControllerName,gpl.point.Controller.eValue=b.deviceControllerValue,a.bindings.updateBackgroundColor(),gpl._newDevicePoint&&gpl.devicePoint._id!==gpl._newDevicePoint._id&&(gpl.devicePoint=gpl._newDevicePoint,gpl.deviceId=gpl._newDevicePoint._id,gpl.blockManager.forEachBlock(function(a){gpl.log("processing block",a.gplId),a.isNonPoint!==!0&&a.formatPointFromData(null,null,"Device Point",gpl.devicePoint),gpl.fire("editedblock",a)})),delete gpl._newDevicePoint,gpl.$sequencePropertiesModal.modal("hide")},showUpdateSequenceModal:function(){gpl.isEdit&&(delete gpl._newDevicePoint,gpl.$sequencePropertiesModal.modal("show"))},selectDevicePoint:function(){gpl.openPointSelector(function(b,c){var d=$.extend(!0,{},gpl.point);d["Point Refs"][0].Value=b,d=gpl.formatPoint({oldPoint:gpl.point,point:d,property:"Sequence Device"}),d.err?(gpl.log("Error setting device point:",d.err),gpl.showMessage("Error setting device point: "+d.err)):(a.bindings.deviceName(c),a.bindings.deviceUpi(b),gpl.log("Set device point Successfully"),$.ajax({url:"/api/points/"+b}).done(function(a){gpl._newDevicePoint=a}))},null,"Device","Device Point",{})},addNewButton:function(){var b=(gpl.makeId(),{left:a.contextX,top:a.contextY});a.doAddNewButton(b)},addNewDynamic:function(){d("NewDynamic")},addNewText:function(){var b=gpl.blockManager.create({cls:gpl.blocks.TextBlock,cfg:{left:(a.contextX-15)/gpl.scaleValue,top:(a.contextY-10)/gpl.scaleValue,text:"Text"}});gpl.blockManager.openTextEditor(b)}}),a.bindings.currentZoom.subscribe(function(b){a.scale(b/100,!0)}),a.bindings.deviceUpdateIntervalMinutes.subscribe(c),a.bindings.deviceUpdateIntervalSeconds.subscribe(c),a.bindings.deviceShowValue.subscribe(function(a){b("Show Value",a)}),a.bindings.deviceShowLabel.subscribe(function(a){b("Show Label",a)}),a.bindings.backgroundColorHex=ko.computed(function(){var b="#"+a.bindings.backgroundColor();return gpl.isEdit||gpl.$body.css("background-color",b),b}),a.$saveButton.click(function(){a.doSave()}),a.$saveForLaterButton.click(function(){a.doSaveForLater()}),a.$editButton.click(function(){a.doEdit()}),a.$cancelButton.click(function(){gpl.isCancel=!0,a.bindings.hasEdits(!1),gpl.blockManager.handleUnload(),gpl.lineManager.prepSaveData(gpl.json),delete gpl.json.editVersion,m(!0),gpl.saveSequence(),setTimeout(function(){a.doCancel()},100)}),a.$quitButton.click(function(){a.doCancel()}),a.$validateButton.click(function(){a.validate()}),gpl.$messageModal.modal({show:!1}),ko.bindingHandlers.colorpicker={init:function(a,b,c,d,e){var f=b(),g=ko.unwrap(f),h=$(a);h.parent();f.subscribe(function(a){h.jqxColorPicker("setColor",a)}),h.jqxColorPicker({colorMode:"hue",width:220,height:200}),h.jqxColorPicker("setColor",g),h.on("colorchange",function(a){f(a.args.color.hex)})}},ko.bindingHandlers.numeric={init:function(a,b){$(a).on("keydown",function(a){46==a.keyCode||8==a.keyCode||9==a.keyCode||27==a.keyCode||13==a.keyCode||65==a.keyCode&&a.ctrlKey===!0||188==a.keyCode||190==a.keyCode||110==a.keyCode||a.keyCode>=35&&a.keyCode<=39||(a.shiftKey||(a.keyCode<48||a.keyCode>57)&&(a.keyCode<96||a.keyCode>105))&&a.preventDefault()})}},ko.bindingHandlers.datepicker={init:function(a,b,c){var d={autoclose:!0,startView:"year",onSelect:function(a,c){b()(new Date(a))}};$(a).datepicker(d)},update:function(a,b){var c=ko.utils.unwrapObservable(b());$(a).datepicker("setDate",c)}},ko.bindingHandlers.clockpicker={init:function(a,b,c){var d=b(),e={doneText:"Done",autoclose:!0,afterDone:function(){d($(a).val())}};$(a).clockpicker(e),$(a).change(function(b){$(a).clockpicker("resetclock")})},update:function(a,b){var c,d,e=ko.utils.unwrapObservable(b());"string"!=typeof e?(c=("00"+Math.floor(e/100)).slice(-2),d=("00"+e%100).slice(-2),$(a).val(c+":"+d)):$(a).val(e)}}},a.initCanvas=function(){var b={renderOnAddRemove:!1,selection:!1,backgroundColor:"#"+a.backgroundColor,hasControls:!1,hoverCursor:"default"},c={renderOnAddRemove:!1,selection:!1,hasControls:!1,hoverCursor:"default"},d={renderOnAddRemove:!1,backgroundColor:"#"+a.backgroundColor,hasControls:!1,selection:!1,draggable:!1,hoverCursor:"default"};fabric.Group.prototype.hasControls=!1,fabric.Group.prototype.removeWithoutUpdate=function(a){return this._moveFlippedObject(a),this._restoreObjectsState(),this.forEachObject(this._setObjectActive,this),this.remove(a),this._calcBounds(),this._updateObjectsCoords(),this},fabric.Group.prototype.doRemoveUpdates=function(){this.forEachObject(this._setObjectActive,this),this._calcBounds(),this._updateObjectsCoords()},fabric.Group.prototype.addMultipleWithUpdate=function(){this.forEachObject(this.addWithUpdate,this)},fabric.Canvas.prototype._renderAll=fabric.Canvas.prototype.renderAll,fabric.Canvas.prototype.renderAll=function(){a.haltRender||this._renderAll()},a.$mainCanvasEl.attr({width:window.innerWidth||1024,height:window.innerHeight||800}),gpl.isEdit?(a.canvas=new fabric.Canvas(a.mainCanvasElId,b),gpl.canvases.main=a.canvas,a.toolbarCanvas=new fabric.Canvas("toolbarCanvas",c),gpl.canvases.toolbar=a.toolbarCanvas):(gpl.nobg&&delete d.backgroundColor,a.canvas=new fabric.Canvas(a.mainCanvasElId,d),gpl.canvases.main=a.canvas),a.$mainUpperCanvas=$("#"+a.mainCanvasElId+" + .upper-canvas"),a.$mainCanvasContainer=$("#"+a.mainCanvasElId).parent(),a._getObjectCount=0,a._getObjectTime=0,a.showCoordinateText=function(){a.coordinateText=new fabric.Text("x,x",{top:0,left:window.innerWidth-200,textAlign:"center",fontSize:12,fontFamily:"arial",gplType:"label"}),a.canvas.add(a.coordinateText),a.registerHandler({event:"mouse:move",handler:function(b){var c=a.canvas.getPointer(b.e);a.coordinateText.text=Math.round(c.x)+","+Math.round(c.y),a.renderAll()}})},fabric.Canvas.prototype.sendToBackGPL=function(a){fabric.util.removeFromArray(this._objects,a),this._objects.unshift(a)},fabric.Canvas.prototype.bringToFrontGPL=function(a){fabric.util.removeFromArray(this._objects,a),this._objects.push(a)},a.sendToBack=function(b){a.canvas.sendToBackGPL(b)},a.bringToFront=function(b,c){(c||a.canvas).bringToFrontGPL(b)}},a.initToolbar=function(){gpl.isEdit&&(a.toolbar=new gpl.Toolbar(a))},a.initManagers=function(){gpl.blockManager=new gpl.BlockManager(a),gpl.lineManager=new gpl.LineManager(a)},a.initQualityCodes=function(){var a,b,c=gpl._qualityCodes.Entries;for(gpl.qualityCodes={},a=0;a<c.length;a++)b=c[a],gpl.qualityCodes[b["Quality Code Label"]]={color:b["Quality Code Font HTML Color"],text:b["Quality Code"]}},a.initShapes=function(){var b,c,e,f,g,h,j,k,l,n,o,p,q,r=gpl.json,s=r.line||[],t=r.block||[],u=r.dynamic||[],v=!1;for(i(),gpl.isEdit&&m(),p=0;p<u.length;p++)b=u[p],a.doAddNewButton(b);for(p=0;p<t.length;p++)c=t[p],c._idx=p,f=a.blockTypes[c.blockType||c.type],f&&(e=f.blockType,e&&gpl.blocks[e]&&(v=!0,gpl.blockManager.isActiveUPI(c,gpl.blocks[e])&&(l=$.extend(!0,{},c),l.iconType=c.blockType,l._idx=p,gpl.isEdit||(l.selectable=!1,l.draggable=!1,l.lockMovementX=!0,l.lockMovementY=!0),o=gpl.blockManager.create({cls:gpl.blocks[e],cfg:l}),c.gplId=o.gplId))),v||d("******* ERROR: block type",c.blockType,"not found *******"),v=!1;for(p=0;p<s.length;p++){for(k=[],g=s[p],h=g.handle,q=0;q<h.length;q++)j=h[q],k.push({x:j.x,y:j.y});n=new gpl.ConnectionLine(k,a.canvas,g.isNew||!1),a.shapes.push(n)}a.renderAll()},a.initKnockout=function(){ko.applyBindings(a.bindings)},a.initSocket=function(){if(!gpl.noSocket){var b=io.connect(window.location.origin);a.socket=gpl.socket=b,a.pauseRender(),b.on("connect",function(){var a={};a.socketid=b.id,a.display={},a.display["Screen Objects"]=gpl.blockManager.screenObjects,gpl.isEdit||b.emit("displayOpen",{data:a})}),a.keepAliveInterval=setInterval(function(){$.ajax({url:"/home"}).done(function(a){})},9e5),b.on("recieveUpdate",function(a){var b=a.upi,c=a.dynamic;gpl.blockManager.processValue(b,c)}),b.on("sequenceUpdateMessage",function(b){gpl.showMessage("Sequence Saved"),a.doCompleteSave&&(a.doCompleteSave=!1,a.afterSave())}),b.on("sequencePointsUpdated",function(a){gpl.blockManager.resetChanges()}),a.registerHandler({event:"unload",handler:function(){b.disconnect()},type:"DOM",window:!0}),a.keepAliveInterval=function(){var a,c=function(){b.emit("doRefreshSequence",{sequenceID:gpl.upi})};return c(),a=setInterval(c,3e5)}()}},a.initEvents=function(){window.onbeforeunload=a.handleNavigateAway,a.registerHandlers([{event:"unload",type:"DOM",window:!0,handler:function(){a.destroy()}},{event:"mouseup",type:"DOM",window:!0,handler:function(b){var c=$(window).scrollTop(),d=$(window).scrollLeft(),e=parseInt(b.clientX,10)+5+d,f=parseInt(b.clientY,10)+5+c;3===b.which&&(a.openContextMenu(e,f,b),b.preventDefault())}},{event:"mousemove",type:"DOM",handler:function(b){var c,d,e,f,g=b.pageX,h=b.pageY,i=b.originalEvent.movementX,j=b.originalEvent.movementY,k=-.01;a.middleMouseDown?(c=gpl.scaleValue+k*j,c>gpl.MAXZOOM?c=gpl.MAXZOOM:c<gpl.MINZOOM&&(c=gpl.MINZOOM),a.scale(c)):a.rightClickDown?a.pan(i,j):(e=a.canvas.findTarget(b),e?(f=e?gpl.blockManager.getBlock((e||{}).gplId):null,f&&!f.isToolbar&&"Constant"!==f.blockType?(d=(gpl.pointUpiMap[f.upi]||{}).Name,a.updateTooltip(d,g,h)):a.clearTooltip()):gpl.isEdit?(e=a.toolbarCanvas.findTarget(b),f=e?gpl.blockManager.getBlock((e||{}).gplId):null,f?(d=f.blockType,a.updateTooltip(d,g,h)):a.clearTooltip()):a.clearTooltip())}},{event:"mouseup",type:"DOM",handler:function(b){a.middleMouseDown=!1,a.rightClickDown=!1,a.hasPanned=!1}},{event:"click",type:"DOM",handler:function(b){var c,d=$(b.target);d.hasClass("actionBtn")&&(c=a.actionButtons[d.attr("data-actionButtonID")],a.editBlock=c,gpl.isEdit?c&&a.bindings.editActionButton():c&&c.click())}},{event:"object:moving",handler:function(b){var c,d,e,f,g={},h={left:b.target.left-b.target._originalLeft,top:b.target.top-b.target._originalTop};if(b.target.set({left:Math.round(b.target.left/gpl.gridSize)*gpl.gridSize,top:Math.round(b.target.top/gpl.gridSize)*gpl.gridSize}),b.target instanceof fabric.Group)for(d=b.target._objects,c=0;c<d.length;c++)e=d[c],e.gplType&&(g[e.gplId]||(f=gpl.blockManager.blocks[e.gplId],f&&(g[e.gplId]={gplObject:f,object:e})));a.movedObjects=g;for(e in g)g.hasOwnProperty(e)&&g[e].gplObject.setOffset(h)}},{event:"selection:cleared",handler:function(b){var c,d=a.movedObjects;if(d)for(c in d)d.hasOwnProperty(c)&&d[c].gplObject.resetOffset();a.gplObjects=null}},{event:"selection:created",handler:function(b){a.canvas.deactivateAll()}},{event:"mouse:up",handler:function(b){a.mouseDown=!0;var c=a.canvas.getPointer(b.e),d=c.x,e=c.y,f=gpl.manager.getObject({left:d,top:e,gplType:"anchor"});gpl.isEdit&&null===gpl.manager.state&&!a.isEditingLine&&f&&1===b.e.which&&(d=f.left+f.width/2,e=f.top+f.height/2,a.shapes.push(new gpl.SchematicLine(d,e,f,a,f.isVertical)))}},{event:"mouse:up",handler:function(b){var c,e,f=a.canvas.getPointer(b.e),g=f.x,h=f.y;gpl._rightClickTargets=gpl._rightClickTargets||[],3===b.e.which&&(e=gpl.manager.getObject({left:g,top:h}),e&&(c=gpl.blockManager.getBlock(e.gplId),c?d(c):(c=gpl.lineManager.getLine(e.gplId),c&&d(c))))}},{event:"keydown",handler:function(b){var c,e,f,g,h,i;if(gpl.isEdit&&b.which===gpl.DELETEKEY){if(c=a.canvas.getActiveGroup(),e=a.canvas.getActiveObject(),c){for(c=c._objects,h=0;h<c.length;h++)e=c[h],g=e.gplId,a.canvas.remove(e),f=gpl.lineManager.lines[g]||gpl.blockManager.blocks[g],f&&(f instanceof gpl.ConnectionLine?gpl.fire("removeline",f):gpl.fire("deleteblock",f));f=null}e&&("block"===e.gplType?(f=gpl.blockManager.blocks[e.gplId],i="deleteblock"):e instanceof fabric.Line?(f=gpl.lineManager.lines[e.gplId],i="removeline"):e instanceof gpl.blocks.TextBlock?(f=gpl.texts[e.gplId],i="deleteblock"):d("invalid block")),a.canvas.discardActiveObject(),a.canvas.discardActiveGroup(),f&&gpl.fire(i,f),a.renderAll()}},type:"DOM"}]),$("body").on("hide.bs.modal",".modal",function(){a.modalOpen=!1}),$("body").on("show.bs.modal",".modal",function(){a.modalOpen=!0}),gpl.on("newblock",function(b){a.addToBoundingRect(b)}),gpl.on("openwindow",function(){a.clearTooltip(),a.contextMenu.jqxMenu("close")}),a.handleColorChange=function(b){a.bindings.deviceBackgroundColor(b)},a.bgColorPicker=new CustomColorsPicker(gpl.$bgColorPicker,a.handleColorChange,a.backgroundColor),a.bgColorPicker.render()},n()},$(function(){gpl.skipInit||gpl.initGpl()});
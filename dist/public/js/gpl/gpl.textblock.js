fabric.Textbox=fabric.util.createClass(fabric.IText,fabric.Observable,{defaultWeight:"normal",defaultFill:"#000000",defaultFontSize:12,toolbarHeight:30,toolbarOffsetTop:6,toolbarOffsetLeft:-8,toolbarWidth:30,proxyOffsetLeft:8,isNonPoint:!0,useNativeEdit:!0,type:"TextBlock",gplType:"text",minWidth:30,initialize:function(a){this.convertConfig(a),this.callSuper("initialize",this.text,this.config),this.set("lockUniScaling",!1),this.set("lockScalingY",!0),this.set("hasBorders",a.hasBorders),this.setControlsVisibility({tl:!1,tr:!1,br:!1,bl:!1,ml:!0,mt:!1,mr:!0,mb:!1,mtr:!0}),this.gplId=gpl.makeId(),gpl.texts[this.gplId]=this,gpl.blockManager.registerBlock(this)},convertConfig:function(a){var b=a,c=b.font,d={1:"right",0:"left"};this.config=a,c?(b.fontWeight=c.bold?"bold":"normal",b.fill="#"+gpl.convertColor(c.color||0),b.fontSize=parseInt(c.size,10)||this.defaultFontSize,b.textDecoration=c.underline?"underline":"",b.fontFamily=c.name||"Arial"):(b.fontWeight=this.defaultWeight,b.fill=this.defaultFill,b.fontSize=this.defaultFontSize),b.originX="left",b.originY="top",b.Font&&"true"===b.Font.Underline&&(b.textDecoration="underline"),this.config.left+=10,this.config.top+=5,this.config.selectable=!!gpl.isEdit,this.config.width=parseInt(this.config.width,10)||this.minWidth,this.config.height=null,this.config.textAlign=d[b.alignment]||"center",$.extend(this,this.config),this.text=this.config.label||"ABC"},setActive:function(){this.inactive=!1,this.setCoords()},"delete":function(){gpl.manager.canvas.remove(this),delete gpl.texts[this.gplId]},_wrapText:function(a,b){var c,d=b.split(this._reNewline),e=[];for(c=0;c<d.length;c++)e=e.concat(this._wrapLine(a,d[c]+"\n"));return e},_wrapLine:function(a,b){var c,d=this.width,e=b.split(" "),f=[],g="";if(a.measureText(b).width<d)f.push(b);else for(;e.length>0;){if(d<=a.measureText("W").width)return b.split("");for(;Math.ceil(a.measureText(e[0]).width)>=d;)c=e[0],e[0]=c.slice(0,-1),e.length>1?e[1]=c.slice(-1)+e[1]:e.push(c.slice(-1));Math.ceil(a.measureText(g+e[0]).width)<d?g+=e.shift()+" ":(f.push(g),g=""),0===e.length&&f.push(g.substring(0,g.length-1))}return f},_getTextLines:function(a){var b;return a=a||this.ctx,a.save(),this._setTextStyles(a),b=this._wrapText(a,this.text),a.restore(),b},_renderViaNative:function(a){var b;this._setTextStyles(a),b=this._wrapText(a,this.text),this.height=this._getTextHeight(a,b),this.clipTo&&fabric.util.clipContext(this,a),this._renderTextBackground(a,b),this._translateForTextAlign(a),this._renderText(a,b),"left"!==this.textAlign&&"justify"!==this.textAlign&&a.restore(),this._renderTextDecoration(a,b),this.clipTo&&a.restore(),this._setBoundaries(a,b),this._totalLineHeight=0},get2DCursorLocation:function(a){void 0===a&&(a=this.selectionStart);var b,c,d,e=0,f=[],g=this._getTextLines();for(b=a;b>=0&&!(e>g.length-1);)b-=g[e].length,b<0?f[f.length]=g[e].slice(0,b+g[e].length):f[f.length]=g[e],e++;return e--,c=f[f.length-1],d=c.length,f[e]===g[e]&&e+1<g.length-1&&(e++,d=0),{lineIndex:e,charIndex:d}},_getCursorBoundariesOffsets:function(a,b,c,d){var e,f,g,h=0,i="cursor"===b?this._getHeightOfLine(this.ctx,0)-this.getCurrentCharFontSize(c.lineIndex,c.charIndex):0;for(e=d[c.lineIndex].split(""),f=0;f<c.charIndex;f++)h+=this._getWidthOfChar(this.ctx,e[f],c.lineIndex,f);for(f=0;f<c.lineIndex;f++)i+=this._getCachedLineHeight(f);return g=this._getCachedLineOffset(c.lineIndex,d),this._clearCache(),{top:i,left:h,lineLeft:g}},toObject:function(a){return fabric.util.object.extend(this.callSuper("toObject",a),{minWidth:this.minWidth})}}),fabric.Textbox.fromObject=function(a){return new fabric.Textbox(a.text,fabric.util.object.clone(a))},fabric.Textbox.instances=[],fabric.Textbox.__setObjectScaleOverridden=fabric.Canvas.prototype._setObjectScale,fabric.Canvas.prototype._setObjectScale=function(a,b,c,d,e,f){var g,h=b.target,i=fabric.Textbox.__setObjectScaleOverridden;"TextBlock"===h.type?(g=h.width*(a.x/b.scaleX/(h.width+h.strokeWidth)),g>=h.minWidth&&h.set("width",g)):i.call(fabric.Canvas.prototype,a,b,c,d,e,f)},fabric.util.object.extend(fabric.Textbox.prototype,{getDownCursorOffset:function(a,b){return this.callSuper("getDownCursorOffset",a,b)-1},getUpCursorOffset:function(a,b){return this.callSuper("getUpCursorOffset",a,b)-1}});
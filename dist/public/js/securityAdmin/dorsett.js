var dorsett=function(){var a=window.location.origin,b=a+"/api/security/",c=a+"/pointlookup",d="",e=function(){var a={user:"group",group:"user"},b="";this.typeName=function(c){return b=c?a[c]:b}},f=function(a){var b=this[a];return delete this[a],b},g={required:!0,pattern:{message:"Invalid phone number.",params:/^\(?([2-9][0-8][0-9])\)?[-. ]?([2-9][0-9]{2})[-. ]?([0-9]{4})$/}},h=function(){$("#DT_Security_panel").on("mouseenter","li",function(){$(this).find(".closeBtn").show()}).on("mouseleave","li",function(){$(this).find(".closeBtn").hide()})},i=function(a){var b;for(prop in a)b=a[prop],b&&"undefined"!=typeof b.Value&&(a[prop]=b.Value);return a},j=function(a,b){return a==b?0:a<b?-1:1},k=function(a,b){var c=j,d=j;return a&&(d=function(b,d){return c(a(b),a(d))}),b?function(a,b){return-1*d(a,b)}:d};return{domContext:{},headerContext:{},domContextHeight:ko.observable(),domContextWidth:ko.observable(),draggedItem:{},groupData:{},userData:{},editData:{},msg:{},draggableType:new e,initialize:function(a){var b=this,c=($("#DT_Security_sections"),$("#loadingTitle"),$("#loadingScreen"));infuser.defaults.templateUrl="js/securityAdmin/views",infuser.defaults.templateSuffix=".tmpl.htm",infuser.defaults.templatePrefix="",Messenger.options={extraClasses:"messenger-fixed messenger-on-top",theme:"future"},$.when(b.getUsers(),b.getGroups()).done(function(){b.domContext=a,b.headerContext=$("#DT_Security_header"),b.resize(),b.domContext.resize(function(){b.resize()}),ko.applyBindings(b,$("#DT_Security_main")[0]),setTimeout(function(){c.addClass("animated fadeOut"),setTimeout(function(){c.hide(),c.removeClass("animated fadeOut")},1e3)},500)}),h()},getGroups:function(){var a=this,c=function(){return dorsett.sortBy("User Group Name")};return $.ajax({url:b+"groups/getallgroups",contentType:"application/json",dataType:"json",type:"post"}).done(function(b){var d=0,e=b.length;for(d;d<e;d++)b[d]=i(b[d]);"undefined"==typeof a.groupData.allData?a.groupData=new dorsett.PagedObservableArray({pageSize:500,searchFields:["User Group Name"],data:b,sort:c}):a.groupData.allData(b)})},getUsers:function(){var a=this,c=function(){return dorsett.sortBy("Last Name","First Name")};return $.ajax({url:b+"users/getallusers",contentType:"application/json",dataType:"json",type:"post"}).done(function(b){console.log(b.Users);var d=b.Users,e=0,f=d.length;for(e;e<f;e++)d[e]=i(d[e]);"undefined"==typeof a.userData.allData?a.userData=new dorsett.PagedObservableArray({pageSize:500,searchFields:["First Name","Last Name","username"],data:d,sort:c}):a.userData.allData(d)})},resize:function(){var a=this,b=a.domContext.height()-a.headerContext.outerHeight(),c=a.domContext.width()-$("#DT_Security_panel").outerWidth();a.domContextHeight(b),a.domContextWidth(c)},showPanel:function(a,b){if(b._id&&b._id==dorsett.editData._id)return dorsett.hidePanel();var c=$("#DT_Security_panel"),d=$("#DT_Security_panelWindow"),e=$("#DT_Security_sections"),f=ko.utils.parseJson(ko.toJSON(dorsett.groupData.allData())),g=[];dorsett.draggableType.typeName(a),"group"==a&&(dorsett.editData=new dorsett.models.groupModel(b),dorsett.editData.pAccess=function(a){return ko.computed({read:function(){return!!(this._pAccess()&a)},write:function(b){console.log(this),b?this._pAccess(this._pAccess()|a):this._pAccess(this._pAccess()&~a)}},dorsett.editData)}),"user"==a&&(dorsett.editData=new dorsett.models.userModel(b),dorsett.editData.Password=ko.observable(""),g=ko.utils.arrayFilter(f,function(a){a._id;if(void 0==a.Users)return!1;for(var b in a.Users)if(a.Users.hasOwnProperty(b)&&b==dorsett.editData._id)return a["Group Admin"]=a.Users[b]["Group Admin"],!0}),dorsett.editData.Groups=ko.observableArray(ko.utils.arrayMap(g,function(a){return{groupid:a._id,"User Group Name":a["User Group Name"],"Group Admin":a["Group Admin"]}}))),dorsett.editData.isEditMode=ko.observable(!1),dorsett.editData.errors=ko.validation.group(dorsett.editData,{deep:!0}),ko.removeNode(d[0]),infuser.get("panel_"+a,function(a){var d=$(a)[0];ko.applyBindingsWithValidation(dorsett.editData,d,{registerExtenders:!0,messagesOnModified:!0,insertMessages:!1,decorateElement:!1,errorElementClass:"input-validation-error",errorMessageClass:"error",grouping:{deep:!0}}),c.html($(d)),c.trigger("create"),c.tween({right:{duration:.3,stop:0,effect:"circIn"}}),e.tween({paddingRight:{duration:.3,stop:380,effect:"circIn",onStop:function(){$.isEmptyObject(b)&&dorsett.editMode()}}}),e.find(".group, .user").draggable("disable"),$.play()})},hidePanel:function(){var a=$("#DT_Security_sections");dorsett.editData={isEditMode:ko.observable(!1),errors:ko.validation.group(dorsett.editData,{deep:!0})},a.find(".group, .user").draggable("disable"),$("#DT_Security_panel").tween({right:{duration:.3,stop:-380,effect:"circIn"}}),a.tween({paddingRight:{duration:.3,stop:0,effect:"circIn"}}),$.play()},editUserPhoto:function(){d="users",console.log("editPhoto"),$(".uploadPhoto").click()},editGroupPhoto:function(){d="groups",console.log("editPhoto"),$(".uploadPhoto").click()},uploadImage:function(a){var c=new FileReader,e=new FormData,f={},g=function(a){console.log(a),e.append("name",a.fileName),e.append("image",a.image),e.append("user",dorsett.editData._id),$.ajax({url:b+d+"/editPhoto",processData:!1,type:"POST",cache:!1,contentType:!1,data:e}).success(function(a){console.log("success",a.imageUrl),$("#singlePhoto").css({backgroundImage:"url(img/users/"+a.imageUrl+")"}),dorsett.getUsers(),dorsett.getGroups(),console.log(dorsett.editData.Photo())}).error(function(a){console.log("err",a)})};c.onload=function(){f.image=c.result,f.fileName=a.name,g(f)},c.readAsDataURL(a)},getUserById:function(a){var b=this;return ko.utils.arrayFirst(b.userData.allData(),function(b){return b._id==a})},getGroupById:function(a){var b=this;return ko.utils.arrayFirst(b.groupData.allData(),function(b){return b._id==a})},editMode:function(){var a=$("#DT_Security_panel"),b=$("#DT_Security_sections");dorsett.editData.isEditMode(!0),a.trigger("create"),b.find("."+dorsett.draggableType.typeName()).draggable("enable"),a.find("input[type=text]:first").focus()},cancelEditMode:function(){var a=$("#DT_Security_panel"),b=$("#DT_Security_sections"),c=dorsett.editData.Password?"user":"group",d=dorsett.editData._id;isNew=!d,data={},isNew?(dorsett.showPanel(c,{}),dorsett.hidePanel()):(dorsett.editData={},dorsett.showPanel(c,"user"==c?dorsett.getUserById(d):dorsett.getGroupById(d))),dorsett.editData.isEditMode(!1),a.trigger("create"),b.find(".group, .user").draggable("disable")},saveUser:function(){var a,c,d=dorsett.editData["First Name"]()+" "+dorsett.editData["Last Name"]();return dorsett.editData.isValid()?(a=ko.data.projections.projectVM(dorsett.editData,{_id:"",username:"",Password:"","Password Reset":[!1,!1],"Last Login Time":"","Last Activity Time":"","Auto Logout Duration":[0,null],"Session Length":[0,null],"First Name":"","Last Name":"","System Admin":[!1,!1],Photo:"",Title:"","Contact Info":[{Type:"",Value:"",Name:""}],Groups:[{groupid:"","Group Admin":[!1,!1]}]}),f.call(a,"Photo"),f.call(a,"Last Login Time"),f.call(a,"Last Activity Time"),a["User Groups"]=f.call(a,"Groups"),a._id?(""==a.Password&&f.call(a,"Password"),c={userid:f.call(a,"_id"),"Update Data":a}):(f.call(a,"_id"),c=a),void $.ajax({type:"POST",url:b+"users/saveuser",dataType:"json",contentType:"application/json",data:ko.toJSON(c)}).pipe(function(a,b,c){a._id||"success"==a.message?$.when(dorsett.getUsers(),dorsett.getGroups()).done(function(){Messenger().hideAll(),Messenger().post({type:"info",message:d+" saved successfully.",hideAfter:3}),dorsett.hidePanel()}):a.message&&dorsett.alertMessage("Message",a.message)})):void dorsett.editData.errors.showAllMessages()},deleteUser:function(){var a=$(".confirmDialog"),c=dorsett.editData["First Name"]()+" "+dorsett.editData["Last Name"]();return a.find(".title").text("Confirm Delete"),a.find(".message").text("Are you sure you want to remove "+c+"?"),a.off("click").on("click",".delete",function(){$.ajax({type:"POST",url:b+"users/removeuser",dataType:"json",contentType:"application/json",data:ko.toJSON({userid:dorsett.editData._id})}).pipe(function(a,b,d){"success"==a.message?$.when(dorsett.getUsers(),dorsett.getGroups()).done(function(){dorsett.hidePanel(),$(".confirmDialog").one("popupafterclose",function(){Messenger().hideAll(),Messenger().post({type:"info",message:c+" was removed successfully.",hideAfter:3})}).popup("close")}):a.message&&dorsett.alertMessage("Message",a.message)})}),!0},saveGroup:function(){var a,c;return dorsett.editData.isValid()?(a=ko.data.projections.projectVM(dorsett.editData,{_id:"","User Group Name":"",Description:"",_pAccess:0,Users:[{userid:"","Group Admin":[!1,!1]}],Photo:""}),a._id?c={"User Group Upi":f.call(a,"_id"),"Update Data":a}:(f.call(a,"_id"),c=a),void $.ajax({type:"POST",url:b+"groups/savegroup",dataType:"json",contentType:"application/json",data:ko.toJSON(c)}).pipe(function(a,b,c){a._id||"success"==a.message?$.when(dorsett.getUsers(),dorsett.getGroups()).done(function(){Messenger().hideAll(),Messenger().post({type:"info",message:dorsett.editData["User Group Name"]()+" saved successfully.",hideAfter:3}),dorsett.hidePanel()}):a.message?dorsett.alertMessage("Message",a.message):a.err&&dorsett.alertMessage("Message","<p>An error has occurred.</p>\n\n "+a.err.err)})):void dorsett.editData.errors.showAllMessages()},deleteGroup:function(){var a=$(".confirmDialog"),c=dorsett.editData["User Group Name"]();return a.find(".title").text("Confirm Delete"),a.find(".message").text("Are you sure you want to remove "+c+"?"),a.off("click").on("click",".delete",function(){$.ajax({type:"POST",url:b+"groups/removegroup",dataType:"json",contentType:"application/json",data:ko.toJSON({"User Group Upi":dorsett.editData._id})}).pipe(function(a,b,d){"success"==a.message?$.when(dorsett.getUsers(),dorsett.getGroups()).done(function(){dorsett.hidePanel(),$(".confirmDialog").one("popupafterclose",function(){Messenger().hideAll(),Messenger().post({type:"info",message:c+" was removed successfully.",hideAfter:3})}).popup("close")}):a.message&&dorsett.alertMessage("Message",a.message)})}),!0},alertMessage:function(a,b){var c=$(".popupDialog");c.find(".title").text(a),c.find(".message").html(b),c.popup("open")},removeGroupFromUser:function(a){dorsett.editData.Groups.remove(a)},removeUserFromGroup:function(a){dorsett.editData.Users.remove(a)},removeContactInfo:function(a){dorsett.editData["Contact Info"].remove(a)},openPasswordDialog:function(){var a=$(".passwordDialog");return a.find(".firstName").text(dorsett.editData["First Name"]()),a.find(".password").val(dorsett.editData.Password()),a.find(".btnCopy").zclip({path:"js/ZeroClipboard.swf",copy:function(){return dorsett.editData.Password()}}),dorsett.editData["Password Reset"](!0),!0},generatePassword:function(a,b){for(var c,d=0,e="";d<a;){if(c=Math.floor(100*Math.random())%94+33,!b){if(c>=33&&c<=47)continue;if(c>=58&&c<=64)continue;if(c>=91&&c<=96)continue;if(c>=123&&c<=126)continue}d++,e+=String.fromCharCode(c)}return e},openContactInfoDialog:function(){return $(".contactInfoDialog").find(".firstName").text(dorsett.editData["First Name"]()),!0},addContactInfo:function(){var a=$("#DT_Security_panel"),b=$("#contactInfoList"),c=dorsett.editData["Contact Info"],d=$(".contactInfoDialog");return""==d.find("select.contactOptions").val()||""==d.find(".value").val()?(alert("Choose a Type and enter a Value."),!1):(c.push(new dorsett.models.contactInfoModel({Type:d.find("select.contactOptions").val(),Name:d.find(".name").val(),Value:d.find(".value").val()})),c()[c().length-1].Value.isModified(!0),a.trigger("create"),b.listview("refresh"),d.find("select.contactOptions").val("").selectmenu("refresh",!0),d.find(".name").val(""),d.find(".value").val(""),!0)},contactValidationMap:[{type:"Email",val:{required:!0,email:!0}},{type:"SMS",val:g,mask:"9999999999"},{type:"Voice",val:g,mask:"9999999999"}],userCount:function(a,b){var c,d=0;for(c in this){var e=ko.utils.arrayFirst(dorsett.userData.allData(),function(a){return a._id==c});e&&d++}return a&&b?d+" "+(1==d?a:b):d},viewPointAccess:function(a){var b,d=dorsett.editData._id,e=dorsett.editData["User Group Name"](),f=(window.opener||window.top).workspaceManager;b=f.openWindowPositioned([c,"/security/",d].join(""),"Group Permissions","groupPermissions","groupPermissions","groupPermissions",{width:960,height:600,callback:function(){b.pointLookup.init(null,{groupid:d,groupname:e})}})},setMask:function(a,b){var c,d=$(a.target);return c=ko.utils.arrayFirst(dorsett.contactValidationMap,function(a){return a.type==d.val()}),"undefined"==typeof c.mask?void $(b).unmask():void $(b).mask(c.mask)},sortBy:function(){for(var a,b,c,d=[],e=arguments.length,f=0;f<e;f++)a=arguments[f],"string"==typeof a?(b=a,c=j):(b=a.name,c=k(a.primer,a.reverse)),d.push({name:b,cmp:c});return function(b,c){for(var f,g,h=0;h<e&&(g=0,a=d[h],f=a.name,g=a.cmp(b[f],c[f]),0===g);h++);return g}},scale:function(a,b,c,d){var e,f,g=$(window).width()-30,h=$(window).height()-30,i=2*c,j=2*d,k=a+i+j,l=b+i+j;return k<g&&l<h?(f=k,e=l):k/g>l/h?(f=g,e=g/k*l):(e=h,f=h/l*k),{width:f-(i+j),height:e-(i+j)}}}}();
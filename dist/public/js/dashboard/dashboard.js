var tou={itemIdx:0,idxPrefix:"tou_",dateFormat:"M-D-YYYY",backgroundFolder:"/img/dashboard/backgrounds/",HOUR:36e5,DAY:864e5,WEEK:6048e5,makeId:function(){return tou.itemIdx++,tou.idxPrefix+tou.itemIdx},logLinePrefix:!0,fullDayList:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],shortDayList:["sun","mon","tue","wed","thu","fri","sat"],fullMonthList:["January","February","March","April","May","June","July","August","September","October","November","December"],saveErrorText:"We encountered an error and could not save this page. Please try again. If the problem persists please reload the page and try again.",criticalErrorText:"We encountered an error while communicating with the server. Please try again. You may need to reload this page.",meterUPIs:{Consumption:[],Demand:[],Reactive:[]},utilityTemplates:{Electricity:{utilityName:"",utilityType:"","Point Type":{Value:"Utility"},Dashboard:{settings:{backgroundImages:["bluefield.jpg","flowers.jpg","forest.jpg","grass.jpg","mountains.jpg","palmtrees.jpg","raindrops.jpg","road.jpg","rockyshore.jpg","singleleaf.jpg"],background:"singleleaf.jpg",bgOpacity:100,bgBrightness:100,useColor:!1,bgColor:"000000"},headeritems:[],dashboarditems:[]},Meters:[],PreviousRateTables:{},RateTables:{"Fiscal Year":"","Additional Off Peak Days":{order:0}},Billing:{defaultTitle:"",committedBills:{}},Reports:{committedReports:{}},Security:[]}},addUtility:function(a,b){tou.getUtilityMarkup(a,function(c){var d=tou.utilityTemplates[a],e=b.replace(/ /g,"_"),f=(tou.bindings.utilities().length,'<div><div class="utility '+e+'" data-bind="with: utility_'+e+'">'+c+"</div></div>");d.utilityName=b,d.utilityType=a,tou.rawUtilities.push(d),d.path="",tou.saveUtility(d,d,function(){var a=tou.getUtilityConfig(d);$(".dashboardContent").append(f),tou.registerUtility(a,!0)})})},deleteUtility:function(a){var b,c,d,e=tou.bindings["utility_"+a],f=tou.utilities[a],g=tou.bindings.canRead(f.Security),h=$("body"),i=function(i){h.unblock(),i.err?tou.alert(tou.criticalErrorText):(tou.forEachArray(tou.rawUtilities,function(b,c){if(b.utilityName===a)return tou.rawUtilities.splice(c,1),!1}),delete tou.utilities[a],c=tou.bindings.utilities(),b=c.length,tou.forEach(c,function(b){if(b.name!==a)return d=b,!1}),b>1?(g&&tou.bindings.viewableUtilities(tou.bindings.viewableUtilities()-1),d.activate()):tou.bindings.viewableUtilities(0),tou.bindings.utilities.remove(e),$(".dashboardContent ."+f.shortName).parent().remove())};h.block({message:"Deleting Utility"}),$.ajax({url:"/dashboard/removeUtility",type:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify({utilityName:a})}).done(i).fail(function(){h.unblock(),tou.alert(tou.criticalErrorText)})},getUtilityMarkup:function(a,b){$.ajax({url:"/dashboard/getMarkup?type="+a}).done(function(a){b(a.markup)}).fail(function(){tou.alert(tou.criticalErrorText)})},buildMeterList:function(a){var b=tou.meterUPIs;a.forEach(function(a){a.meterPoints.forEach(function(a){b[a.meterPointDesc].push(a.upi)})}),b.consumption=b.Consumption,b.reactive=b.Reactive,b.demand=b.Demand},getRawUtility:function(a){var b,c;for(b=0,c=tou.rawUtilities.length;b<c;b++)if(tou.rawUtilities[b].utilityName===a)return tou.rawUtilities[b];return null},print:function(a){a.css("overflow","visible"),a.printArea({mode:"iframe"}),a.css("overflow","auto")},exportPDF:function(a){var b=a.find("svg"),c=function(a,b,c){if(b=parseInt(b,10)||0,b<=0)return a;var d=document.createElement("canvas");d.height=Math.min(a.height-b,c),d.width=a.width;var e=d.getContext("2d"),f=new Image;return f.src=a.toDataURL(),e.drawImage(f,0,b,f.width,f.height,0,0,f.width,f.height),d},d=function(a){for(var b=new jsPDF("p","px","letter"),d=b.internal,e=d.pageSize,f=d.scaleFactor,g=e.width,h=e.height,i=0,j=a.height,k=a.width/(g*f);i<j;){var l=c(a,i,h*f);b.addImage(l,"png",0,0,g,0,null,"NONE"),i+=h*f*k,i<j&&b.addPage()}b.save("test.pdf")};b.each(function(){var a,b;a=document.createElement("canvas"),a.className="screenShotTempCanvas",b=(new XMLSerializer).serializeToString(this),b=b.replace(/xmlns=\"http:\/\/www\.w3\.org\/2000\/svg\"/,""),canvg(a,b),$(a).insertAfter(this),$(this).attr("class","tempHide"),$(this).hide()}),html2canvas(a,{width:a.width(),height:a.height(),onrendered:d})},numberWithCommas:function(a){return null!==a&&void 0!==a?a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","):""},utilityPages:{},dataRequests:{},requestOptions:[],utilityList:[],dashboardItems:[],DashboardItem:function(a,b){var c,d,e=a.page,f=e.rawUtility,g=new Date,h={column:"Trend",solidgauge:"Gauge",gauge:"Gauge",statistic:"Statistic"},i=h[a.type.toLowerCase()],j="Statistic"!==i,k=void 0===a.useFiscalYear||a.useFiscalYear,l=tou.makeId(),m=e.getLayoutCSS(),n="Please Wait",o=55,p=0,q={peak:!0,period:!0,useFiscalYear:!0,dataSource:!0,withDataSource:!0},r={width:!0,height:!0,style:!0,colorStops:!0,colorStopsType:!0},s={width:!0,height:!0},t={calendaryear:function(a){a.setMonth(0),t.month(a)},year:function(a){var b=c.getFiscalYearData(c.getFiscalYear());return c.bindings.useFiscalYear()?b&&b.start:void t.calendaryear(a)},month:function(a){a.setDate(1),t.day(a)},week:function(a){a.setDate(a.getDate()-a.getDay()),t.day(a)},day:function(a){a.setHours(0),a.setMinutes(0),a.setSeconds(0),a.setMilliseconds(0)}},u={year:{offsetCalendarYear:function(a,b){var c=new Date(a);return c.setYear(c.getFullYear()+(b?1:-1)),c.getTime()},offset:function(a,b){var d=c.getFiscalYear(b?0:-1),e=c.getFiscalYearData(d);return e&&e.end},pretty:function(a){var b=moment(),d=moment(a);return c.bindings.useFiscalYear()?c.getFiscalYear()===e.fiscalYear?"This Year":"FY"+c.fiscalYear:b.isSame(d,"year")?"This Year":a.getFullYear()},scale:"month"},month:{offset:function(a,b){var c=new Date(a);return c.setMonth(c.getMonth()+(b?1:-1)),c.getTime()},pretty:function(a){var b=moment(),c=moment(a);return b.isSame(c,"month")?"This Month":"Month, "+c.format("MMMM YYYY")},scale:"day"},week:{offset:function(a,b){var c=new Date(a).getTime();return b?c+=tou.WEEK:c-=tou.WEEK,c},pretty:function(a){var b=moment(),c=moment(a);return b.isSame(c,"day")?"This Week":"Week of "+c.format(tou.dateFormat)},scale:"day"},day:{offset:function(a,b){var c=new Date(a);return c.setDate(c.getDate()+(b?1:-1)),c.getTime()},pretty:function(a){var b=moment(),c=moment(a);return b.isSame(c,"day")?"Today":"Day, "+c.format("ddd "+tou.dateFormat)},scale:"half-hour"}},v=Object.keys(u),w={Consumption:{upis:function(){return d.Consumption},type:"consumption",fx:"sum"},Demand:{upis:function(){return d.Demand},type:"demand",fx:"max"},"Outside Air Temperature":{upis:function(){return[tou.weatherPoints.OAT]},type:"",fx:"tempRange",hideMove:!0},"Heating Degree Days":{upis:function(){return[tou.weatherPoints.HDD]},type:"",fx:"weather",units:"HDD"},"Cooling Degree Days":{upis:function(){return[tou.weatherPoints.CDD]},type:"",fx:"weather",units:"CDD"},"Current Demand":{upis:function(){return d.Demand},type:"demand",scale:"latest half",hideMove:!0},"Current On Peak Demand":{upis:function(){return d.Demand},type:"demand",peak:"on",scale:"latest half",hideMove:!0},"Current Off Peak Demand":{upis:function(){return d.Demand},type:"demand",peak:"off",scale:"latest half",hideMove:!0},"On Peak Demand":{upis:function(){return d.Demand},type:"demand",peak:"on"},"Off Peak Demand":{upis:function(){return d.Demand},type:"demand",peak:"off"},"Highest Demand":{upis:function(){return d.Demand},type:"demand",fx:"max"},"Highest On Peak Demand":{upis:function(){return d.Demand},peak:"on",type:"demand",fx:"max"},"Highest Off Peak Demand":{upis:function(){return d.Demand},peak:"off",type:"demand",fx:"max"}},x=function(a,b){var d=new Date(a.getTime());return d=t[c.bindings.period()](d)||d,"year"===c.bindings.period()?d/1e3:b?Math.round(d.getTime()/1e3):d.getTime()},y=function(a,b){var d=x(a);return d=u[c.bindings.period()].offset(d,!0),b?Math.round(d/1e3):d},z=function(){var a=c.bindings.peak(),b=w[c.bindings.dataSource()].peak;return"column"===c.chartType?"":b||a},A=function(a){var b=u[c.bindings.period()].scale,d=c.bindings.dataSource(),e=w[d].scale;return c.chartType&&c.chartType.match("gauge")?"latest half":"Statistic"===c.type?d.match("Current")?"latest half":c.bindings.period():e||b},B=function(a){var b=w[a||c.bindings.dataSource()].type;return b},C=function(a){var b="max",d=c.bindings.dataSource();return"column"===c.chartType&&(b="sum"),"demand"===B(a)&&(b="max"),w[a]&&w[a].fx||w[d]&&w[d].fx||b},D=function(a){var b=a||c.bindings.dataSource(),d=w[b].upis();return d};return"360"===a.style&&"solidgauge"===a.type&&(i="Gauge",a.type="gauge"),e.onLayout(function(a){c.measurements=a}),a.$parent=a.$element,a.mainContent?(a.$container=a.$element.find(".portlet"),a.$element=a.$container.find(".content")):a.$container=a.$element,c={_cfg:a,touid:l,type:i,chartType:a.type,measurements:m,resizeTimer:250,$parent:a.$parent,$container:a.$container,$element:a.$element,mainContent:a.mainContent,utilityName:a.utilityName,fiscalYear:e.fiscalYear,getFiscalYear:function(a){return(c.fiscalYear||e.fiscalYear)+(a||0)},getFiscalYearData:function(a){return e.fiscalYears[a||c.getFiscalYear()]},bindings:{touid:l,mainContent:a.mainContent,type:ko.observable(i),width:ko.observable(a.width),height:ko.observable(a.height),title:ko.observable(a.title),value:ko.observable("0"),when:ko.observable(""),currDate:ko.observable(g),dataSource:ko.observable(a.dataSource),withDataSource:ko.observable(a.withDataSource||"None"),useFiscalYear:ko.observable(k),period:ko.observable(a.period),periodList:ko.observableArray(v),colorStopsType:ko.observable(a.colorStopsType),colorStops:ko.observableArray(a.colorStops),peak:ko.observable(a.peak),style:ko.observable(a.style.toString()),loaded:ko.observable(!1),editDashboardItem:e.bindings.editDashboardItem,noData:ko.observable(!1),changePeriod:function(a){c.bindings.period(a),c.requestData()},forward:function(){var a,b,d,e=c.getFiscalYearData();a=c.bindings.currDate(),b=u[c.bindings.period()],"year"===c.bindings.period()?(c.fiscalYear=c.getFiscalYear()+1,d=b.offset(a,!0),a.setYear(c.fiscalYear),c.bindings.currDate(a)):(d=b.offset(a,!0),c.bindings.currDate(new Date(d)),(!e||e&&d>e.end)&&(c.fiscalYear=c.getFiscalYear()+1)),tou.log("Fiscal Year:",c.fiscalYear),c.requestData()},rewind:function(){var a,b,d,e=c.getFiscalYearData();a=c.bindings.currDate(),b=u[c.bindings.period()],"year"===c.bindings.period()?(c.fiscalYear=c.getFiscalYear()-1,d=b.offset(a),a.setYear(c.fiscalYear),c.bindings.currDate(a)):(d=b.offset(a),c.bindings.currDate(new Date(d)),(!e||e&&d<e.start)&&(c.fiscalYear=c.getFiscalYear()-1)),tou.log("Fiscal Year:",c.fiscalYear),c.requestData()},getPage:function(){return e},getInstance:function(){return c}},getUtility:function(){return f},socketReconnect:function(){c.doRequest()},processUpdates:function(a){var b=this,c=!1,d=!1,f=!1;tou.forEach(a,function(a,e){b.bindings[e](a),q[e]&&(c=!0),r[e]&&(d=!0),s[e]&&(f=!0)}),c?(b.requestData(),f&&e.updateLayout()):d&&(e.updateLayout(b.$container),b.drawTrendPlot())},handleSocket:function(a){var b=a.touid,d=b.split("-")[1],e=[null,null];e[d]=a,"statistic"===c.chartType&&(e=a),c.handleData(e)},handleData:function(a){var b,d,e,f=a.result||a,g=[],h=c.lastFx,i={max:"maxes",sum:"sums",tempRange:"tempRanges",weather:"sums"},k=i[h],l="tempRange"!==h&&"weather"!==h,m=!0,n=c.bindings.withDataSource(),o=function(a){if(a&&0!==a.length)tou.forEachArray(a,function(a){var b,c=function(a){b=a,l&&(b*=1e3),b=Math.round(b)};m&&0!==a.timestamp&&(m=!1),a.range?(c(a[h]),g.push({Value:b,timestamp:1e3*a.range.start})):(c(a.value),g.push({Value:b,timestamp:1e3*a.timestamp}))});else if(c.bindings.noData(!0),!a)return},p=function(a){var b=[],c=[];tou.forEachArray(a,function(a){!m||"string"===a.max&&"string"==typeof a.min||(m=!1),b.push({Value:"string"==typeof a.max?null:tou.toFixed(a.max,1),timestamp:1e3*a.range.start}),c.push({Value:"string"==typeof a.min?null:tou.toFixed(a.min,1),timestamp:1e3*a.range.start}),g=[{data:c,name:"Low"},{data:b,name:"High"}]})},q=function(){return b&&0!==b.timestamp?(m&&0!==b.timestamp&&void 0!==b.timestamp&&(m=!1),void(void 0!==b.value?d=b.value:(d=b[h],void 0===d&&(d="weather"===h?b.sum:b.max)))):(c.bindings.noData(!0),void(d=0))};c.bindings.noData(!1),f.error?m=!0:"column"===c.chartType?"None"!==n?(f[0]&&(o(f[0].results[k]),c.mainData=g,g=[]),f[1]&&("Outside Air Temperature"===n||n.match("Degree Days")?f[1].error?g=null:"Outside Air Temperature"===n?p(f[1].results.tempRanges):(l=!1,o(f[1].results[k])):o(f[1].results.maxes),c.withData=g)):(o(Array.isArray(f)?f[0].results[k]:f.results[k]),c.mainData=g,c.withData=null):c.chartType.match("gauge")?(f[0]&&!f[0].error&&(b=f[0].results[k].slice(-1)[0],q(b),isNaN(d)&&(d=0,l=!1),l&&(d*=1e3,d=Math.round(d)),g=[{Value:d}],c.mainData=g),f[1]&&!f[1].error&&(b=f[1].results.maxes.slice(-1)[0],q(b),c.maxY=1e3*d),c.bindings.noData()&&(g=[],c.mainData=g)):(b=f.results[k].slice(-1)[0],q(b),m=!1,b=f.results[k][0],e=moment.unix(b.timestamp||b.range.start),e=e.format("MM/DD/YY HH:mm:SS"),isNaN(d)&&(d="",l=!1),l&&(d*=1e3),g=[{Value:tou.numberWithCommas(Math.round(d)),when:e}],c.mainData=g),c.bindings.loaded(!0),c.bindings.noData(m),c.$container.unblock(),j?(c.trendPlot&&c.trendPlot.destroy(),c.drawTrendPlot()):m?(c.bindings.value(0),c.bindings.when("")):(c.bindings.value(g[0].Value),c.bindings.when(g[0].when))},requestData:function(){var a=["dataSource","period"],b=!0;tou.forEachArray(a,function(a){return""===c.bindings[a]()&&(b=!1),b}),b&&c.doRequest()},doRequest:function(){var a,b=(c.bindings.currDate(),function(a){return{range:{start:x(c.bindings.currDate(),!0),end:y(c.bindings.currDate(),!0)},fiscalYear:c.getFiscalYear(),type:B(a),scale:A(a),fx:C(a),upis:D(a),peak:z(a),socketid:tou.socketid,touid:c.touid+"-0",utilityName:c.utilityName}}),d={options:[b()],handler:function(a){c.handleData(a)}};c.lastFx=d.options[0].fx,c.chartType.match("gauge")?(d.bundleResponses=!0,a=$.extend(!0,{},d.options[0],{fx:"max",scale:c.bindings.period(),touid:c.touid+"-1",range:{end:y(c.bindings.currDate(),!0),start:x(c.bindings.currDate(),!0)}}),d.options.push(a)):"column"===c.chartType&&"None"!==c.bindings.withDataSource()&&(d.bundleResponses=!0,withOption=b(c.bindings.withDataSource()),withOption.touid=c.touid+"-1",d.options.push(withOption)),c.lastRequest=d,c.$container.block({message:n}),tou.addDataRequest(d,!0,"/api/meters/getUsage")},updateSize:function(){var a=this;a.measurements=e.getLayoutCSS(),a.bindings.loaded()&&a.drawTrendPlot()},handleResize:function(){tou.currPage&&"Dashboard"===tou.currPage.title&&(c.lastResize=new Date,setTimeout(function(){new Date-c.lastResize>=c.resizeTimer&&c.updateSize()},c.resizeTimer))},drawTrendPlot:function(){if(j){var a=c.getTrendPlotConfig(c.mainData,c.withData);a?c.trendPlot=new TrendPlot(a):c.$element.html("No Data To Display")}},getTrendPlotConfig:function(b,d){var e={},f=["#2b908f","#f45b5b"],g=c.bindings.withDataSource(),h={target:c.$element,y:"Value",height:c.measurements.height[c.bindings.height()]-o,width:c.measurements.width[c.bindings.width()]-p,x:"timestamp",type:a.type,animation:!1,yAxisTitle:"",data:[],colorStops:c.bindings.colorStops(),colorStopsType:c.bindings.colorStopsType(),style:c.bindings.style(),hideLegendXLabel:!0};return 0===b.length&&c.bindings.noData(!0),"column"!==a.type?(e.style=h.style,h.max=c.maxY,"180"===h.style?h.type=e.type="solidgauge":h.type=e.type="gauge",h.units=e.units=c.bindings.units(),e.data=b,e.name=c.bindings.dataSource(),h.data.push(e)):(h.units=e.units=c.bindings.units(),h.data.push({type:"column",data:b,name:c.bindings.dataSource(),units:c.bindings.units(),color:"#e4d354"}),d&&(Array.isArray(d)?"Outside Air Temperature"===g?tou.forEachArray(d,function(a,b){h.data.push({type:"line",data:a.data,name:a.name,yAxis:1,color:f[b],units:"&deg;F"})}):h.data.push({type:"line",data:d,name:g,yAxis:1,color:f[0],units:w[g].units}):h.data.push({type:"line",data:d,name:g}))),c.bindings.noData()&&(h=null),h},destroy:function(){var a,b,c=this;tou.forEachArray(tou.dashboardItems,function(b,d){b.touid===c.touid&&(a=d)}),$(window).off("resize",function(){c.handleResize()}),void 0!==a&&(tou.dashboardItems.splice(a,1),"Statistic"!==c.type||c.mainContent?(tou.forEachArray(e.bindings.dashboardItems(),function(a,d){a.touid===c.touid&&(b=d)}),e.bindings.dashboardItems.splice(b,1),c.$container.parent().remove()):(tou.forEachArray(e.bindings.headerItems(),function(a,d){a.touid===c.touid&&(b=d)}),e.bindings.headerItems.splice(b,1)),e.updateLayout())}},c.bindings.classNames=ko.computed(function(){return c.bindings.width()+" "+c.bindings.height()}),c.bindings.prettyDate=ko.computed(function(){var a=c.bindings.currDate(),b=c.bindings.period();return u[b].pretty?u[b].pretty(a):moment(a).format("ddd, "+tou.dateFormat)}),c.bindings.showForward=ko.computed(function(){var a=c.bindings.period(),b=c.bindings.currDate(),d=moment(),e=moment(b),f=c.fiscalYear||b.getFullYear(),g=c.getFiscalYearData(f+1),h=c.bindings.dataSource(),i=w[h];return("Statistic"!==c.type||!i||!i.hideMove)&&("year"===a&&c.bindings.useFiscalYear()?!!g:d.isAfter(e,a))}),c.bindings.showBackward=ko.computed(function(){var a=c.bindings.dataSource(),b=w[a];return"Statistic"!==c.type||!b||!b.hideMove}),c.bindings.units=ko.computed(function(){var a=c.bindings.dataSource();return a.match("Temperature")?"&deg;F":a.match("Degree Days")?w[a].units:a.toLowerCase().match("consumption")?"kWh":"kW"}),tou.onLoad(function(){d=tou.getActiveMeterList(f.Meters),c.requestData()}),tou.on("meterssaved",function(a){a===f.utilityName&&(d=tou.getActiveMeterList(f.Meters),c.requestData())}),$(window).resize(function(){c.handleResize()}),e.loaded&&a.mainContent&&setTimeout(function(){e.updateLayout()},100),tou.dashboardItems.push(c),a.mainContent&&(ko.cleanNode(c.$container[0]),ko.applyBindings(c.bindings,c.$container[0])),c},availablePeriods:{},buildAvailablePeriods:function(a){var b,c,d,e,f,g,h,i,j=tou.currUtility,k=j.utilityName,l=this,m=l.availablePeriods,n={},o=(l.months,new Date),p=o.getFullYear(),q=o.getMonth(),r=a||!1,s={},t=function(a,c){for(var d,e,f,g,h,j,k=new Date(c.start.date),m=new Date(c.start.date),r=new Date(c.end.date),t=a["Fiscal Year"],u=c.rangeType;m<r;)f=m.getFullYear(),g=m.getMonth(),e=l.fullMonthList[g],h=[e,", ",f].join(""),n.hasOwnProperty(h)===!1&&(d=new Date(m).setMonth(g+1),m<o&&(n[h]=!0,j=f===p?g===q?"This month":h.split(", ")[0]:h,b.push({period:"Month",childPeriod:"Day",childFormatCode:"D",start:m.getTime(),end:d,fullDate:h,prettyDate:j,searchDate:h.toLowerCase().replace(",",""),month:e,year:f,fiscalYear:t,season:[u.charAt(0).toUpperCase(),u.slice(1)].join(""),rateTable:$.extend(!0,{},a)})),s.hasOwnProperty(t)===!1?(h=["Fiscal Year",t].join(" "),s[t]={period:"Year",childPeriod:"Month",childFormatCode:"MM",start:k.getTime(),end:d,fullDate:h,prettyDate:h,searchDate:h.toLowerCase().replace(",",""),month:null,year:null,fiscalYear:t,season:null,rateTable:$.extend(!0,{},a)}):(i=s[t],i.start=Math.min(i.start,k.getTime()),i.end=Math.max(i.end,d))),m.setMonth(g+1)},u=function(a){if("object"==typeof a){var b,e;for(e in a)if(f=a[e],f.hasOwnProperty("periods"))for(b=f.periods,c=0,d=b.length;c<d;c++)t(a,b[c])}},v=function(){for(var a in s)b.push(s[a])};if(r||!m.hasOwnProperty(k)){if(m[k]=[],b=m[k],null!==j){if(g=j.PreviousRateTables,h=j.RateTables,void 0!==g)for(e in g)u(g[e]);void 0!==h&&u(h)}v(),b.sort(function(a,b){var c;return c="Year"===a.period||"Year"===b.period?a.end===b.end?"Year"===a.period?-1:1:a.end<b.end?1:-1:a.start<b.start?1:-1})}},toFixed:function(a,b){var c,d,e=Math.abs(a),f=e.toString(),g=f.split(".")[1],h=a<0;return 0===b?f=e.toFixed(0):g&&g.length>b&&(f=f.substr(0,f.indexOf(".")+b+2),c=f.charAt(f.length-1),f=f.substr(0,f.length-1),c>=5&&(d=Math.pow(10,f.length-f.indexOf(".")-1),f=(+f+1/d).toFixed(b))),f*(h?-1:1)},toFixedComma:function(a,b){var c=tou.toFixed(a,void 0===b?128:b);return tou.numberWithCommas(c)},cellWidthHelper:function(a,b){var c=b.children(),d=b.clone();return d.children().each(function(a){$(this).width(c.eq(a).width())}),d},isSystemAdmin:function(){var a=tou.workspaceManager.user();return a["System Admin"]&&a["System Admin"].Value},loadJade:function(a,b){$.ajax({url:"/dashboard/getJadeFile?file="+a+".jade",success:function(a){b(a)}})},saveUtility:function(a,b,c,d){var e,f,g,h,i=!1,j=function(){if(d!==!0){var a,b=g.split("."),c=e;for(a=0;a<b.length;a++)c=c[b[a]];h=$.extend(c,h)}};"string"==typeof a?(f=a,g=Object.keys(b)[0],h=b[g]):(f=a.utilityName,g=a.path,h=b,i=a.remove||i),tou.forEachArray(tou.rawUtilities,function(a){if(a.utilityName===f)return e=a,!1}),j(),$.ajax({url:"/dashboard/saveUtility",type:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify({utility:{path:g,data:h,utilityName:f,remove:i}})}).done(c).fail(function(){tou.alert(tou.criticalErrorText)})},cancelConfirm:function(){tou._confirmCb&&tou._confirmCb(!1)},submitConfirm:function(){tou._confirmCb&&tou._confirmCb(!0)},confirm:function(a){var b=a.callback,c=a.message,d=!!c;tou._confirmCb=b,tou.showModal("touConfirm",{message:c,showBody:d})},alert:function(a,b){tou.showModal("touAlert",{message:a,hideOK:b})},addDataRequest:function(a,b,c){Array.isArray(a.options)||(a.options=[a.options]),a.bundleResponses&&a.touid?(tou.dataRequests[a.touid]=a,a.options.forEach(function(b){b.touid=a.touid})):a.options.forEach(function(b){b.touid=a.touid||b.touid||tou.makeId(),tou.dataRequests[b.touid]=a}),tou.requestOptions=tou.requestOptions.concat(a.options),b&&tou.makeDataRequest(c)},handleDataResponse:function(a){var b=[];return Array.isArray(a)?(tou.forEachArray(a,function(c){var d=c.touid,e=tou.dataRequests[d];return b.push(d),e.bundleResponses?(e.handler(a),!1):void e.handler(c)}),void tou.forEachArray(b,function(a){delete tou.dataRequests[a]})):void tou.alert(tou.criticalErrorText)},makeDataRequest:function(a){void 0===a&&(a="/api/meters/getUsage"),tou.requestOptions.length>0&&$.ajax({"content-type":!1,type:"POST",url:a,data:{options:tou.requestOptions}}).done(function(a){tou.handleDataResponse(a)}).fail(function(a){tou.handleDataResponse(!1)}),tou.requestOptions=[]},emptyFn:function(){},formatDate:function(a,b){var c,d=["Hours","Minutes","Seconds","Milliseconds"],e=[2,2,2,3],f=[":",":",":",""],g=" --",h="";b&&f.push(g),"number"==typeof a&&(a=new Date(a));for(c in d)d.hasOwnProperty(c)&&(h+=("000"+a["get"+d[c]]()).slice(-1*e[c])+f[c]);return h},log:function(){var a,b,c,d,e=[].splice.call(arguments,0),f=function(a){return("    "+a).slice(-4)},g=tou.formatDate(new Date,!0);tou.logLinePrefix===!0&&(d=new Error,Error.captureStackTrace&&(Error.captureStackTrace(d),a=d.stack.split("\n")[2],b=a.split(":"),c=b[2],e.unshift("line:"+f(c),g))),tou.noLog||console.log.apply(console,e)},preloadedImages:{},preloadImage:function(a){tou.preloadedImages[a]||(tou.preloadedImages[a]=!0,$("<img />").attr("src",tou.backgroundFolder+a))},getMeterList:function(a,b){var c={Consumption:[],Reactive:[],Demand:[]},d=b||{},e=d.active,f=d.getMeterPoint,g=d.getAllMeters;return a.forEach(function(a){(g||a.isActive===e)&&a.meterPoints.forEach(function(a){var b;b=f?a:a.upi,c[a.meterPointDesc].push(b)})}),c.consumption=c.Consumption,c.reactive=c.Reactive,c.demand=c.Demand,c},getInactiveMeterList:function(a,b){var c={active:!1,getMeterPoint:b,getAllMeters:!1};return tou.getMeterList(a,c)},getActiveMeterList:function(a,b){var c={active:!0,getMeterPoint:b,getAllMeters:!1};return tou.getMeterList(a,c)},getMeters:function(a){var b,c,d,e=[];if(tou.currUtility)if(b=tou.currUtility.Meters,void 0!==a)for(d=b.length,c=0;c<d;c++)b[c].isActive===a&&e.push(b[c]);else e=b;return e},retrieveMeterPoint:function(a,b){var c,d,e=a.meterPoints.length;for(c=0;c<e;c++)if(b.toLowerCase()===a.meterPoints[c].meterPointDesc.toLowerCase()){d=a.meterPoints[c];break}return d},monthsYearsArray:[],addYearValuesToList:function(){var a,b,c=[],d=tou.monthYearList(),e=d.length,f=moment().format("YYYY");for(a=0;a<e;a++)b=moment(d[a].theDate).format("YYYY"),b!==f&&(c.push({text:f,theDate:moment("01/01/"+f,"MM/DD/YYYY").format(),period:"year"}),f=b),c.push(d[a]);return c.push({text:b,theDate:moment("01/01/"+b,"MM/DD/YYYY").format(),period:"year"}),c},monthYearList:function(){var a=1,b=new Date,c=new Date("03/01/2011"),d=moment().format("MMMM"),e=(new Date).getFullYear(),f=moment(b).diff(moment(c),"months",!0)+1,g={};if(f=parseInt(f,10),0===tou.monthsYearsArray.length)for(;a<f;)g=e==moment(b).format("YYYY")?d===moment(b).format("MMMM")?{text:"This Month",theDate:moment(b).format(),period:"month"}:{text:moment(b).format("MMMM"),theDate:moment(b).format(),period:"month"}:{text:moment(b).format("MMMM, YYYY"),theDate:moment(b).format(),period:"month"},tou.monthsYearsArray.push(g),b=moment(b).subtract(1,"month"),a++;return tou.monthsYearsArray},objectWithoutProp:function(a,b){var c={};return tou.forEach(a,function(a,d){d!==b&&(c[d]=a)}),c},forEach:function(a,b){var c,d=Object.keys(a),e=d.length,f=!0;for(c=0;c<e&&f;c++)f=b(a[d[c]],d[c],c),void 0===f&&(f=!0);return f},forEachArray:function(a,b){var c,d=a||[],e=d.length,f=!0;for(c=0;c<e&&f;c++)f=b(d[c],c),void 0===f&&(f=!0);return f},forEachArrayRev:function(a,b){var c,d=a||[],e=d.length,f=!0;for(c=e-1;c>=0&&f;c--)f=b(d[c],c),void 0===f&&(f=!0);return f},eventLog:[],eventHandlers:{},on:function(a,b){tou.eventHandlers[a]=tou.eventHandlers[a]||[],tou.eventHandlers[a].push(b)},fire:function(){var a=Array.prototype.slice.call(arguments),b=a.shift();tou.forEachArray(tou.eventHandlers[b],function(b){b.apply(this,a)})},onLoadFns:[],onLoad:function(a){tou.loaded?a():tou.onLoadFns.push(a)},pages:{},utilities:{},modals:{},globalModals:{touConfirm:{message:"",showBody:!0},touAlert:{message:"",hideOK:!1},addUtility:{utilityType:"",utilityName:""},editUtility:{utilityName:""}},modalTemplates:{},modalDefaults:{},processModalTemplate:function(a,b){var c={};tou.modalTemplates[b]||(c.errorMessages=ko.observableArray([]),tou.modalDefaults[b]=tou.modalDefaults[b]||{},tou.forEach(a,function(a,b){var d;if("computeds"===b)tou.forEach(a,function(a,b){c[b]=ko.computed(a(c))});else{if("noReset"===b)return;d="object"!=typeof a||Array.isArray(a)?a:a.val,Array.isArray(d)?c[b]=ko.observableArray(d):"function"==typeof d?c[b]=d.bind(c):c[b]=ko.observable(d)}}),tou.modalTemplates[b]=c,tou.modalDefaults[b]=$.extend(!0,{},a))},showModal:function(a,b,c){var d=tou.modals[a+"Modal"],e=d.el,f=d.context;e&&(c&&(f.$page!==c&&tou.resetModal(d),f.$page=c),b&&tou.forEach(b,function(a,b){f.$data[b]&&(Array.isArray(a)&&"object"==typeof a[0]?f.$data[b](ko.mapping.fromJS(a)()):f.$data[b](a))}),tou.currModal=d,e.modal("show"))},resetModal:function(a){var b=tou.modalDefaults[a.name],c=a.context.$data;tou.forEach(b,function(a,d){"function"==typeof a||"computeds"===d||"noReset"===d||b.noReset&&b.noReset[d]||c[d](a)}),c.errorMessages([])},hideModal:function(){var a=tou.currModal;tou.currModal&&(tou.resetModal(a),a.el.modal("hide"),tou.currModal=null)},$pages:".page .mainContent",getPageHeight:function(){var a=$(window).height(),b=tou.bindings.activePage(),c=b.shortTitle,d=b.title.toLowerCase(),e=tou.currUtility.shortName,f=$("."+e+" ."+(c||d)+" .topBar").outerHeight();return a-f},doPageResize:function(){$(tou.$pages).height(tou.getPageHeight()-20)},weatherPoints:{OAT:null,CDD:null,HDD:null},getWeatherPoints:function(){$.ajax({url:"/api/system/weather"}).done(function(a){tou.processWeatherPoints(a)})},processWeatherPoints:function(a){var b,c,d={"Outside Air Temperature Point":"OAT","Heating Degree Days Point":"HDD","Cooling Degree Days Point":"CDD"};for(b in a)c=a[b],tou.weatherPoints[d[b]]=c&&c._id},getUtilityConfig:function(a){var b=a.utilityName,c=a.utilityType,d=$.extend(!0,[],tou.utilityPages[c]());return{name:b,type:c,pages:d,rawUtility:a}},initUtilities:function(){tou.forEachArray(tou.rawUtilities,function(a,b){var c=tou.getUtilityConfig(a);c.active=0===b,tou.registerUtility(c)}),tou.fire("utilitiesLoaded")},initSocket:function(a){var b=io.connect(window.location.origin);b.on("connect",function(){tou.socket=b,tou.socketid=b.id,a()}),b.on("disconnect",function(){tou.forEachArray(tou.dashboardItems,function(a){a.socketReconnect()})}),b.on("updateDashboard",function(a){var b=a[0],c=b.touid.split("-")[0];tou.forEachArray(tou.dashboardItems,function(a){a.touid===c&&a.handleSocket(b)})}),tou.keepAliveInterval=setInterval(function(){$.ajax({url:"/home"}).done(function(a){})},9e5)},init:function(){var a=$("body"),b=$(".leftBar"),c=!1,d=function(){c||(c=!0,a.removeClass("loading"),$(".pages a").eq(0).addClass("selected"),b.jScrollPane({verticalGutter:0}),tou.fire("loaded"))};a.mousedown(function(a){if(1==a.button)return!1}),tou.poppedIn=window.top.location.href!==window.location.href,tou.workspaceManager=window.opener&&window.opener.workspaceManager,tou._openWindow=tou.workspaceManager&&tou.workspaceManager.openWindowPositioned,tou.processWeatherPoints(tou._weatherPoints),tou.currUtility=tou.rawUtilities[0],tou.currUtility&&(tou.currUtility.shortName=tou.currUtility.utilityName.replace(/ /g,"_"),tou.buildMeterList(tou.currUtility.Meters),tou.buildAvailablePeriods()),String.prototype.capFirst=function(){return this.charAt(0).toUpperCase()+this.slice(1)},tou.initUtilities(),tou.bindings.activeUtility.subscribe(function(a){tou.currUtility=tou.getRawUtility(a),tou.buildMeterList(tou.currUtility.Meters),tou.buildAvailablePeriods(),tou.doPageResize()}),tou.initSocket(d),tou.on("loaded",function(){tou.loaded=!0,tou.bindings.loaded(!0),tou.forEachArray(tou.onLoadFns,function(a){a()}),tou.onLoadFns=[]}),tou.poppedIn&&a.addClass("poppedIn"),a.tooltip({selector:'[data-toggle="tooltip"]',container:"body"}),a.on("hidden.bs.modal",tou.hideModal),$(document).on("show.bs.modal",".modal",function(){var a=1040+10*$(".modal:visible").length;$(this).css("z-index",a),setTimeout(function(){$(".modal-backdrop").not(".modal-stack").css("z-index",a-1).addClass("modal-stack")},0)}),tou.forEach(tou.globalModals,tou.processModalTemplate),tou.forEachArray(tou.rawUtilities,function(a){tou.utilities[a.utilityName]=a}),$(window).resize(function(){tou.doPageResize(),b.data("jsp").reinitialise()}),tou.initKnockout()},initKnockout:function(){ko.bindingHandlers.touModal={init:function(a,b,c,d,e){var f,g,h,i=$(a),j=b(),k=tou.modalTemplates[j],l=c(),m=l.touPage;return g=e.createChildContext(k),m&&(utility=m.split("-"),f=utility[1].replace(/ /g,"_"),h=tou.currUtility.utilityName,tou.pages[h]&&(f=tou.pages[h][f],g.$page=f)),e.$root[j+"Context"]=g,ko.applyBindingsToDescendants(g,a),tou.modals[j+"Modal"]={el:i,context:g,name:j},i.addClass(j+"Modal"),i.attr({"data-backdrop":"static","data-keyboard":"false"}),{controlsDescendantBindings:!0}}},ko.virtualElements.allowedBindings.trendPlot=!0,ko.bindingHandlers.trendPlot={init:function(a,b,c,d,e){var f,g=$(ko.virtualElements.firstChild(a)),h=g.find(".portlet"),i=b(),j=(c(),d.utilityName),k=$.extend({$element:h,utilityName:j},i);0===h.length&&(k.$element=g),i._cfg?(f=new tou.DashboardItem(k),$.extend(e.$data,f)):(f=new tou.DashboardItem(k),$.extend(e.$data,f))}},ko.virtualElements.allowedBindings.onlyOneCheck=!0,ko.bindingHandlers.onlyOneCheck={init:function(a,b){var c=$(ko.virtualElements.childNodes(a)),d=c.find("input:checkbox");d.change(function(a){var b=$(a.target),d=c.find(":checked").not(b);return d.each(function(a,b){b.click()}),!0})},update:function(a,b){}},ko.bindingHandlers.datepicker={init:function(a,b,c){var d={autoclose:!0,startView:"year"};$(a).datepicker(d).on("changeDate",function(c){var d=b(),e=d();c.date?d(c.date):""!==e&&$(a).datepicker("setDate",e)})},update:function(a,b){var c=ko.utils.unwrapObservable(b());$(a).datepicker("setDate",c)}},ko.bindingHandlers.timepicker={init:function(a,b,c){var d=b(),e={doneText:"Done",autoclose:!0,afterDone:function(){d($(a).val())}};$(a).clockpicker(e),$(a).change(function(b){$(a).clockpicker("resetclock")})},update:function(a,b){var c,d,e=ko.utils.unwrapObservable(b());"string"!=typeof e?(c=("00"+Math.floor(e/100)).slice(-2),d=("00"+e%100).slice(-2),$(a).val(c+":"+d)):$(a).val(e)}},ko.bindingHandlers.editableText={init:function(a,b,c,d,e){var f=b(),g=f&&f(),h=$(a);e.$index(),
e.$parent.name(),e.$parentContext.$parentContext.$data;void 0!==g&&h.val(g),void 0===f&&(tou._invalidRates=tou._invalidRates||[],tou._invalidRates.push({data:e.$data,parent:e.$parent})),h.on("blur",function(){f&&f($(this).val())}),tou.on("ratetablecancel",function(){h.val(g)})},update:function(a,b){var c=ko.utils.unwrapObservable(b());$(a).val(c)}},ko.bindingHandlers.sortableArray={init:function(a,b,c,d,e){var f=b(),g=$(a),h=c(),i=h.indexOffset||0,j=h.sortIf,k=h.handle,l=function(){g.sortable({helper:tou.cellWidthHelper,cancel:".static",handle:k,stop:function(a,b){var c=ko.dataFor(b.item[0]),d=f(),e=ko.utils.arrayIndexOf(b.item.parent().children(),b.item[0])-i;e>=d.length&&(e=d.length-1),e<0&&(e=0),b.item.remove(),f.remove(c),f.splice(e,0,c)}})};j?(j()&&l(),j.subscribe(function(a){a&&l()})):l()}},ko.bindingHandlers.dragAndDrop={init:function(a,b,c,d,e){var f=b(),g=c(),h=g.targetClass,i=$(a),j=i.find(h),k=i.parent();j.draggable({revert:"invalid",helper:"clone",cursor:"move"}),k.droppable({accept:h,drop:function(a,b){var c=$(b.draggable).data("type");f(c,!0)}})}},ko.bindingHandlers.slider={init:function(a,b){var c=b(),d=$(a);d.bootstrapSlider({reversed:!0,tooltip:"hide",value:c()}).on("slide",function(a){c(a.value)})},update:function(a,b){var c=b(),d=c(),e=$(a);e.bootstrapSlider("setValue",d)}},ko.bindingHandlers.hiddenUpload={init:function(a,b,c){var d=$(a),e=(c(),b()),f=d.data("target"),g=$("#"+f),h=function(a){var b=g[0].files[0];e(b)};d.click(function(){g.click()}),g.change(h)}},ko.bindingHandlers.stopBindings={init:function(){return{controlsDescendantBindings:!0}}},ko.applyBindings(tou.bindings),tou.knockoutLoaded=!0},bindings:{backgroundImage:ko.observable("/img/dashboard/backgrounds/singleleaf.jpg"),showMainBackground:ko.observable(!1),activePage:ko.observable(),activeUtility:ko.observable(),loadModals:ko.observable(!1),loaded:ko.observable(!1),utilities:ko.observableArray([]),utilityTypes:ko.observable(["Electricity"]),viewableUtilities:ko.observable(0),addUtility:function(){tou.showModal("addUtility")},saveUtility:function(a){var b=ko.toJS(a),c=b.utilityType,d=b.utilityName,e=!0;""===d||d.match(/[^a-zA-Z0-9 ]/g)?a.errorMessages(["Invalid Utility Name"]):(tou.forEachArray(tou.rawUtilities,function(a){if(a.utilityName===d)return e=!1,!1}),e?(tou.hideModal(),tou.addUtility(c,d)):a.errorMessages(["Duplicate Utility Name"]))},editUtility:function(a){tou._editUtility=a,tou.showModal("editUtility",{utilityName:a.name})},updateUtility:function(a){var b=tou._editUtility.name,c=ko.toJS(a),d=c.utilityName,e=!1;tou.forEachArray(tou.rawUtilities,function(a){if(a.utilityName===d)return e=!0,!1}),d!==b?""===d||d.match(/[^a-zA-Z0-9 ]/g)?a.errorMessages(["Invalid Utility Name"]):e?a.errorMessages(["Duplicate Utility Name"]):tou.saveUtility(b,{utilityName:d},function(a){tou.alert("Reloading Page, please wait",!0),window.location.reload()},!0):tou.hideModal()},deleteUtility:function(){var a=tou._editUtility.name;tou.hideModal(),setTimeout(function(){tou.deleteUtility(a)},50)},pageClick:function(a){var b=a.shortTitle||a.title.replace(/ /g,""),c=a.shortTitle||a.title.replace(/ /g,"_"),d=b.toLowerCase(),e=tou.bindings.activePage(),f=(e.title.replace(/ /g,""),a.utilityName.replace(/ /g,"_"));tou.bindings.activePage(a),tou.currPage=a,a.isActive(!0),tou.bindings.backgroundImage(tou.backgroundFolder+a.background),tou.bindings.showMainBackground("dashboard"!==d),a.delayLoad&&!a.loaded&&(a.loaded=!0,a.init()),$("."+f+" > div").css("display","none"),$("."+f+" ."+d).css("display","block"),$(".leftBar ."+f+" .pages a.selected").removeClass("selected"),$(".leftBar ."+f+" ."+c).addClass("selected"),tou.fire("pageClick",b)},popInOut:function(){var a="mainWindow";return tou.poppedIn&&(a=""),tou._openWindow(window.location.href,"Dashboard","Dashboard",a,"dashboard"),tou.poppedIn=!tou.poppedIn,!1},popInOutText:function(){return tou.poppedIn?"Pop Out":"Pop In"},popInOutClass:function(){return tou.poppedIn?"fa-arrow-circle-up":"fa-arrow-circle-down"},canRead:function(a){var b=tou.workspaceManager.user();if(b["System Admin"].Value)return!0;for(var c=0;c<b.groups.length;c++)if(a.indexOf(b.groups[c]._id)>-1)return!0;return!1},canWrite:function(a){var b=tou.workspaceManager.user();if(b["System Admin"].Value)return!0;for(var c=0;c<b.groups.length;c++)if(a.indexOf(b.groups[c]._id)>-1&&0!==(8&b.groups[c]._pAccess))return!0;return!1}},Utility:function(a){var b,c,d,e=$.extend(!0,{},a),f=e.rawUtility,g=e.name,h=g.replace(/ /g,"_"),i=function(a,c){b[c]=ko.computed(a.bind(b))},j={initFns:[],pages:e.pages,loaded:e.active,bindings:{obName:ko.observable(e.name),name:e.name,shortName:h,pages:e.pages,active:ko.observable(e.active),type:e.type,loaded:ko.observable(e.active),deactivate:function(){j.bindings.active(!1)},activate:function(){tou.forEachArray(tou.bindings.utilities(),function(a){a.name!==j.bindings.name&&a.deactivate()}),j.bindings.active(!0),tou.bindings.pageClick(j.pages[0])}}},k=function(){tou.forEachArray(j.initFns,function(a){var b=a.fn,c=a.page;b.call(c)})};tou.isSystemAdmin();return tou.pages[g]={},e.active&&tou.bindings.activeUtility(g),tou.forEachArray(j.pages,function(a,e){a.adminOnly=a.adminOnly||!1,tou.currPage||(tou.currPage=a),tou.pages[g][a.title.replace(/ /g,"_")]=a,a.utilityName=g,a.utilityNameShort=h,a.rawUtility=f,tou.preloadImage(a.background),b=a.bindings||{},c=a.computedBindings||{},b.$page=a,a.shouldShow=!a.adminOnly||a.adminOnly&&tou.isSystemAdmin(),a.utility=j,tou.forEach(c,i),j.bindings[(a.shortTitle||a.title.replace(/ /g,"").toLowerCase())+"Bindings"]=b,a.modalTemplates&&tou.forEach(a.modalTemplates,tou.processModalTemplate),a.isActive()&&(d=a,tou.bindings.activePage(a)),a.delayLoad?a.loaded=!1:j.initFns.push({page:a,fn:a.init||tou.emptyFn})}),tou.bindings.utilities.push(j.bindings),tou.bindings["utility_"+h]=j.bindings,j.$el=$(".utility."+h).parent(),tou.loaded&&(ko.cleanNode(j.$el[0]),ko.applyBindings(tou.bindings,j.$el[0])),e.active&&tou.bindings.canRead(e.rawUtility.Security)&&k(),j.bindings.active.subscribe(function(a){var b=a?"block":"none";a&&(tou.bindings.activeUtility(e.name),j.bindings.loaded()||(j.bindings.loaded(!0),k())),$(".utility."+h).css("display",b)}),j},registerUtility:function(a,b){var c=new tou.Utility(a),d=tou.bindings.canRead(a.rawUtility.Security);a.rawUtility.shortName=a.name.replace(/ /g,"_"),tou.utilityList.push(c),d&&tou.bindings.viewableUtilities(tou.bindings.viewableUtilities()+1),b&&d&&(c.bindings.activate(),tou.bindings.loadModals(!0))}};tou.utilityPages.Electricity=function(){return[{title:"Dashboard",isActive:ko.observable(!0),background:"singleleaf.jpg",gutter:30,$portlets:$(".portlet"),currItem:null,bindings:{isEditMode:ko.observable(!1),toEditMode:function(){this.isEditMode(!0)},cancelEditMode:function(){this.$page.doCancel(),this.isEditMode(!1)},save:function(){this.$page.doSave(),this.isEditMode(!1)},uploadBackground:function(a){this.$page.uploadImage(a)},noMeters:ko.observable(!0),noPeriods:ko.observable(!0),loaded:ko.observable(!1),useColor:ko.observable(!1),background:ko.observable("singleleaf.jpg"),oldBackground:ko.observable(""),dashboardItems:ko.observableArray([]),backgroundImages:ko.observableArray([]),headerItems:ko.observableArray([]),bgColor:ko.observable("000000"),bgOpacity:ko.observable(100),bgBrightness:ko.observable(100),newBackground:ko.observable(),uploadPreview:ko.observable(),showBackgroundModal:function(){var a={bgColor:this.bgColor(),background:this.background(),useColor:this.useColor(),backgroundImages:this.backgroundImages()};a.useColor&&(a.background=this.oldBackground()),a.uploadImageFn=this.$page.uploadImage.bind(this.$page),tou.showModal("electricityDashboardSelectBackground",a,this.$page)},updateDashboardBackground:function(a){var b=ko.toJS(a),c=b.background;this.bindings.useColor(b.useColor),this.bindings.bgColor(b.bgColor),b.useColor?(this.bindings.oldBackground(this.bindings.background()),this.bindings.background("blank.png")):this.bindings.background(c),tou.hideModal()},selectBackground:function(a){tou.log(ko.toJS(a))},editDashboardItem:function(a){var b=ko.toJS(a),c=b.getPage(),d=b.getInstance();c.bindings.isEditMode()&&(c.currItem=d,c.currBindings=$.extend(!0,{},ko.toJS(d.bindings)||{}),c.setWithOptions(b),b.withDataOptions=c.withDataOptions,tou.showModal("electricityEditDashboardItem",b,c))},updateDashboardItem:function(a){var b=this,c=ko.toJS(a),d=b.currItem,e=b.currBindings,f={};tou.forEach(c,function(a,b){e.hasOwnProperty(b)&&e[b]!==a&&(f[b]=a)}),d.processUpdates(f),tou.hideModal()},deleteDashboardItem:function(a){this.currItem.destroy(),tou.hideModal()}},computedBindings:{configRequired:function(){return this.noMeters()||this.noPeriods()}},modalTemplates:{electricityDashboardSelectBackground:{bgColor:"",background:"",backgroundImages:[],useColor:!1,backgroundPreview:"",uploadImageFn:"",newBackgroundHandler:function(a){this.uploadImageFn()(a)},selectBackground:function(a){this.background(a),this.useColor(!1)}},electricityEditDashboardItem:{period:"Week",title:"",width:1,height:1,dataSource:"Consumption",withDataSource:"None",useFiscalYear:!0,type:"",style:"180",colorStopsType:"percent",colorStops:[],withDataOptions:[],showOAT:!1,showHDD:!1,showCDD:!1,addColorStop:function(){this.colorStops.push({from:ko.observable(""),to:ko.observable(""),color:ko.observable("#000000")})},computeds:{titleText:function(a){return function(){return"Update "+a.type()+" Widget"}}},noReset:{withDataOptions:!0,showOAT:!0,showCDD:!0,showHDD:!0}}},doCancel:function(){var a=this;a.$packeryTarget.parent().block({message:""}),a.initItems(),a.initPackery(),a.$packeryTarget.parent().unblock()},doSave:function(){var a=this,b=a.getItemTemplate("Trend"),c=Object.keys(b),d=Object.keys(a.rawUtility.Dashboard.settings),e=a.bindings,f=a.utilityName,g=[],h={},i=[],j={},k={Trend:"column",Gauge:"solidgauge",Statistic:"statistic"},l=function(a){var b=ko.toJS(a.bindings),d={};return tou.forEachArray(c,function(a){d[a]=b[a]}),d},m=a.$packeryTarget.packery("getItemElements");tou.forEachArray(tou.dashboardItems,function(a){if(a.getUtility().utilityName===f){var b=l(a);b.type=k[b.type],"Statistic"!==a.type||a.mainContent?h[a.touid]=b:g.push(b)}}),tou.forEachArray(m,function(a){var b=ko.dataFor(a);i.push(h[b.touid])}),tou.forEachArray(d,function(a){j[a]=e[a]()}),a.rawUtility.Dashboard.headeritems=g,a.rawUtility.Dashboard.dashboarditems=i,a.rawUtility.Dashboard.settings=j,tou.saveUtility(a.rawUtility.utilityName,{Dashboard:a.rawUtility.Dashboard},function(a){tou.log(a)})},getItemTemplate:function(a,b){var c={Trend:"column",Gauge:"solidgauge",Statistic:"statistic"},d={width:"singleCol",height:"singleRow",title:"Title",type:c[a],peak:"",units:"kW",dataSource:"",withDataSource:"",period:"day",style:180,mainContent:b,colorStopsType:"percent",colorStops:[{from:"",to:"",color:"#000000"}]};return d},addNewItem:function(a,b,c){var d,e=this,f=e.dashboardItems.length,g=c||e.getItemTemplate(a,b);g.page=e,g.utilityName=e.utilityName,"Statistic"!==a||b?(g.$element=e.appendTemplate(f),d=new tou.DashboardItem(g,f),e.dashboardItems.push(d),e.updateLayout(g.$element)):e.bindings.headerItems.push(g)},updatePackeryElements:function(){var a=this;a.portletSelector="."+a.utilityNameShort+" .portlet",a.$portlets=$(a.portletSelector),a.$packeryTarget=$("."+a.utilityNameShort+" .dashboard .mainContent .innerContent")},initPackery:function(a){var b=this,c=b.getLayoutCSS(),d=b.$portlets.draggable("instance");d=d&&void 0!==d.started,b.updatePackeryElements(),b.packeryLoaded=!0,Packery.data(b.$packeryTarget[0])&&b.$packeryTarget.packery("destroy"),b.$packeryTarget.packery({columnWidth:c.width.singleCol,rowHeight:b.rowHeight,itemSelector:".portlet",gutter:b.gutter}),b.$packeryTarget.packery("bindResize"),b.bindings.isEditMode()&&(b.draggies=[],$(b.portletSelector).each(function(a,c){var d=new Draggabilly(c,{handle:".dragHandle"});b.draggies.push(d),b.$packeryTarget.packery("bindDraggabillyEvents",d)})),tou.doPageResize()},stopPackery:function(){tou.forEachArray(self.draggies,function(a){a.disable()})},initLayout:function(){var a=this;a.getLayoutCSS();a.hasLayout||a.initPackery(!0),a.hasLayout=!0},updateLayout:function(a){var b=this;b.getLayoutCSS();b.loading||(a?b.$packeryTarget.packery("fit",a[0]):(tou.forEachArray(b.draggies,function(a){a.destroy()}),b.initPackery()))},setLayoutCSS:function(){var a=this,b=a.getLayoutCSS(),c=[];a.rowHeight=b.height.singleRow,tou.$layoutCSS||(tou.$layoutCSS=$("<style/>",{id:"touLayout",html:""}),$("head").append(tou.$layoutCSS)),tou.forEach(b,function(a,b){tou.forEach(a,function(a,d){c.push("."+d+" {"+b+":"+a+"px;}")})}),tou.$layoutCSS.html(c.join(" ")),tou.forEachArray(a.layoutFns,function(a){a(b)})},layoutFns:[],onLayout:function(a){var b=this;b.layoutFns.push(a)},getLayoutCSS:function(){var a=this,b=window.innerWidth-140,c=tou.getPageHeight()-40,d=a.gutter,e=(c-2*d)/3,f=2*e+d,g=c,h={width:{singleCol:Math.floor(b/3)-28,doubleCol:2*Math.floor(b/3)-28,tripleCol:b-25},height:{singleRow:e,doubleRow:f,tripleRow:g}};return h},uploadImage:function(a){var b=this,c=new FormData;c.append(a.name,a),$.ajax({url:"/dashboard/uploadBackground",processData:!1,type:"POST",cache:!1,contentType:!1,data:c}).done(function(c){if(c.err)tou.log("Upload error",c.err);else{var d=a.name;d.match(/\s/)&&(d=d.split(" ").join("_")),b.bindings.backgroundImages.push(d),b.bindings.background(d),tou.hideModal()}}).fail(function(){tou.alert(tou.criticalErrorText)})},appendTemplate:function(a){var b=this,c=$("#trendPlotTemplate").html();return b.$packeryTarget.append(c.replace(/__IDX__/g,a)),b.$packeryTarget.find(".dashboardItem"+a)},initItems:function(){var a=this,b=a.rawUtility.Dashboard.settings,c=a.utilityName,d=[],e=[];tou.forEachArray(a.rawUtility.Dashboard.dashboarditems,function(a,b){a?e.push(a):tou.log("**Dashboard Error: Dashboard item",b,"null")}),a.rawUtility.Dashboard.dashboarditems=e,a.dashboardItems=[],a.bindings.headerItems([]),tou.forEachArrayRev(a.dashboardItems,function(a){a.destroy()}),tou.forEachArrayRev(tou.dashboardItems,function(a){a.utilityName===c&&a.destroy()}),a.$packeryTarget.html(""),tou.forEachArray(a.rawUtility.Dashboard.dashboarditems,function(b,e){var f;b.$element=a.appendTemplate(e),b.page=a,b.utilityName=c,f=new tou.DashboardItem(b,e),a.dashboardItems.push(f),d.push(f)}),tou.forEachArray(a.rawUtility.Dashboard.headeritems,function(b){a.addNewItem("Statistic",null,b)}),tou.forEach(b,function(b,c){a.bindings[c](b)})},setFiscalYears:function(){var a=this;a.fiscalYears={},a.fiscalYear=tou.currUtility.RateTables["Fiscal Year"],tou.forEachArray(tou.availablePeriods[a.utilityName],function(b){b.fullDate&&b.fullDate.match("Fiscal Year")&&(a.fiscalYears[b.fiscalYear]={start:b.start,end:b.end})})},setWithOptions:function(a){var b=this,c=tou.bindings.electricityEditDashboardItemContext.$data,d={CDD:{name:"Cooling Degree Days",showInList:!1},HDD:{name:"Heating Degree Days",showInList:!1},OAT:{name:"Outside Air Temperature",showInList:!1}},e=["None"];tou.forEach(d,function(a,b){var c=a.name;tou.weatherPoints[b]&&(e.push(c),a.showInList=!0)}),a&&tou.forEach(d,function(b,c){a["show"+c]=b.showInList}),b.withDataOptions=e,c.withDataOptions(e)},init:function(){var a=this,b=200;a.loading=!0,tou.bindings.loadModals(tou.rawUtilities.length>0),a.$packeryTarget=$("."+a.utilityName+" .dashboard .mainContent .innerContent"),a.setFiscalYears(),a.initItems(),a.bindings.useColor()&&a.bindings.background("blank.png"),a.loading=!1,$(window).resize(function(){tou.currPage&&tou.currPage.title!==a.title?a.needsResize=!0:(a.lastResize=new Date,setTimeout(function(){new Date-a.lastResize>=b&&(a.setLayoutCSS(),a.updateLayout())},b))}),tou.on("pageClick",function(b){b===a.title&&a.needsResize&&(a.needsResize=!1,a.setLayoutCSS(),a.updateLayout(),tou.forEachArray(tou.dashboardItems,function(a){a.handleResize()}))}),a.bindings.isEditMode.subscribe(function(b){b?a.initPackery():a.stopPackery()}),a.loaded=!0,a.bindings.loaded(!0),tou.onLoad(function(){setTimeout(function(){a.setWithOptions(),a.setLayoutCSS(),a.initLayout(),tou.makeDataRequest(),tou.getMeters().length>0&&a.bindings.noMeters(!1),tou.on("meterssaved",function(b){b===a.utilityName&&a.bindings.noMeters(0===tou.getMeters().length)}),tou.availablePeriods[a.utilityName].length>0&&a.bindings.noPeriods(!1),tou.on("ratetablesaved",function(b){b===a.utilityName&&(a.setFiscalYears(),a.bindings.noPeriods(0===tou.availablePeriods[a.utilityName].length))}),a.initPackery(!0)},1)})}},{title:"Billing",isActive:ko.observable(!1),background:"woodbackgroundtile.jpg",classPrefix:"",delayLoad:!0,defaultTitle:"",tempDefaultTitle:"",committedBills:{},dataRequests:{},billData:{loadFactor:{displayValue:"0%",value:0,contributors:{}},title:"",collections:[],commit:{done:!1,timestamp:0,user:""}},yearBillData:{title:"",commit:{done:!1,timestamp:0,user:""},collections:[]},bills:[],rawUtility:null,activeMeters:[],daysInMonth:[31,28,31,30,31,30,31,31,30,31,30,31],modalTemplates:{billingDefaultTitle:{title:""},billingUncommitBill:{commitInfo:""},billingCommitBill:{}},bindings:{configRequired:ko.observable(!1),billData:ko.observable({loadFactor:{displayValue:"0%",value:0,contributors:{}},title:"",collections:[],commit:{done:!1,timestamp:0,user:""}}),yearBillData:ko.observable({title:"",commit:{done:!1,timestamp:0,user:""},collections:[]}),billsFilter:ko.observable(""),selectedBill:ko.observable({period:"",prettyDate:""}),billsAvailable:ko.observable(!1),billingCycle:ko.observable({completedDays:"Working...",totalDays:0,complete:!1,percentComplete:"0%"}),gettingData:ko.observable(!1),isEditMode:ko.observable(!1),print:function(){tou.print($(this.$page.classPrefix+"."+this.$page.title.toLowerCase()+" .mainContent"))},exportPDF:function(){tou.exportPDF($(this.$page.classPrefix+"."+this.$page.title.toLowerCase()+" .billingContent"))},toEditMode:function(){this.isEditMode(!0)},cancelEditMode:function(){var a=this,b=a.$page,c=b.billData,d=b.defaultTitle;b.tempDefaultTitle!==d&&(b.tempDefaultTitle=d,c.title=b.processBillTitle(d,a.selectedBill()),a.billData(c)),a.isEditMode(!1)},save:function(){var a,b=this,c=b.$page,d=$(b.$page.classPrefix+".billingTopBar button.editControl"),e=d.find("i");c.defaultTitle!==c.tempDefaultTitle?(d.attr("disabled",!0),a=setTimeout(function(){e.show()},100),c.saveBilling(c,{path:[c.title,"defaultTitle"].join("."),remove:!1,data:c.tempDefaultTitle,callback:function(f){clearTimeout(a),e.hide(),d.attr("disabled",!1),f?tou.alert(tou.saveErrorText):(c.defaultTitle=c.tempDefaultTitle,b.isEditMode(!1))}})):b.isEditMode(!1)},isSystemAdmin:function(){return tou.isSystemAdmin()},selectBill:function(a){this.selectedBill(a)},commitBill:function(){var a,b=this,c=parseInt((new Date).getTime()/1e3,10),d=b.bindings.selectedBill(),e="Month"===d.period?b.billData:b.yearBillData,f=$.extend(!0,{},e),g=b.committedBills,h=tou.workspaceManager.user(),i=$(".billingCommitBillModal .commitControls button"),j=i.find("i"),k=function(a){a.done=!0,a.timestamp=c,a.user=[h.firstName,h.lastName].join(" ")};k(f.commit),i.attr("disabled",!0),a=setTimeout(function(){j.show()},100),b.saveBilling(b,{path:[b.title,"committedBills",d.fullDate].join("."),remove:!1,data:f,callback:function(c){clearTimeout(a),j.hide(),i.attr("disabled",!1),c?tou.alert("There was a problem committing this bill. Please try again. If the problem persists please reload the page and try again."):(k(e.commit),d.isCommitted(!0),g[d.fullDate]=f,b.buildBill(d),tou.hideModal())}})},uncommitBill:function(){var a,b=this,c=b.bindings.selectedBill(),d=b.committedBills,e=$(".billingUncommitBillModal .uncommitControls button"),f=e.find("i");e.attr("disabled",!0),a=setTimeout(function(){f.show()},100),b.saveBilling(b,{path:[b.title,"committedBills",c.fullDate].join("."),remove:!0,data:null,callback:function(g){clearTimeout(a),f.hide(),e.attr("disabled",!1),g?tou.alert("There was a problem uncommitting this bill. Please try again. If the problem persists please reload the page and try again."):(delete d[c.fullDate],c.isCommitted(!1),b.buildBill(c),tou.hideModal())}})},showCommitModal:function(){tou.showModal("billingCommitBill",null,this.$page)},showUncommitModal:function(){tou.showModal("billingUncommitBill",{commitInfo:this.getCommitInfoString(this.billData().commit)},this.$page)},showDefaultTitleModal:function(){this.isEditMode()&&tou.showModal("billingDefaultTitle",{title:this.$page.tempDefaultTitle},this.$page)},updateBillTitle:function(a){var b=this,c=a.title(),d=b.defaultTitle,e=b.billData;c!==d&&(b.tempDefaultTitle=c,e.title=b.processBillTitle(c,b.bindings.selectedBill()),b.bindings.billData(e)),tou.hideModal()},getCommitInfoString:function(a){var b=new Date(1e3*a.timestamp),c=new Date,d=b.getDate(),e=tou.fullMonthList[b.getMonth()],f=b.getFullYear(),g=[e,d].join(" ");return f!==c.getFullYear()&&(g=[g,", ",f].join("")),g+=".",["This bill was committed by",a.user,"on",g].join(" ")}},computedBindings:{filteredBills:function(){var a=this,b=a.billsFilter().toLowerCase(),c=a.$page.bills;return""===b?c:ko.utils.arrayFilter(c,function(a){return a.searchDate.indexOf(b)>-1})}},clearBillData:function(){var a=this.billData;a.collections.length=0,a.title="",a.loadFactor={displayValue:"0%",value:0,contributors:{}},a.commit={done:!1,timestamp:0,user:""}},clearYearBillData:function(){var a=this.yearBillData;a.title="",a.commit={done:!1,timestamp:0,user:""},a.collections.length=0},saveBilling:function(a,b){var c={utilityName:a.utilityName,path:b.path,remove:b.remove};tou.saveUtility(c,b.data,function(a){tou.log("saveresponse",a),void 0!==b.callback&&(a.message&&"success"===a.message?b.callback(!1):b.callback(!0))},!0)},newCollection:function(a){return{name:a,columns:{name:{visible:!0,title:"Name"},usage:{visible:!1,title:"TBD"},rate:{visible:!1,title:"Rate ($)"},rateModifier:{visible:!1,title:"Rate + {ratemodifier}% ($)",value:0},amount:{visible:!0,title:"Amount ($)"}},rows:[]}},newRow:function(a){return{name:{displayValue:a,visible:!0},usage:{value:0,displayValue:"0",visible:!1,units:{displayValue:"",visible:!1},contributors:{}},rate:{value:0,displayValue:"0",visible:!1},modifiedRate:{value:0,displayValue:"0",visible:!1},amount:{value:0,displayValue:"0",visible:!0}}},processBillTitle:function(a,b){var c={Month:{"{Season}":b.season,"{Month}":b.month,"{Year}":b.year,"{Fiscal Year}":b.fiscalYear},Year:{"{Season}":"","{Month}":"","{Year}":"","{Fiscal Year}":b.fiscalYear}},d=c[b.period];return a=a.replace(/{Month}|{Season}|{Year}|{Fiscal Year}/g,function(a){return d[a]}),a.replace(/  /g," ")},buildActiveMeters:function(){var a=this;return a.activeMeters=tou.getActiveMeterList(tou.currUtility.Meters),a.activeMeters},getNumberOfDecimalDigits:function(a){var b=a.toString().split(".")[1];return void 0===b?0:b.length},buildBill:function(a){if(void 0!==a){var b=this;"Month"===a.period?b.getMonthData(a,function(){b.bindings.billData(b.billData),b.bindings.gettingData(!1)}):b.getYearData(a,function(){b.bindings.yearBillData(b.yearBillData),b.bindings.gettingData(!1)})}},getMonthData:function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q=this,r=a.rateTable,s=r["Fiscal Year"],t=q.billData.collections,u={demand:"kW",consumption:"kWh",reactive:"kVAR",reactivepower:"kVAR"},v=tou.makeId(),w={options:[],handler:q.receiveDataHandler.bind(q)},x={start:parseInt(a.start/1e3,10),end:parseInt(a.end/1e3,10)},y=[v,"both","consumption"].join("_"),z=null,A=q.activeMeters||q.buildActiveMeters(),B=function(b){for(var c=new Date(a.start).setDate(15),d=0,e=b.length;d<e;d++){var f=b[d];if(c>new Date(f.start.date)&&c<new Date(f.end.date))return f}return null},C=function(a){var b={transition:"Transition",cooling:"Summer",summer:"Summer",heating:"Winter",winter:"Winter"};return a.name.replace("{Season}",b[e.rangeType])},D=function(a){return a.replace(/ /g,"").split("AND")},E=function(a){return a.match(/[0-9.]+/)[0]},F=function(a){return a.match(/[<>=]+/)[0]},G=function(a,b){var c,d,e,f=D(a.qualifier),g=D(b.qualifier),h=f[0],i=g[0];return c=E(h),d=E(i),c===d?(e=F(h),"<"===e||"<="===e?-1:1):c<d?-1:1},H=function(){var a,b,c,d,e,f,g,h,i,j;for(i=0,j=m.length;i<j;i++)if(n=m[i],a=n.tierError,b=n.qualifier,c=D(b),e=E(c[0]),f=c[1]&&E(c[1]),d=F(c[0]).match(/[<=]/g),0===i?(!d||c.length>1)&&(a=!0):a||(h=D(m[i-1].qualifier),g=E(h[h.length-1]),e!==g&&(a=!0)),a)for(i;i<j;i++)m[i].tierError=!0;else e&&f?n.multiplier=f-e:d?n.multiplier=+e:n.multiplier=null},I=function(a){J({touid:y,rateType:"consumption",peak:"both",rate:{qualifier:""}}),J({touid:[v,a,"demand"].join("_"),rateType:"demand",peak:a})},J=function(a){var b=a.touid,c=a.peak,d=a.rateType,e={rateCollectionName:L,fiscalYear:s,touid:b,scale:"month",peak:c,range:x};if("demand"===d)e.fx="max",e.upis=A.demand;else if("consumption"===d)e.fx="sum",e.upis=A.consumption,a.rate.qualifier.length&&(z=d,I("On Peak Demand"===a.rate.qualifierDemand?"on":"both"),z=null);else if("reactive"===d)e.fx="reactiveCharge",e.upis=A.demand,e.secondUpis=A.reactive;else{if("loadFactor"!==d)return;z=d,I("both"),z=null}b&&(q.dataRequests.hasOwnProperty(b)===!1&&(q.dataRequests[b]=[],e.utilityName=q.utilityName,w.options.push(e)),q.dataRequests[b].push({masterRateType:z,rateType:d,billingCollection:h,billingRow:g,requestOptions:e}))},K=function(a){if("transition"!==e.rangeType||a.showInTransition||e.enablePeakSelection){var b,d,j=f[a.name],o=a.type,p=a.peak,r=a.qualifier,s=!0;(isNaN(j)||null===j||"string"==typeof j)&&(j=0),g=q.newRow(C(a)),g.tempData={rate:a},g.rateElement=$.extend({},a),"ratemodifier"===o?(l.visible=!0,l.title=l.title.replace("{ratemodifier}",j),l.value=j,s=!1):"flatrate"===o?(g.usage.value=j,g.rate.value=1):("consumption"===o?(r.length&&"off"===p&&(c.hasOwnProperty(r)===!1?(n={rows:[g],qualifier:r,tierError:!1,qualifierDemand:a.qualifierDemand},c[r]=n,m.push(n)):(n=c[r],n.rows.push(g),n.qualifierDemand!==a.qualifierDemand&&(n.tierError=!0))),"off"===p?h.tempData.offPeakConsumptionRow=g:"on"===p&&(h.tempData.onPeakConsumptionRow=g)):"demand"===o?"on"===p&&(h.tempData.onPeakDemandRow=g):"reactive"===o&&(p="transition"===e.rangeType?e.enablePeakSelection?"on":"both":"on",g.rateElement.peak=p),b=u[o],g.usage.units.displayValue=b,i[b]=!0,g.rate.visible=!0,g.rate.value=j,d=q.getNumberOfDecimalDigits(j),d>h.tempData.maxRateDigits&&(h.tempData.maxRateDigits=d),k.visible=!0,g.usage.visible=!0,J({touid:[v,p,o].join("_"),rate:a,peak:p,rateType:o})),s===!0&&h.rows.push(g)}};if(q.dataRequests={callback:b},q.clearBillData(),q.committedBills.hasOwnProperty(a.fullDate))return void q.bindings.billData(q.committedBills[a.fullDate]);q.billData.title=q.processBillTitle(q.defaultTitle,a);for(var L in r)d=r[L],d.hasOwnProperty("periods")!==!1&&(e=B(d.periods),e&&Object.keys(e.rates).length&&(f=e.rates,h=q.newCollection(L),j=h.columns,k=j.rate,l=j.rateModifier,h.tempData={unitsUsed:{},uniqueTieredConsumptions:[],maxRateDigits:0,maxModifiedRateDigits:0},i=h.tempData.unitsUsed,m=h.tempData.uniqueTieredConsumptions,c={},d.rates.forEach(K),m.sort(G),H(),h.rows.length>0&&(t[d.order]=function(){return h}())));for(o=0,p=t.length;o<p;o++)h=t[o],void 0===h&&(t.splice(o,1),p-=1,o-=1);J({touid:null,rateType:"loadFactor"}),q.billData.loadFactor.contributors.hours=function(){var b,c=new Date(a.start),d=c.getMonth(),e=c.getFullYear();return b=q.daysInMonth[d],1===d&&e%4===0&&b++,24*b}(),t.length>0?(q.bindings.gettingData(!0),tou.addDataRequest(w),tou.makeDataRequest()):q.bindings.billData(q.billData)},getYearData:function(a,b){var c=this,d=a.fiscalYear,e=c.bills.filter(function(a){return a.fiscalYear===d&&"Month"===a.period}),f=[],g=c.yearBillData,h=function(){g.source.sort(function(a,b){return a.start>b.start?1:-1}),c.postProcessYearData_step1(b)},i=function(a,b){g.source.push({month:a.month,start:a.start,end:a.end,season:a.season,data:b,fullDate:a.fullDate,fiscalyear:a.fiscalYear,rateTable:a.rateTable})},j=function(a){c.getMonthData(a,k)},k=function(){i(f[0],$.extend(!0,{},c.billData)),f.shift(),f.length?j(f[0]):h()};return c.clearYearBillData(),c.committedBills.hasOwnProperty(a.fullDate)?void c.bindings.yearBillData(c.committedBills[a.fullDate]):(g.source=[],g.title=c.processBillTitle(c.defaultTitle,a),Array.prototype.push.apply(g.collections,[{name:{displayValue:"Demand",id:"demand"},columns:[{name:{title:"Name",visible:!0}}],rows:[{name:{id:"onPeak",displayValue:"On Peak Demand",visible:!0},units:{displayValue:"",visible:!1},data:[]},{name:{id:"offPeak",displayValue:"Off Peak Demand",visible:!0},units:{displayValue:"",visible:!1},data:[]},{name:{id:"reactiveAtPeak",displayValue:"Reactive Power at Peak Demand",visible:!0},units:{displayValue:"",visible:!1},data:[]}]},{name:{displayValue:"Consumption",id:"consumption"},columns:[{name:{title:"Name",visible:!0}}],rows:[{name:{id:"total",displayValue:"Total Consumption",visible:!0},units:{displayValue:"",visible:!1},data:[]},{name:{id:"onPeak",displayValue:"On Peak Consumption",visible:!0},units:{displayValue:"",visible:!1},data:[]},{name:{id:"offPeak",displayValue:"Off Peak Consumption",visible:!0},units:{displayValue:"",visible:!1},data:[]}]},{name:{displayValue:"Load Factor",id:"loadFactor"},columns:[{name:{title:"Name",visible:!0}}],rows:[{name:{id:"loadFactor",displayValue:"Load Factor",visible:!0},units:{displayValue:"",visible:!1},data:[]}]},{name:{displayValue:"Charges",id:"charges"},columns:[{name:{title:"Name",visible:!0}}],rows:[]},{name:{displayValue:"NET Cost",id:"netCost"},columns:[{name:{title:"Name",visible:!0}}],rows:[{name:{id:"kwh",displayValue:"NET Cost Per kWh",visible:!0},units:{displayValue:"",visible:!1},data:[]}]}]),e.forEach(function(a){a.isCommitted()?i(a,c.committedBills[a.fullDate]):f.push(a)}),void(f.length?j(f[0]):h()))},postProcessYearDataReceiveDataHandler:function(a){if(this.dataRequests.hasOwnProperty(a.touid)!==!1){var b=this,c=a.results,d=this.dataRequests[a.touid],e=d.usage,f=d.rateType,g={consumption:"sums",demand:"maxes"},h={consumption:"sum",demand:"max"},i=0;a.error?e.displayValue="Error":("reactive"===f?"object"==typeof c&&(i=c[0].reactive.max||0):i=c[g[f]][0][h[f]]||0,e.value=tou.toFixed(1e3*i,0),e.displayValue=b.prettyValue({value:e.value,digits:0})),delete e.notFound,delete b.dataRequests[a.touid],1===Object.keys(b.dataRequests).length&&b.postProcessYearData_step2(b)}},postProcessYearData_step1:function(a){var b=this,c={},d=[],e={January:"Jan",February:"Feb",March:"Mar",April:"Apr",May:"May",June:"Jun",July:"Jul",August:"Aug",September:"Sep",October:"Oct",November:"Nov",December:"Dec"},f=b.activeMeters||b.buildActiveMeters(),g={options:[],handler:b.postProcessYearDataReceiveDataHandler.bind(b)},h=function(){var a=j(b.yearBillData.collections,"charges"),c=a.rows,e=[];b.yearBillData.source.forEach(function(a,f){var g=j(a.data.collections,"Total Charges"),h=g&&g.rows||[],i=0;d.forEach(function(a){var b,d=k(h,a,"displayValue"),e=k(c,a,"displayValue"),g={value:d&&d.amount.value||0,displayValue:d&&d.amount.displayValue||"-"};if(!e)for(c.push({name:{displayValue:a,visible:!0},data:[]}),e=c[c.length-1],b=0;b<f;b++)e.data.push({value:0,displayValue:"-",isTotal:!0});e.data.push(g),i+=g.value}),i=tou.toFixed(i,2),e.push({value:i,displayValue:b.prettyValue({value:i,minDigits:2}),isTotal:!0})}),c.push({name:{displayValue:"Total",visible:!0},data:e,isTotalRow:!0})},i=function(a,b,c){for(var d,e=0,f=a.length;e<f;e++)if(d=a[e].name,"object"==typeof d&&(d=d[c||"id"]),d===b)return a[e]},j=function(a,b,c){return i(a,b,c)},k=function(a,b,c){return i(a,b,c)},l=function(a,c,d){for(var e,f,g,h,i=a.collections,j={demand:"kW",consumption:"kWh",reactive:"kVAR"},k=0,l=i.length;k<l;k++){e=i[k];for(var m=0,n=e.rows.length;m<n;m++)if(f=e.rows[m],f.rateElement&&f.rateElement.type===c&&("reactive"===c||f.rateElement.peak===d))return g=f.usage,g="reactive"===c?g.contributors.reactiveMax:"demand"===c?g.contributors.demand:g.contributors.consumption,g=tou.toFixed(g,0),h={value:g,displayValue:b.prettyValue({value:g,digits:0})},h.units={displayValue:f.usage.units.displayValue,visible:!1},h.rateElement=f.rateElement,h}return{value:0,displayValue:"0",units:{displayValue:j[c],visible:!1},notFound:!0}},m=function(a){var b=a.loadFactor;
return{value:b.value,displayValue:b.displayValue}},n=function(a){var c=a.source,d={utilityName:b.utilityName,fiscalYear:c.fiscalyear,touid:tou.makeId(),scale:"month",peak:a.peak,fx:a.fx,upis:a.upis,range:{start:parseInt(c.start/1e3,10),end:parseInt(c.end/1e3,10)}};return a.secondUpis&&(d.secondUpis=a.secondUpis),d},o={demand:function(a,c,d){var e,h,i,j=c.data;h=l(j,"demand","on"),e=k(a.rows,"onPeak"),e.data.push(h),h.notFound&&(i=n({source:c,peak:"on",fx:"max",upis:f.demand}),g.options.push(i),b.dataRequests[i.touid]={requestOptions:i,usage:h,rateType:"demand"}),h=l(j,"demand","off"),e=k(a.rows,"offPeak"),e.data.push(h),h.notFound&&(i=n({source:c,peak:"off",fx:"max",upis:f.demand}),g.options.push(i),b.dataRequests[i.touid]={requestOptions:i,usage:h,rateType:"demand"}),h=l(j,"reactive"),e=k(a.rows,"reactiveAtPeak"),e.data.push(h),h.notFound&&(i=n({source:c,peak:"both",fx:"reactiveCharge",upis:f.demand,secondUpis:f.reactive}),g.options.push(i),b.dataRequests[i.touid]={requestOptions:i,usage:h,rateType:"reactive"})},consumption:function(a,c,d){var e,h,i,j=c.data;h=l(j,"consumption","both"),h.isTotal=!0,e=k(a.rows,"total"),e.data.push(h),h.notFound&&(i=n({source:c,peak:"both",fx:"sum",upis:f.consumption}),g.options.push(i),b.dataRequests[i.touid]={requestOptions:i,usage:h,rateType:"consumption"}),h=l(j,"consumption","on"),e=k(a.rows,"onPeak"),e.data.push(h),h.notFound&&(i=n({source:c,peak:"on",fx:"sum",upis:f.consumption}),g.options.push(i),b.dataRequests[i.touid]={requestOptions:i,usage:h,rateType:"consumption"}),h=l(j,"consumption","off"),e=k(a.rows,"offPeak"),e.data.push(h),h.notFound&&(i=n({source:c,peak:"off",fx:"sum",upis:f.consumption}),g.options.push(i),b.dataRequests[i.touid]={requestOptions:i,usage:h,rateType:"consumption"})},loadFactor:function(a,b,c){k(a.rows,"loadFactor").data.push(m(b.data))},charges:function(a,b,e){var f=j(b.data.collections,"Total Charges"),g=f&&f.rows||[];g.forEach(function(a){var b=a.name.displayValue;"Total"===b||c[b]||(c[b]=!0,d.push(b))})},netCost:function(a,b,c){}};b.dataRequests={callback:a},b.yearBillData.source.forEach(function(a,c){b.yearBillData.collections.forEach(function(b){b.columns.push({name:{title:e[a.month],visible:!0},season:a.season,start:a.start,end:a.end,fullDate:a.fullDate}),o[b.name.id](b,a,c)})}),h(),0===g.options.length?b.postProcessYearData_step2(b):(b.bindings.gettingData(!0),tou.addDataRequest(g),tou.makeDataRequest())},postProcessYearData_step2:function(a){var b=function(){var b=f(e(a.yearBillData.collections,"netCost").rows,"kwh").data,c=f(e(a.yearBillData.collections,"charges").rows,"Total","displayValue").data,d=f(e(a.yearBillData.collections,"consumption").rows,"total").data;c.forEach(function(c,e){var f,g=c.value/d[e].value;g===1/0&&(g=0),f={value:g,displayValue:a.prettyValue({value:g,digits:4,minDigits:4})},b.push(f)})},c=function(){var b,c,d,g,h={demand:{calc:"Average",digits:0,prepend:"",append:""},consumption:{calc:"Total",digits:0,prepend:"",append:""},loadFactor:{calc:"Average",digits:1,prepend:"",append:"%"},charges:{calc:"Total",digits:2,minDigits:2,prepend:"$",append:""},netCost:{calc:"Average",digits:4,minDigits:4,prepend:"$",append:""}};a.yearBillData.collections.forEach(function(i){var j=h[i.name.id];i.columns.push({name:{title:j.calc,visible:!0}}),i.rows.forEach(function(h){var k,l={value:0,index:null},m=0,n=0,o={},p={};h.data.forEach(function(a,b){a.value>l.value&&(l.value=a.value,l.index=b),m+=a.value,n++,k=a.units&&a.units.displayValue,k&&k.length&&!p[k]&&(p[a.units.displayValue]=!0)}),null!==l.index&&(h.data[l.index].isMax=!0),"Total"===j.calc?(o.value=m,o.isTotal=!0):"netCost"===i.name.id?(b=e(a.yearBillData.collections,"consumption"),c=f(b.rows,"total"),d=e(a.yearBillData.collections,"charges"),g=f(d.rows,"Total","displayValue"),o.value=g.data[g.data.length-1].value/c.data[c.data.length-1].value):o.value=m/n,o.displayValue=a.prettyValue({value:o.value,digits:j.digits,minDigits:j.minDigits,prepend:j.prepend,append:j.append}),h.data.push(o),"demand"!==i.name.id&&"consumption"!==i.name.id||(p=Object.keys(p),1===p.length?(h.units.displayValue=p[0],h.units.visible=!0):h.data.forEach(function(a){a.units&&a.units.displayValue.length&&(a.units.visible=!0)}))})})},d=function(a,b,c){for(var d,e=0,f=a.length;e<f;e++)if(d=a[e].name,"object"==typeof d&&(d=d[c||"id"]),d===b)return a[e]},e=function(a,b,c){return d(a,b,c)},f=function(a,b,c){return d(a,b,c)};b(),c(),delete a.yearBillData.source,a.dataRequests.callback()},prettyValue:function(a){var b=a.hasOwnProperty("digits")?a.digits||0:2,c=tou.toFixed(a.value,b).toString().split("."),d=c[0],e=c[1],f=a.prepend,g=a.append;if(a.minDigits)for(e=e||"",i=e.length,len=a.minDigits;i++<len;)e+="0";return void 0!==e&&(e=[".",e].join("")),void 0===f&&(f=""),void 0===g&&(g=""),d=d.replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,"),[f,d,e,g].join("")},applyPostProcessing:function(){var a,b=this,c=b.billData.collections,d=b.newCollection("Total Charges"),e=0,f=c.length>1,g=function(a){return a.modifiedRate.visible?a.modifiedRate.value:a.rate.value},h=function(){var a,c=b.billData.loadFactor,d=c.contributors;a=d.totalConsumption/(d.hours*d.maxDemand)||0,a*=100,c.value=a,c.displayValue=b.prettyValue({value:a,digits:1,append:"%"})};c.forEach(function(a){var c,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z=0,A=b.newRow("Total"),B=a.tempData,C=a.columns.usage,D=Object.keys(B.unitsUsed),E=D.length,F=E>1,G=B.onPeakDemandRow,H=B.uniqueTieredConsumptions,I=B.onPeakConsumptionRow,J=B.offPeakConsumptionRow,K=J&&J.usage.value,L={},M=0,N=0;for(E>0&&(C.visible=!0,E>1?C.title="Usage":C.title=D[0]),p=0,q=H.length;p<q;p++)for(k=H[p],n=k.rows,l=n[0],contributors=l.usage.contributors,k.tierError?(t=0,i="Error"):null!==k.multiplier?(c=tou.toFixed(contributors.maxDemand||contributors.peakDemand||0,0),t=tou.toFixed((l.usage.value/tou.toFixed(contributors.totalConsumption,0)||0)*c*k.multiplier,0),t=Math.min(t,K),K-=t,N+=t,K<0&&(N+=K,K=0)):(t=K,N+=t),p!==q-1||k.tierError||I&&(h=tou.toFixed(contributors.totalConsumption,0)-I.usage.value-N,1===Math.abs(h)&&(t+=h)),r=0,s=n.length;r<s;r++)l=n[r],l.usage.contributors.tierMultiplier=k.multiplier,l.usage.value=t,"Error"===i&&(l.usage.displayValue="Error",l.tempData.doNotGetDisplayValue=!0);for(n=a.rows,p=0,q=n.length;p<q;p++)l=n[p],v=l.tempData,o=v.rate,m=[o.type,o.peak,o.qualifier].join("_"),"demand"===o.type&&"off"===o.peak&&void 0!==G&&(t=l.usage.value-G.usage.value,l.usage.value=t<0?0:t),j="flatrate"===o.type?14:0,l.tempData.doNotGetDisplayValue||(l.usage.value<0?l.usage.displayValue=b.prettyValue({value:Math.abs(l.usage.value),digits:0,prepend:"(",append:")"}):l.usage.displayValue=b.prettyValue({value:l.usage.value,digits:j})),l.rate.displayValue=b.prettyValue({value:l.rate.value,minDigits:a.tempData.maxRateDigits,digits:a.tempData.maxRateDigits}),l.modifiedRate.displayValue=b.prettyValue({value:l.modifiedRate.value,minDigits:a.tempData.maxModifiedRateDigits,digits:a.tempData.maxModifiedRateDigits}),u=g(l)*l.usage.value,u=tou.toFixed(u,2),u<0?(u=0,l.amount.displayValue="-"):l.amount.displayValue=b.prettyValue({value:u,minDigits:2}),l.amount.value=u,z+=u,l.usage.visible&&(F?l.usage.units.visible=!0:L.hasOwnProperty(m)===!1&&(L[m]=!0,M+=l.usage.value)),"reactive"===o.type&&(x=b.newRow("Lagging Reactive Power at Peak Demand"),x.amount.visible=!1,i=l.tempData.reactiveMax||0,x.usage.value=i,x.usage.displayValue=b.prettyValue({value:i,digits:0}),x.usage.visible=!0,x.usage.units.displayValue="kVAR",F&&(x.usage.units.visible=!0),n.splice(p,0,x),y=b.newRow(["Less ",l.tempData.rate.threshold,"% of Maximum Demand"].join("")),y.amount.visible=!1,i=l.tempData.lessDemandMax||0,y.usage.value=i,y.usage.displayValue=b.prettyValue({value:i,digits:0}),y.usage.visible=!0,y.usage.units.displayValue="kVAR",F&&(y.usage.units.visible=!0),n.splice(p+1,0,y),q+=2,p+=2),delete l.tempData;A.amount.value=z,A.amount.displayValue=b.prettyValue({value:z,minDigits:2,prepend:"$"}),A.usage.value=M,A.usage.displayValue=b.prettyValue({value:M,digits:0}),C.visible===!0&&"kWh"===C.title&&Object.keys(L).length>1&&(A.usage.visible=!0),a.rows.push(A),f&&(w=b.newRow(a.name),w.amount.value=z,w.amount.displayValue=b.prettyValue({value:z,minDigits:2}),d.rows.push(w),e+=z),delete a.tempData}),f&&(a=b.newRow("Total"),a.amount.value=e,a.amount.displayValue=b.prettyValue({value:e,minDigits:2,prepend:"$"}),d.rows.push(a),c.push(d)),h(),b.dataRequests.callback()},receiveDataHandler:function(a){if(this.dataRequests.hasOwnProperty(a.touid)!==!1){var b,c,d=this,e=d.dataRequests[a.touid],f=a.results,g=d.billData.loadFactor,h={consumption:"sums",demand:"maxes"},i={consumption:"sum",demand:"max"};e.forEach(function(e){var j,k,l,m,n=e.rateType,o=function(){var a,b=j.rate.value,c=j.modifiedRate;c.visible=!0,b*=1+m.value/100,b=b.toPrecision(14),b=parseFloat(b),c.value=b,a=d.getNumberOfDecimalDigits(b),a>k.maxModifiedRateDigits&&(k.maxModifiedRateDigits=a)};j=e.billingRow,l=j.usage.contributors,k=e.billingCollection.tempData,m=e.billingCollection.columns.rateModifier,a.error?c=0:"reactive"===n?(l.threshold=j.tempData.rate.threshold,"object"==typeof f?(l.reactiveMax=1e3*(f[0].reactive.max||0),l.demandMax=1e3*(f[0].demand.max||0),j.tempData.reactiveMax=tou.toFixed(l.reactiveMax,0),j.tempData.lessDemandMax=tou.toFixed(l.demandMax*(l.threshold/100),0),c=j.tempData.reactiveMax-j.tempData.lessDemandMax):(j.tempData.reactiveMax=0,l.reactiveMax=0,j.tempData.demandMax=0,l.demandMax=0,c=0)):(c=f[h[n]][0][i[n]]||0,c*=1e3),e.masterRateType?(b="consumption"===n?"totalConsumption":"both"===e.requestOptions.peak?"maxDemand":"peakDemand","loadFactor"===e.masterRateType?g.contributors[b]=c:l[b]=c):(l[n]=c,j.usage.value=tou.toFixed(c,0),m.visible&&o())}),delete d.dataRequests[a.touid],1===Object.keys(d.dataRequests).length&&d.applyPostProcessing()}},initSubscriptions:function(){var a=this,b=a.classPrefix,c=a.bindings,d=new Date,e=d.getFullYear(),f=d.getMonth();c.selectedBill.subscribe(function(b){if(b){var g={complete:!1},h=new Date(b.start),i=h.getMonth(),j=h.getFullYear();"Month"===b.period?(g.totalDays=a.daysInMonth[i],1===i&&j%4===0&&g.totalDays++,e===j&&f===i?g.completedDays=d.getDate():g.complete=!0):(g.totalDays=(b.end-b.start)/864e5,d>=b.start&&d<b.end?g.completedDays=Math.ceil((d-b.start)/864e5):g.complete=!0),g.complete?(g.completedDays=g.totalDays,g.percentComplete="100%"):g.percentComplete=[parseInt(g.completedDays/g.totalDays*100,10),"%"].join(""),c.billingCycle(g),a.buildBill(b)}}),c.isEditMode.subscribe(function(a){var c=$(b+".billingTopBar .viewControls").find("button");c.attr("disabled",a)}),c.gettingData.subscribe(function(a){var c=$(b+".billingTopBar").find("button");c.attr("disabled",a)})},init:function(){var a,b=this,c=b.bindings,d="."+b.utilityNameShort+" ",e=$(d+".billingTopBar .dropdown-menu.availablePeriods"),f=e.find("input"),g=0===tou.getMeters(!0).length,h=function(a){if(a)for(var c=0,d=b.bills.length;c<d;c++)if(b.bills[c].fullDate===a.fullDate)return b.bills[c]},i=function(){var d;b.bills=$.extend(!0,[],tou.availablePeriods[b.utilityName]),b.bills.forEach(function(a){a.isCommitted=ko.observable(!!b.committedBills.hasOwnProperty(a.fullDate))}),a=g||0===b.bills.length,c.configRequired(a),a||(c.billsAvailable(b.bills.length>0),c.billsFilter.valueHasMutated(),d=h(c.selectedBill()),d||(d=b.bills[1]||b.bills[0]),c.selectedBill(d))};b.classPrefix=d,b.rawUtility=tou.currUtility,b.committedBills=b.rawUtility.Billing.committedBills,b.defaultTitle=b.rawUtility.Billing.defaultTitle,b.tempDefaultTitle=b.defaultTitle,b.initSubscriptions(),b.buildActiveMeters(),i(),tou.on("ratetablesaved",function(a){b.utilityName===a&&i()}),tou.on("meterssaved",function(a){b.utilityName===a&&(g=0===tou.getMeters(!0).length,b.buildActiveMeters(),i())}),f.click(function(a){a.stopPropagation()}),$(d+"button.billSelect").click(function(a){window.setTimeout(function(){0===e.scrollTop()&&f.focus()},50)})}},{title:"Reports",isActive:ko.observable(!1),delayLoad:!0,background:"woodbackgroundtile.jpg",listOfMonthYears:ko.observableArray([]),modalTemplates:{reportingUncommitReport:{commitInfo:""},reportingCommitReport:{}},blockUI:function(a){var b=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings;a===!0?(b.$reportsContent.hide(),b.$reportsGettingData.show()):(b.$reportsContent.show(),b.$reportsGettingData.hide()),b.$topBarControls.attr("disabled",a)},saveReport:function(a,b){var c={utilityName:a.utilityName,path:b.path,remove:b.remove};tou.saveUtility(c,b.data,function(a){tou.log("saveresponse",a),void 0!==b.callback&&(a.message&&"success"===a.message?b.callback(!1):b.callback(!0))},!0)},initReportSocket:function(a){tou.socket.on("returnUsage",function(a){var b=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings;null===a.err?b.parseReturnedData(a.results):tou.alert("Error while retrieving data.  ("+a.err+")")})},refreshMonthYear:function(){var a=this,b=$.extend(!0,[],a.listOfMonthYears());a.bindings.$page.committedReports&&(a.reportPeriods=ko.utils.arrayFilter(b,function(b){return b.isReportCommitted=ko.observable(!!a.bindings.$page.committedReports.hasOwnProperty(b.fullDate)),b}),a.listOfMonthYears(b))},init:function(){var a,b=this,c=$("."+b.utilityNameShort+" .reportsTopBar .availablePeriods"),d=c.find("input"),e=function(){if(""===b.bindings.selectedMonthYear()){a=b.bindings.filteredReportMonthYear();for(var c=0,d=a.length,e=!1;c<d&&!e;c++)"Month"===a[c].period&&(b.bindings.monthSelected(a[c]),e=!0)}},f=function(){var a,c,d=0===b.bindings.listOfMeters().length||0===b.listOfMonthYears().length;b.bindings.configRequired(d),b.refreshMonthYear(),a=b.bindings.$page.listOfMonthYears(),d||(e(),c=ko.utils.arrayFilter(a,function(a){return a.searchDate===b.bindings.selectedMonthYear().searchDate}),b.bindings.selectedMonthYear(c[0]),b.bindings.rateTablePeriod(b.bindings.findPeriod(b.bindings.selectedMonthYear().rateTable["Demand Charges"].periods)))};b.initReportSocket(b.bindings.getData),$.extend(b.bindings,{$mainContent:$("."+b.utilityNameShort+" .mainContent"),$reportsContent:$("."+b.utilityNameShort+" .reportsContent"),$busySpinner:$("."+b.utilityNameShort+" .reportsContent .busySpinner"),$thisTopBar:$("."+b.utilityNameShort+" .topBar"),$highestOnPeakDemand:$("."+b.utilityNameShort+" .section.highestOnPeakDemand"),$highestDemand:$("."+b.utilityNameShort+" .section.highestDemand"),$highestConsumption:$("."+b.utilityNameShort+" .section.highestConsumption"),$highlowTemperatures:$("."+b.utilityNameShort+" .section.highlowTemperatures"),$missingDataSection:$("."+b.utilityNameShort+" .section.missingData"),$demandAndUsage:$("."+b.utilityNameShort+" .section.demandandusage"),$meterstotals:$("."+b.utilityNameShort+" .section.meterstotals"),$reportsChartsContent:$("."+b.utilityNameShort+" .reportsContent .reportsChartsContent"),$reportsGridContent:$("."+b.utilityNameShort+" .reportsContent .reportsGridContent"),$individualMetersData:$("."+b.utilityNameShort+" .reportsContent .individualMetersData"),$topBarControls:$("."+b.utilityNameShort+" .reportsTopBar").find("button"),$reportsGettingData:$("."+b.utilityNameShort+" .reportsGettingData")}),$(window).resize(function(){b.bindings.handleResize()}),d.click(function(a){a.stopPropagation()}),$("."+b.utilityNameShort+" .reportsTopBar .availablePeriodsSelect").click(function(a){window.setTimeout(function(){0===c.scrollTop()&&d.focus()},50)}),b.committedReports=b.rawUtility.Reports?b.rawUtility.Reports.committedReports:tou.utilityTemplates[b.utilityNameShort].Reports.committedReports,b.bindings.$busySpinner.hide(),b.bindings.listOfMeters(tou.getMeters(!0)),b.bindings.inactiveMeters(tou.getMeters(!1)),b.listOfMonthYears(tou.availablePeriods[b.utilityName]),b.bindings.numberOfInactiveMeters(b.bindings.inactiveMeters().length),b.bindings.meterIndexArray=b.bindings.indexMeters(),b.bindings.$reportsContent.hide(),b.bindings.$reportsGridContent.hide(),b.bindings.decimalPlaces="kW"===b.bindings.electricalUnit?0:3,b.bindings.configRequired(0===b.bindings.listOfMeters().length||0===b.listOfMonthYears().length),""===b.bindings.selectedMonthYear()&&f(),b.bindings.reportDateFilter.valueHasMutated(),tou.on("meterssaved",function(a){a===b.utilityName&&(b.bindings.listOfMeters(tou.getMeters(!0)),b.bindings.inactiveMeters(tou.getMeters(!1)),b.bindings.numberOfInactiveMeters(b.bindings.inactiveMeters().length),b.bindings.meterIndexArray=b.bindings.indexMeters(),f())}),tou.on("ratetablesaved",function(a){a===b.utilityName&&(b.listOfMonthYears(tou.availablePeriods[b.utilityName]),b.bindings.reportDateFilter.valueHasMutated(),f())})},bindings:{activeDataRequests:[],configRequired:ko.observable(!1),activeDataRequest:ko.observable(!1),committedReports:{},dataRequestTimer:null,decimalPlaces:0,displayPercentageOfValidData:ko.observable(0),duOffPeakMW:ko.observable({timestamp:null,value:null}),duOnPeakMW:ko.observable({timestamp:null,value:null}),duOffPeakMVAR:ko.observable({timestamp:null,value:null}),duOnPeakMVAR:ko.observable({timestamp:null,value:null}),duOffPeakMaxMVAR:ko.observable({timestamp:null,value:null}),duOnPeakMaxMVAR:ko.observable({timestamp:null,value:null}),duOffPeakMWH:ko.observable({timestamp:null,value:null}),duOnPeakMWH:ko.observable({timestamp:null,value:null}),electricalUnit:"kW",endTime:0,errorWithRequest:ko.observable(!1),gridReportCollection:[],highestConsumptionLastYear:ko.observable(""),highestConsumptionNow:ko.observable(""),highestDemandLastYear:ko.observable(""),highestDemandNow:ko.observable(""),highestOnPeakDemandLastYear:ko.observable(""),highestOnPeakDemandNow:ko.observable(""),highestTemperatureNow:ko.observable(""),inactiveMeters:ko.observableArray([]),koGridReportCollection:ko.observableArray([]),lastResize:null,listOfMeters:ko.observableArray(),lowestTemperatureNow:ko.observable(""),maxPeriodUsage:ko.observable(0),meterIndexArray:[],MeterReportCollection:ko.observableArray([]),missingDataCollection:ko.observableArray([]),numberOfDaysInCurrentPeriod:0,numberOfInactiveMeters:ko.observable(0),numberOfTimeSlotsPerDay:48,percentageOfMissingData:ko.observable(0),rateTablePeriod:ko.observable({}),reportData:{},reportDateFilter:ko.observable(""),reportModes:["Chart","Grid"],resizeTimer:500,selectedMonthYear:ko.observable(""),selectedReportsMode:ko.observable("Chart"),startTime:0,summedDataCollection:ko.observableArray([]),sumOfOffPeakConsumption:ko.observable(0),sumOfOnPeakConsumption:ko.observable(0),sumOfTotalPeriodUsage:ko.observable(0),temperatureCollection:ko.observableArray([]),temperatureTitle:ko.observable(""),highestTemperatureVerbiage:ko.observable(""),lowestTemperatureVerbiage:ko.observable(""),temperatureVerbiageHDDCDD:ko.observable(""),findPeriod:function(a){var b,c,d,e=new Date(this.selectedMonthYear().start).setDate(15);for(d=0,len=a.length;d<len;d++)b=a[d],e>new Date(b.start.date)&&e<new Date(b.end.date)&&(c=b);return c},getUnitsInPeriod:function(){var a=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,b=0,c=a.selectedMonthYear();return"month"===c.period.toLowerCase()?b=a.numberOfDaysInCurrentPeriod:"year"===c.period.toLowerCase()&&(b=12),b},highlightMaxes:function(){var a,b,c,d,e,f=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,g=["gridonpeakdemand","gridoffpeakdemand","gridonpeakconsumption","gridoffpeakconsumption","gridconsumptiontotal"],h=["meterOffPeakSum","meterOnPeakSum","meterOnAndOffPeakSum"];for(e=0;e<g.length;e++)d=null,a=null,$(f.$reportsGridContent).find("."+g[e]+" .itemValue").each(function(){c=$(this).html().replace(/,/g,""),b=parseFloat(c),b>a&&(a=b,d=$(this).parent())}),d&&(d.addClass("danger"),"gridonpeakdemand"===g[e]?(d.parent().find(".occurrent.onpeakdemand").addClass("danger"),d.parent().find(".gridonpeakreactive").addClass("danger")):"gridoffpeakdemand"===g[e]&&(d.parent().find(".occurrent.offpeakdemand").addClass("danger"),d.parent().find(".gridoffpeakreactive").addClass("danger")));for(e=0;e<h.length;e++)d=null,a=null,$(f.$individualMetersData).find("."+h[e]).each(function(){"Totals"!==$(this).parent().find(".individualMeterName").html()&&(c=$(this).html().replace(/,/g,""),b=parseFloat(c),b>a&&(a=b,d=$(this)))})},handleResize:function(){var a=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings;a.lastResize=new Date,setTimeout(function(){new Date-a.lastResize>=a.resizeTimer&&a.drawCharts()},a.resizeTimer)},drawCharts:function(a){var b=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings;""!==b.selectedMonthYear()&&b.listOfMeters().length>0&&(setTimeout(function(){b.renderOnPeakDemand(b.reportData.OnPeakDemand,a)},1),setTimeout(function(){b.renderDemand(b.reportData.MaxForOnOffPeakDemandArray,a)},1),setTimeout(function(){b.renderConsumption(b.reportData.TotaledOnOffPeakConsumption,a)},1),setTimeout(function(){b.renderTemperatures(b.reportData.TemperatureData,a)},1))},print:function(){var a=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings;a.drawCharts(!0),setTimeout(function(){tou.print($("."+a.$page.utilityNameShort+" ."+a.$page.title.toLowerCase()+" .reportsContent"))},900)},exportPDF:function(){tou.exportPDF($("."+this.$page.utilityNameShort+" ."+this.$page.title.toLowerCase()+" .reportsContent"))},commitReport:function(){var a,b=this,c=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,d=parseInt((new Date).getTime()/1e3,10),e=$.extend(!0,{},c.reportData),f=b.committedReports,g=tou.workspaceManager.user(),h=$(".reportingCommitReportModal .commitControls button"),i=h.find("i"),j=function(a){a.commit={done:!0,timestamp:d,user:[g.firstName,g.lastName].join(" ")}};j(e),h.attr("disabled",!0),a=setTimeout(function(){i.show()},100),b.saveReport(b,{path:[b.title,"committedReports",c.selectedMonthYear().fullDate].join("."),remove:!1,data:e,callback:function(d){clearTimeout(a),i.hide(),h.attr("disabled",!1),d?tou.alert("There was a problem committing this report. Please try again. If the problem persists please reload the page and try again."):(j(e),c.reportData=e,f[c.selectedMonthYear().fullDate]=e,c.selectedMonthYear().isReportCommitted(!0),tou.hideModal(),b.refreshMonthYear())}})},uncommitReport:function(){var a,b=this,c=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,d=b.committedReports,e=$(".reportingUncommitBillModal .uncommitControls button"),f=e.find("i");e.attr("disabled",!0),a=setTimeout(function(){f.show()},100),b.saveReport(b,{path:[b.title,"committedReports",c.selectedMonthYear().fullDate].join("."),remove:!0,data:null,callback:function(g){clearTimeout(a),f.hide(),e.attr("disabled",!1),g?tou.alert("There was a problem uncommitting this report. Please try again. If the problem persists please reload the page and try again."):(delete d[c.selectedMonthYear().fullDate],c.selectedMonthYear().isReportCommitted(!1),tou.hideModal(),b.refreshMonthYear(),c.getData())}})},showCommitModal:function(){tou.showModal("reportingCommitReport",null,this.$page)},showUncommitModal:function(){var a=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings;tou.showModal("reportingUncommitReport",{commitInfo:"This report was committed by Nikola Teslaon"+a.selectedMonthYear().start},this.$page)},getCommitInfoString:function(a){var b=this,c=b.$page.committedReports[a.fullDate],d=new Date(1e3*c.commit.timestamp),e=new Date,f=d.getDate(),g=tou.fullMonthList[d.getMonth()],h=d.getFullYear(),i=[g,f].join(" ");return h!==e.getFullYear()&&(i=[i,", ",h].join("")),i+=".",["This report was committed by",c.commit.user,"on",i].join(" ")},getChartWidth:function(a){return a===!0?725:window.innerWidth-210},adjustPrecision:function(a){var b=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings;return a=isNaN(a)?0:a,a="kW"===b.electricalUnit?1e3*a:a},findMax:function(a){var b,c,d=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,e={value:null,timeStamp:null};if(a)for(c=a.length,b=0;b<c;b++)null!==a[b].value&&(null===e.value||e.value<a[b].value)&&(e.value=tou.toFixed(a[b].value,d.decimalPlaces),e.timeStamp=a[b].timeStamp);return e},findByTimestamp:function(a,b){var c,d=null,e=a.length;for(c=0;c<e;c++)if(a[c].timeStamp===b){d=a[c];break}return d},sumCollection:function(a){var b,c=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,d=0,e=a.length;for(b=0;b<e;b++)d+=a[b].value;return tou.toFixed(d,c.decimalPlaces)},initGridData:function(){var a=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings;if(0===a.koGridReportCollection().length){var b,c,d,e,f=this.selectedMonthYear(),g=f.period.toLowerCase(),h=[];for("month"===g?(c=1,e=a.numberOfDaysInCurrentPeriod+1):"year"===g&&(c=0,e=12),b=moment(f.start).startOf("month").endOf("day"),d=c;d<e;d++)h.push({date:b.unix(),OnPeakDemand:0,OnPeakReactive:0,OffPeakDemand:0,OffPeakReactive:0,OnPeakConsumption:0,OffPeakConsumption:0,TotaledOnOffPeakConsumption:0}),b=moment(b).add(1,f.childPeriod);a.koGridReportCollection(h)}},initPeriodArray:function(){var a,b=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,c=b.selectedMonthYear(),d=[],e=0,f=moment(c.start).unix(),g=b.getUnitsInPeriod();for(a=0;a<g;a++)e=parseInt(moment.unix(f).format(c.childFormatCode),10)-1,d[e]={value:null,timeStamp:1e3*f},f=moment.unix(f).add(1,c.childPeriod).unix();return d},formatHighestValueVerbiage:function(a,b,c){var d,e=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,f=e.selectedMonthYear(),g=tou.toFixed(a,e.decimalPlaces),h=c?"dddd, MMMM Do YYYY, HH:00":"dddd, MMMM Do YYYY";return null!==b&&g>0?"month"===f.period.toLowerCase()?d=moment(b).format(h)+" and was "+tou.numberWithCommas(g)+e.electricalUnit:"year"===f.period.toLowerCase()&&(d=moment(b).format("MMMM, YYYY")+" and was "+tou.numberWithCommas(g)+e.electricalUnit):d="- no data available -",d},totalOnOffPeak:function(a,b){var c,d,e=b?b.length:0,f=[],g=function(a,b){var c=0;return c+=a?a.value:0,c+=b?b.value:0};for(c=0;c<e;c++)d=g(a[c],b[c]),f.push({value:d,timeStamp:b[c].timeStamp});return f},maxForOnOffPeak:function(a,b){var c,d=b?b.length:0,e=[],f=function(a,b){var c;return c=a<=b?b:a};for(c=0;c<d;c++)e.push({value:f(a[c].value,b[c].value),timeStamp:b[c].timeStamp});return e},setGridData:function(a){var b=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings;if(b.reportData[a]){var c,d,e,f,g,h=$.extend(!0,[],b.koGridReportCollection()),i=b.selectedMonthYear(),j=b.reportData[a].length;for(c=0;c<j;c++)d=b.reportData[a][c],g=new Date(d.timeStamp),e=ko.utils.arrayFirst(h,function(a){return f=new Date(1e3*a.date),"month"===i.period.toLowerCase()?f.getDate()===g.getDate():"year"===i.period.toLowerCase()?f.getMonth()===g.getMonth():null}),e?e[a]={value:tou.toFixed(d.value,0),timeStamp:d.timeStamp}:console.log(" --- setGridData() NOT FOUND ---- i = ",c,"   collectionItem timestamp = ",new Date(d.timeStamp));b.koGridReportCollection(h)}},indexMeters:function(){var a,b,c=this.listOfMeters(),d=[];for(a=0;a<c.length;a++)for(b=0;b<c[a].meterPoints.length;b++)void 0===d[c[a].meterPoints[b].upi]?d[c[a].meterPoints[b].upi]={meterIndex:a,meterPointIndex:b}:console.log("found duplicate UPIs upi = "+c[a].meterPoints[b].upi+"  i = "+a+"  j = "+b);return d},renderCompleteReport:function(){var a=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings;a.reportData&&(a.highestOnPeakDemandLastYear(a.reportData.LastYearsOnPeakDemand),a.highestDemandLastYear(a.reportData.LastYearsDemand),a.duOnPeakMWH(a.findMax(a.reportData.OnPeakConsumption)),a.duOffPeakMWH(a.findMax(a.reportData.OffPeakConsumption)),a.maxPeriodUsage(a.findMax(a.reportData.TotaledOnOffPeakConsumption)),a.sumOfOnPeakConsumption(a.sumCollection(a.reportData.OnPeakConsumption)),a.sumOfOffPeakConsumption(a.sumCollection(a.reportData.OffPeakConsumption)),a.sumOfTotalPeriodUsage(a.sumCollection(a.reportData.TotaledOnOffPeakConsumption)),a.setGridData("OnPeakConsumption"),a.setGridData("OffPeakConsumption"),a.setGridData("TotaledOnOffPeakConsumption"),a.renderConsumption(a.reportData.TotaledOnOffPeakConsumption),a.highestConsumptionLastYear(a.reportData.HighestConsumptionLastYear),a.renderTemperatures(a.reportData.TemperatureData),a.setCddAndHddVerbiage(),a.missingDataCollection(a.reportData.MissingMeterData),a.percentageOfMissingData(a.reportData.PercentageMissingMeterData),a.displayPercentageOfValidData(tou.toFixed(a.percentageOfMissingData(),2)),a.setGridData("OnPeakDemand"),a.setGridData("OffPeakDemand"),a.setGridData("OnPeakReactive"),a.setGridData("OffPeakReactive"),a.duOnPeakMW(a.findMax(a.reportData.OnPeakDemand)),a.duOffPeakMW(a.findMax(a.reportData.OffPeakDemand)),a.duOnPeakMaxMVAR(a.findMax(a.reportData.OnPeakReactive)),a.duOffPeakMaxMVAR(a.findMax(a.reportData.OffPeakReactive)),a.duOnPeakMVAR(a.findByTimestamp(a.reportData.OnPeakReactive,a.duOnPeakMW().timeStamp)),a.duOffPeakMVAR(a.findByTimestamp(a.reportData.OffPeakReactive,a.duOffPeakMW().timeStamp)),a.renderOnPeakDemand(a.reportData.OnPeakDemand),a.renderDemand(a.reportData.MaxForOnOffPeakDemandArray),a.MeterReportCollection(a.reportData.IndividualMeterData),a.highlightMaxes())},renderOnPeakDemand:function(a,b){var c,d,e=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,f=e.selectedMonthYear(),g=e.findMax(a),h=e.getChartWidth(b),i=$(e.$reportsContent).find(" .highestOnPeakDemandPeriodChart");d=e.formatHighestValueVerbiage(g.value,g.timeStamp,!0),e.highestOnPeakDemandNow(d),a&&a.sort(function(a,b){return a.timeStamp>b.timeStamp?1:-1}),i.length>0&&(c=new TrendPlot({width:h,height:300,target:i,y:"value",x:"timeStamp",rawX:"timeStamp",highlightMax:!0,tooltip:{formatter:function(){var a="",b=this;return $.each(this.points,function(c){a+='<span style="font-size: 10px">'+moment(this.point.rawX).format("dddd, MMM DD, YYYY HH:mm")+'</span><br><span style="color:'+this.point.color+'"></span> '+this.series.name+": <b>"+trendPlots.numberWithCommas(this.y)+" "+e.electricalUnit+"</b>",c<b.points.length-1&&(a+="<br/>")}),a}},data:{data:a,name:"Demand"},type:"column",xAxis:{allowDecimals:!1},yAxisTitle:e.electricalUnit,xValueFormatter:function(a){var b=new Date(a);return b.setHours(0),b.setMinutes(0),b.setSeconds(0),b.setMilliseconds(0),"Year"===f.period&&b.setDate(1),b.getTime()}}))},renderDemand:function(a,b){var c,d,e=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,f=e.selectedMonthYear(),g=e.findMax(a),h=e.getChartWidth(b),i=$(e.$reportsContent).find(" .highestDemandPeriodChart");d=e.formatHighestValueVerbiage(g.value,g.timeStamp,!0),e.highestDemandNow(d),a&&a.sort(function(a,b){return a.timeStamp>b.timeStamp?1:-1}),i.length>0&&(c=new TrendPlot({width:h,height:300,target:i,y:"value",x:"timeStamp",rawX:"timeStamp",highlightMax:!0,tooltip:{formatter:function(){var a="",b=this;return $.each(this.points,function(c){a+='<span style="font-size: 10px">'+moment(this.point.rawX).format("dddd, MMM DD, YYYY HH:mm")+'</span><br><span style="color:'+this.point.color+'"></span> '+this.series.name+": <b>"+trendPlots.numberWithCommas(this.y)+" "+e.electricalUnit+"</b>",c<b.points.length-1&&(a+="<br/>")}),a}},data:{data:a,name:"Demand"},type:"column",xAxis:{allowDecimals:!1},yAxisTitle:e.electricalUnit,xValueFormatter:function(a){var b=new Date(a);return b.setHours(0),b.setMinutes(0),b.setSeconds(0),b.setMilliseconds(0),"Year"===f.period&&b.setDate(1),b.getTime()}}))},renderConsumption:function(a,b){var c,d,e,f=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,g=f.selectedMonthYear(),h=f.findMax(a),i=f.getChartWidth(b),j=$(f.$reportsContent).find(" .highestConsumptionPeriodChart");for(d=f.formatHighestValueVerbiage(h.value,h.timeStamp,!1),f.highestConsumptionNow(d),a&&a.sort(function(a,b){return a.timeStamp>b.timeStamp?1:-1}),e=0;e<a;e++)a[e].value=tou.toFixed(a[e].value,f.decimalPlaces);j.length>0&&(c=new TrendPlot({width:i,height:300,target:j,y:"value",x:"timeStamp",highlightMax:!0,data:{data:a,name:"Consumption",units:"kWh"},type:"column",xAxis:{allowDecimals:!1},yAxisTitle:f.electricalUnit+"h",xValueFormatter:function(a){var b=new Date(a);return b.setHours(0),b.setMinutes(0),b.setSeconds(0),b.setMilliseconds(0),"Year"===g.period&&b.setDate(1),b.getTime();
}}))},renderTemperatures:function(a,b){var c,d,e,f,g=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,h="day"===g.selectedMonthYear().childPeriod.toLowerCase()?"Daily":g.selectedMonthYear().childPeriod+"ly",i=g.getChartWidth(b),j=$(g.$reportsContent).find(".highlowTemperaturesPeriodChart");d="High/Low "+h+" Temperatures - "+g.selectedMonthYear().prettyDate,g.temperatureTitle(d),a&&a.trendPlotData.valid?(null!==a.highestTemp.timeStamp?(g.highestTemperatureNow({value:a.highestTemp.value?tou.toFixed(a.highestTemp.value,1):null,timeStamp:a.highestTemp.timeStamp}),g.lowestTemperatureNow({value:a.lowestTemp.value?tou.toFixed(a.lowestTemp.value,1):null,timeStamp:a.lowestTemp.timeStamp}),e="The high temperature on "+moment.unix(a.highestTemp.timeStamp).format("dddd, MMMM Do YYYY")+" was "+a.highestTemp.value.toFixed(1)+" degrees. ",f="The low temperature on "+moment.unix(a.lowestTemp.timeStamp).format("dddd, MMMM Do YYYY")+" was "+a.lowestTemp.value.toFixed(1)+" degrees. "):(g.highestTemperatureNow({value:null,timeStamp:null}),g.lowestTemperatureNow({value:null,timeStamp:null}),e="no data available",f="no data available"),g.highestTemperatureVerbiage(e),g.lowestTemperatureVerbiage(f),a.trendPlotData.maxes&&a.trendPlotData.maxes.sort(function(a,b){return a.timeStamp>b.timeStamp?1:-1}),a.trendPlotData.mins&&a.trendPlotData.mins.sort(function(a,b){return a.timeStamp>b.timeStamp?1:-1}),j.length>0&&(c=new TrendPlot({width:i,height:300,target:j,y:"value",x:"timeStamp",data:[{data:a.trendPlotData.maxes,name:"Max",yAxis:0},{data:a.trendPlotData.mins,name:"Min",yAxis:0}],type:"line",xAxis:{allowDecimals:!1},yAxisTitle:"F"})),g.$highlowTemperatures.show()):(g.$highlowTemperatures.hide(),g.temperatureTitle(""),j.html(""),g.highestTemperatureVerbiage(""),g.lowestTemperatureVerbiage(""),g.temperatureVerbiageHDDCDD(""))},buildConsumptionArray:function(a){if(a){var b=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,c=b.buildOnOffSumArray(a,"sums","sum");b.reportData.OffPeakConsumption=c.offPeakData,b.reportData.OnPeakConsumption=c.onPeakData,b.reportData.TotaledOnOffPeakConsumption=b.totalOnOffPeak(b.reportData.OnPeakConsumption,b.reportData.OffPeakConsumption)}},buildDemandAndReactiveArray:function(a){if(a){var b=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings;b.parseDemandAndReactiveArrays(a),b.reportData.MaxForOnOffPeakDemandArray=b.maxForOnOffPeak(b.reportData.OnPeakDemand,b.reportData.OffPeakDemand)}},buildOnOffSumArray:function(a,b,c){var d,e,f=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings;if(a){var g,h,i,j,k,l,m=f.selectedMonthYear(),n=a.length;for(d=f.initPeriodArray(),e=f.initPeriodArray(),i=0;i<n;i++){j=a[i];for(var o in j.results[b])k=j.results[b][o],k&&(l=f.adjustPrecision(k[c]),g=moment(1e3*k.range.start),h=parseInt(moment(g).format(m.childFormatCode),10)-1,"on"===j.peak?(d[h].timeStamp=1e3*k.range.start,d[h].value=l):(e[h].timeStamp=1e3*k.range.start,e[h].value=l))}}return{onPeakData:d,offPeakData:e}},parseDemandAndReactiveArrays:function(a){var b,c,d,e,f=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,g=function(a,b){return a===b?1e3*(a-1):1e3*a},h=function(a){var b,c=a.length,d=!0;for(b=0;b<c;b++)null!==a[b].value&&(d=!1),a[b].value=null===a[b].value?0:tou.toFixed(a[b].value,f.decimalPlaces);return a};if(a){var i,j,k,l,m,n,o,p,q=f.selectedMonthYear();for(b=f.initPeriodArray(),c=f.initPeriodArray(),d=f.initPeriodArray(),e=f.initPeriodArray(),i=0;i<a.length;i++)for(k=a[i],j=0;j<k.results.length;j++)l=k.results[j],l.demand.max&&(o=g(l.demand.timestamp,l.demand.range.end),n=moment(o).format(q.childFormatCode),m=parseInt(n,10)-1,"on"===k.peak?b[m]={timeStamp:o,value:f.adjustPrecision(l.demand.max)}:c[m]={timeStamp:o,value:f.adjustPrecision(l.demand.max)}),l.reactive.max&&(p=g(l.reactive.timestamp,l.reactive.range.end),n=moment(p).format(q.childFormatCode),m=parseInt(n,10)-1,"on"===k.peak?d[m]={timeStamp:p,value:f.adjustPrecision(l.reactive.max)}:e[m]={timeStamp:p,value:f.adjustPrecision(l.reactive.max)});b=h(b),c=h(c),d=h(d),e=h(e)}f.reportData.OnPeakDemand=b,f.reportData.OffPeakDemand=c,f.reportData.OnPeakReactive=d,f.reportData.OffPeakReactive=e},buildLastYearsConsumptionArray:function(a){if(a){var b=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,c=b.buildMetersTrendPlotArray(a);b.reportData.HighestConsumptionLastYear=b.formatHighestValueVerbiage(c.highestValue.value,c.highestValue.timeStamp,!1)}},buildLastYearsOnPeakDemandArray:function(a){if(a&&a.results.maxes){var b=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,c=a.results.maxes[0],d=b.adjustPrecision(c.max);b.reportData.LastYearsOnPeakDemand=b.formatHighestValueVerbiage(d,1e3*c.timestamp,!0)}},buildLastYearsDemandArray:function(a){if(a&&a.results.maxes){var b=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,c=a.results.maxes[0],d=b.adjustPrecision(c.max);b.reportData.LastYearsDemand=b.formatHighestValueVerbiage(d,1e3*c.timestamp,!0)}},buildTemperatureArray:function(a){if(a){var b=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings;b.reportData.TemperatureData=b.parseTemperatureArray(a)}},setCddAndHddVerbiage:function(a){var b,c=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings;void 0===a?null===c.reportData.HddValue||null===c.reportData.CddValue?b="":(b="There were "+tou.numberWithCommas(tou.toFixed(c.reportData.CddValue,0))+" CDD and ",b+=tou.numberWithCommas(tou.toFixed(c.reportData.HddValue,0))+" HDD in this ",b+=c.selectedMonthYear().period+"."):b="   * "+a.replace(".","")+" for CDD/HDD *  ",c.temperatureVerbiageHDDCDD(b)},setCDDValue:function(a){var b=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings;a&&void 0===a.error?(b.reportData.CddValue=a.results.sums[0].sum,b.setCddAndHddVerbiage()):a.error&&(b.reportData.CddValue=a.error,b.setCddAndHddVerbiage(a.error))},setHDDValue:function(a){var b=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings;a&&void 0===a.error?(b.reportData.HddValue=a.results.sums[0].sum,b.setCddAndHddVerbiage()):a.error&&(b.reportData.HddValue=a.error,b.setCddAndHddVerbiage(a.error))},buildMetersTrendPlotArray:function(a){var b,c,d,e,f,g=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,h=this.selectedMonthYear(),i=a.results,j=g.initPeriodArray(),k={value:0,timeStamp:null},l=function(a,b,c){a&&c&&(a.timeStamp=1e3*c,a.value+=g.adjustPrecision(b))};"max"===a.fx?(d="maxes",e="max"):"sum"===a.fx&&(d="sums",e="sum");for(f in i[d])b=i[d][f],b&&void 0!==b[e]&&(c=parseInt(moment.unix(b.range.start).format(h.childFormatCode),10)-1,l(j[c],b[e],b.range.start));for(c=0;c<j.length;c++)k.value<j[c].value&&(k.value=tou.toFixed(j[c].value,g.decimalPlaces),k.timeStamp=j[c].timeStamp),j[c].value=tou.toFixed(j[c].value,g.decimalPlaces);return{trendPlotData:j,highestValue:k}},buildMissingDataArray:function(a){if(a.results){var b,c,d,e,f=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,g=$.extend(!0,[],f.listOfMeters()),h=[],i=a.results.missingPercentage.length,j=100*g.length,k=0;for(b=0;b<i;b++)d=a.results.missingPercentage[b],e=d.upis[0],c=g[f.meterIndexArray[e].meterIndex],c.missingPercentage=parseFloat(tou.toFixed(d.missingPercentage,2)).toFixed(2),k+=d.missingPercentage;for(b=0;b<g.length;b++)void 0!==g[b].missingPercentage&&g[b].missingPercentage>0&&g[b].missingPercentage>0&&(delete g[b].meterPoints,h.push(g[b]));f.reportData.MissingMeterData=h,f.reportData.PercentageMissingMeterData=(j-k)/j*100}},parseTemperatureArray:function(a){var b,c,d,e,f=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings;if(void 0===a.error){var g,h,i,j,k=f.selectedMonthYear(),l=a.results.tempRanges.length,m=f.initPeriodArray(),n=f.initPeriodArray();for(c={value:null,timeStamp:null},d={value:null,timeStamp:null},b={valid:!1,maxes:m,mins:n},g=0;g<l;g++)h=a.results.tempRanges[g],i=moment(1e3*h.range.start).format(k.childFormatCode),j=parseInt(i,10)-1,m[j].value=$.isNumeric(h.max)?tou.toFixed(h.max,2):null,m[j].timeStamp=1e3*h.range.start,n[j].value=$.isNumeric(h.min)?tou.toFixed(h.min,2):null,n[j].timeStamp=1e3*h.range.start,null===m[j].value&&null===n[j].value||(b.valid=!0);$.each(m,function(a,b){b.value&&(b.value>c.value||null===c.value)&&(c.value=tou.toFixed(b.value,1),c.timeStamp=b.timeStamp/1e3)}),$.each(n,function(a,b){b.value&&(b.value<d.value||null===d.value)&&(d.value=tou.toFixed(b.value,1),d.timeStamp=b.timeStamp/1e3)}),f.temperatureCollection(b),e={trendPlotData:b,highestTemp:c,lowestTemp:d}}else f.temperatureCollection(null),e=null;return e},buildMetersReportArray:function(a){if(a){var b,c,d,e,f,g,h,i=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,j=a.length;for(c=$.extend(!0,[],i.listOfMeters()),e=c.length,b=0;b<e;b++)d=c[b],d.onPeakSum=0,d.offPeakSum=0;for(c[e]={displayedMeterName:"Totals",offPeakSum:0,onPeakSum:0},b=0;b<j;b++){f=a[b];for(var k in f.results.sums)k=parseInt(k,10),d=c[i.meterIndexArray[k].meterIndex],g=f.results.sums[k],g&&(h="kW"===i.electricalUnit?1e3*g.sum:g.sum,"on"===f.peak?(d.onPeakSum=h,c[e].onPeakSum+=h):(d.offPeakSum=h,c[e].offPeakSum+=h))}for(b=0;b<c.length;b++)delete c[b].meterPoints,c[b].onPeakSum=tou.toFixed(c[b].onPeakSum,"kW"===i.electricalUnit?1:3),c[b].offPeakSum=tou.toFixed(c[b].offPeakSum,"kW"===i.electricalUnit?1:3);i.reportData.IndividualMeterData=c}},parseReturnedData:function(a){var b,c,d,e=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,f=e.activeDataRequests.length,g=!1;for(e.reportData={},this.$page.blockUI(!0),c=0;c<f;c++){for(d=[],b=0;b<a.length;b++)delete a[b].upis,e.activeDataRequests[c].touid===a[b].touid.split("-")[0]&&(d.push(a[b]),g=!0);d.length>0&&(1===d.length?e.activeDataRequests[c].fx(d[0]):e.activeDataRequests[c].fx(d))}g?(e.renderCompleteReport(),this.$page.blockUI(!1),e.activeDataRequests=[]):(tou.alert("no matching data returned from request"),this.$page.blockUI(!1),e.errorWithRequest(!0),e.$reportsContent.hide()),e.activeDataRequest(!1),e.dataRequestTimer&&(clearTimeout(e.dataRequestTimer),e.dataRequestTimer=null)},buildMissingDataRequestObject:function(a,b,c){var d,e,f,g,h,i,j,k=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,l=k.selectedMonthYear(),m=[],n=k.listOfMeters(),o=n.length;for(j=0;j<o;j++)f=n[j],d=[],g=tou.retrieveMeterPoint(f,"Consumption"),h=tou.retrieveMeterPoint(f,"Demand"),i=tou.retrieveMeterPoint(f,"Reactive"),g.upi&&g.upi>0&&d.push(g.upi),h.upi&&h.upi>0&&d.push(h.upi),i.upi&&i.upi>0&&d.push(i.upi),d.length>0&&m.push(d);return m.length>0&&(e=[],e.push({touid:c,utilityName:tou.currUtility.utilityName,range:{start:moment(a).unix(),end:moment(b).unix()},scale:l.period.toLowerCase(),fx:"missingPercentage",upis:m})),e},buildMeterPointRequestObject:function(a,b,c,d,e,f,g,h){var i,j,k,l,m=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,n=m.listOfMeters(),o=[],p=n.length;for(k=0;k<p;k++)i=n[k],j=tou.retrieveMeterPoint(i,d),j.upi&&j.upi>0&&o.push(j.upi);return o.length>0&&(l=[],l.push({touid:h,utilityName:tou.currUtility.utilityName,range:{start:a.unix(),end:b.unix()},fiscalYear:c,type:d,scale:g,fx:e,upis:o}),"on"!==f&&"off"!==f||(l[0].peak=f)),l},buildMeterPointOnOffRequestObject:function(a,b,c,d,e){var f,g,h,i,j=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,k=j.selectedMonthYear(),l=[],m=j.listOfMeters(),n=m.length;for(i=0;i<n;i++)g=m[i],h=tou.retrieveMeterPoint(g,c),h.upi&&h.upi>0&&l.push(h.upi);return l.length>0&&(f=[],f.push({touid:e+"-1",utilityName:tou.currUtility.utilityName,range:{start:a.unix(),end:b.unix()},fiscalYear:k.fiscalYear,type:c,scale:k.childPeriod.toLowerCase(),fx:d,upis:l,peak:"on"}),f.push({touid:e+"-2",utilityName:tou.currUtility.utilityName,range:{start:a.unix(),end:b.unix()},fiscalYear:k.fiscalYear,type:c,scale:k.childPeriod.toLowerCase(),fx:d,upis:l,peak:"off"})),f},buildReactiveRequestObject:function(a,b,c,d){var e,f,g,h,i,j=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,k=j.selectedMonthYear(),l=[],m=[],n=j.listOfMeters(),o=n.length;for(i=0;i<o;i++)f=n[i],g=tou.retrieveMeterPoint(f,"Demand"),h=tou.retrieveMeterPoint(f,"Reactive"),g.upi&&g.upi>0&&m.push(g.upi),h.upi&&h.upi>0&&l.push(h.upi);return m.length>0&&l.length>0&&(e=[],e.push({touid:d+"-1",utilityName:tou.currUtility.utilityName,range:{start:a.unix(),end:b.unix()},upis:m,secondUpis:l,type:"demand",fiscalYear:k.fiscalYear,scale:c,peak:"on",fx:"reactiveCharge"}),e.push({touid:d+"-2",utilityName:tou.currUtility.utilityName,range:{start:a.unix(),end:b.unix()},upis:m,secondUpis:l,type:"demand",fiscalYear:k.fiscalYear,scale:c,peak:"off",fx:"reactiveCharge"})),e},buildMetersTotalsRequestObject:function(a,b,c){var d,e,f,g,h=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,i=h.selectedMonthYear(),j=[],k=h.listOfMeters(),l=k.length;for(g=0;g<l;g++)e=k[g],f=tou.retrieveMeterPoint(e,"Consumption"),f.upi&&f.upi>0&&j.push(f.upi);return j.length>0&&(d=[],d.push({touid:c+"-1",utilityName:tou.currUtility.utilityName,range:{start:a.unix(),end:b.unix()},fiscalYear:i.fiscalYear,type:"consumption",scale:i.period.toLowerCase(),fx:"sum",splitUpis:!0,upis:j,peak:"on"}),d.push({touid:c+"-2",utilityName:tou.currUtility.utilityName,range:{start:a.unix(),end:b.unix()},fiscalYear:i.fiscalYear,type:"consumption",scale:i.period.toLowerCase(),fx:"sum",splitUpis:!0,upis:j,peak:"off"})),d},buildTemperaturesRequestObject:function(a,b,c){var d=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,e=d.selectedMonthYear(),f=[];return f.push({touid:c,utilityName:tou.currUtility.utilityName,range:{start:a.unix(),end:b.unix()},scale:e.childPeriod.toLowerCase(),fx:"tempRange",upis:[tou.weatherPoints.OAT]}),f},buildCDDRequestObject:function(a,b,c){var d=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,e=d.selectedMonthYear(),f=[];return f.push({touid:c,utilityName:tou.currUtility.utilityName,range:{start:a.unix(),end:b.unix()},scale:e.period.toLowerCase(),fx:"weather",upis:[tou.weatherPoints.CDD]}),f},buildHDDRequestObject:function(a,b,c){var d=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,e=d.selectedMonthYear(),f=[];return f.push({touid:c,utilityName:tou.currUtility.utilityName,range:{start:a.unix(),end:b.unix()},scale:e.period.toLowerCase(),fx:"weather",upis:[tou.weatherPoints.HDD]}),f},getData:function(){var a=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings;if(""!==a.selectedMonthYear()&&a.listOfMeters().length>0){a.startTime=moment(),a.errorWithRequest(!1),this.$page.blockUI(!0);var b,c=this.selectedMonthYear(),d=(c.period.toLowerCase(),moment(c.start).startOf("month").startOf("day")),e=moment(d).subtract(1,"year"),f=moment(c.end).startOf("month").startOf("day"),g=moment(e).add(1,c.period.toLowerCase()),h=0,i=[];a.initGridData(),a.dataRequestTimer&&(clearTimeout(a.dataRequestTimer),a.dataRequestTimer=null),a.activeDataRequests=[],b=a.buildMeterPointRequestObject(e,g,c.fiscalYear-1,"demand","max","on",c.period.toLowerCase(),tou.makeId()),b&&(i.push.apply(i,b),a.activeDataRequests.push({fx:a.buildLastYearsOnPeakDemandArray,touid:b[0].touid})),b=a.buildMeterPointRequestObject(e,g,c.fiscalYear-1,"demand","max","na",c.period.toLowerCase(),tou.makeId()),b&&(i.push.apply(i,b),a.activeDataRequests.push({fx:a.buildLastYearsDemandArray,touid:b[0].touid})),b=a.buildMeterPointOnOffRequestObject(d,f,"consumption","sum",tou.makeId()),b&&(i.push.apply(i,b),a.activeDataRequests.push({fx:a.buildConsumptionArray,touid:b[0].touid.split("-")[0]})),b=a.buildMeterPointRequestObject(e,g,c.fiscalYear-1,"consumption","sum","na",c.childPeriod.toLowerCase(),tou.makeId()),b&&(i.push.apply(i,b),a.activeDataRequests.push({fx:a.buildLastYearsConsumptionArray,touid:b[0].touid})),b=a.buildTemperaturesRequestObject(d,f,tou.makeId()),i.push.apply(i,b),a.activeDataRequests.push({fx:a.buildTemperatureArray,touid:b[0].touid}),b=a.buildCDDRequestObject(d,f,tou.makeId()),i.push.apply(i,b),a.activeDataRequests.push({fx:a.setCDDValue,touid:b[0].touid}),b=a.buildHDDRequestObject(d,f,tou.makeId()),i.push.apply(i,b),a.activeDataRequests.push({fx:a.setHDDValue,touid:b[0].touid}),b=a.buildMissingDataRequestObject(d,f,tou.makeId()),b&&(i.push.apply(i,b),a.activeDataRequests.push({fx:a.buildMissingDataArray,touid:b[0].touid})),b=a.buildReactiveRequestObject(d,f,c.childPeriod.toLowerCase(),tou.makeId()),b&&(i.push.apply(i,b),a.activeDataRequests.push({fx:a.buildDemandAndReactiveArray,touid:b[0].touid.split("-")[0]})),b=a.buildMetersTotalsRequestObject(d,f,tou.makeId()),b&&(i.push.apply(i,b),a.activeDataRequests.push({fx:a.buildMetersReportArray,touid:b[0].touid.split("-")[0]})),i.length>0?tou.socket&&(a.activeDataRequest(!0),tou.socket.emit("getUsage",{options:i}),h=18e4,a.dataRequestTimer=setTimeout(function(){a.$reportsContent.hide(),a.$reportsGettingData.hide(),a.$topBarControls.attr("disabled",!1),tou.alert("Report request timed out")},h)):tou.alert("no options were set for Report request")}},monthSelected:function(a){var b=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings,c=moment(a.start),d=moment(a.end);b.numberOfDaysInCurrentPeriod=tou.toFixed(moment.duration(d.diff(c)).asDays(),0),b.selectedMonthYear(a),b.rateTablePeriod(b.findPeriod(b.selectedMonthYear().rateTable["Demand Charges"].periods)),""!==b.selectedReportsMode()&&(b.koGridReportCollection([]),a.isReportCommitted&&a.isReportCommitted()?(b.reportData=b.$page.committedReports[a.fullDate],b.reportData?(b.initGridData(),b.renderCompleteReport()):b.$reportsContent.html("No data found for committed report '"+a.fullDate+"'")):b.getData())},modeSelected:function(a){var b=tou.bindings["utility_"+tou.currUtility.shortName].reportsBindings;switch(b.selectedReportsMode(a),a){case"Chart":b.$reportsChartsContent.show(),b.$reportsGridContent.hide();break;case"Grid":b.$reportsChartsContent.hide(),b.$reportsGridContent.show()}}},computedBindings:{filteredReportMonthYear:function(){var a=this,b=a.reportDateFilter().toLowerCase(),c=a.$page.listOfMonthYears();return""===b?c:ko.utils.arrayFilter(c,function(a){return a.searchDate.toLowerCase().indexOf(b)>-1})}}},{title:"Rate Table",shortTitle:"ratetable",isActive:ko.observable(!1),background:"woodbackgroundtile.jpg",rateTables:{},titles:{},delayLoad:!0,rateTableTemplate:{"Additional Off Peak Days":{order:0}},getRateTableTemplate:function(a){var b=this.rateTableTemplate;return b["Fiscal Year"]=a,b},clearRateTables:function(){this.rateTables={},this.bindings.holidays([]),this.bindings.rateTables([])},getRateTable:function(a){return this.rateTables[a]},getRateTableByTitle:function(a){var b,c=this;return tou.forEach(c.rateTables,function(c,d){if(c.title===a)return b=c,!1}),b},getTitle:function(a){return this.titles[a]=this.titles[a]||0,a.capFirst()},loadYear:function(a){var b=this,c=b.previousYears[a];b.createRateTables(c)},deleteHoliday:function(a){var b=a.oldName,c=this;tou.forEachArray(c.bindings.holidays(),function(a,d){if(a.name()===b)return c.bindings.holidays.splice(d,1),!1})},addNewHoliday:function(a){var b=this;a.date=moment(a.date).format(tou.dateFormat),a.isUpdate?(tou.forEach(b.bindings.holidays(),function(b,c){if(b.name()===a.oldName)return b.name(a.name),b.date(a.date),!1}),b.bindings.holidays.valueHasMutated(),tou.currUtility.RateTables["Additional Off Peak Days"][a.name]=a.date,delete tou.currUtility.RateTables["Additional Off Peak Days"][a.oldName]):(tou.currUtility.RateTables["Additional Off Peak Days"][a.name]=a.date,a.name=ko.observable(a.name),a.date=ko.observable(a.date),b.bindings.holidays.push(a))},addNewRatePeriod:function(a){var b,c=this.bindings.currRateTable(),d=this.getRateTable(c.touid),e=c.rates(),f=tou.dateFormat,g=moment(a.dateFrom),h=moment(a.dateTo);b={start:{date:g.format(f)},end:{date:h.format(f)},rangeType:a.season,title:a.seasonName||this.getTitle(a.season),days:[],rates:{},enablePeakSelection:a.enablePeakSelection||!1,touid:a.touid},tou.forEachArray(tou.fullDayList,function(c,d){a["day"+c]&&b.days.push(tou.shortDayList[d])}),b.start.peak=parseInt(a.timeFrom.replace(":",""),10),b.end.peak=parseInt(a.timeTo.replace(":",""),10),a.isUpdate||(b.touid||(b.touid=tou.makeId()),tou.forEachArray(e,function(a){var c=a.name();b.rates[c]=ko.observable()})),d.addNewPeriod(b,a.isUpdate,a.periodIdx)},deletePeriod:function(a){var b=a.periodIdx,c=this.bindings.currRateTable(),d=this.getRateTable(c.touid);d.deletePeriod(b)},deleteRate:function(a){var b=a.rateIdx,c=this.bindings.currRateTable(),d=this.getRateTable(c.touid);d.deleteRate(b)},addNewRateElement:function(a){var b=this.bindings.currRateTable(),c=this.getRateTable(b.touid),d=(c.cfg,b.rates(),b.periods(),{name:ko.observable(a.rateName),type:ko.observable(a.type),qualifier:ko.observable(a.rateQualifier),peak:ko.observable(a.peak),threshold:ko.observable(a.threshold),qualifierDemand:ko.observable(a.qualifierDemand)});c.addRate(d,a.isUpdate,a.rateIdx)},addNewFiscalYear:function(a){var b,c=this,d=$.extend(!0,{},tou.currUtility.RateTables),e=d["Fiscal Year"],f=parseInt(a.yearToCopy,10),g=a.copyData,h=parseInt(a.year,10),i=h-f,j=function(a){var b=a.split("-"),c=parseInt(b.pop(),10);return c+=i,b.push(c),b.join("-")},k=function(){tou.forEach(b,function(a,c){"Additional Off Peak Days"===c?tou.forEach(a,function(b,c){"order"!==c&&(a[c]=j(b))}):"Fiscal Year"===c?b["Fiscal Year"]=a+i:tou.forEachArray(a.periods,function(a){a.end.date=j(a.end.date),a.start.date=j(a.start.date)})})};c.bindings.latestYear(h),c.bindings.currFiscalYear(h),c.bindings.previousYears.unshift(h),c.createYearDropdown(c.previousYears),tou.currUtility.PreviousRateTables[e]=d,b=g?f!==e?$.extend(!0,{},tou.currUtility.PreviousRateTables[f]):$.extend(!0,{},d):$.extend(!0,{},c.getRateTableTemplate(h)),a.copyData&&k(),c.previousYears[h]=b,tou.currUtility.RateTables=b,c.createRateTables(b)},createAndAddRateTable:function(a,b){var c;return a._page=this,c=new this.RateTable(a),this.rateTables[c.touid]=c,b||this.bindings.rateTables.push(c.getBindings()),c},RateTable:function(a){var b,c,d=this,e=tou.makeId(),f=a._page,g=[],h=$.extend(!0,[],a.rates||[]),i=$.extend(!0,[],a.periods||[]),j=(a.qualifier||"",a.cfg||{rates:h||[],periods:i||[],parentTable:a.parentTable||null}),k=j.periods||[],l=a.title,m=[],n=ko.mapping.fromJS($.extend(!0,[],i)),o=function(a){var b=!0;"demand"!==a.type&&"consumption"!==a.type||"on"===a.peak&&(b=!1),a.touid=a.touid||tou.makeId(),a.showInTransition=b},p=function(a){var b=["start","end","rangeType","title","days","rates","touid","enablePeakSelection"];tou.forEach(a,function(c,d){b.indexOf(d)===-1&&delete a[d]}),a.touid=a.touid||tou.makeId()};tou.forEachArray(h,o),tou.forEachArray(k,p),c=ko.mapping.fromJS($.extend(!0,[],h)),d=$.extend(d,{parentTable:null,touid:e,rawPeriods:k,rawRates:h,title:l,observablePeriods:n,observableRates:c,hidePeakInfo:j.hidePeakInfo||!1,cfg:j,getBindings:function(){var a={rates:c,periods:n,title:ko.observable(l),touid:e,modifierQueue:m,hidePeakInfo:ko.observable(d.hidePeakInfo),isChild:ko.observable(null!==d.parentTable)};return d.bindings=a,a},syncPositionsToKnockout:function(){var a=[];tou.forEachArray(c(),function(b){tou.forEachArray(d.rawRates,function(c){if(c.name===b.name())return a.push(c),!1})}),d.rawRates=a,j.rates=a},getExportConfig:function(){var a=d.parentTable&&d.parentTable.title;return tou.forEachArray(n(),function(a,b){var c=d.rawPeriods[b].rates;tou.forEach(a.rates,function(a,b){c[b]=parseFloat(a())})}),d.syncPositionsToKnockout(),l=d.title,j.title=l,j.parentTable=a,j.rates=d.rawRates,j.hidePeakInfo=d.hidePeakInfo,j},destroy:function(){tou.forEachArray(g,function(a){a.parentTable=null}),d.parentTable&&d.parentTable.removeChildTable(d)},addChildTable:function(a){g.push(a),d.syncTablesToChild(a)},removeChildTable:function(a){var b=a.touid;tou.forEachArray(g,function(a,c){if(a.touid===b)return g.splice(c,1),!1})},buildPeriods:function(a){var b=[];tou.forEachArray(a,function(a){a.touid=a.touid||tou.makeId();var c=f.convertPeriod(a);b.push(c)}),d.rawPeriods=a,ko.mapping.fromJS(b,n)},buildRates:function(a){h=a,d.rawRates=h,tou.forEachArray(h,o),ko.mapping.fromJS(h,c)},syncTablesToChild:function(a){var b=$.extend(!0,{},k);tou.forEach(b,function(a){a.rates={}}),a.buildPeriods($.extend(!0,[],b))},linkToTable:function(a){var b=f.getRateTable(a);b.addChildTable(d),d.parentTable=b,d.bindings&&d.bindings.isChild(!0)},unlinkTable:function(){d.parentTable.removeChildTable(d),d.parentTable=null,d.bindings.isChild(!1)},updateChildPeriods:function(a,b,c){tou.forEachArray(g,function(d){d.addPeriod(a,b,c)})},updateChildRates:function(a,b,c){},addPeriod:function(a,b,c){var d=this;a.touid=a.touid||tou.makeId(),b?(delete a.rates,$.extend(!0,k[c],a),ko.mapping.fromJS(f.convertPeriod(a),n()[c],n()[c])):(k.push(a),a=f.convertPeriod(a),n.push(ko.mapping.fromJS(a))),d.updateChildPeriods(k)},deletePeriod:function(a){k.splice(a,1),n.splice(a,1)},addRate:function(b,e,f){var g=ko.toJS(b);o(g),e?this.updateRate(b,g,f):(a.rates.push(g),d.rawRates.push(g),tou.forEachArray(j.periods,function(a){a.rates[b.name()]=null}),tou.forEachArray(n(),function(a){a.rates[b.name()]=ko.observable()}),b.showInTransition=ko.observable(g.showInTransition),void 0===c()?c([b]):c.push(b),this.updateChildRates(b))},addNewPeriod:function(a,b,c){var d=ko.toJS(a),e=f.convertPeriod(d);b?this.updatePeriod(a,d,c):(this.rawPeriods.push(d),n.push(ko.mapping.fromJS(e)),this.updateChildPeriods(a)),this.rawPeriods.sort(function(a,b){return new Date(a.start.date)>new Date(b.start.date)?1:-1}),n.sort(function(a,b){return new Date(a._rawStart())>new Date(b._rawStart())?1:-1})},updatePeriod:function(a,b,c){var d=n()[c],e=f.convertPeriod(b),g=($.extend(!0,{},e.rates),d.rates);delete a.rates,delete b.rates,delete e.rates,this.rawPeriods[c]=$.extend(this.rawPeriods[c],b),i[c]=$.extend(i[c],e),n()[c]=ko.mapping.fromJS(e),n()[c].rates=g,n.valueHasMutated(),this.updateChildPeriods(a,!0,c)},updateRate:function(a,b,e){var f=(c()[e],a.name(),d.rawRates),g=f[e].name;o(b),f[e]=$.extend(f[e],b),c()[e]=ko.mapping.fromJS(b),tou.forEachArray(this.rawPeriods,function(a){var c=a.rates[g];delete a.rates[g],a.rates[b.name]=c}),tou.forEachArray(n(),function(a){var c=a.rates[g]();delete a.rates[g],a.rates[b.name]=ko.observable(c)}),c.valueHasMutated(),this.updateChildRates(a,!0,e)},deleteRate:function(a){var b=d.rawRates[a],e=b.name;tou.forEachArray(this.rawPeriods,function(a){delete a.rates[e]}),tou.forEachArray(i,function(a){delete a.rates[e]}),tou.forEachArray(n(),function(a){delete a.rates[e]}),h.splice(a,1),c.splice(a,1)},updateRates:function(a,b){var d=this;b||(h=$.extend(!0,[],a),d.rawRates=h,c=ko.mapping.fromJS(a)),d.ratesUpdated(h)},ratesUpdated:function(a){tou.forEachArray(g,function(b){b.updateRates(a)})},getEditProperties:function(){var a=d.parentTable&&d.parentTable.title;return{title:d.title,isChild:null!==d.parentTable,parentTableName:a||"",hidePeakInfo:d.hidePeakInfo}}}),j.parentTable?j.parentTable.match(tou.idxPrefix)?d.linkToTable(j.parentTable):(b=f.getRateTableByTitle(j.parentTable),b?d.linkToTable(b.touid):tou.on("newRateTable-"+j.parentTable,function(a){b=f.getRateTableByTitle(j.parentTable),d.linkToTable(b)})):0===h.length&&0===i.length&&j&&(d.buildRates(j.rates),d.buildPeriods(j.periods)),tou.fire("newRateTable-"+l)},modalTemplates:{electricityRateFiscalYear:{fiscalYear:""},electricityRatePeriod:{title:"Add Rate Period",season:"transition",dateFrom:"",dateTo:"",daySunday:!1,dayMonday:!1,dayTuesday:!1,dayWednesday:!1,dayThursday:!1,dayFriday:!1,daySaturday:!1,enablePeakSelection:!1,timeFrom:"",timeTo:"",seasonName:"",isUpdate:!1,periodIdx:"",saveText:"Add",touid:0,computeds:{atLeastOneDay:function(a){return function(){var b=!1;return tou.forEachArray(tou.fullDayList,function(c){a["day"+c]()&&(b=!0)}),b}}}},electricityAddRateElement:{title:"Add Rate Element",type:"demand",peak:"on",rateName:"",rateQualifier:"",threshold:0,isUpdate:!1,rateIdx:"",saveText:"Add",qualifierDemand:"Peak Demand",addQualifier:function(a,b){var c=this.rateQualifier();c+=" "+$(b.target).data("val"),this.rateQualifier(c),$(".rateQualifier").focus()}},electricityEditRateTable:{title:"",isChild:!1,unlink:!1,parentTableName:"",hidePeakInfo:!1},electricityAddRateTable:{tableName:"",copyPeriods:!1,linkPeriods:!1,linkedTable:"",rateTablesUsable:[],hidePeakInfo:!1},electricityAddOffPeakDay:{date:"",name:"",isUpdate:!1,oldName:"",saveText:"Add",title:"Add Off Peak Day"},electricityAddFiscalYearRateTable:{previousYears:[],year:"",yearToCopy:"",copyData:!1,currFiscalYear:""}},bindings:{isEditMode:ko.observable(!1),currRateTable:ko.observable(),holidays:ko.observableArray([]),previousYears:ko.observableArray([]),currFiscalYear:ko.observable(),initialized:ko.observable(!1),latestYear:ko.observable(),setFiscalYear:function(a){var b=ko.toJS(a),c=parseInt(b.fiscalYear,10);isNaN(c)||c<=0?a.errorMessages(["Invalid Fiscal Year"]):(this.bindings.initialized(!0),this.bindings.latestYear(c),this.bindings.currFiscalYear(c),this.createYearDropdown(tou.currUtility.PreviousRateTables),tou.currUtility.RateTables["Fiscal Year"]=c,tou.currUtility.RateTables["Fiscal Year"]=c,this.createRateTables(tou.currUtility.RateTables),tou.hideModal(),this.bindings.toEditMode())},print:function(){tou.print($("."+this.$page.utilityName+" ."+this.$page.title.toLowerCase().replace(/ /g,"")+" .mainContent"))},exportPDF:function(){tou.exportPDF($("."+this.$page.utilityName+" ."+this.$page.title.toLowerCase().replace(/ /g,"")+" .rateTableContent"))},toEditMode:function(){this.isEditMode(!0)},cancelEditMode:function(){this.$page.doCancel(),this.isEditMode(!1)},save:function(){this.$page.doSave()},loadYear:function(a){var b=parseInt(a,10);b!==this.currFiscalYear()&&this.cancelEditMode(),this.currFiscalYear(b),this.$page.loadYear(a)},addRateTable:function(){tou.showModal("electricityAddRateTable",{rateTablesUsable:this.rateTablesUsable()},this.$page)},addHoliday:function(){this.isEditMode()&&tou.showModal("electricityAddOffPeakDay",null,this.$page)},editHoliday:function(a){var b=ko.toJS(a);this.isEditMode()&&(b.title="Edit Off Peak Day",b.isUpdate=!0,b.oldName=a.name(),b.saveText="Update",tou.log(b),tou.showModal("electricityAddOffPeakDay",b,this.$page))},deleteHoliday:function(a){var b=ko.toJS(a);this.deleteHoliday(b),tou.hideModal()},addNewHoliday:function(a){var b=ko.toJS(a),c=[];b.date||c.push("Invalid Date"),b.name||c.push("Must enter name"),c.length>0?a.errorMessages(c):(a.errorMessages.removeAll(),this.addNewHoliday(b),tou.hideModal())},addRatePeriod:function(a){this.currRateTable(a),tou.showModal("electricityRatePeriod",{dateFrom:"",dateTo:""},this.$page)},addNewRatePeriod:function(a){var b=ko.toJS(a),c=b.isUpdate,d=this.bindings.currRateTable(),e=this.getRateTable(d.touid),f=moment(b.dateFrom).format(tou.dateFormat),g=moment(b.dateTo).format(tou.dateFormat),h=[];b.dateFrom&&b.dateTo?b.dateFrom>b.dateTo&&h.push("Start date must be before end date"):h.push("Must select valid date range"),"transition"!==b.season&&(b.timeFrom&&b.timeTo?parseInt(b.timeFrom.replace(":",""),10)>parseInt(b.timeTo.replace(":",""),10)&&h.push("Start time must be before end time"):h.push("Must select peak time range"),b.atLeastOneDay||h.push("Must select at least one day")),this.checkForOverlap(e,f,g,c,b)&&h.push("Periods cannot overlap"),h.length>0?a.errorMessages(h):(a.errorMessages.removeAll(),this.addNewRatePeriod(b),tou.hideModal())},deletePeriod:function(a){var b=ko.toJS(a);this.deletePeriod(b),tou.hideModal()},deleteRate:function(a){var b=ko.toJS(a);this.deleteRate(b),tou.hideModal()},addRateElement:function(a){this.currRateTable(a),tou.showModal("electricityAddRateElement",null,this.$page)},addNewRateElement:function(a){var b,c=ko.toJS(a),d=[],e=c.type,f=c.rateQualifier,g=!0,h=!1,i=!1,j=this.getRateTable(this.bindings.currRateTable().touid),k={2:function(a){return"AND"===a},1:function(a){return!a.match("[a-zA-Z]")},0:function(a){return["<","<=",">",">="].indexOf(a)!==-1}},l=function(){var a=f.match(/[\d]+/g)||[],b=f.match(/[{<}{>}]+/g)||[];a.length>1?g=2===b.length&&(a[0]>a[1]?"<"===b[0]&&">"===b[1]:">"===b[0]&&"<"===b[1]):b.length!==a.length&&(g=!1);
};c.threshold=parseInt(c.threshold,10),c.rateName||d.push("Must choose rate name"),"reactive"===e&&(c.threshold||0===c.threshold||d.push("Invalid rate threshold")),"consumption"===e&&("off"===c.peak?""!==c.rateQualifier&&(b=c.rateQualifier.trim().split(/\s+/),b.length>0&&(2===b.length||(b.length-2)%3===0?tou.forEachArray(b,function(a,b){return g=k[b%3](a)}):g=!1),g||(h=!0),g&&(l(),g||(i=!0)),g||d.push("Invalid qualifier.<br/>Qualifier must be space-delimited and a valid mathematical expression.  Examples: <br/>< 425<br/>>= 425 AND < 620")):c.rateQualifier=""),tou.forEachArray(j.rawRates,function(a,b){if(a.name===c.rateName&&b!==c.rateIdx)return d.push("Duplicate rate name"),!1}),d.length>0?a.errorMessages(d):(a.errorMessages.removeAll(),this.addNewRateElement(c),tou.hideModal())},editRatePeriod:function(a,b){var c,d,e,f=this.$page,g=ko.toJS(b),h=a.$data.touid,i=f.getRateTable(h);this.isEditMode()&&null===i.parentTable&&(tou.forEachArray(i.rawPeriods,function(a,b){a.touid===g.touid&&(c=a,d=b)}),e=f.convertPeriodToKO(c),e.title="Update Rate Period",e.saveText="Update",e.isUpdate=!0,e.periodIdx=d,this.currRateTable(a.$data),tou.showModal("electricityRatePeriod",e,this.$page))},editRateElement:function(a,b){var c,d,e,f=this.$page,g=ko.toJS(b),h=a.$data.touid,i=f.getRateTable(h);this.isEditMode()&&(tou.forEachArray(i.rawRates,function(a,b){a.name===g.name&&(c=a,d=b)}),e=f.convertRateToKO(c),e.title="Update Rate Element",e.saveText="Update",e.isUpdate=!0,e.rateIdx=d,this.currRateTable(a.$data),tou.showModal("electricityAddRateElement",e,this.$page))},addNewFiscalYearRateTable:function(){tou.showModal("electricityAddFiscalYearRateTable",{previousYears:this.previousYears(),currFiscalYear:this.currFiscalYear()},this.$page)},addNewFiscalYear:function(a){var b=ko.toJS(a),c=b.previousYears,d=parseInt(b.year,10),e=[];c.indexOf(d)===-1&&d!==this.bindings.currFiscalYear()||e.push("Duplicate year"),(isNaN(d)||d<=0)&&e.push("Invalid year"),e.length>0?a.errorMessages(e):(a.errorMessages.removeAll(),this.addNewFiscalYear(b),this.bindings.toEditMode(),tou.hideModal())},addNewRateTable:function(a){var b,c=ko.toJS(a),d={title:c.tableName,rates:[],periods:[]},e=this.checkForUniqueTitle(c.tableName);""===c.tableName?a.errorMessages(["Table name cannot be empty"]):e?(c.linkPeriods?d.parentTable=c.linkedTable.touid:c.copyPeriods&&(b=this.getRateTable(c.linkedTable.touid),d.cfg={periods:$.extend(!0,[],Array.prototype.slice.call(b.cfg.periods))}),this.createAndAddRateTable(d),tou.hideModal()):a.errorMessages(["Duplicate Table Name"])},editRateTable:function(a){this.isEditMode()&&(this.currRateTable(a),tou.showModal("electricityEditRateTable",this.$page.getRateTable(a.touid).getEditProperties(),this.$page))},deleteRateTable:function(){this.deleteRateTable(),tou.hideModal()},updateRateTable:function(a){var b=ko.toJS(a),c=b.title,d=this.checkForUniqueTitle(c);d?(a.errorMessages.removeAll(),this.updateRateTable(b),tou.hideModal()):a.errorMessages(["Duplicate Table Name"])},rateTables:ko.observableArray([])},computedBindings:{rateTablesUsable:function(){var a=this.rateTables(),b=[];return tou.forEachArray(a,function(a){a.isHoliday||b.push(a)}),b},shouldShowEdit:function(){var a=this.currFiscalYear(),b=this.latestYear();return a===b}},checkForUniqueTitle:function(a){var b=!0,c=this.bindings.currRateTable()&&this.bindings.currRateTable().touid;return tou.forEach(this.rateTables,function(d){d.title===a&&d.touid!==c&&(b=!1)}),b},doCancel:function(){this.createRateTables(tou.currUtility.RateTables),tou.fire("ratetablecancel")},getSaveData:function(){var a=this,b={},c=ko.toJS(a.bindings.rateTables());return tou.forEachArray(c,function(c,d){var e=a.getRateTable(c.touid),f=e&&e.getExportConfig(),g={};f?b[f.title]={order:d,periods:f.periods,rates:f.rates,parentTable:f.parentTable,hidePeakInfo:f.hidePeakInfo}:(tou.forEachArray(c.holidays,function(a){g[a.name]=a.date}),g.order=d,b[c.title]=g)}),b},doSave:function(){var a=this,b=a.getSaveData(),c=$.extend(!0,{},a.previousYears),d=a.bindings.currFiscalYear(),e=0,f=function(){e++,2===e&&(a.bindings.isEditMode(!1),delete c[d],tou.buildAvailablePeriods(!0),tou.fire("ratetablesaved",tou.currUtility.utilityName))};delete c[d],tou.saveUtility(a.utilityName,{RateTables:b},function(a){f(),tou.log("saveresponse",a)}),tou.saveUtility(a.utilityName,{PreviousRateTables:c},function(a){f(),tou.log("saveresponse",a)})},deleteRateTable:function(){var a,b=this.bindings.currRateTable(),c=b.touid,d=this.rateTables[c].title;delete this.rateTables[c],delete tou.currUtility.RateTables[d],tou.forEachArray(this.bindings.rateTables(),function(b,d){if(b.touid===c)return a=d,!1}),this.bindings.rateTables.splice(a,1)},updateRateTable:function(a){var b=this.bindings.currRateTable(),c=this.getRateTable(b.touid);b.title(a.title),c.title=a.title,a.unlink&&c.unlinkTable(),c.bindings.hidePeakInfo(a.hidePeakInfo||!1),c.hidePeakInfo=a.hidePeakInfo||!1,tou.hideModal()},checkForOverlap:function(a,b,c,d,e){var f=!1,g=new Date(b),h=new Date(c),i=function(a,b){var c=new Date(a.start.date),i=new Date(a.end.date);g>i||h<c||(!d||d&&e.periodIdx!==b)&&(f=!0)};return tou.forEachArray(a.rawPeriods,function(a,b){return i(a,b)}),f},buildRateTable:function(a){var b,c,d=a.start,e=a.end,f=a.days,g=a.rates,h=new Date(d.date),i=new Date(e.date),j=new Date(i.getTime()),k=d.peak,l=e.peak,m=Math.floor(k/100),n=k%100,o=Math.floor(l/100),p=l%100,q=tou.shortDayList,r=[],s=this.timestamps||[],t=new Date(h.getTime()),u="off",v=function(){var a;u="off"===u?"on":"off",a=g[u],s.push({peak:u,timestamp:t.getTime()/1e3,rate:a,friendlyDate:t.toString()})},w=new Date;for(0===s.length&&s.push({timestamp:h.getTime()/1e3,rate:g.off,friendlyDate:h.toString()}),tou.forEachArray(f,function(a){r.push(q.indexOf(a))}),j.setDate(j.getDate()+1),j.setSeconds(-1),b=j.getTime();t.getTime()<b;)c=t.getDay(),r.indexOf(c)!==-1&&(t.setHours(m),t.setMinutes(n),v(),t.setHours(o),t.setMinutes(p),v()),t.setDate(t.getDate()+1);s.sort(function(a,b){return a.timestamp-b.timestamp}),this.timestamps=s,tou.log("Built rate table in",(new Date-w)/1e3,"seconds")},findDate:function(a){for(var b=0,c=new Date;a/1e3>this.timestamps[b].timestamp;)b++;tou.log("found date",this.timestamps[b-1],"in",new Date-c,"milliseconds")},findAllOnPeriods:function(a,b){for(var c,d,e=a.getTime()/1e3,f=b.getTime()/1e3,g=0,h=[],i=new Date;e>this.timestamps[g].timestamp;)g++;for(;f>this.timestamps[g].timestamp;)"on"===this.timestamps[g].peak&&(c=this.timestamps[g],d=this.timestamps[g+1],h.push({start:c.timestamp,end:d.timestamp,rate:c.rate})),g++;return tou.log("found ranges in",new Date-i,"milliseconds"),h},convertRateToKO:function(a){var b={type:a.type,peak:a.peak,rateName:a.name,rateQualifier:a.qualifier,threshold:a.threshold,qualifierDemand:a.qualifierDemand};return b},convertPeriodToKO:function(a){var b={season:a.rangeType,dateFrom:new Date(a.start.date),dateTo:new Date(a.end.date),enablePeakSelection:a.enablePeakSelection,daySunday:!1,dayMonday:!1,dayTuesday:!1,dayWednesday:!1,dayThursday:!1,dayFriday:!1,daySaturday:!1,seasonName:a.title,touid:a.touid};return void 0===a.start.peak&&(a.start.peak=0),void 0===a.end.peak&&(a.end.peak=0),b.timeFrom=Math.floor(a.start.peak/100)+":"+("0"+a.start.peak%100).slice(-2),b.timeTo=Math.floor(a.end.peak/100)+":"+("0"+a.end.peak%100).slice(-2),tou.forEachArray(a.days,function(a){var c=tou.fullDayList[tou.shortDayList.indexOf(a)];b["day"+c]=!0}),b},convertPeriod:function(a){var b,c={},d=function(a){var b=new Date(a),c=b.getMonth()+1,d=b.getDate();return[c,d].join("/")},e=function(a){var b="",c=0,d={sun:1,mon:3,tue:3,wed:3,thu:3,fri:3,sat:1};return tou.forEachArray(a,function(a,b){c+=d[a]}),b=15===c?"Weekdays":2===c?"Weekends":a.map(function(a){return a.charAt(0).toUpperCase()+a.slice(1)}).join(", ")},f=function(a){var b,c,d=function(a){var b;return b=a<100?"00"+a:a>=100&&a<1e3?"0"+a:a,moment(b,["HH:mm"]).format("h:mm a")};return b=d(a.start.peak),c=d(a.end.peak),b+" - "+c};return a.touid||(a.touid=tou.makeId()),a.rates?tou.forEach(a.rates,function(a,b){c[b]=a}):c={},b={periodTitle:a.title,periodType:a.rangeType,rangeText:d(a.start.date)+" - "+d(a.end.date),daysText:e(a.days),timeText:f(a),peakText:"On-Peak",_rawStart:a.start.date,_rawEnd:a.end.date,touid:a.touid||tou.makeId(),enablePeakSelection:a.enablePeakSelection||!1},b.rates=c,b},createRateTables:function(a){var b=this,c=[],d=function(a,d){var e,f=[],g=[];"number"!=typeof a&&(a.periods?(a.periods.sort(function(a,b){return new Date(a.start.date)>new Date(b.start.date)?1:-1}),tou.forEachArray(a.periods,function(a){f.push(b.convertPeriod(a))}),g=Array.prototype.slice.call(a.rates),e=b.createAndAddRateTable({title:d,periods:f,rates:g,cfg:$.extend(!0,{},a)},!0),c[a.order]=e.getBindings()):(tou.forEach(a,function(a,c){"order"!==c&&b.bindings.holidays.push({name:ko.observable(c),date:ko.observable(a)})}),b.bindings.holidays.sort(function(a,b){return new Date(a.date())<new Date(b.date())?-1:1}),c[a.order]={isHoliday:!0,holidays:b.bindings.holidays,title:d}))};b.clearRateTables(),tou.forEach(a,d),b.bindings.rateTables(c)},createYearDropdown:function(a){var b=this,c=[],d=b.bindings.currFiscalYear();b.previousYears={},c.push(d),b.previousYears[d]=tou.currUtility.RateTables,tou.forEach(a,function(a,d){c.push(d),b.previousYears[d]=b.previousYears[d]||a}),c.sort().reverse(),b.bindings.previousYears(c)},init:function(){var a=this;tou.currUtility.RateTables["Fiscal Year"]&&""!==tou.currUtility.RateTables["Fiscal Year"]?(a.bindings.currFiscalYear(tou.currUtility.RateTables["Fiscal Year"]),a.bindings.latestYear(tou.currUtility.RateTables["Fiscal Year"]),a.createYearDropdown(tou.currUtility.PreviousRateTables),a.bindings.initialized(!0),a.createRateTables(tou.currUtility.RateTables)):tou.bindings.canWrite(tou.currUtility.Security[0])&&tou.showModal("electricityRateFiscalYear",null,a)}},{title:"Meters",isActive:ko.observable(!1),background:"woodbackgroundtile.jpg",init:function(){var a=this;$.extend(a.bindings,{$metersTbody:$("."+a.utilityNameShort+" .meters .sortablemeters")}),$("."+a.utilityNameShort+" .mainContent .meters").on("change","input:checkbox",function(b){a.bindings.adjustInactiveCount()}),a.bindings.initSortable(),$("."+a.utilityNameShort+" .meters").on("click",".addNewMeter-button",function(b){var c,d={isActive:!0,displayedMeterName:"",meterPoints:[{meterPointDesc:"Reactive",meterPointName:"- - -",upi:null,pointType:null},{meterPointDesc:"Demand",meterPointName:"- - -",upi:null,pointType:null},{meterPointDesc:"Consumption",meterPointName:"- - -",upi:null,pointType:null}]},e=$("."+a.utilityNameShort+" .meters"),f=e.find(".mainContent");b.preventDefault(),b.stopPropagation(),a.bindings.listOfMeters.indexOf(d)===-1&&(a.bindings.listOfMeters.push(d),c=e.find("table tbody tr:last"),c.addClass("ui-sortable-handle")),a.bindings.metersSortOrder("none"),f.stop().animate({scrollTop:f.get(0).scrollHeight},700)}),$("."+a.utilityNameShort+" .meters").on("click","th.meterDisplayName > div",function(b){var c=function(){var b,c,d,e,f;switch(a.bindings.metersSortOrder()){case"none":for(d=[],c=a.bindings.metersSortOrderNone.length,b=0;b<c;b++)e=a.bindings.metersSortOrderNone[b],f=ko.utils.arrayFilter(a.bindings.listOfMeters(),function(a){return a.displayedMeterName.toLowerCase()===e.displayedMeterName.toLowerCase()}),d.push(f[0]);break;case"asc":d=$.extend(!0,[],a.bindings.listOfMeters()),d.sort(function(a,b){var c,d=a.displayedMeterName.toLowerCase(),e=b.displayedMeterName.toLowerCase();return c=d>e?-1:d<e?1:0});break;case"dsc":d=$.extend(!0,[],a.bindings.listOfMeters()),d.sort(function(a,b){var c,d=a.displayedMeterName.toLowerCase(),e=b.displayedMeterName.toLowerCase();return c=d<e?-1:d>e?1:0})}a.bindings.listOfMeters(d)};if(a.bindings.isInEditMode()===!1){switch(a.bindings.metersSortOrder()){case"none":a.bindings.metersSortOrderNone=$.extend(!0,[],a.bindings.listOfMeters()),a.bindings.metersSortOrder("asc");break;case"asc":a.bindings.metersSortOrder("dsc");break;case"dsc":a.bindings.metersSortOrder("none")}c(),b.preventDefault(),b.stopPropagation()}}),a.bindings.listOfMeters(tou.getMeters()),a.setInactiveMeterCount()},setInactiveMeterCount:function(){var a=0;this.bindings.listOfMeters().forEach(function(b){b.isActive===!1&&a++}),this.bindings.inactiveMeterCount(a)},bindings:{backgroundImage:ko.observable("/woodbackground.jpg"),activePage:ko.observable(),metersTitle:ko.observable(),activeUtility:ko.observable(),isInEditMode:ko.observable(!1),preEditListOfMeters:[],metersSortOrder:ko.observable("none"),metersSortOrderNone:[],listOfMeters:ko.observableArray([]),inactiveMeterCount:ko.observable(0),adjustInactiveCount:function(){var a=tou.bindings["utility_"+tou.currUtility.shortName].metersBindings,b=0;ko.utils.arrayForEach(a.listOfMeters(),function(a){a.isActive||b++}),a.inactiveMeterCount(b)},initSortable:function(){var a=tou.bindings["utility_"+tou.currUtility.shortName].metersBindings;a.isInEditMode()?$("."+tou.currUtility.shortName+" .meters .sortablemeters").sortable({appendTo:a.$metersTbody,disabled:!a.isInEditMode(),items:"tr",forceHelperSize:!0,helper:"original",stop:function(b,c){var d=ko.dataFor(c.item[0]),e=ko.utils.arrayIndexOf(c.item.parent().children(),c.item[0]);e>=a.listOfMeters().length&&(e=a.listOfMeters().length-1),e<0&&(e=0),c.item.remove(),a.listOfMeters.remove(d),a.listOfMeters.splice(e,0,d),a.metersSortOrder("none")},scroll:!0,handle:".handle"}):$("."+tou.currUtility.shortName+" .meters .sortablemeters").sortable({appendTo:a.$metersTbody,disabled:!a.isInEditMode(),items:"tr",forceHelperSize:!0,helper:"original",scroll:!0})},"delete":function(a){var b=tou.bindings["utility_"+tou.currUtility.shortName].metersBindings;b.listOfMeters.remove(a),b.adjustInactiveCount()},clearMeterPoint:function(a,b){var c,d,e=tou.bindings["utility_"+tou.currUtility.shortName].metersBindings,f=parseInt(b.currentTarget.attributes.meterPointIndex.value,10),g=parseInt(b.currentTarget.attributes.parentIndex.value,10);c=e.listOfMeters(),d=c[g].meterPoints[f],d.meterPointName="- - -",d.upi=null,e.listOfMeters([]),e.listOfMeters(c),e.$page.setInactiveMeterCount()},toEditMode:function(){var a=tou.bindings["utility_"+tou.currUtility.shortName].metersBindings;a.isInEditMode(!0),a.metersSortOrder("none"),a.metersSortOrderNone.length>0&&a.listOfMeters(a.metersSortOrderNone),a.preEditListOfMeters=$.extend(!0,[],a.listOfMeters()),a.initSortable()},cancelEditMode:function(){var a=tou.bindings["utility_"+tou.currUtility.shortName].metersBindings;$("."+this.$page.utilityNameShort+" .meters .errormessage").html(""),a.isInEditMode(!1),a.listOfMeters(this.preEditListOfMeters),a.$page.setInactiveMeterCount(),a.preEditListOfMeters=[],a.metersSortOrderNone=[],a.initSortable()},openPointSelector:function(a,b,c,d){var e,f,g,h,i,j,k=tou.bindings["utility_"+tou.currUtility.shortName].metersBindings,l=d||"/pointLookup",m=function(a,b,c){a&&(i.meterPoints[g].upi=a,i.meterPoints[g].pointType=c,i.meterPoints[g].meterPointName=b,j[h]=i,k.listOfMeters([]),k.listOfMeters(j),k.$page.setInactiveMeterCount())},n=function(){e.pointLookup.MODE="select",e.pointLookup.init(m,{name2:i.displayedMeterName,name3:"*SUM*"})};h=a,f=c,g=b,j=k.listOfMeters(),i=j[a],e=tou.workspaceManager.openWindowPositioned(l,"Select Point","","","Select Dynamic Point",{callback:n,width:1e3})},changeMeterPoint:function(a,b){var c=tou.bindings["utility_"+tou.currUtility.shortName].metersBindings,d=parseInt(b.currentTarget.getAttribute("upi"),10),e=parseInt(b.currentTarget.getAttribute("parentIndex"),10),f=parseInt(b.currentTarget.getAttribute("meterPointIndex"),10);c.openPointSelector(e,f,d)},showPointReview:function(a){var b,c=tou.workspaceManager.openWindowPositioned,d=tou.workspaceManager.config.Utility.pointTypes,e=a.pointType,f=parseInt(a.upi,10),g={width:850,height:600};b=d.getUIEndpoint(e,f),b&&c(b.review.url,a.meterPointName,e,b.review.target,f,g)},save:function(){var a,b,c=this,d=this.$page.utilityNameShort,e=c.listOfMeters(),f=$("."+d+" .meters .errormessage"),g=function(){var a,b=[];for(c.$metersTbody.find("tr.meterdata").each(function(a,b){$(b).addClass("faded")}),c.$metersTbody.find(".nameerror").each(function(a,b){$(b).removeClass("nameerror")}),a=0;a<e.length;a++)if(""===e[a].displayedMeterName.trim())return{blankmetername:!0,locationA:a};for(a=0;a<e.length;a++){if(void 0!==b[e[a].displayedMeterName])return{duplicateMeterName:!0,locationA:b[e[a].displayedMeterName],locationB:a};b[e[a].displayedMeterName]=a}},h=g();f.html(""),h?h.duplicateMeterName===!0?(a="."+d+" .meters tr.meterdata:eq("+h.locationA+") td:eq(1) input",b="."+d+" .meters tr.meterdata:eq("+h.locationB+") td:eq(1) input",$(a).addClass("nameerror"),$(a).parent().parent().removeClass("faded"),$(a).focus(),$(b).addClass("nameerror"),$(b).parent().parent().removeClass("faded"),f.html("Duplicate meter Names for '"+$(a)[0].value+"'")):h.blankmetername===!0&&(a="."+d+" .meters tr.meterdata:eq("+h.locationA+") td:eq(1) input",$(a).addClass("nameerror"),$(a).parent().parent().removeClass("faded"),$(a).focus(),f.html("Meter Name is BLANK")):($("."+d+" .meters table tbody .faded").each(function(a,b){$(b).removeClass("faded")}),tou.saveUtility(c.$page.utilityName,{Meters:e},function(a){a.message&&"success"===a.message?(tou.currUtility.Meters=c.$page.rawUtility.Meters=e,tou.fire("meterssaved",tou.currUtility.utilityName),c.listOfMeters([]),c.listOfMeters(tou.currUtility.Meters),c.metersSortOrderNone=[],c.$page.setInactiveMeterCount(),c.isInEditMode(!1),c.initSortable()):tou.alert(tou.saveErrorText)}))}}},{title:"Data Store",shortTitle:"datastore",isActive:ko.observable(!1),background:"woodbackgroundtile.jpg",listOfMonthYears:[],blockCount:0,topBarDropDownStates:[],topBarEditButtonStates:[],init:function(){var a=this,b="."+a.utilityNameShort,c=function(a){var b=$(a),c=b.find(".dropdown-menu"),d=b.find("input");b.click(function(a){window.setTimeout(function(){0===c.scrollTop()&&d.focus()},50)}),d.click(function(a){a.stopPropagation()})},d=function(b){b===a.utilityName&&(a.listOfMonthYears=ko.utils.arrayFilter(tou.availablePeriods[b],function(a){return"Month"===a.period}),a.bindings.datastoreDateFilter.valueHasMutated(),a.bindings.listOfMeters([]),a.bindings.listOfMeters(tou.getMeters()),a.bindings.monthSelected(a.listOfMonthYears[0]),a.bindings.configRequired(0===a.listOfMonthYears.length||0===a.bindings.listOfMeters().length))},e=/^\-?\d+((\.)\d+)?$/,f=function(a){return String(a).search(e)!=-1},g=function(){return a.bindings.$datastoreContent.find(".error").length>0};$.extend(a.bindings,{$mainContent:$("."+a.utilityNameShort+" .dataStoreMainContent"),$dataStoreTable:$("."+a.utilityNameShort+" .datastoreTable"),$datastoreContent:$("."+a.utilityNameShort+" .dataStoreContent"),$topBarControls:$("."+a.utilityNameShort+" .dataStoreTopBar").find("button"),$datastoreGettingData:$("."+a.utilityNameShort+" .dataStoreGettingData"),$datastoreSaveButton:$("."+a.utilityNameShort+" .dataStoreTopBar .btn-success")}),a.bindings.$dataStoreTable.on("click","tbody .inlineedit",function(b){var c=$(this).parent();$(this).keyup(function(){var b=a.bindings.$datastoreContent.find(".dataTables_paginate");""!=this.value?f(this.value)?($(this).removeClass("error"),g()||(b.show(),a.bindings.$datastoreSaveButton.prop("disabled",!1)),c.addClass("datachanged"),c.attr("title","")):(b.hide(),a.bindings.$datastoreSaveButton.prop("disabled",!0),$(this).addClass("error"),$(this).focus(),c.attr("title","'"+this.value+"' is not a valid number")):($(this).removeClass("error"),g()||(b.show(),a.bindings.$datastoreSaveButton.prop("disabled",!1)))})}),a.bindings.$dataStoreTable.on("change","tbody .inlineedit",function(a){var b=$(this).parent();b.addClass("datachanged")}),$(window).resize(function(){a.bindings.handleResize(a)}),a.bindings.initDatastoreDataTable([]),a.bindings.$datastoreContent.hide(),d(a.utilityName),c(b+" .dataStoreTopBar .availablePeriodsContainer"),c(b+" .dataStoreTopBar .availableMetersContainer"),tou.on("meterssaved",function(a){d(a)}),tou.on("ratetablesaved",function(a){d(a)})},bindings:{backgroundImage:ko.observable("/woodbackground.jpg"),errorWithRequest:ko.observable(!1),configRequired:ko.observable(!1),postingToDataStore:ko.observable(!1),datastoreDateFilter:ko.observable(""),datastoreMeterFilter:ko.observable(""),activePage:ko.observable(),activeUtility:ko.observable(),selectedMonthYear:ko.observable(),selectedDataType:ko.observable("All Data"),selectedMeter:ko.observable(),isInEditMode:ko.observable(!1),listOfAnalogInputs:ko.observableArray(),listOfMeters:ko.observableArray(),listOfMeterReads:[],currentDatatablesPage:1,listOfDataTypes:["All Data","Missing Data"],resizeTimer:500,lastResize:null,handleResize:function(a){var b=tou.bindings["utility_"+tou.currUtility.shortName].datastoreBindings;b.lastResize=new Date,setTimeout(function(){new Date-b.lastResize>=b.resizeTimer&&($("."+a.utilityNameShort+" .dataTables_scrollBody").css("height",window.innerHeight-210),a.bindings.$dataStoreTable.dataTable().fnAdjustColumnSizing())},b.resizeTimer)},setBlockState:function(a){var b=this.$page,c="."+b.utilityNameShort,d=$(c+" .dataStoreContent"),e=$(c+" .dataStoreGettingData"),f=$(c+" .dataStoreTopBar .dropdown button"),g=$(c+" .dataStoreTopBar .buttonBar button").not(".dataStoreEditButton"),h=this.$page.topBarDropDownStates,i=this.$page.topBarEditButtonStates,j=function(){var a=function(a,b){a.each(function(a){var c=$(this).attr("disabled");void 0===c&&(c=!1),b[a]=c})};a(f,h),a(g,i)},k=function(){var a=function(a,b){a.each(function(a){var c=b[a];$(this).attr("disabled",c)})};a(f,h),a(g,i)},l=function(a){a.each(function(a){$(this).attr("disabled",!0)})};a===!0?(1===++b.blockCount&&j(),l(f),this.isInEditMode()===!1&&(l(g),d.hide(),e.show())):(b.blockCount=0,this.showMeterSelectMessage()===!1&&(d.show(),this.$dataStoreTable.dataTable().fnDraw(!1)),e.hide(),k())},block:function(){this.setBlockState(!0)},unblock:function(){this.setBlockState(!1)},initDatastoreDataTable:function(a){var b=(tou.bindings["utility_"+tou.currUtility.shortName].datastoreBindings,function(a){var b,c=$(a).html(),d=c;b=$('<span class="hideInEdit">'+d+'</span><input class="inlineedit form-control showInEdit" style="width: 150px; color: red" type="text" />'),$.isNumeric(d)===!0&&b.val(d),$(a).html(b)}),c=function(a,c){c.missingData===!0&&($(a).addClass("missingdata"),$(a).addClass("editable"),b(a)),c.userEdited===!0&&($(a).addClass("useredited"),$(a).addClass("editable"),b(a))},d={showGroupPanel:!1,keepLastSelected:!1,scrollY:window.innerHeight-210+"px",processing:!0,data:ko.observableArray(a),fnCreatedRow:function(a,b,c){$(a).attr("timestamp",b.meterStart)},aoColumns:[{title:"Date",mData:"monthDay",className:"dt-head-center"},{title:"Time",mData:"time",className:"dt-head-center"},{title:"Consumption (MWh)",mData:"consumption.meterReadValue",className:"dt-head-right",fnCreatedCell:function(a,b,d,e,f){$(a).attr("colIndex",f),$(a).addClass("dt-body-right"),c(a,d.consumption)}},{title:"Demand (MW)",mData:"demand.meterReadValue",className:"dt-head-right",fnCreatedCell:function(a,b,d,e,f){$(a).attr("colIndex",f),$(a).addClass("dt-body-right"),c(a,d.demand)}},{title:"Reactive (MVAR)",mData:"reactive.meterReadValue",className:"dt-head-right",fnCreatedCell:function(a,b,d,e,f){$(a).attr("colIndex",f),$(a).addClass("dt-body-right"),c(a,d.reactive)}}],multiSelect:!1,pageLength:48,bLengthChange:!1,bSort:!1,displaySelectionCheckbox:!1,canSelectRows:!1,selectedItems:ko.observableArray(),footerVisible:!1,rowHeight:30,bFilter:!1,showColumnMenu:!1,showFilter:!1};this.$dataStoreTable.DataTable(d)},displayMissingData:function(a){var b,c,d=[];if(a[0].results&&a[0].results.missingData){var e,f,g,h,i,j,k,l,m=a[0].results.missingData[0].length,n=a[0].upis,o=function(a){var b;for(e=0;e<n.length;e++)if(n[e]===a){b=e;break}return b};for(b=this.selectedMeter(),g=o(tou.retrieveMeterPoint(b,"Consumption").upi),i=o(tou.retrieveMeterPoint(b,"Demand").upi),k=o(tou.retrieveMeterPoint(b,"Reactive").upi),e=0;e<m;e++)c=a[0].results.missingData[0][e],f=c.timestamp,g>-1&&(h=c.columns[g].Value),i>-1&&(j=c.columns[i].Value),k>-1&&(l=c.columns[k].Value),d.push({meterDate:moment.unix(f,"X").format(),monthDay:moment.unix(f).format("M/DD"),time:moment.unix(f).format("h:mm a"),meterStart:f,consumption:{meterReadValue:isNaN(h)?"-":c.columns[g].missingData?"Missing":h,missingData:!isNaN(h)&&c.columns[g].missingData,userEdited:!isNaN(h)&&c.columns[g].userEdited},demand:{meterReadValue:isNaN(j)?"-":c.columns[i].missingData?"Missing":j,missingData:!isNaN(j)&&c.columns[i].missingData,userEdited:!isNaN(j)&&c.columns[i].userEdited},reactive:{meterReadValue:isNaN(l)?"-":c.columns[k].missingData?"Missing":l,missingData:!isNaN(l)&&c.columns[k].missingData,userEdited:!isNaN(l)&&c.columns[k].userEdited}})}this.listOfMeterReads=d,this.$dataStoreTable.DataTable().rows.add(this.listOfMeterReads).draw(),this.unblock()},displayAllData:function(a){if(void 0!==a[0]){var b,c,d,e,f,g,h,i,j,k,l=[],m=a[0].results.datastore.length,n=function(b){var d;for(c=0;c<a.length;c++)if(a[c].upis[0]===b){d=c;break}return d};for(b=this.selectedMeter(),e=n(tou.retrieveMeterPoint(b,"Consumption").upi),g=n(tou.retrieveMeterPoint(b,"Demand").upi),i=n(tou.retrieveMeterPoint(b,"Reactive").upi),c=0;c<m;c++)e>-1&&(f=a[e].results.datastore[c].columns[0],d=a[e].results.datastore[c].timestamp),g>-1&&(h=a[g].results.datastore[c].columns[0],d=a[g].results.datastore[c].timestamp),i>-1&&(j=a[i].results.datastore[c].columns[0],d=a[i].results.datastore[c].timestamp),k={meterDate:moment.unix(d,"X").format(),monthDay:moment.unix(d).format("M/DD"),time:moment.unix(d).format("h:mm a"),meterStart:d,consumption:{meterReadValue:f?f.missingData?"Missing":f.Value:"-",missingData:!!f&&f.missingData,userEdited:!!f&&f.userEdited},demand:{meterReadValue:h?h.missingData?"Missing":h.Value:"-",missingData:!!h&&h.missingData,userEdited:!!h&&h.userEdited},reactive:{meterReadValue:j?j.missingData?"Missing":j.Value:"-",missingData:!!j&&j.missingData,userEdited:!!j&&j.userEdited}},l.push(k);this.listOfMeterReads=l,this.$dataStoreTable.DataTable().rows.add(this.listOfMeterReads).draw()}this.unblock()},postToDataStore:function(a,b,c){var d=tou.bindings["utility_"+tou.currUtility.shortName].datastoreBindings,e=this;d.postingToDataStore(!0),$.ajax({url:b,type:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify(a)}).done(function(a){c&&c.call(e,a)}).fail(function(a,b,c){tou.alert(tou.criticalErrorText),d.$datastoreGettingData.hide(),d.$topBarControls.attr("disabled",!1),d.errorWithRequest(!0)}).always(function(){e.postingToDataStore(!1)})},setMetersListWithMissingData:function(a){var b,c,d,e,f,g=this.$page.rawUtility.Meters,h=g.length,i=[];for(e=0;e<h;e++)for(d=g[e],b=a.length,f=0;f<b;f++)if(c=a[f],c.name===d.displayedMeterName){i.push(d),a.splice(f,1);break}this.listOfMeters(i),this.unblock()},getMetersWithMissingData:function(){if(this.selectedMonthYear()){var a,b,c,d,e,f,g={},h=this.$page.rawUtility.Meters,i=h.length,j=this.selectedMonthYear();for(this.listOfMeters([]),this.selectedMeter(null),g.options={start:parseInt(j.start/1e3,10),end:parseInt(j.end/1e3,10)},g.options.meters=[],f=0;f<i;f++)a=[],b=h[f],c=tou.retrieveMeterPoint(b,"Consumption"),d=tou.retrieveMeterPoint(b,"Demand"),e=tou.retrieveMeterPoint(b,"Reactive"),c.upi&&c.upi>0&&a.push(c.upi),d.upi&&d.upi>0&&a.push(d.upi),e.upi&&e.upi>0&&a.push(e.upi),a.length>0&&g.options.meters.push({name:b.displayedMeterName,upis:a});g.options.meters.length>0?this.postToDataStore(g,"/api/meters/getMissingMeters",this.setMetersListWithMissingData):this.unblock()}},buildMissingDataReqObj:function(a,b,c,d){var e=[],f=tou.retrieveMeterPoint(c,"Consumption").upi,g=tou.retrieveMeterPoint(c,"Demand").upi,h=tou.retrieveMeterPoint(c,"Reactive").upi,i={};return i.options=[],f>0&&e.push(f),g>0&&e.push(g),h>0&&e.push(h),i.options.push({utilityName:tou.currUtility.utilityName,range:{start:a,end:b},scale:"half-hour",fx:d,upis:e}),i},buildReqObj:function(a,b,c,d){var e=tou.retrieveMeterPoint(c,"Consumption").upi,f=tou.retrieveMeterPoint(c,"Demand").upi,g=tou.retrieveMeterPoint(c,"Reactive").upi,h={};return h.options=[],e>0&&h.options.push({utilityName:tou.currUtility.utilityName,range:{start:a,end:b},scale:"half-hour",fx:d,upis:[e]}),f>0&&h.options.push({utilityName:tou.currUtility.utilityName,range:{start:a,end:b},scale:"half-hour",fx:d,upis:[f]}),g>0&&h.options.push({utilityName:tou.currUtility.utilityName,range:{start:a,end:b},scale:"half-hour",fx:d,upis:[g]}),h},getDataStore:function(){if(this.selectedMonthYear()&&this.selectedMeter()){this.block();var a,b,c,d,e,f=this.selectedMonthYear();this.errorWithRequest(!1),b="Missing Data"===this.selectedDataType()?"missingData":"datastore",a=this.selectedMeter(),d=parseInt(f.start/1e3,10),e=parseInt(f.end/1e3,10),this.listOfMeterReads=[],"missingData"===b?(c=this.buildMissingDataReqObj(d,e,a,b),this.postToDataStore(c,"/api/meters/getUsage",this.displayMissingData)):(c=this.buildReqObj(d,e,a,b),this.postToDataStore(c,"/api/meters/getUsage",this.displayAllData))}},setDataStore:function(a){var b={values:a};this.postToDataStore(b,"/api/meters/editDatastore")},setListOfMeters:function(){"Missing Data"===this.selectedDataType()?(this.block(),this.getMetersWithMissingData()):this.listOfMeters(tou.getMeters())},dataTypeSelected:function(a){this.$dataStoreTable.DataTable().clear().draw(),this.selectedDataType(a),this.setListOfMeters(),this.getDataStore()},meterSelected:function(a){this.$dataStoreTable.DataTable().clear().draw(),this.selectedMeter(a),this.getDataStore()},monthSelected:function(a){this.$dataStoreTable.DataTable().clear().draw(),this.selectedMonthYear(a),this.setListOfMeters(),this.getDataStore()},toEditMode:function(){this.isInEditMode(!0),this.block(!0)},cancelEditMode:function(){$(this.$dataStoreTable.dataTable().fnGetNodes()).find("td.datachanged").each(function(){var a=$(this),b=a.find("input"),c=a.find("span"),d=parseFloat(c.html());$.isNumeric(d)===!1?b.val(""):b.val(d),a.removeClass("datachanged")}),$(this.$dataStoreTable.dataTable().fnGetNodes()).find(".error").each(function(){$(this).removeClass("error")}),this.$datastoreContent.find(".dataTables_paginate").show(),this.isInEditMode(!1),this.unblock()},save:function(){console.log("save called...."),this.block();var a,b=[],c=function(){var a,b,c,d=tou.bindings["utility_"+tou.currUtility.shortName].datastoreBindings,e=[],f=d.$dataStoreTable.DataTable(),g=f.columns()[0];for(a=0;a<g.length;a++)b=f.column(a).header(),c=$(f.column(a).header()).html(),c.indexOf("Consumption")>-1?e[a]="Consumption":c.indexOf("Demand")>-1?e[a]="Demand":c.indexOf("Reactive")>-1&&(e[a]="Reactive");return e};a=c(),$(this.$dataStoreTable.dataTable().fnGetNodes()).find("td.datachanged").each(function(){var c,d=tou.bindings["utility_"+tou.currUtility.shortName].datastoreBindings,e=$(this),f=e.find("input"),g=e.find("span"),h=e.parent(),i=parseInt(h.attr("timestamp"),10),j=parseFloat(f.val()),k=parseInt(e.attr("colindex"),10);c=tou.retrieveMeterPoint(d.selectedMeter(),a[k]).upi,$.isNumeric(j)&&j!==parseFloat(g.html())&&(b.push({upi:c,Value:j,timestamp:i,statusflags:0}),g.html(j),e.addClass("userEdited")),e.removeClass("datachanged")}),this.setDataStore(b),this.$datastoreContent.find(".dataTables_paginate").show(),this.isInEditMode(!1),this.unblock()}},computedBindings:{filteredDatastoreMonthYear:function(){var a=this,b=a.datastoreDateFilter().toLowerCase(),c=a.$page.listOfMonthYears;return""===b?c:ko.utils.arrayFilter(c,function(a){return a.searchDate.indexOf(b)>-1})},filteredMeters:function(){var a=this,b=a.datastoreMeterFilter().toLowerCase(),c=a.listOfMeters();return""===b?c:ko.utils.arrayFilter(c,function(a){return a.displayedMeterName.toLowerCase().indexOf(b)>-1})},isEditEnabled:function(){var a=this.selectedMonthYear(),b=this.selectedMeter(),c=this.postingToDataStore();return!(!a||!b||c)},showMeterSelectMessage:function(){var a=!!this.selectedMonthYear(),b=!!this.selectedMeter(),c=this.listOfMeters(),d=this.$page.listOfMonthYears,e=this.configRequired();return d.length&&c.length>=0&&a&&!b&&!e;
}}},{title:"Import/Export",shortTitle:"export",isActive:ko.observable(!1),background:"woodbackgroundtile.jpg",listOfMonthYears:[],init:function(){var a,b=this,c=("."+b.utilityNameShort+" ",function(a){var b=$(a),c=b.find(".dropdown-menu"),d=b.find("input");b.click(function(a){window.setTimeout(function(){0===c.scrollTop()&&d.focus()},50)}),d.click(function(a){a.stopPropagation()})}),d=function(c){c===b.utilityName&&(a=tou.currUtility.Meters,b.bindings.listOfMeters(a),b.bindings.meterSelected(a[0]),b.listOfMonthYears=ko.utils.arrayFilter(tou.availablePeriods[b.utilityName],function(a){return"Month"===a.period}),b.bindings.selectedMonthYear(b.listOfMonthYears[0]||{prettyDate:"Working..."}),b.bindings.importExportDateFilter.valueHasMutated(),b.bindings.exportAvailable(b.listOfMonthYears.length>0&&a.length>0))};d(b.utilityName),tou.on("meterssaved",function(a){d(a)}),tou.on("ratetablesaved",function(a){d(a)}),c(".exportBody .availablePeriodsContainer"),c(".exportBody .availableMetersContainer")},bindings:{dateFormat:"MMMM YYYY",inAjax:ko.observable(!1),importExportDateFilter:ko.observable(""),importExportMeterFilter:ko.observable(""),selectedMonthYear:ko.observable(),uploadMethods:ko.observableArray(["1"]),selectedMeter:ko.observable(),listOfMeters:ko.observableArray(),upiMap:ko.observableArray([]),exportAvailable:ko.observable(!0),changeMonth:function(a){this.selectedMonthYear(a)},meterSelected:function(a){a&&(this.selectedMeter(a),this.upiMap(a&&a.meterPoints))},downloadCsv:function(){var a=this.selectedMonthYear(),b=this;return b.inAjax(!0),$.ajax({url:"/api/meters/exportCSV",type:"POST",dataType:"json",data:{options:{range:{start:parseInt(a.start/1e3,10),end:parseInt(a.end/1e3,10)},upiMap:b.upiMap(),meterName:b.selectedMeter().displayedMeterName}}}).done(function(a){a.err?tou.alert("The file could not be downloaded because the server encountered an error. Please try again."):window.open("/api/meters/downloadCsv?path="+a.path)}).fail(function(){tou.alert(tou.criticalErrorText)}).always(function(){b.inAjax(!1)}),!1},uploadCsv:function(a,b){var c,d,e,f=this,g=0,h="The file could not be uploaded because the server encountered an error. Please try again.",i=a[0],j=function(){$fileInput=$("."+f.$page.utilityNameShort+" input.uploadBtn"),$fileInput.closest("form").get(0).reset()};if(this.uploadMethods().forEach(function(a){g+=parseInt(a,10)}),i){if(e=i.name.split(".").pop(),"csv"!==e.toLowerCase())return void tou.alert("The selected file is not in the correct format. Only CSV files are supported.");f.inAjax(!0),d=new FormData,d.append("csv",i),$.ajax({url:"/api/meters/uploadCSV",processData:!1,type:"POST",cache:!1,contentType:!1,data:d}).done(function(a){a.path?(d={options:{methods:g,path:a.path}},$.ajax({url:"/api/meters/importCSV",type:"POST",dataType:"json",data:d}).done(function(a){c=a.message&&"success"===a.message?"Import Successful. "+a.updatedCount+" records were affected.":h,tou.alert(c)}).fail(function(){tou.alert(tou.criticalErrorText)}).always(function(){f.inAjax(!1),j()})):(c=a.err&&a.message?a.message:h,tou.alert(c),f.inAjax(!1),j())}).fail(function(){tou.alert(tou.criticalErrorText),f.inAjax(!1),j()})}}},computedBindings:{filteredImportExportMonthYear:function(){var a=this,b=a.importExportDateFilter().toLowerCase(),c=a.$page.listOfMonthYears;return""===b?c:ko.utils.arrayFilter(c,function(a){return a.searchDate.indexOf(b)>-1})},filteredImportExportMeters:function(){var a=this,b=a.importExportMeterFilter().toLowerCase(),c=a.listOfMeters();return""===b?c:ko.utils.arrayFilter(c,function(a){return a.displayedMeterName.toLowerCase().indexOf(b)>-1})}}},{title:"Security",isActive:ko.observable(!1),background:"woodbackgroundtile.jpg",adminOnly:!0,permissionLevels:{READ:1,CONTROL:2,ACKNOWLEDGE:4,WRITE:8},hasAccess:function(a,b){return!!(a._pAccess&this.permissionLevels[b])},getUsersOnPoint:function(a){var b,c,d,e,f,g,h=[],i=a.bindings.groupsOnPoint(),j=a.bindings.allUsers(),k={};for(f=0,g=i.length;f<g;f++){group=i[f],usersInGroup=group.users;for(e in usersInGroup)user=j[e],b=!!user&&user["System Admin"].Value,c=usersInGroup[e]["Group Admin"],d=b||c,user&&(user.canRead|=group.canRead||d,user.canWrite|=group.canWrite||d,user.canControl|=group.canControl||d,user.canAcknowledge|=group.canAcknowledge||d,user.isGroupAdmin|=c),k.hasOwnProperty(e)===!1&&(k[e]=!0,user?h.push(user):h.push({_id:e,name:e,canRead:!1,canWrite:!1,canControl:!1,canAcknowledge:!1,"System Admin":{Value:!1}}))}return h},init:function(){var a=this,b=function(a){if(null===a||"object"!=typeof a)return a;var c=a.constructor();for(var d in a)c[d]=b(a[d]);return c};a.bindings.security(a.rawUtility.Security),a.bindings.originalSecurity=b(a.rawUtility.Security),a.bindings.usersOnPoint(a.getUsersOnPoint(a));var c=function(b){if(b)for(var c=0,d=b.length;c<d;c++){var e=b[c];e.name=e["First Name"].Value+" "+e["Last Name"].Value,a.bindings.allUsers()[e._id]=e}},d=function(b){for(var c=0,d=b.length;c<d;c++){var e=b[c],f=e._id;a.bindings.allGroups()[f]={_id:f,name:e["User Group Name"],canRead:!0,canWrite:a.hasAccess(e,"WRITE"),canControl:a.hasAccess(e,"CONTROL"),canAcknowledge:a.hasAccess(e,"ACKNOWLEDGE"),users:e.Users}}};$.ajax({url:"/api/security/groups/getallgroups",contentType:"application/json",type:"post"}).done(function(b){d(b),$.ajax({url:"/api/security/users/getallusers",contentType:"application/json",type:"post"}).done(function(b){c(b.Users),a.bindings.security.valueHasMutated()}).fail(function(){tou.alert(tou.criticalErrorText)})}).fail(function(){tou.alert(tou.criticalErrorText)})},bindings:{originalSecurity:[],isInEditMode:ko.observable(!1),security:ko.observableArray([]),user:ko.observable(tou.workspaceManager.user()),groups:ko.observableArray([]),groupsOnPoint:ko.observableArray([]),allGroups:ko.observable({}),allUsers:ko.observable({}),groupsNotOnPoint:ko.observableArray([]),usersOnPoint:ko.observableArray([]),editPage:function(){var a=this;a.isInEditMode(!0)},cancelEdit:function(){var a=this;a.security(a.originalSecurity),a.isInEditMode(!1)},savePage:function(){var a=this;tou.saveUtility(a.$page.utilityName,{Security:a.security()},function(b){b.message&&"success"===b.message?a.isInEditMode(!1):tou.alert(saveErrorText)})},toggleUsers:function(a,b,c,d){var e=b?$(b.currentTarget):$(c),f=e.children(".fa"),g=e.children("div"),h=200;d=void 0===d?"block"===g.css("display"):d,d?(g.slideUp(h),f.removeClass("fa-folder-open"),f.addClass("fa-folder")):(g.slideDown(h),f.removeClass("fa-folder"),f.addClass("fa-folder-open"))},toggleAllUsers:function(a,b){var c=this,d="."+this.$page.utilityNameShort+" ",e=$(b.currentTarget),f=e.children(".fa"),g=$(d+"tbody .group"),h=!!f.hasClass("fa-folder-open");g.each(function(a,b){c.toggleUsers(void 0,void 0,b,h)}),f.hasClass("fa-folder")?(f.removeClass("fa-folder"),f.addClass("fa-folder-open")):(f.removeClass("fa-folder-open"),f.addClass("fa-folder"))},getGroupUsers:function(a){var b=[],c=this.allGroups(),d=this.allUsers();if(c.hasOwnProperty(a)){var e=c[a].users;for(var f in e){var g="",h=d[f];if(h){var i=h["System Admin"].Value;e[f]["Group Admin"];g=h.name,i&&(g+='<span class="systemAdmin">(System Admin)</span>')}else g=f;b.push(g)}}return b.sort()},getUserName:function(a){var b=a.name;return a["System Admin"].Value&&(b+='<span class="systemAdmin">(System Admin)</span>'),b},addGroup:function(a,b){a.userCanEditPermissions()&&a.security.push(b._id)},removeGroup:function(a,b){a.userCanEditPermissions()&&a.security.remove(b._id)}},computedBindings:{showPermissionsTable:function(){return!!this.security().length||this.isInEditMode()},userCanEditPermissions:function(){return!!this.user()["System Admin"].Value},showRemoveGroupIcon:function(){return this.userCanEditPermissions()&&this.isInEditMode()},showGroupsNotOnPoint:function(){return this.isInEditMode()&&this.userCanEditPermissions()&&this.groupsNotOnPoint().length},showUsers:function(){return!(this.isInEditMode()&&this.userCanEditPermissions()||!this.usersOnPoint().length)},buildGroup:function(){for(var a,b,c,d=this.security(),e=this.allUsers(),f=this.allGroups(),g=[],h=[],i=[],j=function(a,b){return a.name==b.name?0:a.name<b.name?-1:1},k=0,l=d.length;k<l;k++)a=d[k],b=f[a],b?g.push(b):g.push({_id:a,name:a,canRead:!1,canWrite:!1,canControl:!1,canAcknowledge:!1,users:[]});this.groupsOnPoint(g.sort(j));for(a in f)b=f[a],d.indexOf(a)==-1&&h.push(b);this.groupsNotOnPoint(h.sort(j));for(a in e)c=e[a],c.canRead=c.canWrite=c.canControl=c.canAcknowledge=c.isGroupAdmin=!1;i=this.$page.getUsersOnPoint(this.$page),this.usersOnPoint(i.sort(j))}}}]},$(function(){setTimeout(function(){tou.init()},1)});
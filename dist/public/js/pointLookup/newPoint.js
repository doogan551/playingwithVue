"use strict";window.newPoint=function(a,b,c){function d(){this.widgetTheme="customArctic",this.availablePointTypes=b.observableArray(a.POINTTYPES),this.fullName=b.observable(""),this.pointType=b.observable(a.POINTTYPE),this.name1=b.observable(""),this.name2=b.observable(""),this.name3=b.observable(""),this.name4=b.observable(""),this.operationType=b.observable("New Point"),this.subTypeList=b.observableArray(),this.subType=b.observable(a.SUBTYPE)}function e(a){switch(a.toLowerCase()){case"report":h.subTypeList(q);break;case"sensor":h.subTypeList(p);break;default:h.subTypeList([])}h.subType(void 0),h.pointType(a)}function f(){function d(a,b){var c,d=a.length,e=-1;for(c=0;c<d;c++)if(a[c].key===b){e=c;break}return e}var f={height:"100%",width:"100%",panels:[{min:150,size:200},{min:250,collapsible:!1}],splitBarSize:3,theme:h.widgetTheme};if(g={pointType:new c.jqx.dataAdapter({localdata:h.availablePointTypes,dataType:"observablearray"})},a.ID){var m=1,n=a.NAME,r=n.split("_");r.forEach(function(a){h["name"+m++](a)}),h.operationType("Clone"),h.fullName("Cloning "+n)}a.POINTTYPE&&(f.showSplitBar=!1,f.panels=[{size:0},{collapsible:!1}]),i.jqxSplitter(f),j.jqxListBox({source:g.pointType,selectedIndex:d(h.availablePointTypes(),o.selectedPointType),height:"100%",width:"100%",displayMember:"key",valueMember:"enum",itemHeight:20,equalItemsWidth:!0,theme:h.widgetTheme}),j.on("change",function(a){var b=a.args.item.label;e(b)}),k.on("click",function(){var b,d,e,f={name1:c.trim(h.name1()),name2:c.trim(h.name2()),name3:c.trim(h.name3()),name4:c.trim(h.name4())},g=c("#pointNameColumn").find(".toolbar input:enabled:first"),i={},j=0,l="",m=window.opener.workspaceManager;if(k.attr("disabled","disabled"),b=h.pointType(),!b)return k.removeAttr("disabled"),alert("Please choose a point type");if(a.ID&&(i.targetUpi=a.ID),!f.name1.length)return k.removeAttr("disabled"),alert("Please place a value in segment 1");if(!g.val().length)return k.removeAttr("disabled"),alert("Please create a valid point name"),g.focus();for(var n=4;n;n--){if(j){if(!f["name"+n].length)return l=["Please place a value in segment ",n,". Skipping segments is not allowed."].join(""),k.removeAttr("disabled"),alert(l)}else f["name"+n].length&&(j=n);i["name"+n]=f["name"+n]}if(i.pointType=b,a.hasOwnProperty("SUBTYPE"))switch(b.toLowerCase()){case"report":h.subTypeList(q);break;case"sensor":h.subTypeList(p);break;default:h.subTypeList([])}void 0!==h.subType()&&h.subType()!==-1&&h.subTypeList().length&&(i.subType={Value:h.subTypeList()[h.subType()].name,eValue:h.subType()}),"Clone"===h.operationType()?c.blockUI({message:"Cloning, please wait"}):c.blockUI({message:"Creating point, please wait"}),c.ajax({url:"/api/points/initpoint",dataType:"json",type:"post",data:i}).done(function(a){return c.unblockUI(),a.err?(k.removeAttr("disabled"),alert(a.err)):window.attach&&"function"==typeof window.attach.saveCallback?(window.attach.saveCallback.call(void 0,a),window.close()):(d=m.config.Utility.pointTypes.getUIEndpoint(i.pointType,a._id),e=d.edit||d.review,void m.openWindowPositioned(e.url,a.Name,i.pointType,e.target,a._id,{width:1250,height:750,callback:function(){window&&window.close()}}))})}),l.on("click",function(){window.close()}),b.applyBindings(h)}var g,h,i,j,k,l,m=window.opener.workspaceManager,n=m.config,o=c.getAllQueryStrings(),p=n.Utility.pointTypes.getEnums("Sensor Types","Sensor").filter(function(a){return!a.noninitializable}),q=n.Utility.pointTypes.getEnums("Report Types","Report").filter(function(a){return!a.noninitializable});return a.init=function(a){var b=(c(window).height(),c("#pointNameColumn").find(".toolbar input"));if(i=c("#splitter"),window.opener||(i.hide(),alert("The Infoscan Point Navigator cannot be opened directly. You will now be redirected to the workspace."),window.location.replace("/")),k=c(".createPointBtn"),l=c(".cancelBtn"),j=c("#pointTypes"),h=new d,window.attach&&window.attach.point)for(var g=4;g;g--)window.attach.point["name"+g]?(window.attach.point.hasValue=!0,h["name"+g](window.attach.point["name"+g]),4!=g&&b.eq(g-1).prop("disabled",!0)):window.attach.point.hasValue&&(alert("The point name is incorrect. Blank name segments are not allowed"),window.close());f(),!!h.pointType()==!1&&o.selectedPointType&&e(o.selectedPointType)},b.bindingHandlers.allowedChars={init:function(a,b){var d=c(a),e=c(".invalidCharMsg"),f=e.find(".invalidChar"),g=d.offset(),h=d.outerHeight(),i=g.top+h+3,j=g.left,k=d.outerWidth(),l=window.opener.workspaceManager.config;d.on("keypress",function(a){var b=String.fromCharCode(a.which);0==l.Utility.isPointNameCharacterLegal(b)&&(e.css({opacity:1,top:i,left:j,width:k}),f.text(b),e.stop().show(),m.playSound("beep"),a.preventDefault(),a.stopImmediatePropagation(),d.blur())}).on("blur",function(){}).on("focus",function(){e.fadeOut(400)})}},a}(window.newPoint||{},ko,jQuery),$(window.newPoint.init);
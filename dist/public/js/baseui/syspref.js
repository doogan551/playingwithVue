var sysPrefsViewModel=function(){var a=this,b=[],c=function(a){var b=a.charAt(0).toLowerCase()+a.substring(1).replace(/\s/g,"");return b+"ViewModel"},d=function(){var b,c,d=!1,e=a.sections.length;for(b=0;b<e;b++)c=a.sections[b],c.dirty&&c.dirty()===!0&&(d=!0);a.dirty(d)};return a.registerSection=function(e,f){var g=new e,h=c(g.displayName),i=function(){a.sections.sort(function(a,b){return a.displayName===b.displayName?0:a.displayName<b.displayName?-1:1})};a.sections.push(g),i(),a[h]=g,g.dirty&&g.dirty.subscribe(function(a){d()}),f&&b.push(g[f])},a.runInitFunctions=function(){var a,c,d=b.length;for(a=0;a<d;a++)c=b[a],"function"==typeof c&&c()},a.sections=[],a.getSection=function(b){var d=c(b);return a[d]},a.saveAll=function(){var b,c,d=a.sections.length;for(c=0;c<d;c++)b=a.sections[c],b.save&&b.dirty&&b.dirty()&&b.save()},a.cancelAll=function(){var b,c,d=a.sections.length;for(c=0;c<d;c++)b=a.sections[c],b.cancel&&b.cancel();a.dirty(!1)},a.goToSection=function(a){var b="#"+a;location.hash=b},a.dirty=ko.observable(!1),a.section=ko.observable(""),$(window).on("hashchange",function(){var b=location.hash.substring(1);a.section(b)}),a}();ko.bindingHandlers.clickEdit={init:function(a,b,c,d,e){var f=$(a),g=f.children("span"),h=f.children("input"),i=f.children("select"),j=ko.unwrap(b());f.addClass("clickToEdit"),f.on("click",function(a){g.addClass("hide"),h.removeClass("hide").focus(),i.removeClass("hide").focus(),j=h.val()||i.val()}),h.on("blur",function(a){h.addClass("hide"),g.removeClass("hide")}),i.on("blur",function(a){i.addClass("hide"),g.removeClass("hide")}),h.on("keyup",function(a){var b=a.which||a.keyCode;return 27===b?(h.val(j),h[0].blur(),!0):13!==b||(h[0].blur(),!1)})}},ko.validation.rules.ipAddress={validator:function(a){var b,c,d,e;if(ko.validation.utils.isEmptyVal(a))return!1;if(b=a.split("."),d=b.length,4!==b.length)return!1;for(c=0;c<d;c++){if(e=b[c],"string"==typeof e&&e.match(/[^\d]+/))return!1;if(e=parseInt(b[c],10),e<0||e>255)return!1}return!0},message:"Invalid IP Address"},ko.validation.registerExtenders();var calendarViewModel=function(){var a={$calendarData:"",displayName:"Calendar",dirty:ko.observable(!1),season:ko.observable(""),originalSeason:"",hasError:ko.observable(!1),errorOccurred:ko.observable(!1),gettingData:ko.observable(!1).extend({throttle:250}),year:ko.observable(),holidays:ko.observableArray(),originalHolidays:[],updateDatePicker:function(b){$("#jqxCalendar").off("change"),$("#jqxCalendar").jqxCalendar("setMinDate",new Date(b,0,1)),$("#jqxCalendar").jqxCalendar("setMaxDate",new Date(b,11,31)),$("#jqxCalendar").jqxCalendar("setDate",new Date(b,0,1)),$("#jqxCalendar").on("change",function(b){a.add(b.args.date),$("#jqxCalendar").css("display","none")})},incrementYear:function(){var b,c=!0;a.dirty()===!0&&(c=confirm("You have unsaved data. Would you like to proceed (your changes will be lost)?")),c&&(b=a.year()+1,a.year(b),a.updateDatePicker(b))},decrementYear:function(){var b,c=!0;a.dirty()===!0&&(c=confirm("You have unsaved data. Would you like to proceed (your changes will be lost)?")),c&&(b=a.year()-1,a.year(b),a.updateDatePicker(b))},modifyDay:function(b,c){var d,e,f=Date.parse(b.month+"."+b.date()+"."+a.year()).addDays(c);d=f.getMonth()+1,e=f.getDate(),a.match(d,e)?alert("Whoops, we can't change this because "+f.toString("MMMM")+" "+e+" already exists."):(b.month=d,b.date(e),a.dirty(a.different()))},incrementDay:function(b){a.modifyDay(b,1)},decrementDay:function(b){a.modifyDay(b,-1)},getData:function(b){var c,d,e=[];b=b||a.year(),a.gettingData(!0),$.ajax({url:"/api/calendar/getyear",data:{year:b},dataType:"json",type:"post"}).done(function(f){var g,h=function(b){a.dirty(a.different())};if(a.originalHolidays.length=0,null!==f&&null!==f.dates)for(c=0,d=f.dates.length;c<d;c++)g={},f.dates[c].date=parseInt(f.dates[c].date,10),f.dates[c].month=parseInt(f.dates[c].month,10),g.month=f.dates[c].month,g.date=ko.observable(f.dates[c].date),g.comment=ko.observable(f.dates[c].comment),g.comment.subscribe(h),e.push(g),b===a.year()?a.originalHolidays.push({month:f.dates[c].month,date:f.dates[c].date,comment:f.dates[c].comment}):a.dirty(!0);a.holidays(e),a.getSeasonData()}).fail(function(b,c,d){alert(c+": "+d),a.gettingData(!1)})},updateSeasonData:function(b){var c,d,e,f;e=a,f={"Current Season":e.season()},e.gettingData(!0),d={success:function(a){e.gettingData(!1),"success"!==a.message?e.hasError(!0):(e.originalSeason=e.season(),e.dirty(!1))},fail:function(a,b,c){return e.gettingData(!1),e.hasError(!0),c}},c={url:"api/calendar/updateseason",type:"POST",dataType:"json",data:f},$.ajax(c).done(d.success).fail(d.fail)},getSeasonData:function(){var b,c,d;return d=a,d.gettingData(!0),c={success:function(b){return d.season(b["Current Season"]),d.originalSeason=d.season(),d.gettingData(!1),a.$calendarData.show(),b},fail:function(b,c,e){return d.gettingData(!1),d.hasError(!0),a.$calendarData.show(),e}},b={url:"api/calendar/getseason",type:"POST",dataType:"json"},$.ajax(b).done(c.success).fail(c.fail),b},changeSeason:function(b,c){return a.dirty(a.different()),!0},copyPreviousYear:function(b){a.getData(a.year()-1)},getDayOfWeek:function(b){return Date.parse(b.month+"."+b.date()+"."+a.year()).toString("dddd")},getMonth:function(b){return Date.parse(b.month+"."+b.date()+"."+a.year()).toString("MMMM")},different:function(){var b,c,d,e=!1,f=a.holidays().length,g=a.originalHolidays.length;for(g!==f&&(e=!0),c=0;c<f&&e===!1;c++){for(b=!1,d=0;d<g;d++)if(_.isEqual(a.originalHolidays[d],ko.toJS(a.holidays()[c]))){b=!0;break}b===!1&&(e=!0)}return a.season()!==a.originalSeason&&(e=!0),e},match:function(b,c){return ko.utils.arrayFirst(a.holidays(),function(a){return a.month===b&&a.date()===c})},add:function(b){var c={},d=b.getMonth()+1,e=b.getDate();a.match(d,e)?alert("Whoops, "+b.toString("MMMM")+" "+e+" already exists. Please select another date."):(c.month=d,c.date=ko.observable(e),c.comment=ko.observable("Description..."),a.holidays.push(c),a.dirty(a.different()))},"delete":function(b){a.holidays.remove(b),a.dirty(a.different())},save:function(b){$.ajax({url:"/api/calendar/newdate",data:{year:a.year(),dates:ko.toJS(a.holidays)},dataType:"json",type:"post"}).done(function(b){var c,d;if(void 0===b.err){if(a.originalHolidays.length=0,null!==b.dates)for(c=0,d=b.dates.length;c<d;c++)a.originalHolidays.push({month:b.dates[c].month,date:b.dates[c].date,comment:b.dates[c].comment});a.updateSeasonData(b)}})},cancel:function(){var b,c,d,e=[],f=function(b){a.dirty(a.different())};for(b=0,c=a.originalHolidays.length;b<c;b++)d={},d.month=a.originalHolidays[b].month,d.date=ko.observable(a.originalHolidays[b].date),d.comment=ko.observable(a.originalHolidays[b].comment),d.comment.subscribe(f),e.push(d);a.holidays(e),a.season(a.originalSeason),a.dirty(!1)},alertTest:function(a){alert(a)}};return a.year.subscribe(function(b){a.$calendarData=$("#calendar").find(".calendarData"),a.$calendarData.hide(),a.getData(),a.dirty(!1)}),a},controllerViewModel=function(){var a,b,c,d,e,f=this,g="Controller ID",h="Controller Name",i="/api/system/controllers",j="/api/system/updateControllers",k={},l=function(){f.dirty(!0)},m=function(a,b){var c=a[g],d=a[h],e=a.Description,f=a.isUser===!0||"true"===a.isUser||!1;this.isUser=f,this[g]=ko.observable(parseInt(c,10)),this[h]=ko.observable(d),this.Description=ko.observable(e),this[h].subscribe(l),this.Description.subscribe(l),this._idx=b},n=function(a){var b,c=a.length,d=[];for(b=0;b<c;b++)d.push(new m(a[b],b));f.sortByID(),f.controllers(d),f.dirty(!1)},o=function(){$.ajax({url:i}).done(function(b){a=b,n(b)})},p=function(a,b){var c=k[a];f.controllers.sort(function(d,e){var f=d[a](),g=e[a]();return b?(f=parseInt(f,10),g=parseInt(g,10)):(f=f.toLowerCase(),g=g.toLowerCase()),f>g?c:f<g?-1*c:0}),k[a]=-c},q=function(a){var b=a.charAt(0).toUpperCase()+a.substring(1);c.stop(!0).html(b).show(0).delay(2e3).fadeOut()};f.displayName="Controllers",f.dirty=ko.observable(!1),f.hasError=ko.observable(!1),f.controllerName=ko.observable(),f.controllerDesc=ko.observable(),f.controllers=ko.observableArray(),f.showEntryForm=ko.observable(!1),k[h]=-1,k[g]=-1,k.Description=-1,f.init=function(){b=$("#controllerGrid"),c=$("#controllerMessage"),d=$("#newControllerForm"),e=$("#newControllerName"),d.jqxValidator({animationDuration:0,rules:[{input:"#newControllerName",message:"Name is required",action:"blur",rule:"required"},{input:"#newControllerName",message:"Name must be at least 3 characters",action:"blur",rule:"length=3,255"}]}),o()},f.sortByID=function(){p(g,!0)},f.sortByName=function(){p(h)},f.sortByDescription=function(){p("Description")},f.showForm=function(){f.resetForm(),f.showEntryForm(!0),e.focus()},f.resetForm=function(){d.jqxValidator("hide"),f.controllerName(""),f.controllerDesc(""),f.showEntryForm(!1)},f.handleFormSubmit=function(a){var b,c,e,i,j,k=f.controllerName(),l=f.controllerDesc(),n=f.controllers(),o=n.length,p=!1,r=0,s={},t={},u=function(){f.dirty(!0),f.resetForm(),q('Added controller "'+k+'" with ID '+c)},v=function(){var a,b,c=!1;for(a=1;a<r&&!c;a++)t[a]!==!0&&(b=a,c=!0);return c||(b=r+1),b};if(b=d.jqxValidator("validate"),b===!0){for(j=0;j<o&&!p;j++)e=n[j],i=e[g](),t[i]=!0,i>r&&(r=i),""===e[h]()&&(c=i,e[h](k),e.Description(l),e.isUser=!1,p=!0);p===!1?o<255?(c=v(),s[h]=k,s.Description=l,s[g]=c,s.isUser=!1,e=new m(s,f.controllers().length),f.controllers.push(e),u()):q("No available controller slots"):u()}},f.deleteController=function(a,b){var c=a[g](),d=a[h](),e=a._idx,i=f.controllers(),j=i[e];j[h](""),q('Deleted controller "'+d+'" with ID '+c),f.dirty(!0)},f.save=function(){var b=ko.toJS(f.controllers()),c=[],d=function(){var a,d,e;for(a=0;a<b.length;a++)d=b[a],e={},e[g]=d[g],e[h]=d[h],e.Description=d.Description,e.isUser=d.isUser,d[h]&&c.push(e)};d(),$.ajax({url:j,data:{Entries:c},dataType:"json",type:"post"}).done(function(b){f.dirty(!1),a=c,q("Save controllers: "+b.message)})},f.cancel=function(){n(a)}},controlPriorityTextViewModel=function(){var a,b=this,c="/api/system/controlpriorities",d="/api/system/updateControlPriorities",e="Priority Level",f="Priority Text",g=function(){b.dirty(!0)},h=function(a){var b=a[e],c=a[f];this[e]=ko.observable(b),this[f]=ko.observable(c),this[e].subscribe(g),this[f].subscribe(g)},i=function(c){var d,e=c.length,f=[];for(d=0;d<e;d++)f.push(new h(a[d]));b.controlPriorities(f)};b.displayName="Control Priority Text",b.dirty=ko.observable(!1),b.hasError=ko.observable(!1),b.controlPriorities=ko.observableArray(),b.getData=function(){$.ajax({url:c}).done(function(b){a=b,i(b)})},b.save=function(){var a=ko.toJS(b.controlPriorities());$.ajax({url:d,data:{Entries:a},dataType:"json",type:"post"}).done(function(a){b.dirty(!1)}),b.dirty(!1)},b.cancel=function(){i(a),b.dirty(!1)}},qualityCodesViewModel=function(){var a,b=this,c="Quality Code Label",d="Quality Code",e="Quality Code Font HTML Color",f="/api/system/qualityCodes",g="/api/system/updateQualityCodes",h=function(){b.dirty(!0)},i=function(a){var b=a[c],f=a[d],g=a[e];this[c]=ko.observable(b),this[d]=ko.observable(f),this[e]=ko.observable(g),this[e].subscribe(h),this[d].subscribe(h)},j=function(a){var c,d=a.Entries||[],e=d.length,f=a["Quality Code Enable"],g=[];for(c=0;c<e;c++)g.push(new i(d[c]));b.qualityCodes(g),b.covDisabled(0!==f["COV Enable"]),b.alarmsOff(0!==f["Alarms Off"]),b.overriden(0!==f.Override),b.commandPending(0!==f["Command Pending"]),b.dirty(!1)};b.displayName="Quality Codes",b.dirty=ko.observable(!1),b.hasError=ko.observable(!1),b.qualityCodes=ko.observableArray(),b.covDisabled=ko.observable(!0),b.alarmsOff=ko.observable(!1),b.overriden=ko.observable(!0),b.commandPending=ko.observable(!1),b.covDisabled.subscribe(h),b.alarmsOff.subscribe(h),b.overriden.subscribe(h),b.commandPending.subscribe(h),b.getData=function(){$.ajax({url:f}).done(function(b){a=b,j(b)})},b.save=function(){var a,c=ko.toJS(b.qualityCodes());a={Override:b.overriden()?1:0,"COV Enable":b.covDisabled()?1:0,"Alarms Off":b.alarmsOff()?1:0,"Command Pending":b.commandPending()?1:0},$.ajax({url:g,data:{Entries:c,"Quality Code Enable":a},dataType:"json",type:"post"}).done(function(a){b.dirty(!1)})},b.cancel=function(){j(a),b.dirty(!1)}},customColorCodesViewModel=function(){var a,b=this,c=function(){b.dirty(!0)},d=function(a,b){this.hexColor=ko.observable(b),this.hexColor.subscribe(c)},e=function(a,b){var c,d=a.length;for(rawHexColor=[],c=0;c<d;c++)rawHexColor.push(a[c].hexColor());$.ajax({url:b,type:"POST",dataType:"json",success:function(a){},data:{colorsArray:rawHexColor}})},f=function(c){var e,f=c.length,g=[];for(a&&0!==a.length||(a=c),e=0;e<f;e++)g.push(new d(e,c[e]));b.customColorCodes(g),b.dirty(!1)};b.init=function(){$.getJSON("/api/system/getCustomColors",f)},b.cancel=function(){f(a)},b.save=function(){e(b.customColorCodes(),"/api/system/updateCustomColors"),b.dirty(!1)},b.displayName="Custom Color Codes",b.hasError=ko.observable(!1),b.dirty=ko.observable(!1),b.customColorCodes=ko.observableArray()},telemetryViewModel=function(){var a,b,c=this,d={},e="/api/system/telemetry",f="/api/system/updateTelemetry",g=window.opener.workspaceManager.config.Enums["Time Zones"],h=[{name:"Public IP",validation:{ipAddress:!0}},{name:"IP Network Segment",validation:{required:!0,number:!0}},{name:"IP Port",validation:{required:!0,number:!0,min:47808,max:47823}},{name:"APDU Timeout",validation:{required:!0,number:!0}},{name:"APDU Retries",validation:{required:!0,number:!0}},{name:"Time Zone",validation:{required:!0}}],i=function(){c.dirty(!0)},j=function(){i(),c.hasError(b().length>0)},k=function(){var a,d,e,f,g=h.length;for(a=0;a<g;a++)d=h[a],e=d.name,f=d.validation,c[e]=ko.observable(),c[e].subscribe(i),f&&(c[e].extend(f),c[e].subscribe(j));b=ko.validation.group(c)},l=function(){var a,b,e=h.length,f={};for(a=0;a<e;a++)b=h[a].name,f[b]=c[b]();return f.ipPortChanged=c["IP Port"]()!==d["IP Port"],f.originalValues=d,console.log(f),f},m=function(){var b,e,f,g,i=h.length;for(b=0;b<i;b++)e=h[b],f=e.name,g=a[f],c[f](g),"Time Zone"===f&&c.selectedTimeZoneText(o(g)),d[f]=c[f]().toString(),c.dirty(!1)},n=function(){var b,e,f,g,i=h.length;for(b=0;b<i;b++)e=h[b],f=e.name,g=a[f],d[f]=c[f]().toString(),c.dirty(!1);console.log("updatedata originalValues",d)},o=function(a){for(var b in g)if(g[b]["enum"]===a)return b;return""};c.displayName="Telemetry",c.dirty=ko.observable(!1),c.hasError=ko.observable(!1),c.selectedTimeZone=ko.observable(""),c.selectedTimeZoneText=ko.observable(""),k(),c.init=function(){c.getData()},c.getData=function(){$.ajax({url:e}).done(function(b){a=b,m()})},c.getTZText=function(){return"Central"},c.timeZones=function(){var a=[];for(var b in g)a.push({name:b,value:g[b]["enum"]});return a},c.save=function(){var a,d=b(),e=d.length;0===e?(a=l(),c.hasError(!1),$.ajax({url:f,data:a,dataType:"json",type:"post"}).done(function(a){n()})):(c.dirty(!0),c.hasError(!0))},c.cancel=function(){m()},c.changeTimezone=function(a){for(var b in g)g[b]["enum"]===c.selectedTimeZone()&&(c["Time Zone"](c.selectedTimeZone()),c.selectedTimeZoneText(b),c.dirty(!0))}},backupViewModel=function(){var a=this,b=window.opener&&window.opener.workspaceManager.socket();a.displayName="Backup",a.backupMsg=ko.observable(""),a.showBackupMsg=ko.observable(!1),a.dirty=ko.observable(!1),a.hasError=ko.observable(!1),a.init=function(){},a.startBackup=function(){b.emit("fieldCommand",ko.toJSON({"Command Type":14}))},b.on("returnFromField",function(b){b.err?a.backupMsg("Error: "+b.err):a.backupMsg(b),a.showBackupMsg(!0)})},versionsViewModel=function(){var a=this;a.displayName="Versions",a.dirty=ko.observable(!1),a.hasError=ko.observable(!1),a.processVer=ko.observable(""),a.ijsVer=ko.observable(""),a.getData=function(){$.ajax({url:"/api/system/versions"}).done(function(b){b.err?(console.log(b),alert("There was an error getting versions.")):(a.ijsVer(b.infoscanjs),a.processVer(b.Processes))})},a.init=function(){a.getData()}},alarmMessageViewModel=function(){var a,b,c,d,e,f,g,h,i,j,k=this,l=window.opener.workspaceManager.config.Enums["Alarm Categories"],m=window.opener.workspaceManager.config.Enums["Alarm Types"],n="/api/system/getAlarmTemplates",o="/api/system/updateAlarmTemplate",p="/api/system/deleteAlarmTemplate",q=function(a,b){b===!0?a.hide():a.show(),a.attr("disabled",b)},r=function(a){return a.replace(/#/g,"")},s=function(a){var b;return b=j.filter(function(b){return b.renderedIndex===a}),b[0]},t=function(a,b){for(var c in a)if(a.hasOwnProperty(c)&&a[c]["enum"]===parseInt(b,10))return c;return"System Message"},u=function(){var a=[];return a.push({columnKey:"_id",columnName:"ID",width:2,sortable:!1,display:!1}),a.push({columnKey:"msgEditLevel",columnName:"",width:15,sortable:!1,display:!0}),a.push({columnKey:"msgCat",columnName:"Category",width:55,sortable:!0,display:!0}),a.push({columnKey:"msgType",columnName:"Type",width:175,sortable:!0,display:!0}),a.push({columnKey:"msgName",columnName:"Name",width:200,sortable:!0,display:!0}),a.push({columnKey:"msgFormat",columnName:"Definition",width:350,sortable:!0,display:!0}),a.push({columnKey:"msgTextColor",columnName:"Text Color",sortable:!1,display:!1}),a.push({columnKey:"msgBackColor",columnName:"Background Color",sortable:!1,display:!1}),a.push({columnKey:"isSystemMessage",columnName:"System",width:45,sortable:!0,display:!0}),a},v=function(a,b,c){var d,e="<div class='btn-group' title='Clone'><button type='button' data-bind='click:function() { $parent.clone($parent.$index);}' class='btn btn-xs cloneTemplate'><span class='fa fa-clipboard'></span></button></div>",f="<div class='btn-group' title='Delete'><button type='button' data-bind='click:function() { $parent.delete($parent.$index);}' class='btn btn-xs deleteTemplate'><span class='fa fa-trash'></span></button></div>",h=[],j=0,k=function(a,b,c,d){switch(b.columnKey){case"msgFormat":$(a).css("background-color",c.msgBackColor.Value),$(a).css("color",c.msgTextColor.Value);break;case"msgEditLevel":var g=c[b.columnKey].rawValue,h="";switch(g){case 0:h="";break;case 1:h=e;break;case 2:h=f+e;break;default:h=""}$(a).html(h)}},l=function(a,b){var c,d=a.columnName,e=a.sortable;return c={title:d,data:a.columnKey,width:a.width?a.width:"auto",render:{_:"Value"},fnCreatedCell:function(a,b,c,d,e){k(a,s(e),c,e)},bSortable:e}};for(d=0;d<c.length;d++)delete c[d].renderedIndex,c[d].display&&(c[d].renderedIndex=j++,h.push(l(c[d],d)));h.length>0&&g.DataTable({data:i,columns:h,headerCallback:function(a,b,c,e,f){for(d=0;d<h.length;d++)$(a).find("th").eq(d).css("background-color","rgb(234, 234, 234)"),$(a).find("th").eq(d).addClass("strong")},order:[[1,"asc"]],scrollY:!0,scrollX:!0,scrollCollapse:!0,lengthChange:!0,lengthMenu:[[10,18,30,50,75,100,-1],[10,18,30,50,75,100,"All"]],pageLength:100})},w=function(){k.activeDataRequest(!1),i&&(q(f,!1),g.DataTable().clear(),g.DataTable().rows.add(i),g.DataTable().draw())},x=function(a,b){var c,d=0;return d="Event"===t(l,a.msgCat)?0:a.isSystemMessage?1:2,c="object"!=typeof a._id?{_id:{Value:a._id,rawValue:a._id},msgEditLevel:{Value:"",rawValue:d},msgCat:{Value:t(l,a.msgCat),rawValue:a.msgCat},msgType:{Value:t(m,a.msgType),rawValue:a.msgType},msgName:{Value:a.msgName,rawValue:a.msgName},msgFormat:{Value:a.msgFormat,rawValue:a.msgFormat},msgTextColor:{Value:"#"+a.msgTextColor,rawValue:a.msgTextColor},msgBackColor:{Value:"#"+a.msgBackColor,rawValue:a.msgBackColor},isSystemMessage:{Value:a.isSystemMessage?"Yes":"No",rawValue:a.isSystemMessage}}:$.extend(!0,{},a),b&&(c._id=null,c.isSystemMessage={Value:"No",rawValue:!1}),c},y=function(a){var b;for(i=[],b=0;b<a.length;b++)i.push(x(a[b],!1));i.length>0&&(k.alarmTemplate(i[0]),k.alarmTemplateBackgroundColor(r(k.alarmTemplate().msgBackColor.Value)),k.alarmTemplateTextColor(r(k.alarmTemplate().msgTextColor.Value))),k.alarmTemplates(i),w()},z=function(){k.activeDataRequest(!0),$.ajax({url:n}).done(function(a){y(a)})},A=function(a){var b=a.charAt(0).toUpperCase()+a.substring(1);console.log("save message = "+b)},B=function(a){k.alarmTemplate(x(a,!1)),d.modal("show")};k.displayName="Alarm Messages",k.hasError=ko.observable(!1),k.activeDataRequest=ko.observable(!0),k.alarmTemplate=ko.observable(""),k.alarmTemplateBackgroundColor=ko.observable(),k.alarmTemplateTextColor=ko.observable(),k.alarmTemplateName=ko.observable(),k.alarmTemplateDesc=ko.observable(),k.alarmTemplates=ko.observableArray(),k.alarmTemplateTokens=ko.observableArray([{code:"AV",name:"Alarm Value",description:"Include point name in alarm message"},{code:"NAME",name:"Point Name",description:"Include point name in alarm message"},{code:"PE",name:"Program Error",description:"Include point name in alarm message"},{code:"PV",name:"Point Value",description:"Include point name in alarm message"},{code:"RC",name:"Reliability Value",description:"Include point name in alarm message"},{code:"UT",name:"Units Value",description:"Include point name in alarm message"}]),k.showEntryForm=ko.observable(!1),k.init=function(){j=u(),k.alarmTemplateBackgroundColor.subscribe(function(a){h.css("background-color","#"+a)}),k.alarmTemplateTextColor.subscribe(function(a){h.css("color","#"+a)}),e=$("#alarmTemplateContainer"),f=e.find(".alarmMessagesData"),g=e.find(".dataTablePlaceHolder"),a=e.find(".sysprefAlarmTemplateModel"),d=e.find(".alarmTemplateDeleteConfirm"),h=e.find(".msgFormat"),a.modal("hide"),d.modal("hide"),q(f,!0),v(!0,!0,j),g.find("tbody").on("click","tr",function(a){k.alarmTemplate(g.DataTable().row(this).data()),k.displayPopupEditor()}),g.find("tbody").on("click",".cloneTemplate",function(a){a.preventDefault(),a.stopPropagation(),k.clone(g.DataTable().row($(this).parent().parent().parent()).data())}),g.find("tbody").on("click",".deleteTemplate",function(a){a.preventDefault(),a.stopPropagation(),B(g.DataTable().row($(this).parent().parent().parent()).data())}),g.on("draw.dt",function(a,b){var c,d,f,h=g.DataTable().page.info().pages;c=e.find(".dataTables_paginate"),d=c.find("ul.pagination"),f=d.find(".paginate_button"),f=f.not("li.active"),1===h?(c.hide(),f.hide()):(c.show(),f.show())}),z()},k.save=function(){var b=$.extend(!0,{},k.alarmTemplate()),c={},d=function(){var a;b.msgTextColor.rawValue=r(k.alarmTemplateTextColor()),b.msgBackColor.rawValue=r(k.alarmTemplateBackgroundColor()),b.msgName.rawValue=e.find(".msgName").val(),b.isSystemMessage.rawValue?b.msgFormat.rawValue=e.find(".msgFormat").text():b.msgFormat.rawValue=e.find(".msgFormat").val(),b.msgFormat.rawValue=b.msgFormat.rawValue.replace(/\r?\n|\r/g,"");for(a in b)b.hasOwnProperty(a)&&(b[a]=b[a]?b[a].rawValue:null,delete b.msgEditLevel)};d(),null===b._id?c.newObject=b:c.updatedObject=b,$.ajax({url:o,data:c,dataType:"json",type:"post"}).done(function(a){A("Save alarmTemplate: "+a.message),z()}),a.modal("hide")},k.displayPopupEditor=function(){var d={};k.alarmTemplateBackgroundColor(r(k.alarmTemplate().msgBackColor.Value)),k.alarmTemplateTextColor(r(k.alarmTemplate().msgTextColor.Value)),a.modal("show"),h=e.find(".msgFormat"),h.css("background-color","#"+k.alarmTemplateBackgroundColor()),h.css("color","#"+k.alarmTemplateTextColor()),b=a.find(".alarmTokens"),c=b.find(".alarmToken"),k.alarmTemplate().isSystemMessage.rawValue||($(c).dblclick(function(){var a=$(this).find(".alarmTokenCode").text();$(h).val($(h).val()+a)}),$(c).draggable({cursor:"move",helper:"clone",start:function(a,b){d.tr=this,d.helper=b.helper}}),$(h).droppable({drop:function(a,b){var c=b.draggable.find(".alarmTokenCode").text();$(this).val($(this).val()+c)}}))},k.deleteAlarmTemplate=function(){var a={},b=$.extend(!0,{},k.alarmTemplate());a.deleteObject={},a.deleteObject._id=b._id.rawValue,$.ajax({url:p,data:a,dataType:"json",type:"post"}).done(function(a){A("Delete alarmTemplate: "+a.message),z()}),d.modal("hide")},k.clone=function(a){k.alarmTemplate(x(a,!0)),k.displayPopupEditor()}},weatherViewModel=function(){var a,b=this,c="/api/system/weather",d="/api/system/updateWeather",e=window.opener&&window.opener.workspaceManager,f=e&&window.opener.workspaceManager.openWindowPositioned,g=e&&e.config.Enums["Point Statuses"].Active["enum"],h=function(a){var b,c=function(b,c,d){b&&a(b,c,d)},d=function(){b.pointLookup.MODE="select",b.pointLookup.init(c)};b=f("/pointLookup","Select Point","","","Select Weather Point",{callback:d,width:1e3})},i=function(a){var c=[];if(Array.isArray(a))a.forEach(function(a){c.push({title:a.title,point:ko.observable(a.point)})});else for(var d in a)c.push({title:d,point:ko.observable(a[d])});b.weatherPoints(c),b.dirty(!1)},j=function(){$.ajax({url:c}).done(function(b){a=b,i(b)})},k=function(){var a={};return b.weatherPoints().forEach(function(b){var c=b.point(),d=c&&c._id||null;a[b.title]=d}),a},l=function(){var c=ko.toJS(b.weatherPoints);$.ajax({url:d,data:k(),dataType:"json",type:"post"}).done(function(d){var e;console.log(d),d.message&&"success"===d.message?(a=c,b.dirty(!1)):(e=d.err||"Unknown error.",alert("We couldn't save the weather section for the following reason: "+e))})};b.displayName="Weather",b.dirty=ko.observable(!1),b.hasError=ko.observable(!1),b.weatherPoints=ko.observableArray([]),b.init=function(){j()},b.save=function(){l()},b.cancel=function(){i(a)},b.removePointRef=function(a){a.point(null),b.dirty(!0)},b.editPointRef=function(a){h(function(c,d,e){a.point({_id:c,_pStatus:g,Name:d,"Point Type":{Value:e}}),b.dirty(!0)})},b.openPointRef=function(a){var b=a.point(),c=b._id,d=b["Point Type"].Value,g=e&&e.config.Utility.pointTypes,h=g.getUIEndpoint(d,c),i={width:850,height:600};f(h.review.url,b.Name,d,h.review.target,c,i)}},notificationsViewModel=function(){var a=window.location.protocol+"//"+window.location.host,b=a+"/api/security/",c=0,d=$("#scheduleCalendar"),e=function(){return c++,"nid_"+c},f={displayName:"Notifications",dirty:ko.observable(!1),hasError:ko.observable(!1),$modal:$("#notificationsEditMemberModal"),iconLookup:{SMS:"comment",Email:"envelope-o",Voice:"phone"},alertTypeLookup:{SMS:"text",Email:"email",Voice:"call"},templates:{schedule:{holidays:!1,days:[],allDay:!1,startTime:null,endTime:null},scheduleLayer:{alertConfigs:[],schedules:[]},notificationOptions:{Emergency:!1,Critical:!1,Urgent:!1,notifyOnAck:!1},alertNotification:{Value:null,Type:null,delay:1},alertConfig:{id:0,isOnCall:!1,name:"",groups:[],rotateConfig:{}},group:{active:!1,alertDelay:1,id:0,name:"",repeatConfig:{},escalations:[]},escalation:{alertStyle:"Everyone Sequenced",escalationDelay:5,id:0,memberAlertDelay:5,members:[],repeatConfig:{},rotateConfig:{}},repeatConfig:{enabled:!1,repeatCount:0,repeatDelay:5},rotateConfig:{day:"Monday",enabled:!1,scale:1,time:800},member:{firstName:"",id:0,lastName:"",securityGroup:""},policy:{_id:1,_new:!0,name:"",members:[],memberGroups:[],enabled:!0,_currAlertID:1,_currGroupID:1,_currEscalationID:1,alertConfigs:[],scheduleLayers:[],threads:[]}},forEachArray:function(a,b){var c,d=a||[],e=d.length,f=!0;for(c=0;c<e&&f;c++)f=b(d[c],c),void 0===f&&(f=!0);return f},getTemplate:function(a){var b,c,d=$.extend(!0,{},f.templates[a]),e=["repeatConfig","rotateConfig"],g={alertConfig:"_currAlertID",group:"_currGroupID",escalation:"_currEscalationID"};return e.forEach(function(a){d.hasOwnProperty(a)&&(d[a]=f.getTemplate(a))}),g[a]&&(c=f.bindings.currPolicy[g[a]],b=c()+1,c(b),d.id=b),d},policies:[]},g=function(a,b){var c={id:a._id,firstName:a["First Name"].Value,lastName:a["Last Name"].Value,contactInfo:a["Contact Info"].Value,securityGroup:null,alerts:a.alerts,notificationsEnabled:a.notificationsEnabled,notificationOptions:a.notificationOptions||f.getTemplate("notificationOptions")},d=function(b,c){var d;void 0===b.delay&&(b.delay=0===c?0:1),void 0===b.name&&(d=f.getContact(b,a["Contact Info"].Value),b.Name=d.Name)};for(var e in a.alerts)f.forEachArray(a.alerts[e],d);return c};return f.init=function(a){var b=[{data:"firstName()",title:"First Name",className:"firstName",render:function(a,b,c,d){return'<a href="#">'+a+"</a>"}},{data:"lastName()",title:"Last Name",className:"lastName"},{data:"securityGroup()",title:"Member By Way Of Security Group",className:"securityGroup"}],c=function(){var a=f.bindings.currPolicy.members,c=$("#memberList");f.memberDT=c.DataTable({columns:b,paging:!1,searching:!1,bInfo:!1}),$.fn.DataTable.isDataTable(c)?c.DataTable().destroy():f.memberDT=c.DataTable({columns:b,paging:!1,searching:!1,bInfo:!1}),c.on("click",".firstName",function(a){var b=f.memberDT.cell(this).index().row,c=f.memberDT.rows(b).data()[0];f.editMember(c),a.preventDefault()}),a.subscribe(function(a){f.memberDT.clear(),f.memberDT.rows.add(a),f.memberDT.draw()})};c(),f.$tabs=$(".notificationsContent").on("click",".nav a",function(a){a.preventDefault(),$(this).tab("show"),$(this).attr("href").toLowerCase().match("schedule")&&(d.fullCalendar("render"),f.updateScheduleEvents())}),d.fullCalendar({schedulerLicenseKey:"0890776600-fcs-1460400855",eventClick:function(a,b,c){console.log(a),b.preventDefault()},header:{left:"",center:"",right:""},allDaySlot:!1,defaultDate:moment().format("YYYY-MM-DD"),defaultView:"agendaDay",editable:!1,eventLimit:!1,height:575,resources:[{id:"sun",title:"Sunday"},{id:"mon",title:"Monday"},{id:"tues",title:"Tuesday"},{id:"wed",title:"Wednesday"},{id:"thur",title:"Thursday"},{id:"fri",title:"Friday"},{id:"sat",title:"Saturday"},{id:"Holidays",title:"Holidays"}],events:[{id:1,resourceId:"Sunday",start:"2016-01-12T08:00:00",end:"2016-01-12T17:00:00"},{id:2,resourceId:"Monday",start:"2016-01-12T08:00:00",end:"2016-01-12T17:00:00"},{id:3,resourceId:"Holidays",start:"2016-01-12T08:00:00",end:"2016-01-12T17:00:00"}],slotDuration:"01:00:00",slotLabelInterval:"02:00:00"}),a?f.buildPolicies(f._rawPolicies):$.getJSON("/api/policies/get").done(function(a){f._rawPolicies=a,f.buildPolicies(a)})},f.updateScheduleEvents=function(){var a=["#FDA46E","#8666FB"],b=moment().format("YYYY-MM-DDT"),c=moment().add(1,"d").format("YYYY-MM-DDT"),g=[],h=function(a){var b=a/100,c=a%100;return("0"+b).slice(-2)+":"+("0"+c).slice(-2)+":00"},i=function(a,d,g){var i=b+h(a.startTime||0),j=h(a.endTime||0),k=[],l=!1;return a.allDay?(i=b+h(0),j=c+h(0)):(j=0===a.endTime||null===a.endTime?c+j:b+j,void 0!==a.endTime&&void 0!==a.startTime&&a.startTime>a.endTime&&(l=!0)),f.forEachArray(a.days,function(f){l?(0!==a.endTime&&k.push({id:e(),start:b+h(0),end:j,resourceId:f,backgroundColor:d,borderColor:"#666666",title:g}),k.push({id:e(),start:i,end:c+h(0),resourceId:f,backgroundColor:d,borderColor:"#666666",title:g})):k.push({id:e(),start:i,end:j,resourceId:f,backgroundColor:d,borderColor:"#666666",title:g})}),k};f.forEachArray(f.bindings.currPolicy.scheduleLayers(),function(b,c){f.forEachArray(ko.toJS(b.schedules),function(b){g=g.concat(i(b,a[c%2],"Layer "+(c+1)))})}),d.fullCalendar("removeEvents"),d.fullCalendar("addEventSource",g)},f.translateMember=function(a){return f.userLookup[a]},f.translateMembers=function(a){var b,c=a.length,d=[];for(b=0;b<c;b++)d.push(f.translateMember(a[b]));return d},f.unTranslateMembers=function(a){var b=ko.toJS(a);return f.forEachArray(b.members,function(a,c){b.members[c]=a.id}),b},f.buildPolicy=function(a){a.members=f.translateMembers(a.members),f.forEachArray(a.alertConfigs,function(a){var b=[];a.groups=a.groups||[],f.forEachArray(a.groups,function(a){a.escalations=a.escalations||[],f.forEachArray(a.escalations,function(a){a.members=a.members||[]}),a.active?b.unshift(a):b.push(a)}),a.groups=b})},f.buildPolicies=function(a){var b,c=a.length;for(f.bindings.policyList.removeAll(),b=0;b<c;b++)f.buildPolicy(a[b]),f.bindings.policyList.push(ko.viewmodel.fromModel(a[b]))},f.prepPolicyForSave=function(a){f.forEachArray(a.alertConfigs,function(a){var b=!1;f.forEachArray(a.groups,function(a,c){a.active&&(b=!0)}),!b&&a.groups.length>0&&(a.groups[0].active=!0)})},f.cancel=function(){f.dirty(!1),f.bindings.home(),f.init(!0)},f.save=function(){f.forEachArray(f.bindings.policyList(),function(a,b){var c=f.unTranslateMembers(a);f.prepPolicyForSave(c),$.ajax({url:"/api/policies/save",data:JSON.stringify(c),type:"POST",dataType:"json",contentType:"application/json"}).done(function(b){a._new&&a._new()===!0&&(delete a._new,a._id()===f.bindings.currPolicy._id()&&f.bindings.currPolicy._id(b.id),a._id(b.id)),console.log("Saved policy",a.name());
})}),f.dirty(!1)},f.clearEdits=function(a){var b;for(b in f.bindings)b.match("isEditing")&&("isEditingPolicy"!==b||a)&&f.bindings[b](!1)},f.editMember=function(a){f._originalMember=ko.toJS(a),f.bindings.currMember(a),f.bindings.isEditingMember(!0)},f.editMembers=function(a,b){var c,d,e=b.length,g=a.length,h=!1;for(c=0;c<g;c++)for(a[c].selected=!1,h=!1,d=0;d<e&&!h;d++)a[c].id===b[d].id&&(a[c].selected=!0,h=!0);f.bindings.primaryMemberList(a),f.bindings.chosenMembers(b),f.$modal.modal("show")},f.updateAlertConfigMembers=function(){var a=ko.toJS(f.bindings.primaryMemberList()),b=[];a.forEach(function(a){a.selected&&b.push(a.id)}),ko.viewmodel.updateFromModel(f._currEscalation.members,b)},f.updatePolicyMembers=function(){var a=ko.toJS(f.bindings.primaryMemberList()),b=[];a.forEach(function(a){a.selected&&b.push(a)}),ko.viewmodel.updateFromModel(f.bindings.currPolicy.members,b),f.forEachArray(f.bindings.policyList(),function(a){a._id()===f.bindings.currPolicy._id()&&a.members(b)})},f.getContact=function(a,b){var c,d,e=ko.toJS(a),g=e.Value,h=e.Type,i=e.Name;return f.forEachArray(b||f.bindings.currMember().contactInfo(),function(a){var b=ko.toJS(a);return i&&b.Name===i?(c=a,!1):void(b.Value===g&&b.Type===h&&(d=a))}),c||d},f.savePolicy=function(){f.forEachArray(f.bindings.policyList(),function(a,b){a._id()===f.bindings.currPolicy._id()&&ko.viewmodel.updateFromModel(f.bindings.policyList()[b],ko.toJS(f.bindings.currPolicy))}),f.dirty(!0)},f.saveUser=function(a){var b=this,c={userid:a.id,"Update Data":{alerts:a.alerts,notificationOptions:a.notificationOptions,notificationsEnabled:a.notificationsEnabled}},d=function(a,c,d){d[c]=ko.toJS(b.getContact(a)),d[c].delay=a.delay};for(var e in a.alerts)a.alerts[e].forEach(d);$.ajax({url:"/api/security/users/updateuser",type:"post",dataType:"json",contentType:"application/json",data:JSON.stringify(c),success:function(a){a.err?console.log("Error saving user",a.err):console.log("Saved user")}})},f.checkAlertConfigNames=function(a,b,c){var d=!1;return f.forEachArray(c,function(c){if(c.name()===b&&void 0!==a&&a!==c.id())return d=!0,!1}),d&&$.toast({heading:"Error",text:"Duplicate Alert Config Name",position:"top-center",stack:!1}),d},f.bindings={currPolicy:ko.viewmodel.fromModel(f.templates.policy),currAlertConfig:ko.observable(),policyList:ko.observableArray(),alertStyles:[{text:"First Responder Only",value:"FirstResponder"},{text:"Everyone Sequenced",value:"Sequenced"},{text:"Everyone at the same time",value:"Everyone"}],days:["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],shortDays:["mon","tues","wed","thur","fri","sat","sun"],isEditingNewPolicy:ko.observable(!1),isEditingNewConfiguration:ko.observable(!1),isEditingPolicy:ko.observable(!1),isEditingPolicyName:ko.observable(!1),isEditingPolicyEnabled:ko.observable(!1),isEditingAlertConfig:ko.observable(!1),isEditingMember:ko.observable(!1),isEditingAlertNotifications:ko.observable(!1),isEditingSchedule:ko.observable(!1),newPolicyName:ko.observable(),newConfigurationName:ko.observable(),currPolicyName:ko.observable(),currPolicyEnabled:ko.observable(),currMember:ko.observable(),primaryMemberList:ko.observableArray(),chosenMembers:ko.observableArray(),dayMonday:ko.observable(!1),dayTuesday:ko.observable(!1),dayWednesday:ko.observable(!1),dayThursday:ko.observable(!1),dayFriday:ko.observable(!1),daySaturday:ko.observable(!1),daySunday:ko.observable(!1),dayHolidays:ko.observable(!1),savePolicy:function(){f.savePolicy()},updateScheduleEvents:function(){return f.updateScheduleEvents(),!0},editDays:function(a){f.forEachArray(f.bindings.days,function(a,b){f.bindings["day"+a](!1)}),f.forEachArray(a.days(),function(a){var b=f.bindings.shortDays.indexOf(a);b!==-1&&f.bindings["day"+f.bindings.days[b]](!0)}),f.bindings.dayHolidays(a.holidays()),f._currSchedule=a,$("#notificationsEditDaysModal").modal("show")},updateDays:function(){var a=[];f.forEachArray(f.bindings.days,function(b,c){f.bindings["day"+b]()&&a.push(f.bindings.shortDays[c])}),f._currSchedule.holidays(f.bindings.dayHolidays()),f.bindings.dayHolidays()&&a.push("Holidays"),f._currSchedule.days(a),$("#notificationsEditDaysModal").modal("hide"),f.updateScheduleEvents()},getAlertStyleText:function(a){var b;return f.forEachArray(f.bindings.alertStyles,function(c){c.value===a&&(b=c.text)}),b},getUserName:function(a){var b=f.translateMember(a);return b.firstName+" "+b.lastName},addAlertConfig:function(a){a.$parent.alertConfigs.push(a.$data.id())},deleteAlertConfig:function(a){f.bindings.currPolicy.alertConfigs.remove(function(b){return b.id()===a.id()}),f.savePolicy(),f.dirty(!0)},convertTime:function(a){var b=a(),c=b/100,d=c>=12?"PM":"AM";return c>12&&(c-=12),0===c&&(c=12),c+" "+d},convertDate:function(a){var b=a().join(";"),c=[],d="mon;tues;wed;thur;fri",e="sat;sun";return b.match(d)&&(c.push("Weekdays"),b=b.replace(d,"")),b.match(e)&&(c.push("Weekends"),b=b.replace(e,"")),b.match("Holidays")&&(c.push("Holidays"),b=b.replace("Holidays","")),b.length>0?c=c.concat(b.split(";")):0===c.length&&c.push("None"),c=c.filter(function(a,b,c){return""!==a}),c.forEach(function(a,b,c){c[b]=a.charAt(0).toUpperCase()+a.slice(1)}),c.join(",")},deleteSchedule:function(a){var b=a.$index(),c=a.$parentContext.$index();f.bindings.currPolicy.scheduleLayers()[c].schedules.splice(b,1),f.dirty(!0),f.updateScheduleEvents()},addSchedule:function(a){a.schedules.push(ko.viewmodel.fromModel(f.getTemplate("schedule"))),f.updateScheduleEvents()},addScheduleLayer:function(){f.bindings.currPolicy.scheduleLayers.push(ko.viewmodel.fromModel(f.getTemplate("scheduleLayer"))),f.updateScheduleEvents()},deleteScheduleLayer:function(a,b){a.scheduleLayers.splice(b(),1),f.dirty(!0),f.updateScheduleEvents()},editSchedule:function(){f.bindings.isEditingSchedule(!0)},cancelEditSchedule:function(){ko.viewmodel.updateFromModel(f.bindings.currPolicy.scheduleLayers,f._currPolicy.scheduleLayers),f.bindings.isEditingSchedule(!1),f.updateScheduleEvents()},saveSchedule:function(){f._currPolicy=ko.toJS(f.bindings.currPolicy),f.bindings.isEditingSchedule(!1),f.savePolicy()},editAlertConfigMembers:function(a){f.memberCb=f.updateAlertConfigMembers,f._currEscalation=a,f.editMembers(ko.toJS(f.bindings.currPolicy.members()),f.translateMembers(a.members()))},editPolicyMembers:function(){f.memberCb=f.updatePolicyMembers,f.editMembers(f.users,ko.toJS(f.bindings.currPolicy.members()))},getAlertIcon:function(a){var b;return b=a.Name?f.getContact({Name:a.Name()}):f.getContact(ko.toJS(a)),"fa-"+f.iconLookup[b&&b.Type()]},getAlertType:function(a,b,c){var d=f.getContact({Value:a(),Name:c()});return d&&d.Type},addNewAlert:function(a){var b=f.getTemplate("alertNotification"),c=f.bindings.currMember().contactInfo()[0],d=f.bindings.currMember().alerts[a.name];b.Value=c.Value(),b.Type=c.Type(),b.Name=c.Name(),0===d().length&&(b.delay=0),f.bindings.currMember().alerts[a.name].push(ko.viewmodel.fromModel(b))},deleteAlert:function(a,b){var c,d=b();a.alerts.splice(d,1),0===d&&(c=a.alerts()[0],c&&c.delay(0))},getContactString:function(a){var b=f.alertTypeLookup[a.Type()],c=a.Value(),d=a.Name&&a.Name();return[b,d,"at",c].join(" ")},getContactAlertString:function(a){var b=f.getContact(a);return f.bindings.getContactString(b)},editAlertNotifications:function(){f.bindings.isEditingAlertNotifications(!0)},cancelEditAlertNotifications:function(){f.bindings.currMember(ko.viewmodel.fromModel(f._originalMember)),f.bindings.isEditingAlertNotifications(!1),ko.viewmodel.updateFromModel(f.bindings.currMember().alerts,f._originalMember.alerts)},saveAlertNotifications:function(a){f.bindings.isEditingAlertNotifications(!1),f.saveUser(ko.toJS(a)),f.savePolicy()},updateMembers:function(){f.memberCb&&(f.memberCb(),f.memberCb=null,f.savePolicy()),f.$modal.modal("hide")},doDeletePolicy:function(a,b){$.ajax({url:"/api/policies/delete",data:{_id:a},type:"POST",dataType:"json"}).done(function(a){console.log("Deleted"),b()})},deletePolicy:function(a){f.forEachArray(f.bindings.policyList(),function(b,c){b._id()===a._id()&&(a._new&&a._new()?f.bindings.policyList.splice(c,1):f.bindings.doDeletePolicy(a._id(),function(){f.bindings.policyList.splice(c,1)}))})},selectPolicy:function(a){var b=ko.toJS(a);f.bindings.currAlertConfig(null),f.bindings.isEditingMember(!1),f._currPolicy=ko.toJS(a),ko.viewmodel.updateFromModel(f.bindings.currPolicy,b),f.bindings.isEditingPolicy(!0)},addPolicy:function(){f.bindings.newPolicyName(""),f.bindings.isEditingNewPolicy(!0)},doAddNewPolicy:function(){var a=f.getTemplate("policy"),b=f.bindings.newPolicyName();a.name=b,f.bindings.policyList.push(ko.viewmodel.fromModel(a)),f.bindings.isEditingNewPolicy(!1),ko.viewmodel.updateFromModel(f.bindings.currPolicy,a),f.bindings.selectPolicy(a),f.dirty(!0)},editPolicyName:function(){f.bindings.currPolicyName(f.bindings.currPolicy.name()),f.bindings.isEditingPolicyName(!0)},savePolicyName:function(){f.bindings.currPolicy.name(f.bindings.currPolicyName()),f.bindings.isEditingPolicyName(!1),f.savePolicy()},cancelPolicyNameEdit:function(){f.bindings.isEditingPolicyName(!1)},cancelEditMember:function(){f.bindings.currMember(null),f.bindings.isEditingMember(!1)},editPolicyEnabled:function(){f.bindings.currPolicyEnabled(f.bindings.currPolicy.enabled()),f.bindings.isEditingPolicyEnabled(!0)},savePolicyEnabled:function(){f.bindings.currPolicy.enabled(!f.bindings.currPolicyEnabled()),f.bindings.isEditingPolicyEnabled(!1),f.savePolicy()},cancelPolicyEnabledEdit:function(){f.bindings.isEditingPolicyEnabled(!1)},addConfiguration:function(){f.bindings.newConfigurationName(""),f.bindings.isEditingNewConfiguration(!0)},doAddNewConfiguration:function(){var a,b=f.getTemplate("alertConfig");a=f.checkAlertConfigNames(null,f.bindings.newConfigurationName(),f.bindings.currPolicy.alertConfigs()),a||(b.name=f.bindings.newConfigurationName(),f.bindings.currPolicy.alertConfigs.push(ko.viewmodel.fromModel(b)),f.bindings.currAlertConfig(ko.viewmodel.fromModel(ko.toJS(f.bindings.currPolicy.alertConfigs.slice(-1)[0]))),f.bindings.isEditingNewConfiguration(!1),f.bindings.isEditingAlertConfig(!0),f.savePolicy())},editAlertConfig:function(a){f.bindings.currAlertConfig(a)},cancelEditAlertConfig:function(){f.bindings.cancelDoEditAlertConfig(),f.bindings.currAlertConfig(null)},doEditAlertConfig:function(){f._originalAlertConfig=ko.toJS(f.bindings.currAlertConfig),f.bindings.isEditingAlertConfig(!0)},cancelDoEditAlertConfig:function(){ko.viewmodel.updateFromModel(f.bindings.currAlertConfig,f._originalAlertConfig),f.bindings.isEditingAlertConfig(!1)},saveEditAlertConfig:function(){var a,b=f.bindings.currAlertConfig().id();a=f.checkAlertConfigNames(f.bindings.currAlertConfig().id(),f.bindings.currAlertConfig().name(),f.bindings.currPolicy.alertConfigs()),a||(f.forEachArray(f.bindings.currPolicy.alertConfigs(),function(a){if(a.id()===b)return ko.viewmodel.updateFromModel(a,ko.toJS(f.bindings.currAlertConfig)),!1}),f._originalAlertConfig=ko.toJS(f.bindings.currAlertConfig),f.savePolicy(),f.bindings.isEditingAlertConfig(!1))},addAlertGroup:function(){f.bindings.currAlertConfig().groups.push(ko.viewmodel.fromModel(f.getTemplate("group")))},deleteAlertGroup:function(a,b){a.groups.splice(b(),1),f.dirty(!0)},addEscalation:function(a){a.escalations.push(ko.viewmodel.fromModel(f.getTemplate("escalation")))},deleteEscalation:function(a,b){a.escalations.splice(b(),1)},home:function(){f.clearEdits(!0)}},$.ajax({url:b+"groups/getallgroups",contentType:"application/json",dataType:"json",type:"post"}).done(function(a){f.groups=a}),$.ajax({url:b+"users/getallusers",contentType:"application/json",dataType:"json",type:"post"}).done(function(a){var b,c,d=a.Users,e=d.length;for(f.users=[],f.userLookup={},b=0;b<e;b++)c=g(d[b]),f.users.push(c),f.userLookup[c.id]=c}),$("body").on("shown.bs.dropdown",".daySelect input",function(a){}),ko.bindingHandlers.alertConfigName={init:function(a,b,c,d,e){var f,g,h=$(a),i=b(),j=e.$parents[1].alertConfigs(),k=j.length,l=!1;for(g=0;g<k&&!l;g++)j[g].id()===i&&(f=j[g],l=!0);h.html(f.name())}},ko.bindingHandlers.timepicker={init:function(a,b,c,d,e){var f=b(),g={doneText:"Done",autoclose:!0,afterDone:function(){var b=$(a).val().split(":"),c=parseInt(b[0],10),d=parseInt(b[1],10);f(100*c+d),e.$parents[2].updateScheduleEvents(),e.$parents[2].savePolicy()}};$(a).clockpicker(g),$(a).change(function(b){$(a).clockpicker("resetclock")})},update:function(a,b){var c,d,e=ko.utils.unwrapObservable(b());"string"!=typeof e?(c=("00"+Math.floor(e/100)).slice(-2),d=("00"+e%100).slice(-2),$(a).val(c+":"+d)):$(a).val(e)}},f};$(function(){function a(){var b,c,d;void 0===window.opener?window.setTimeout(a,10):(sysPrefsViewModel.registerSection(alarmMessageViewModel,"init"),sysPrefsViewModel.registerSection(calendarViewModel),sysPrefsViewModel.registerSection(controllerViewModel,"init"),sysPrefsViewModel.registerSection(controlPriorityTextViewModel,"getData"),sysPrefsViewModel.registerSection(qualityCodesViewModel,"getData"),sysPrefsViewModel.registerSection(customColorCodesViewModel,"init"),sysPrefsViewModel.registerSection(telemetryViewModel,"init"),sysPrefsViewModel.registerSection(backupViewModel,"init"),sysPrefsViewModel.registerSection(weatherViewModel,"init"),sysPrefsViewModel.registerSection(notificationsViewModel,"init"),sysPrefsViewModel.registerSection(versionsViewModel,"init"),b=(new Date).getFullYear(),c=sysPrefsViewModel.getSection("Calendar"),d=location.hash.substring(1),c.updateDatePicker(b),c.year(b),""===sysPrefsViewModel.section()&&sysPrefsViewModel.section(sysPrefsViewModel.sections[0].displayName),d?sysPrefsViewModel.section(d):location.hash="#"+sysPrefsViewModel.section(),$("#jqxCalendar").jqxCalendar({width:"250px",enableViews:!0}),$(document).mouseup(function(a){var b=$("#jqxCalendar");b.is(a.target)||0!==b.has(a.target).length||b.css("display","none")}),ko.applyBindings(sysPrefsViewModel),sysPrefsViewModel.runInitFunctions())}a()});
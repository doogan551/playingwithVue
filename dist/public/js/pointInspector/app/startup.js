require(["knockout"],function(a){window.ko=a,a.components.register("ctl-description",{require:"components/ctl-description/module"}),a.components.register("ctl-dropdown",{require:"components/ctl-dropdown/module"}),a.components.register("ctl-duration",{require:"components/ctl-duration/module"}),a.components.register("ctl-involvement",{require:"components/ctl-involvement/module"}),a.components.register("ctl-ip",{require:"components/ctl-ip/module"}),a.components.register("ctl-notifications",{require:"components/ctl-notifications/module"}),a.components.register("ctl-number",{require:"components/ctl-number/module"}),a.components.register("ctl-pointReference",{require:"components/ctl-pointReference/module"}),a.components.register("ctl-ROtime",{require:"components/ctl-ROtime/module"}),a.components.register("ctl-ROvalue-eu",{require:"components/ctl-ROvalue-eu/module"}),a.components.register("ctl-states",{require:"components/ctl-states/module"}),a.components.register("ctl-statusBar",{require:"components/ctl-statusBar/module"}),a.components.register("ctl-switch",{require:"components/ctl-switch/module"}),a.components.register("ctl-text",{require:"components/ctl-text/module"}),a.components.register("ctl-value-eu",{require:"components/ctl-value-eu/module"}),a.components.register("ctl-valueBar",{require:"components/ctl-valueBar/module"}),a.components.register("ctl-editor",{require:"components/ctl-editor/module"}),a.components.register("ctl-permissions",{require:"components/ctl-permissions/module"}),a.components.register("ctl-viewControls",{require:"components/ctl-viewControls/module"}),a.components.register("ctl-sendControl",{require:"components/ctl-sendControl/module"}),a.components.register("ctl-readValue",{require:"components/ctl-readValue/module"}),a.components.register("ctl-viewTrend",{require:"components/ctl-viewTrend/module"}),a.components.register("ctl-staticText",{require:"components/ctl-staticText/module"}),a.components.register("ctl-firmwareLoader",{require:"components/ctl-firmwareLoader/module"}),a.components.register("ctl-firmwareVersion",{require:"components/ctl-firmwareVersion/module"}),a.components.register("ctl-conversionWizard",{require:"components/ctl-conversionWizard/module"}),a.components.register("ctl-scheduleEntries",{require:"components/ctl-scheduleEntries/module"}),a.components.register("ctl-qualityCodeEnable",{require:"components/ctl-qualityCodeEnable/module"}),a.components.register("ctl-policies",{require:"components/ctl-policies/module"}),a.components.register("ctl-networkInfo",{require:"components/ctl-networkInfo/module"}),a.components.register("pt-accumulator",{require:"components/pt-accumulator/module"}),a.components.register("pt-alarmstatus",{require:"components/pt-alarmstatus/module"}),a.components.register("pt-analoginput",{require:"components/pt-analoginput/module"}),a.components.register("pt-analogoutput",{require:"components/pt-analogoutput/module"}),a.components.register("pt-analogselector",{require:"components/pt-analogselector/module"}),a.components.register("pt-analogvalue",{require:"components/pt-analogvalue/module"}),a.components.register("pt-average",{require:"components/pt-average/module"}),a.components.register("pt-binaryinput",{require:"components/pt-binaryinput/module"}),a.components.register("pt-binaryoutput",{require:"components/pt-binaryoutput/module"}),a.components.register("pt-binaryselector",{require:"components/pt-binaryselector/module"}),a.components.register("pt-binaryvalue",{require:"components/pt-binaryvalue/module"}),a.components.register("pt-comparator",{require:"components/pt-comparator/module"}),a.components.register("pt-delay",{require:"components/pt-delay/module"}),a.components.register("pt-device",{require:"components/pt-device/module"}),a.components.register("pt-digitallogic",{require:"components/pt-digitallogic/module"}),a.components.register("pt-economizer",{require:"components/pt-economizer/module"}),a.components.register("pt-enthalpy",{require:"components/pt-enthalpy/module"}),a.components.register("pt-logic",{require:"components/pt-logic/module"}),a.components.register("pt-math",{require:"components/pt-math/module"}),a.components.register("pt-multiplexer",{require:"components/pt-multiplexer/module"}),a.components.register("pt-multistatevalue",{require:"components/pt-multistatevalue/module"}),a.components.register("pt-optimumstart",{require:"components/pt-optimumstart/module"}),a.components.register("pt-program",{require:"components/pt-program/module"}),a.components.register("pt-proportional",{require:"components/pt-proportional/module"}),a.components.register("pt-ramp",{require:"components/pt-ramp/module"}),a.components.register("pt-remoteunit",{require:"components/pt-remoteunit/module"}),a.components.register("pt-schedule",{require:"components/pt-schedule/module"}),a.components.register("pt-script",{require:"components/pt-script/module"}),a.components.register("pt-selectvalue",{require:"components/pt-selectvalue/module"}),a.components.register("pt-setpointadjust",{require:"components/pt-setpointadjust/module"}),a.components.register("pt-slideshow",{require:"components/pt-slideshow/module"}),a.components.register("pt-totalizer",{require:"components/pt-totalizer/module"}),a.components.register("pt-vav",{require:"components/pt-vav/module"}),a.components.register("pt-sensor",{require:"components/pt-sensor/module"}),a.components.register("pt-liftstation",{require:"components/pt-liftstation/module"})}),define(["jquery","knockout","socket","moment","big","bannerJS","knockout-projections","knockout.viewmodel","jquery-transit","jquery-mousewheel","jquery-easing","jquery-hilite","bootstrap","bootstrap-switch"],function(a,b,c,d,e,f){function g(c){var d=this,e={extend:{"{root}":{map:function(a){for(var b in a)e.shared.mapValueType(a[b]);return a},unmap:function(a){for(var b in a)e.shared.unmapValueType(a[b]);return a}}},shared:{mapValueType:function(a){return a},unmapValueType:function(a){return a},extendArrayValue:{map:function(a){return b.observable(a)},unmap:function(a){return a()}}},custom:{ValueOptions:{map:function(a){var c=b.observableArray(j.utility.enumToArray(a));return c},unmap:function(a){var b=j.utility.arrayToValueOptions(a());return b}},"{root}.Occupancy Schedule[i]":{map:function(a){var c=b.viewmodel.toModel(a);return c.Enable=b.observable(c.Enable),c["Occupancy Begin Time"]={Value:b.observable(c["Occupancy Begin Time"]),isDisplayable:b.observable(!0),ValueType:b.observable(17)},c["Occupancy End Time"]={Value:b.observable(c["Occupancy End Time"]),isDisplayable:b.observable(!0),ValueType:b.observable(17)},c},unmap:function(a){return"function"==typeof a.Enable&&(a.Enable=a.Enable(),a["Occupancy Begin Time"]=a["Occupancy Begin Time"].Value(),a["Occupancy End Time"]=a["Occupancy End Time"].Value()),a}},"{root}.Boolean Registers[i]":"extendArrayValue","{root}.Integer Registers[i]":"extendArrayValue","{root}.Real Registers[i]":"extendArrayValue"}};d.controls={"Device Time":{commandTX:{"Command Type":1,upi:""},commandRX:{value:b.observable(),error:b.observable()}},"Device Initialize":{commandTX:{"Command Type":2,upi:"",state:1},commandRX:{value:b.observable(),error:b.observable()}},"Command Point":{commandTX:{"Command Type":7,upi:"",Value:"",Controller:"",Relinquish:"",Priority:"",Wait:""},commandRX:{value:b.observable(),error:b.observable()}},"Present Value":{commandTX:{"Command Type":5,upi:""},commandRX:{value:b.observable(),error:b.observable()}},"Control Array":{commandTX:{"Command Type":3,upi:""},commandRX:{value:b.observable(),error:b.observable()}},"Control Log":{commandTX:{"Command Type":8,upi:""},commandRX:{value:b.observable(),error:b.observable()}},"Trend Data":{commandTX:{"Command Type":4,upi:""},commandRX:{value:b.observable(),error:b.observable()}},"Network Info":{commandTX:{"Command Type":15,upi:""},commandRX:{value:b.observable(),error:b.observable()}}},d.issueCommand=function(a,c,e){var f=d.controls[a];b.utils.extend(f.commandTX,c),j.socket.emit("fieldCommand",b.toJSON(f.commandTX)),j.socket.once("returnFromField",function(b){b.err?(f.commandRX.value(""),f.commandRX.error(b.err)):(f.commandRX.error(""),f.commandRX.value(b[a]||b)),"function"==typeof e&&e.call(void 0,f.commandRX)})},d.originalData=c,d.data=b.viewmodel.fromModel(c,e),d.data["Point Refs"].extend({rateLimit:{timeout:500,method:"notifyWhenChangesStop"}}),d.status=b.observable("saved"),d.save=function(c){if(!("saving"===d.status()||(new Date).getTime()-m<1e3)){var e,g=b.viewmodel.toModel(d.data),h={newPoint:g,oldPoint:d.originalData},i="updatePoint",k="fa-spinner fa-spin",l=a(".btnSave i");if(window.setTimeout(function(){"saving"===d.status()&&l.addClass(k)},200),window.attach&&"function"==typeof window.attach.saveCallback)return window.attach.saveCallback.call(void 0,h),window.close();if(a("body").css("overflow","hidden"),c=c||{},g._pStatus===j.utility.config.Enums["Point Statuses"].Inactive["enum"])i="addPoint",h={point:g};else if(g._pStatus==j.utility.config.Enums["Point Statuses"].Active["enum"])for(var n in g)g[n].hasOwnProperty("ValueOptions")&&Array.isArray(g[n].ValueOptions)&&(g[n].ValueOptions=j.utility.arrayToValueOptions(g[n].ValueOptions));if("pt-slideshow"===c.baseComponent){var o,p,q,r,s=h.newPoint["Point Refs"],t=s.length,u=h.newPoint.Slides,v=function(a){for(var b=0;b<u.length;b++)if(u[b].display===a)return b;return null},w=function(){for(var a=0;a<s.length;a++)s[a].AppIndex=a+1,r=s[a].Value,q=u[v(s[a].PointInst)],q&&(q.order=a)};for(o=t-1;o>=0;o--)p=s[o],p&&""===p.PointName&&0===p.Value&&(u.splice(v(p.PointInst),1),s.splice(o,1));w()}b.utils.extend(h,c.extendData),d.status("saving"),j.socket.emit(i,h),j.socket.once("pointUpdated",function(g){var h,i,m=3e3;g.message&&"success"===g.message?(msg="Point was successfully saved.",d.originalData=b.viewmodel.toModel(g.point),b.viewmodel.updateFromModel(d.data,d.originalData),d.status("saved"),c.exitEditModeOnSave&&j.isInEditMode(!1)):("string"==typeof g.err?msg="Error: "+g.err:msg="An unexpected error occurred.",m=null,h="#D50000",i="OK",d.status("error")),e="boolean"==typeof c.close&&c.close&&!g.err,f.showBanner(msg,i,m,h,e),l.removeClass(k),a("body").css("overflow","auto"),e&&setTimeout(window.close,1e3)})}},d.saveAndClose=function(){d.save({close:!0})}}function h(b){return a.ajax({url:j.apiEndpoint+"points/"+b,contentType:"application/json",dataType:"json",type:"get"})}function i(d){var e=".permissionDenied",h=a(".noAccess"),i=!1;return d.err&&("permission denied"===d.err.toLowerCase()&&(e=".permissionDenied"),i=!0),!i&&d.message&&("no point found"===d.message.toLowerCase()&&(e=".pointNotFound"),i=!0),i||j.authorize(d,j.permissionLevels.READ)||(i=!0),i?(h.show().find(e).show(),void j.initDOM()):(j.point=new g(d),j.socket=c.connect(window.location.origin),a(".wrapper").show(400,function(){window.setTimeout(function(){2===d._pStatus&&f.showBanner({msg:"This point has been deleted. Click the restore button to undelete it.",color:"black",dismissText:"Dismiss"})},500)}),j.baseComponent=["pt-",d["Point Type"].Value.toLowerCase().replace(" ","")].join(""),b.applyBindings(j),void(window.document.title=j.point.data.Name()))}var j={},k=window.opener&&window.opener.workspaceManager,l=[],m=0;d.locale("en",{longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"MM/DD/YYYY",LL:"MMMM Do YYYY",LLL:"MMMM Do YYYY LT",LLLL:"dddd, MMMM Do YYYY LT"},calendar:{lastDay:"[Yesterday at] LTS",sameDay:"[Today at] LTS",nextDay:"[Tomorrow at] LTS",lastWeek:"[Last] dddd [at] LTS",nextWeek:"dddd [at] LTS",sameElse:"L LTS"}}),j.webEndpoint="//"+window.location.hostname,j.apiEndpoint=j.webEndpoint+":"+window.location.port+"/api/",j.id=window.location.href.split("/").reverse()[0],j.permissionLevels={READ:1,CONTROL:2,ACKNOWLEDGE:4,WRITE:8},j.utility={getPointRefProperty:function(a,b){var c=void 0!==b?b["Point Refs"]():j.point.data["Point Refs"](),d={},e=0,f=c.length;for(e;e<f;e++)if(a===c[e].PropertyName())return d.arrayIndex=e,d.data=c[e],d},getPointRefPropertyByAppIndex:function(a,b){var c=j.point.data["Point Refs"](),d={},e=0,f=c.length;for(e;e<f;e++)if(a===c[e].PropertyName()&&b===c[e].AppIndex())return d.arrayIndex=e,d.data=c[e],d},enumToArray:function(a){var c=[];for(var d in a)c.push({name:b.observable(d),value:b.observable("undefined"==typeof a[d]["enum"]?a[d]:a[d]["enum"])});return c},arrayToValueOptions:function(a){var c={},d=0;for(d;d<a.length;d++)c[b.unwrap(a[d].name)]=b.unwrap(a[d].value);return c},createUniqueId:function(){var a=Math.max.apply(Math,l),b=a<0?0:a+1;return l.push(b),b},addEvent:function(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent&&a.attachEvent("on"+b,c)},removeEvent:function(a,b,c){a.removeEventListener?a.removeEventListener(b,c,!1):a.detachEvent&&a.detachEvent("on"+b,c)},createSelection:function(a,b,c){if(a.setSelectionRange)a.focus(),a.setSelectionRange(b,c);else if(a.createTextRange){var d=a.createTextRange();d.collapse(!0),d.moveEnd("character",c),d.moveStart("character",b),d.select()}},getSelectionStart:function(a){if("number"==typeof a.selectionStart)return a.selectionStart;if(a.createTextRange){var b;return a.focus(),b=document.selection.createRange().duplicate(),b.moveEnd("character",a.value.length),""===b.text?a.value.length:a.value.lastIndexOf(b.text)}return 0},getSelectionEnd:function(a){if("number"==typeof a.selectionEnd)return a.selectionEnd;if(a.createTextRange){var b;return a.focus(),b=document.selection.createRange().duplicate(),b.moveStart("character",-a.value.length),""===b.text?a.value.length:a.value.lastIndexOf(b.text)}return 0},isInt:function(a){var b=/^[-+]?[0-9]+$/;return b.test(a)},isFloat:function(a){return("number"==typeof a||"string"==typeof a&&""!==a)&&!isNaN(Number(a))},normalizeNumber:function(a){return a.toString().replace(/,/g,"")},formatNumber:function(b,c,d,f){return""===a.trim(b)||isNaN(parseFloat(b))?"":(b=new e(j.utility.normalizeNumber(b)),d=d||j.isInEditMode(),4===c&&(b=b.abs()),3!==c&&4!==c||(b=b.toFixed(0)),k.config.Utility.formatNumber({val:b,noTruncate:d,noComma:f}))},workspace:k,config:k.config,getControllerName:function(a){for(var b=k.systemEnums.controllers,c=b.length;c--;)if(b[c].value===a)return b[c].name;return""},getLevelName:function(a){for(var b=k.systemEnums.controlpriorities,c=b.length;c--;)if(b[c].value===a)return b[c].name;return""}},j.isInEditMode=b.observable(!1),j.modelUpdate=b.observable(!1),j.currentTab=b.observable(),j.toggleEditMode=function(c){var d=j.isInEditMode();d&&(b.viewmodel.updateFromModel(j.point.data,j.point.originalData),a(".invalidCharMsg").hide()),j.isInEditMode(!d)},j.restorePoint=function(b,c){var d=JSON.stringify({upi:j.point.data._id()}),e="";a(c.currentTarget).attr("disabled",!0),j.socket.emit("restorePoint",d),j.socket.once("pointUpdated",function(b){b=JSON.parse(b),b.err?e=["An error occurred when trying to restore this point: ",b.err].join(""):"success"!==b.message&&(e="An unknown error occurred when trying to restore this point. Please try again."),e.length?f.showBanner({msg:e,dismissText:"Dismiss",color:"#D50000"}):(f.showBanner({msg:"Point restored successfully",dismissText:"OK",duration:3e3}),j.point.originalData._pStatus=0,j.point.data._pStatus(0)),a(c.currentTarget).attr("disabled",!1)})},j.close=function(a){var c=b.viewmodel.toModel(j.point.data),d={upi:c._id,method:"hard"},e="deletePoint";1===c._pStatus&&j.socket.emit(e,d),window.close()},j.tabTriggers={},j.events={viewmodelChange:function(c){var d,e,g,h,i=null===c.targetElement?null:c.targetElement instanceof jQuery?c.targetElement:a(c.targetElement),k=j.utility.config;c.hasOwnProperty("oldPoint")&&null!==c.oldPoint?(d={point:b.viewmodel.toModel(c.point),property:c.property,refPoint:c.refPoint,oldPoint:c.oldPoint},e=k.Update.formatPoint(d),console.log("SEND111",d),console.log("UPDATE111",e),e.err?(i&&i.effect("highlight",{color:"#ffff99"},2500),"number"==typeof c.property?(h=c.point["Point Refs"]()[c.property],g=c.oldPoint["Point Refs"][c.property],h.Value(g.Value),h.PointName(g.PointName),f.showBanner(e.err+" The "+c.point["Point Refs"]()[c.property].PropertyName()+" has been set back to its original value.","Dismiss")):(h=c.point[c.property],g=c.oldPoint[c.property],h.hasOwnProperty("Value")?h.Value(g.Value):h(g),f.showBanner(e.err+" The "+c.property+" has been set back to its original value.","Dismiss"))):b.viewmodel.updateFromModel(c.point,e)):(d={point:b.viewmodel.toModel(j.point.data),property:c.property,refPoint:c.refPoint,oldPoint:j.point.originalData,systemNetwork:window.opener.workspaceManager.systemEnumObjects.telemetry["IP Network Segment"],systemIPPort:window.opener.workspaceManager.systemEnumObjects.telemetry["IP Port"]},e=k.Update.formatPoint(d),console.log("SEND",d),console.log("UPDATE",e),e.err?(m=(new Date).getTime(),i&&i.effect("highlight",{color:"#ffff99"},2500),"number"==typeof c.property?(h=j.point.data["Point Refs"]()[c.property],g=j.point.originalData["Point Refs"][c.property],h.Value(g.Value),h.PointName(g.PointName),f.showBanner(e.err+" The "+j.point.data["Point Refs"]()[c.property].PropertyName()+" has been set back to its original value.","Dismiss")):(h=j.point.data[c.property],g=j.point.originalData[c.property],e.truncate?(h.hasOwnProperty("Value")?h.Value(d.point[c.property].Value.substring(0,e.maxLength)):h(d.point[c.property].substring(0,e.maxLength)),f.showBanner(e.err+" The "+c.property+" has been truncated.","Dismiss")):("States"===c.property?h.ValueOptions(j.utility.enumToArray(g.ValueOptions)):h.hasOwnProperty("Value")?h.Value(g.Value):h(g),f.showBanner(e.err+" The "+c.property+" has been set back to its original value.","Dismiss")))):(j.modelUpdate(!0),e=JSON.parse(JSON.stringify(e)),j.point.updatedPoint=e,b.viewmodel.updateFromModel(j.point.data,e),j.modelUpdate(!1)))}},j.initDOM=function(){function b(a){a.removeClass("tabHidden")}function c(a){a.addClass("tabHidden")}var d=a("body"),e=a(".nav"),g=e.find("li>ul"),h=g.parent().children("span"),i=g.find(".back"),k=e.find("li").not(h.parent()).not(i).not(".header"),l=a(".view"),m=a(".viewOverlay"),n=a(".navToggle");a(document).on("contextmenu",function(b){if(!a(b.target).is('textarea, input[type="text"]')&&!a(b.target).closest(".CodeMirror").length)return b.preventDefault(),b.stopImmediatePropagation(),!1}),a(document).on("viewmodelChange",j.events.viewmodelChange),k.on("click",function(){var d,e,f=a(this),g=l.find(".header").find("h4"),h=f.find("span").text(),i=h.split(" "),m=a(".content"),o=j.tabTriggers[h.toLowerCase()];f.hasClass("active")||(c(m),j.currentTab(h.toLowerCase()),i.unshift("#"),d=i.join("").toLowerCase(),e=a(d),l.scrollTop(0),k.removeClass("active"),f.addClass("active"),n.hasClass("shown")&&n.trigger("click"),l.children().stop(!0,!0).animate({opacity:0},{duration:100,easing:"easeOutQuint",complete:function(){g.text(h),b(e),l.children().animate({opacity:1},{duration:500,easing:"easeOutQuint"})}}),"function"==typeof o&&o(!0))}),k.first().trigger("click"),h.on("click",function(){var b=a(this),c=b.siblings("ul");c.show(),c.children().not(".header").not(".back").first().trigger("click"),e.addClass("animating").animate({left:"-146px"},{duration:300,easing:"easeOutExpo",complete:function(){e.removeClass("animating")}})}),i.on("click",function(){g.hide(),k.first().trigger("click"),e.addClass("animating").animate({left:"0px"},{duration:300,easing:"easeOutExpo",complete:function(){e.removeClass("animating")}})}),n.on("click",function(){return n.hasClass("shown")?(a(window).width()<768&&l.animate({left:"0px"},{duration:300,easing:"easeOutExpo",complete:function(){l.removeAttr("style")}}),m.removeClass("shown").css({top:"0",bottom:"0"}),m.animate({left:"0px",opacity:"0"},{duration:300,easing:"easeOutExpo",complete:m.hide}),void n.removeClass("shown")):(m.css({opacity:"0"}).addClass("shown").css({top:"50px",bottom:"30px"}),l.animate({left:"136px"},{duration:300,easing:"easeOutExpo"}),m.animate({left:"136px",opacity:"1"},{duration:300,easing:"easeOutExpo"}),void n.addClass("shown"))}),f.init(),a.fn.bootstrapSwitch.defaults.size="small",a.fn.bootstrapSwitch.defaults.onColor="success",a.support.transition?d.transition({opacity:1},2e3,"easeOutQuint"):d.animate({opacity:1},{duration:500,easing:"easeOutQuint"})},j.authorize=function(a,b){var c=0,d=k.user(),e=d.groups.filter(function(b){return!!~a.Security.indexOf(b._id)}),f=d["System Admin"].Value;if(f)return!0;for(var g=0,h=e.length;g<h;g++)c|=e[g]._pAccess;return!!(c&b)},j.isSystemAdmin=function(){return k.user()["System Admin"].Value},j.isValidFirmwareLoader=function(a){var b=a["Model Type"].eValue();return 8===a["Point Type"].eValue()?13===b||16===b||17===b||18===b||19===b||20===b:144===a["Point Type"].eValue()?3===b||6===b:void 0},window.attach&&window.attach.point?i(JSON.parse(window.attach.point)):h(j.id).done(function(a){i(a)}),b.utils.unwrapProperties=function(a){if(null===a||"object"!=typeof a)return a;var c={};return b.utils.objectForEach(a,function(a,d){c[a]=b.unwrap(d)}),c},b.bindingHandlers.tooltip={init:function(c){var d=a(c);b.utils.domNodeDisposal.addDisposeCallback(c,function(){d.data("bs.tooltip")&&d.tooltip("destroy")})},update:function(c,d){var e=a(c),f=b.unwrap(d()),g=b.utils.unwrapProperties(f),h=e.data("bs.tooltip"),i={delay:{show:500,hide:100}};b.utils.extend(i,g),h?b.utils.extend(h.options,i):e.tooltip(i)}},b.bindingHandlers.modal={init:function(c,d){var e=d();a(c).modal({show:!1}),"function"==typeof e&&a(c).on("hide.bs.modal",function(){e(!1)}),b.utils.domNodeDisposal.addDisposeCallback(c,function(){a(c).data("bs.modal",null)})},update:function(c,d){var e=d();b.utils.unwrapObservable(e)?a(c).modal("show"):a(c).modal("hide")}},b.bindingHandlers.formattedNumericText={update:function(c,d,e){var f,g=j.utility,h=a(c),i=d(),k=b.contextFor(c),l=k.$data.valueType||e().valueType,m=g.formatNumber(i(),l()),n=m.length;n>=17?f=16:n>=12?f=22:n>8&&(f=36),f?h.css({"font-size":f+"px"}):h.attr("style")&&h.attr("style",function(a,b){return b.replace(/font-size[^;]+;?/g,"")}),h.html(m)}},b.bindingHandlers.numeric={init:function(c,d,f){var g,h=j.utility,i=a(c),k=d(),l=b.unwrap(f().valueType),m=f().noTruncate,n=f().noComma,o=f().min,p=f().max,q=f().doValidate,r=b.unwrap(f().noValidation),s=b.computed({read:function(){return i.is(":focus")&&i.is("input")?b.unwrap(k):h.formatNumber(b.unwrap(k),l,m,n)},write:function(a){var c=a,d=b.unwrap(k);"key"!==g&&("undefined"!=typeof o&&c<b.unwrap(o)||"undefined"!=typeof p&&c>b.unwrap(p))&&(c=d),k(isNaN(c)?"":c),k.valueHasMutated()}}).extend({notify:"always"});i.is("input")?b.applyBindingsToNode(c,{value:s}):b.applyBindingsToNode(c,{text:s}),i.on("keydown",function(a){var b=h.getSelectionStart(i[0]),c=i.val(),d=/\./g.test(c),e=/[Ee]/g.test(c),f=a.keyCode,j=!1,k=function(){return 0===b?!/^[\+-]/g.test(c):/^[eE]$|^[eE][^\+-]/g.test(c.substring(b-1,b+1))};switch(g="key",f){case 46:case 8:case 9:case 27:case 13:case 36:case 35:case 37:case 39:j=!0;break;case 65:a.ctrlKey&&(j=!0);break;case 190:case 110:1!==l||d||/[eE]/g.test(c.substring(0,b))||(j=!0);break;case 109:case 189:4!==l&&(j=k());break;case 187:case 107:j=k();break;case 69:e||0===b||(j=!0)}j||((a.shiftKey||(f<48||f>57)&&(f<96||f>105))&&(a.preventDefault(),a.stopImmediatePropagation()),38===f&&(g="arrow",i.trigger("mousewheel",{deltaY:1})),40===f&&(g="arrow",i.trigger("mousewheel",{deltaY:-1})))}).on("mousewheel",function(b,c){var d=h.getSelectionStart(i[0]),f=this.value,j=f.indexOf("."),k=!!~j,l=k?f.length-j-1:0,m=1,n=0,o=f.length;""===a.trim(f)||isNaN(f)||("number"==typeof c.deltaY?(b=c,g="arrow"):g="wheel",i.is(":focus")&&(!!b.preventDefault&&b.preventDefault(),k&&d>j?(m=Math.pow(10,l),n=j+1,o=f.length):(n=0,o=k?j:f.length),i.val(new e(f).plus(b.deltaY/m).toFixed(l)).trigger("change"),h.createSelection(i[0],n,o)))}).on("click",function(a){var b=h.getSelectionStart(i[0]),c=i.val(),d=c.indexOf("."),e=!!~d,f=0,g=c.length;e&&(b>d?(f=d+1,g=c.length):(f=0,g=d)),h.createSelection(i[0],f,g)}).on("focus",function(){i.val(h.normalizeNumber(i.val(),l))}).on("focusout",function(){k(parseFloat(k())),r||q&&a(document).triggerHandler({type:"viewmodelChange",targetElement:i,property:f().propertyName,refPoint:null})}).on("blur",function(){i.val()===k()&&i.val(h.formatNumber(i.val(),l))})}},b.bindingHandlers.validateOnBlur={init:function(c,d,e){var f,g={$element:a(c),property:d()};f=e().value.subscribe(function(b){a(document).triggerHandler({type:"viewmodelChange",targetElement:this.$element,property:this.property,refPoint:null})},g),b.utils.domNodeDisposal.addDisposeCallback(c,function(){f.dispose()})}},b.bindingHandlers.protectedText={init:function(b,c,d,e,f){var g=c(),h=a(b),i=a(".invalidCharMsg"),l=i.find(".invalidChar"),m=h.offset(),n=h.outerHeight(),o=m.top+n+3,p=m.left,q=h.outerWidth(),r=j.utility.config;h.val(g()),h.on("keypress",function(a){var b=String.fromCharCode(a.which);r.Utility.isPointNameCharacterLegal(b)===!1&&(i.css({opacity:1,top:o,left:p,width:q}),l.text(b),i.stop().show(),k.playSound("beep"),a.preventDefault(),a.stopImmediatePropagation(),h.blur())}).on("blur",function(){g()!==h.val()&&(g(h.val()),a(document).triggerHandler({type:"viewmodelChange",targetElement:h,property:d().propertyName,refPoint:null}))}).on("focus",function(){i.fadeOut(400)})}}});
define(["knockout","CM","text!./view.html","bannerJS","CMLang","CMBrackets","CMActiveLine","CMSearch","CMSearchCursor","CMDialog"],function(a,b,c,d){function e(b){var c=this;this.root=b.rootContext,this.apiEndpoint=this.root.apiEndpoint,this.propertyName=b.propertyName,this.containerClass=b.containerClass,this.isReadOnly=b.isReadOnly||!1,this.data=b.data,this.script=this.data[this.propertyName],this.isInEditMode=this.root.isInEditMode,this.status=a.observable("committed"),this.exePath="",this.timeoutId=0,this.editModeSubscription=this.isInEditMode.subscribe(function(a){var b=c.editor;c.isReadOnly||(b.setOption("readOnly",!a&&"nocursor"),b.setOption("styleActiveLine",a),b.setOption("matchBrackets",a),a||b.setValue(c.script()))}),this.sourceChangeSubscription=this.script.subscribe(function(a){var b=c.root.point.originalData["Script Source File"].replace(/(\r\n|\r|\n)/g,"\n").replace(/[\t]/g,"    ");b==a?c.status("committed"):c.status("changed")}),this.tabSubscription=this.root.tabTriggers.source.subscribe(function(a){function b(){$(codeMirror).is(":visible")?c.editor.refresh():c.timeoutId=window.setTimeout(b,50)}var d=c.containerClass?"."+c.containerClass:"";codeMirror=d+" .CodeMirror",c.root.tabTriggers.source(!1),b()})}return a.bindingHandlers.editor={init:function(c,d,e,f){var g=a.unwrap(d());g=g.replace(/[\t]/g,"    ").replace(/(\r\n|\r|\n)/g,"\n"),d()(g),a.applyBindingsToNode(c,{value:d()}),setTimeout(function(){f.editor=b.fromTextArea(c,{lineNumbers:!0,mode:"text/x-dorsett",theme:"mdn-like",readOnly:"nocursor",indentUnit:4,showCursorWhenSelecting:!0,extraKeys:{Tab:function(a){var b=Array(a.getOption("indentUnit")+1).join(" ");a.replaceSelection(b)}}}),f.editor.on("contextmenu",function(a,b){if(!f.isInEditMode())return b.preventDefault(),b.stopImmediatePropagation(),!1}),f.editor.on("changes",function(a){f.script(f.editor.getValue("\n"))})},1e3)},update:function(b,c,d,e){var f=a.unwrap(c());f=f.replace(/[\t]/g,"    ").replace(/(\r\n|\r|\n)/g,"\n"),c()(f),a.applyBindingsToNode(b,{value:c()})}},e.prototype.compile=function(){var a,b=this,c=b.data,e=c._id(),f={upi:e,fileName:e,script:b.data["Script Source File"]()};$.ajax({type:"POST",url:b.apiEndpoint+"scripts/updatescript",data:f}).done(function(c){c.err||!c.path?(a="string"==typeof c.err?c.err:"An unexpected error occurred. Please recompile and commit.",d.showBanner(a,null,1e4),b.status("error")):(b.exePath=c.path,a="Compile successful.",d.showBanner(a,null,3e3),b.status("compiled"))}).fail(function(c,e,f){a="An unexpected error occurred: "+f,d.showBanner(a,null,1e4),b.status("error")})},e.prototype.commit=function(){var a,b=this,c=b.data,e=c._id(),f={upi:e,fileName:e,path:b.exePath};$.ajax({type:"POST",url:b.apiEndpoint+"scripts/commitscript",data:f}).done(function(c){c.err?(a="Commit failed with error: "+c.err,b.status("error")):c.point?(a="Commit successful.",b.status("committed")):(a="An unexpected error occurred. Please recommit.",b.status("error")),d.showBanner(a,null,1e4)}).fail(function(c,e,f){a="An unexpected error occurred: "+f,d.showBanner(a,null,1e4),b.status("error")})},e.prototype.dispose=function(){this.editModeSubscription.dispose(),this.sourceChangeSubscription.dispose(),this.tabSubscription.dispose(),window.clearTimeout(this.timeoutId)},{viewModel:e,template:c}});
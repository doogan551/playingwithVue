define(["knockout","CM","text!./view.html","bannerJS","CMLang","CMBrackets","CMActiveLine","CMSearch","CMSearchCursor","CMDialog"],function(a,b,c,d){function e(a){var b=this,c=a.name,d=c+"Tab",e=0,f=function(){b.$codeMirror.is(":visible")?(b.editor.refresh(),b.editor.focus()):e++<10&&(b.timeoutId=window.setTimeout(f,50))};return b.name=c,b.source=a.script,b.editor=a.editor,b.$tab=$("."+d),b.$editor=$("."+c+"Editor"),b.$codeMirror=b.$editor.find(".CodeMirror"),b.timeoutId=0,b.len=function(){return b.source().length},b.refreshEditor=function(){e=0,f()},b.selectTab=function(){i.removeClass("active"),j.hide(),b.$tab.addClass("active"),b.$editor.show(),b.refreshEditor(),a.viewModel.selectedScript(b)},b.$tab.click(function(a){$(a).hasClass(d)||b.selectTab()}),b}function f(a){return a.productionEditor&&a.developmentEditor?(i=$(".scriptTab"),j=$(".scriptEditor"),a.productionScript=new e({script:a.data["Script Source File"],editor:a.productionEditor,name:"production",viewModel:a}),a.developmentScript=new e({script:a.data["Development Source File"],editor:a.developmentEditor,name:"development",viewModel:a}),a.productionScript.len()?(a.selectedScript(a.productionScript),a.developmentScript.len()||a.developmentScript.$tab.hide()):a.selectedScript(a.developmentScript),void(l=!0)):void window.setTimeout(function(){f(a)},200)}function g(b){window.script=this;var c=this;h=b.apiEndpoint,this.root=b,this.point=b.point,this.data=b.point.data,this.utility=b.utility,this.isInEditMode=b.isInEditMode,this.buildStatus=a.observable("changed"),this.selectedScript=a.observable({}),this.tabTriggers={permissions:a.observable(!1),source:a.observable(!1),involvement:a.observable(!1)},b.tabTriggers=this.tabTriggers,this.sourceTabSubscription=this.tabTriggers.source.subscribe(function(a){var b=c.selectedScript();b.refreshEditor&&b.refreshEditor(),c.tabTriggers.source(!1)}),this.editModeSubscription=this.isInEditMode.subscribe(function(a){var b=c.developmentScript,d=c.productionScript,e=b.editor;e.setOption("readOnly",!a&&"nocursor"),e.setOption("styleActiveLine",a),e.setOption("matchBrackets",a),a?(b.len()||e.setValue(d.source()),b.$tab.show(),b.selectTab()):(e.setValue(b.source()),!b.len()&&d.len()&&(b.$tab.hide(),d.selectTab()))}),this.buildStatusSubscription=this.buildStatus.subscribe(function(a){if(!k){var b=$("<li class='saveAndActivate' style='display: none;'><a href='javascript:void(0)'><i class='glyphicon glyphicon-floppy-open'></i> Save and Activate</a></li>");b.insertAfter(".actions li:first"),b.click(function(a){c.saveAndActivate()}),k=$(".saveAndActivate")}"compiled"===a?k.show():k.hide()}),this.saveStatusSubscription=this.point.status.subscribe(function(a){console.log("saveStatus: ",a),"activating"===c.buildStatus()&&"saving"!==a&&("saved"===a?(c.developmentScript.editor.setValue(""),c.developmentScript.$tab.hide(),c.productionScript.editor.setValue(c.productionScript.source()),c.productionScript.selectTab(),c.buildStatus("activated")):(c.developmentScript.source(c.productionScript.source()),c.productionScript.source(c.point.originalData["Script Source File"]),c.productionScript.refreshEditor()))}),this.sourceChangeSubscription=this.data["Development Source File"].subscribe(function(a){if("changed"!=c.buildStatus()){var b=c.root.point.originalData["Development Source File"].replace(/(\r\n|\r|\n)/g,"\n").replace(/[\t]/g,"    ");b!=a&&c.buildStatus("changed")}}),f(c),b.initDOM()}var h,i,j,k,l=!1;return a.bindingHandlers.editor={init:function(c,d,e,f){var g=a.unwrap(d()),h=e(),i=h.isReadOnly||!1,j=h.name||"editor";g=g.replace(/[\t]/g,"    ").replace(/(\r\n|\r|\n)/g,"\n"),d()(g),a.applyBindingsToNode(c,{value:d()}),setTimeout(function(){f[j]=b.fromTextArea(c,{lineNumbers:!0,mode:"text/x-dorsett",theme:"mdn-like",readOnly:"nocursor",indentUnit:4,showCursorWhenSelecting:!0,extraKeys:{Tab:function(a){var b=Array(a.getOption("indentUnit")+1).join(" ");a.replaceSelection(b)}}}),f[j].on("contextmenu",function(a,b){if(!f.isInEditMode()||i)return b.preventDefault(),b.stopImmediatePropagation(),!1}),f[j].on("changes",function(a){d()(a.getValue("\n"))})},1e3)},update:function(b,c,d,e){var f=a.unwrap(c());f=f.replace(/[\t]/g,"    ").replace(/(\r\n|\r|\n)/g,"\n"),c()(f),a.applyBindingsToNode(b,{value:c()})}},g.prototype.compile=function(){var a,b=this,c=b.data,e={upi:c._id(),script:c["Development Source File"]()},f=$(".btnCompile"),g=f.find("i"),h=b.root.socket;f.addClass("btn-warning"),g.addClass("fa-spin"),h.emit("compileScript",e),h.once("compiledScript",function(c){c.err||!c.path?(a="string"==typeof c.err?c.err:"An unexpected error occurred. Please recompile and commit.",d.showBanner(a,"OK",null,"#D50000"),b.buildStatus("error")):(b.exePath=c.path,d.showBanner("Compile successful.",null,3e3),b.buildStatus("compiled")),g.removeClass("fa-spin"),f.removeClass("btn-warning")})},g.prototype.saveAndActivate=function(){if("compiled"===this.buildStatus()&&this.exePath){var a=this,b={close:!1,extendData:{path:a.exePath},exitEditModeOnSave:!0};a.productionScript.source(a.developmentScript.source()),a.developmentScript.source(""),a.buildStatus("activating"),a.root.point.save(b)}},g.prototype.dispose=function(){this.sourceTabSubscription.dispose(),this.editModeSubscription.dispose(),this.buildStatusSubscription.dispose(),this.saveStatusSubscription.dispose(),this.sourceChangeSubscription.dispose(),window.clearTimeout(this.developmentScript.timeoutId),window.clearTimeout(this.productionScript.timeoutId),i.unbind()},{viewModel:g,template:c}});
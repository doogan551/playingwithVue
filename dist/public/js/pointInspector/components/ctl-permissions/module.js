define(["knockout","text!./view.html"],function(a,b){function c(b){this.actingUser=window.opener.workspaceManager.user(),this.root=b.rootContext,this.security=this.root.point.data.Security,this.isSystemAdmin=this.root.isSystemAdmin(),this.allGroupsRaw={},this.allGroups={},this.allUsers={},this.userSearch=a.observable(""),this.usersOnPoint=a.observableArray([]),this.groupsOnPoint=a.observableArray([]),this.groupsNotOnPoint=a.observableArray([]),this.gettingData=a.observable(!0),this.networkError=a.observable(!1),this.userHTML={systemAdmin:"<span class='systemAdmin'>(System Admin)</span>",groupAdmin:"<span class='groupAdmin'>(Group Admin)</span>"},this.isTabLoaded=b.isTabLoaded.subscribe(function(a){this.render()},this),this.onNetworkError=this.networkError.subscribe(function(a){a&&(this.allGroups={},this.allUsers={},this.usersOnPoint([]),this.groupsOnPoint([]),this.groupsNotOnPoint([]))},this),this.showPermissionsTable=a.computed(function(){return!this.networkError()&&(this.security().length||this.root.isInEditMode())},this),this.showNoPermissionsMsg=a.computed(function(){return!this.networkError()&&0===this.security().length&&!this.root.isInEditMode()},this),this.userCanEditPermissions=a.computed(function(){if(this.isSystemAdmin)return!0;var b=this,c=a.utils.arrayFilter(this.usersOnPoint(),function(a){return a._id===b.actingUser._id});return!!c.length&&c[0].isGroupAdmin},this),this.showGroupsNotOnPoint=a.computed(function(){return this.root.isInEditMode()&&this.userCanEditPermissions()&&this.groupsNotOnPoint().length},this),this.showRemoveGroupIcon=a.computed(function(){return this.userCanEditPermissions()&&this.root.isInEditMode()},this),this.showUsers=a.computed(function(){return!(this.root.isInEditMode()&&this.userCanEditPermissions()||!this.usersOnPoint().length)},this),this.buildGroups=a.computed(function(){var a,b,c,d,e,f=this.gettingData(),g=this.security(),h=this.allUsers,i=this.allGroups,j=[],k=[],l=[],m=[],n=function(a,b){return a.name==b.name?0:a.name<b.name?-1:1};if(!f){for(var o=0,p=g.length;o<p;o++)a=g[o],b=i[a],b?j.push(b):j.push({_id:a,name:a,canRead:!1,canWrite:!1,canControl:!1,canAcknowledge:!1,users:[]});for(a in i)b=i[a],g.indexOf(a)==-1&&k.push(b);for(a in h)c=h[a],c.canRead=c.canWrite=c.canControl=c.canAcknowledge=c.isGroupAdmin=!1;for(o=0,p=j.length;o<p;o++){b=j[o],e=b.users;for(d in e){c=h[d];var q=!!c&&c["System Admin"].Value,r=e[d]["Group Admin"],s=q||r;m.indexOf(d)==-1&&(m.push(d),c?l.push(c):l.push({_id:d,name:d,canRead:!1,canWrite:!1,canControl:!1,canAcknowledge:!1})),c&&(c.canRead|=b.canRead||s,c.canWrite|=b.canWrite||s,c.canControl|=b.canControl||s,c.canAcknowledge|=b.canAcknowledge||s,c.isGroupAdmin|=r)}}this.groupsOnPoint(j.sort(n)),this.groupsNotOnPoint(k.sort(n)),this.usersOnPoint(l.sort(n))}},this).extend({throttle:50}),d=b.rootContext.apiEndpoint}var d="";return c.prototype.render=function(){var a=this,b=function(b,c){a.networkError(!0),console.log("failed: ",c," jqXHR: ",b)},c=function(b,c){return!!(b._pAccess&a.root.permissionLevels[c])},e=function(b){for(var d=0,e=b.length;d<e;d++){var f=b[d],g=f._id;a.allGroupsRaw[g]=f,a.allGroups[g]={_id:g,name:f["User Group Name"],canRead:!0,canWrite:c(f,"WRITE"),canControl:c(f,"CONTROL"),canAcknowledge:c(f,"ACKNOWLEDGE"),users:f.Users}}},f=function(b){for(var c=0,d=b.length;c<d;c++){var e=b[c];e.name=e["First Name"].Value+" "+e["Last Name"].Value,a.allUsers[e._id]=e}};a.gettingData(!0),$.ajax({url:d+"security/groups/getallgroups",contentType:"application/json",type:"post"}).done(function(c){return c.err?(a.networkError(!0),void a.gettingData(!1)):(e(c),void $.ajax({url:d+"security/users/getallusers",contentType:"application/json",type:"post"}).done(function(b){if(b.err)return void a.networkError(!0);f(b.Users);var c=a.security();a.root.point.data.Security([]),a.root.point.data.Security(c),a.gettingData(!1),a.networkError(!1)}).fail(b))}).fail(b)},c.prototype.getGroupUsers=function(a){var b=[];if(this.allGroups.hasOwnProperty(a)){var c=this.allGroups[a].users;for(var d in c){var e="",f=this.allUsers[d];if(f){var g=f["System Admin"].Value,h=c[d]["Group Admin"],i=g||h;e=f.name,i&&(e+=g?this.userHTML.systemAdmin:this.userHTML.groupAdmin)}else e=d;b.push(e)}}return b.sort()},c.prototype.getUserName=function(a){var b=a.name;return a["System Admin"].Value?b+=this.userHTML.systemAdmin:a.isGroupAdmin&&(b+=this.userHTML.groupAdmin),b},c.prototype.toggleUsers=function(a,b,c,d){var e=b?$(b.currentTarget):$(c),f=e.children(".fa"),g=e.children("div"),h=200;d=void 0===d?"block"===g.css("display"):d,d?(g.slideUp(h),f.removeClass("fa-folder-open"),f.addClass("fa-folder")):(g.slideDown(h),f.removeClass("fa-folder"),f.addClass("fa-folder-open"))},c.prototype.toggleAllUsers=function(a,b){var c=this,d=$(b.currentTarget),e=d.children(".fa"),f=$("tbody .group"),g=!!e.hasClass("fa-folder-open");f.each(function(a,b){c.toggleUsers(void 0,void 0,b,g)}),e.hasClass("fa-folder")?(e.removeClass("fa-folder"),e.addClass("fa-folder-open")):(e.removeClass("fa-folder-open"),e.addClass("fa-folder"))},c.prototype.removeGroup=function(a,b){a.userCanEditPermissions()&&a.security.remove(b._id)},c.prototype.addGroup=function(a,b){a.userCanEditPermissions()&&a.security.push(b._id)},c.prototype.dispose=function(){this.isTabLoaded.dispose(),this.onNetworkError.dispose(),this.buildGroups.dispose(),this.showPermissionsTable.dispose(),this.showNoPermissionsMsg.dispose(),this.showGroupsNotOnPoint.dispose(),this.showUsers.dispose()},{viewModel:c,template:b}});
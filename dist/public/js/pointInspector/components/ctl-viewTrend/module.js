define(["knockout","moment","bootstrap-3.3.4","datetimepicker","text!./view.html"],function(a,b,c,d,e){function f(a,b){var c=~b+1;return this.sort(function(d,e){return d[a]==e[a]?0:d[a]<e[a]?c:b})}function g(c){var d=this,e=function(a){var b=parseInt(a.substr(0,2),16),c=parseInt(a.substr(2,2),16),d=parseInt(a.substr(4,2),16),e=(299*b+587*c+114*d)/1e3;return e>=128?"black":"white"},g=function(){var b,c=d.utility.workspace.systemEnumObjects.qualityCodes,f={inAlarm:c.Abnormal.color,inFault:c.Fault.color,oos:c["Out of Service"].color,overridden:c.Overridden.color};for(b in f){var g=f[b];d.sfColors[b]={bg:"#"+g,color:e(g)}}if(d.isEnumValueType){var h=a.viewmodel.toModel(d.data.Value.ValueOptions);for(b in h)d.revValueOptions[h[b]]=b}i=$(".modal.viewTrend"),j=i.find(".modal-dialog"),k=i.find(".modal-header"),l=i.find(".modal-footer"),m=i.find(".modal-body"),i.on("shown.bs.modal",d.sizeModal)};d.root=c.rootContext,d.apiEndpoint=d.root.apiEndpoint,d.config=d.root.utility.config,d.point=d.root.point,d.utility=d.root.utility,d.config=d.utility.config,d.data=d.point.data,d.gettingData=!1,d.readOnOpen=!0,d.isEnumValueType=d.data.Value.ValueType()===d.config.Enums["Value Types"].Enum["enum"],d.revValueOptions={},d.sfColors={},d.sortOrder=a.observable(n),d.showModal=a.observable(!1),d.errorText=a.observable(""),d.reButton=a.observable(""),d.reqType=a.observable(""),d.startTime=a.observable(Math.floor(Date.now()/1e3)),d.page=a.observable(0),d.lastPage=a.observable(0),d.direction=a.observable("next"),d.minDate=a.observable(),d.maxDate=a.observable(),d.trendData=a.observableArray([]),d.trendDataSorted=a.computed(function(){var a=d.trendData(),b=d.sortOrder(),c=[];return Array.prototype.push.apply(c,a),f.call(c,"timestamp",b)},d),d.startTime.subscribe(function(a){}),d.reqType.subscribe(function(a){var b=$(".btnUpload"),c=$(".btnHistory");"upload"===a?(b.attr("disabled","disabled"),c.removeAttr("disabled"),d.reButton("Refresh"),d.getUpload()):"history"===a&&($(function(){$("#datetimepicker1").datetimepicker({minDate:d.minDate(),maxDate:d.maxDate(),showClear:!0,showClose:!0})}),c.attr("disabled","disabled"),b.removeAttr("disabled"),d.reButton("Reset"),d.startTime(Math.floor(Date.now()/1e3)),d.page(1),d.lastPage(1),d.getHistory())}),d.showModal.subscribe(function(a){a&&d.reqType(""!==d.reqType()?d.reqType():"upload")}),d.maxDateFormat=a.computed(function(){return b(d.maxDate()).format("MM/DD/YYYY HH:mm:ss")}),d.minDateFormat=a.computed(function(){return b(d.minDate()).format("MM/DD/YYYY HH:mm:ss")}),d.getLimits(),g(),$(window).resize(function(){d.showModal()&&(clearTimeout(d.resizeId),d.resizeId=setTimeout(d.sizeModal,100))})}var h,i,j,k,l,m,n=-1,o=1;return g.prototype.sizeModal=function(){var a,b;a=2*j.css("padding-top").split("px")[0],b=$(window).height()-a-k.outerHeight(!0)-l.outerHeight(!0)-75,isNaN(b)||(m.height(b),m.css("max-height",b))},g.prototype.toggleModal=function(){this.showModal(!0)},g.prototype.getLimits=function(){var a=this,c={upi:a.data._id()};$.ajax({type:"POST",url:a.apiEndpoint+"trenddata/getTrendLimits",data:c}).done(function(c){a.minDate(b.unix(c.min)),a.maxDate(b.unix(c.max))})},g.prototype.doUpload=function(a,b){a.reqType("upload")},g.prototype.doHistory=function(a,b){a.reqType("history")},g.prototype.showTime=function(){var a=$(".modal.viewTrend"),b=a.find(".modalTime");b.toggle("fast")},g.prototype.printHistory=function(){var a=$(".modal.viewTrend"),b=(a.find(".modalTime"),a.find(".modalValue")),c=window.open(),d="<label>"+this.point.data.Name()+"</label>";d+=b.html(),$(c.document.body).html(d),c.print(),c.close()},g.prototype.getUpload=function(){if(!this.gettingData){var a=this,b=$(".btnViewTrend"),c=b.find("i.fa"),d=$(".modal.viewTrend"),e=d.find(".modalScene"),f=d.find(".modalWait"),g=(d.find(".modalValue"),d.find(".modalError"),d.find(".btnSubmit")),h=function(b){a.loadView(b,"upload")};e.hide(),f.show(),g.prop("disabled",!0),b.removeClass("btn-danger btn-success").addClass("btn-warning"),c.removeClass("fa-signal fa-check fa-warning").addClass("fa-refresh fa-spin"),a.readOnOpen=!0,a.gettingData=!0,a.point.issueCommand("Trend Data",{upi:a.data._id()},h)}},g.prototype.getHistory=function(){var b=this,c=$(".btnViewTrend"),d=c.find("i.fa"),e=$(".modal.viewTrend"),f=e.find(".modalScene"),g=e.find(".modalWait"),h=(e.find(".modalValue"),e.find(".modalError"),e.find(".btnSubmit")),i={startTime:b.startTime(),lastPage:b.lastPage(),direction:"next"===b.direction()?1:-1,page:b.page(),limit:256,upi:b.data._id()};f.hide(),g.show(),h.prop("disabled",!0),c.removeClass("btn-danger btn-success").addClass("btn-warning"),d.removeClass("fa-signal fa-check fa-warning").addClass("fa-refresh fa-spin"),b.readOnOpen=!0,b.gettingData=!0,$.ajax({type:"POST",url:b.apiEndpoint+"trenddata/viewTrend",data:i}).done(function(c){c.err||0===c.length?"next"===b.direction()?$(".nextBtn").attr("disabled","disabled"):"previous"===b.direction()&&$(".prevBtn").attr("disabled","disabled"):($(".nextBtn").removeAttr("disabled"),$(".prevBtn").removeAttr("disabled")),c.err?(c.error=a.observable(c.err),c.value=a.observable("")):(c.error=a.observable(""),c.value=a.observable(c),b.loadView(c,"history"))})},g.prototype.loadView=function(a,c){var d=this,e=$(".btnViewTrend"),f=e.find("i.fa"),g=$(".modal.viewTrend"),h=g.find(".modalScene"),i=(g.find(".modalWait"),g.find(".modalValue")),j=g.find(".modalError"),k=g.find(".btnSubmit"),l=function(a){d.showModal()?f.addClass("fa-signal"):a?(e.addClass("btn-danger"),f.addClass("fa-warning")):(e.addClass("btn-success"),f.addClass("fa-check"))},m=function(a){return d.isEnumValueType?d.revValueOptions[a]||a:d.config.Utility.formatNumber({val:a})},n=a.value(),o=d.config.Enums["Status Flags Bits"],p=0,q=n.length;if(d.showModal()||(d.readOnOpen=!1),d.gettingData=!1,c===d.reqType()){if(h.hide(),k.prop("disabled",!1),e.removeClass("btn-warning"),f.removeClass("fa-refresh fa-spin"),""!==a.error())return l(!0),d.errorText(a.error()),void j.show();for(l(!1),d.trendData().length=0,p;p<q;p++){var r=n[p],s=r["status flags"]|r.statusflags;r.valueString=m(r.hasOwnProperty("value")?r.value:r.Value),r.prettyTime=b.unix(r.timestamp).format("MM/DD/YY - HH:mm:ss"),r.inAlarm=s&o["In Alarm"]["enum"],r.inFault=s&o["In Fault"]["enum"],r.oos=s&o["Out of Service"]["enum"],r.overridden=s&o.Override["enum"],d.trendData().push(r)}d.trendData.valueHasMutated(),i.show()}},g.prototype.refreshData=function(){var a=this;a.getLimits(),"upload"===a.reqType()?a.getUpload():"history"===a.reqType()&&(a.startTime(Math.floor(Date.now()/1e3)),a.page(1),a.lastPage(1),a.direction("next"),a.getHistory())},g.prototype.setDateTime=function(){var a=this,b=new Date($("#datetimepicker1").data("date")).getTime()/1e3;a.startTime(b?b:Math.floor(Date.now()/1e3)),a.page(1),a.lastPage(1),a.getHistory()},g.prototype.reverseSort=function(){var a=this;h||(h=$("thead th:first i")),h.removeClass("fa-chevron-up fa-chevron-down"),a.sortOrder()==n?(a.sortOrder(o),h.addClass("fa-chevron-down")):(a.sortOrder(n),h.addClass("fa-chevron-up"))},g.prototype.previousPage=function(){var a=this;a.lastPage(a.page()),a.page(a.page()-1),0===a.page()&&a.page(a.page()-1),a.direction("previous"),a.startTime(!!a.trendData().length&&a.trendData()[0].timestamp+1||a.startTime()),a.getHistory()},g.prototype.nextPage=function(){var a=this;a.lastPage(a.page()),a.page(a.page()+1),0===a.page()&&a.page(a.page()+1),a.direction("next"),a.startTime(!!a.trendData().length&&a.trendData()[a.trendData().length-1].timestamp-1||a.startTime()),a.getHistory()},g.prototype.dispose=function(){this.trendDataSorted.dispose()},{viewModel:g,template:e}});
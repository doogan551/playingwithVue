define(["knockout","text!./view.html"],function(a,b){function c(b){var c=this;c.root=b.rootContext,c.config=c.root.utility.config,c.point=c.root.point,c.data=c.point.data,c.utility=c.root.utility,c.security=c.root.point.data.Security,c.isSystemAdmin=c.root.isSystemAdmin(),c.gettingData=!1,c.readOnOpen=!0,c.showModal=a.observable(!1),c.errorText=a.observable(""),c.controls=a.observableArray([]),c.pointBtnClick=function(){c.loadControls()},c.hardwareBtnClick=function(){c.getControls()};for(var d=0;d<16;d++)c.controls.push({level:c.utility.getLevelName(d+1),value:a.observable(""),controller:a.observable(""),releaseTime:a.observable(""),isHighestPriority:a.observable(!1)})}return c.prototype.toggleModal=function(){this.showModal(!0),this.readOnOpen&&($("#pcBtn").click(),this.loadControls())},c.prototype.loadControls=function(){var b=this,c=$(".btnViewControls"),d=c.find("i.fa"),e=$(".modal.viewControls"),f=e.find(".modalScene"),g=e.find(".modalWait"),h=e.find(".modalValue"),i=(e.find(".modalError"),e.find(".btnSubmit")),j=e.find(".refreshBtn"),k=b.controls(),l=b.data["Control Array"](),m=!1,n=b.data.Value.ValueType()===b.config.Enums["Value Types"].Enum["enum"],o=function(c,d){var e=a.toJS(b.data.Value.ValueOptions),f=a.utils.arrayFilter(e,function(a){return a[c]===d});return f[0]},p=function(a){b.showModal()?d.addClass("fa-search"):(b.readOnOpen=!1,a?(c.addClass("btn-danger"),d.addClass("fa-warning")):(c.addClass("btn-success"),d.addClass("fa-check")))},q=function(){for(var a=0;a<k.length;a++)k[a].controller(""),k[a].value(""),k[a].releaseTime(""),k[a].isHighestPriority(!1);for(var c=0;c<l.length;c++){var d=l[c].Controller(),e=l[c].Value(),f=l[c]["Release Time"](),g=l[c].Level(),h=k[g-1];if(h.controller(b.utility.getControllerName(d)),n){var i=o("value",e);h.value(i&&i.name||e)}else h.value(e);0!==f?h.releaseTime(moment.unix(f).format("MM/DD/YY - HH:mm:ss")):h.releaseTime(""),m||h.isHighestPriority(m=!0)}b.controls.valueHasMutated()},r=function(){$.ajax({url:"/api/points/"+b.data._id(),type:"GET",dataType:"json"}).done(function(c){a.viewmodel.updateFromModel(b.data,c),p(!1)}).fail(function(a){p(!0),console.log("error")}).always(function(){q(),b.gettingData=!1,f.hide(),i.prop("disabled",!1),c.removeClass("btn-warning"),d.removeClass("fa-refresh fa-spin"),h.show()})};j.show(),f.hide(),g.show(),i.prop("disabled",!0),c.removeClass("btn-danger btn-success").addClass("btn-warning"),d.removeClass("fa-search fa-check fa-warning").addClass("fa-refresh fa-spin"),r()},c.prototype.getControls=function(){if(!this.gettingData){var b=this,c=$(".btnViewControls"),d=c.find("i.fa"),e=$(".modal.viewControls"),f=e.find(".modalScene"),g=e.find(".modalWait"),h=e.find(".modalValue"),i=e.find(".modalError"),j=e.find(".btnSubmit"),k=e.find(".refreshBtn"),l=b.controls(),m=[],n=function(c,d){var e=a.toJS(b.data.Value.ValueOptions),f=a.utils.arrayFilter(e,function(a){return a[c]===d});return f[0]},o=function(a){b.showModal()?d.addClass("fa-search"):(b.readOnOpen=!1,a?(c.addClass("btn-danger"),d.addClass("fa-warning")):(c.addClass("btn-success"),d.addClass("fa-check")))},p=function(a){for(var b=[],c=0;c<16;c++){var d={Value:0,Level:0,Controller:0,"Release Time":0};0!==(a["active controls"]>>c&1)&&(d.Value=a.values[c],d.Level=c+1,d.Controller=a.controllers[c],d["Release Time"]=a.times[c],b.push(d))}return b},q=function(a){var e=a.value(),g=!1,k=b.data.Value.ValueType()===b.config.Enums["Value Types"].Enum["enum"];if(b.gettingData=!1,f.hide(),j.prop("disabled",!1),c.removeClass("btn-warning"),d.removeClass("fa-refresh fa-spin"),a.error())return o(!0),b.errorText(a.error()),void i.show();o(!1),m=p(e);for(var q=0;q<l.length;q++)l[q].controller(""),l[q].value(""),l[q].releaseTime(""),l[q].isHighestPriority(!1);for(var r=0;r<m.length;r++){var s=m[r].Controller,t=m[r].Value,u=m[r]["Release Time"],v=m[r].Level,w=l[v-1];if(w.controller(b.utility.getControllerName(s)),k){var x=n("value",t);w.value(x&&x.name||t)}else w.value(t);0!==u?w.releaseTime(moment.unix(u).format("MM/DD/YY - HH:mm:ss")):w.releaseTime(""),g||w.isHighestPriority(g=!0)}b.controls.valueHasMutated(),h.show()};k.show(),f.hide(),g.show(),j.prop("disabled",!0),c.removeClass("btn-danger btn-success").addClass("btn-warning"),d.removeClass("fa-search fa-check fa-warning").addClass("fa-refresh fa-spin"),b.readOnOpen=!0,b.gettingData=!0,b.point.issueCommand("Control Array",{upi:b.data._id()},q)}},c.prototype.refreshControls=function(){var a=this;$("#pcBtn").parents(".btn").hasClass("active")?a.pointBtnClick():a.hardwareBtnClick()},c.prototype.dispose=function(){},{viewModel:c,template:b}});
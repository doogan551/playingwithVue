define(["knockout","text!./view.html"],function(a,b){function c(a,b,c){return Math.floor(Math.sqrt(Math.pow(b-(a.offset().left+a.width()/2),2)+Math.pow(c-(a.offset().top+a.height()/2),2)))}function d(a,b,c){if(a.setSelectionRange)a.focus(),a.setSelectionRange(b,c);else if(a.createTextRange){var d=a.createTextRange();d.collapse(!0),d.moveEnd("character",c),d.moveStart("character",b),d.select()}}function e(a){var b=[];this.showLabel=!a.hasOwnProperty("showLabel")||a.showLabel,this.naked=a.naked,this.columnClasses=a.columnClasses,this.readOnlyText=a.readOnlyText?a.readOnlyText:"lh30",this.propertyName=a.propertyName,this.data=a.data[this.propertyName],this.min=a.min,this.max=a.max,this.noValidation=a.noValidation,this.isInEditMode=a.rootContext.isInEditMode,this.forceEdit=a.forceEdit||!1,"undefined"!=typeof this.min&&(b=this.min.split(":"),this.min=60*b[0]*60+60*b[1]+parseInt(b[2],10)),"undefined"!=typeof this.max&&(b=this.max.split(":"),this.max=60*b[0]*60+60*b[1]+parseInt(b[2],10))}return a.bindingHandlers.duration={init:function(b,e,f){var g=$(b),h=g.find(".hr"),i=g.find(".min"),j=g.find(".sec"),k=a.contextFor(b),l=e(),m=k.$data.data.ValueType(),n=function(){l(l()+3600)},o=function(){l(l()-3600)},p=function(){l(l()+60)},q=function(){l(l()-60)},r=function(){l(l()+1)},s=function(){l(l()-1)},t=a.unwrap(f().max),u=a.unwrap(f().min),v=a.unwrap(f().noValidation),w={$field:h,next:n,prev:o},x={$field:i,next:p,prev:q},y={$field:j,next:r,prev:s},z=0,A=[],B=0,C=function(a){var b=parseInt(B,10);if("undefined"==typeof a)return b;if("number"!=typeof a){for(var c in A)if(A[c].$field.is(a)){b=c;break}}else b+=a,b<0?b=A.length-1:b>A.length-1&&(b=0);return B=b,b};switch(m){case 12:u=u||0,t=t||86399,A.push(w,x,y);break;case 13:u=u||0,t=t||3599,A.push(x,y),h.next(".timeSeg").andSelf().hide();break;case 17:u=u||0,t=t||86340,A.push(w,x),j.next(".timeSeg").andSelf().hide()}g.is(".durationCtrl")&&g.on("keydown",function(a){var b,c,e=0;switch(a.keyCode){case 33:break;case 34:break;case 37:z=A[C(-1)],b=z.$field,c=b.val().length,d(b[0],e,c);break;case 38:z=A[C()],z.next(),l()>t&&l(t),b=z.$field,c=b.val().length,d(b[0],e,c);break;case 39:z=A[C(1)],b=z.$field,c=b.val().length,d(b[0],e,c);break;case 40:z=A[C()],z.prev(),l()<u&&l(u),b=z.$field,c=b.val().length,d(b[0],e,c);break;default:z=A[C()]}}).on("mousewheel",function(a,b){var c,e,f,g,h=0;"number"==typeof b.deltaY&&(a=b),e=a.deltaY,f=e>0?"Up":"Down",z=A[C()],c=z.$field,g=c.val().length,c.is(":focus")&&(a.preventDefault(),"Up"==f?(z.next(),l()>t&&l(t)):(z.prev(),l()<u&&l(u)),d(c[0],h,g))}).on("click",function(a){var b,e,f,g=0,h={dom:[],proximities:[]};for(var i in A)h.dom.push(A[i].$field),h.proximities.push(c(A[i].$field,a.pageX,a.pageY));f=Math.min.apply(Math,h.proximities),b=h.dom[h.proximities.indexOf(f)],C(b),e=b.val().length,b.focus(),d(b[0],g,e)}).on("focusin",function(){$(this).addClass("focused")}).on("focusout",function(){var a=parseInt(h.val(),10),b=parseInt(i.val(),10),c=parseInt(j.val(),10),d=3600*a+60*b+c;$(this).removeClass("focused"),l(d<u?u:d>t?t:d),l.valueHasMutated(),v||$(document).triggerHandler({type:"viewmodelChange",targetElement:g,property:k.$data.propertyName,refPoint:null})})},update:function(b,c){var d=$(b),e=d.find(".hr"),f=d.find(".min"),g=d.find(".sec"),h=a.utils.unwrapObservable(c()),i=~~(h/3600),j=~~(h%3600/60),k=h%60;i=i>9?i:"0"+i,j=j>9?j:"0"+j,k=k>9?k:"0"+k,e.is("input")?e.val(i):e.html(i+' <span class="timeSeg">hr</span>'),f.is("input")?f.val(j):f.html(j+' <span class="timeSeg">min</span>'),g.is("input")?g.val(k):g.html(k+' <span class="timeSeg">sec</span>')}},e.prototype.doSomething=function(){},e.prototype.dispose=function(){},{viewModel:e,template:b}});
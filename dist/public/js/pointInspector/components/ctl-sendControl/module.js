define(["knockout","text!./view.html","bannerJS","datetimepicker"],function(a,b,c,d){function e(b){var c=this;if(c.root=b.rootContext,c.config=c.root.utility.config,c.point=c.root.point,c.data=c.point.data,c.utility=c.root.utility,c.isEnumValueType=c.data.Value.ValueType()===c.config.Enums["Value Types"].Enum["enum"],c.controllerId=c.utility.workspace.user().controllerId,c.disableControl=!c.controllerId,c.revValueOptions={},c.showModal=a.observable(!1),c.controlValue=a.observable(),c.controlPriority=a.observable(c.data["Control Priority"]&&c.data["Control Priority"].eValue()),c.valueValidation=a.observable(""),c.showValidation=a.observable(!1),c.controlFocus=a.observable(!0),c.controlFocus.subscribe(function(a){c.showValidation(!1);var b=c.controlValue();a||["Analog Input","Analog Output"].indexOf(c.data["Point Type"].Value())>=0&&(c.min=c.data["Minimum Value"].Value(),c.max=c.data["Maximum Value"].Value(),b>c.max?(c.controlValue(c.max),c.valueValidation("Value "+b+" is greater maximum value: "+c.max+". Value has been set to max."),c.showValidation(!0)):b<c.min&&(c.controlValue(c.min),c.valueValidation("Value "+b+" is lower minimum value: "+c.min+". Value has been set to min."),c.showValidation(!0)))}),c.isEnumValueType){c.controlValue(c.data.Value.eValue());var d=a.viewmodel.toModel(c.data.Value.ValueOptions);for(var e in d)c.revValueOptions[d[e]]=e}else c.controlValue(c.data.Value.Value());0===c.controlPriority()&&c.controlPriority(16),c.checkReleaseModel=function(){switch(c.data._devModel()){case c.config.Enums["Device Model Types"]["MicroScan 5 xTalk"]["enum"]:case c.config.Enums["Device Model Types"]["MicroScan 5 UNV"]["enum"]:case c.config.Enums["Device Model Types"]["SCADA Vio"]["enum"]:return!0}return!1},c.override={"Time to Override":{Value:a.observable(0),ValueType:a.observable(12),isReadOnly:a.observable(!1),isDisplayable:a.observable(!0)}},c.override["Time to Override"].Value.subscribe(function(a){var b=new Date;b.setSeconds(b.getSeconds()+a),$("#datetimepicker").data("DateTimePicker").date(b)}),$(function(){$("#datetimepicker").datetimepicker({showClear:!0,showClose:!0,format:"MM/DD/YY - HH:mm",sideBySide:!0}),$("#datetimepicker").data("DateTimePicker").defaultDate(new Date),$("#datetimepicker").focusout(function(){var a=$("#datetimepicker").data("DateTimePicker").date().unix()-Math.floor(Date.now()/1e3);a>0?c.override["Time to Override"].Value(a):c.override["Time to Override"].Value(0),$("#rtBtn").click()}),$(".ttoInput").focusout(function(){$("#ttoBtn").click()})})}function f(a){var b=$("#timeControl").find(".active").attr("id"),c=a.override["Time to Override"].Value(),d=0;return"ttoLabel"===b&&0!==c?d=Math.floor(Date.now()/1e3)+c:"rtLabel"===b&&(d=$("#datetimepicker").data("DateTimePicker").date().unix()),d}function g(a,b){if(a.root.authorize(a.data,a.root.permissionLevels.CONTROL)){var d=$(".btnSendControl"),e=d.find("i.fa"),g=$(".modal.sendControl"),h=g.find(".btnSubmit"),i=h.find(".fa"),j={upi:a.data._id(),Relinquish:b,Priority:a.controlPriority(),OvrTime:f(a),Wait:1,Value:a.controlValue(),Controller:a.controllerId,logData:{user:a.utility.workspace.user(),point:{_id:a.data._id(),Security:a.data.Security(),Name:a.data.Name(),name1:a.data.name1(),name2:a.data.name2(),name3:a.data.name3(),name4:a.data.name4(),"Point Type":{eValue:a.data["Point Type"].eValue()}},newValue:{Value:a.controlValue()}}},k=function(b){a.showModal()?e.addClass("fa-bullseye"):b?(d.addClass("btn-danger"),e.addClass("fa-warning")):(d.addClass("btn-success"),e.addClass("fa-check"))},l=function(a){return h.prop("disabled",!1),i.removeClass("fa-refresh fa-spin"),d.removeClass("btn-warning"),e.removeClass("fa-refresh fa-spin"),a.error()?(k(!0),void c.showBanner("Send control failed. "+a.error(),"Ok",null,"#D50000")):void k(!1)};h.prop("disabled",!0),d.removeClass("btn-danger btn-success").addClass("btn-warning"),e.removeClass("fa-bullseye fa-check fa-warning").addClass("fa-refresh fa-spin"),i.addClass("fa-refresh fa-spin"),a.isEnumValueType&&(j.logData.newValue={eValue:j.Value,Value:a.revValueOptions[j.Value]}),a.showModal(!1),a.point.issueCommand("Command Point",j,l)}}return e.prototype.toggleModal=function(){var a=this,b=$(".modal.sendControl");a.showModal(!0),b.on("shown.bs.modal",function(a){var c=b.find(".val:first");c.focus().select(),$("#datetimepicker").data("DateTimePicker").date(new Date)}),b.on("hidden.bs.modal",function(b){a.override["Time to Override"].Value(0),$("#ttoBtn").click(),$("#ttoLabel").removeClass("active")})},e.prototype.sendControl=function(){g(this,0)},e.prototype.relinquish=function(){g(this,1)},e.prototype.dispose=function(){},{viewModel:e,template:b}});
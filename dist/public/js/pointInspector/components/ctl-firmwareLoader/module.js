define(["knockout","text!./view.html"],function(a,b){function c(b){var c=this;c.root=b.rootContext,c.point=c.root.point,c.data=c.point.data,c.socket=c.root.socket,c.utility=c.root.utility,c.model=c.data["Model Type"].Value(),c.modal={error:a.observable(""),template:a.observable(""),showModal:a.observable(!1),submitText:a.observable(""),finishedText:a.observable(""),title:a.observable(""),value:a.observable(""),isDownloading:a.observable(!1),cancel:function(){$(".progress-bar").removeClass("progress-bar-danger"),$(".progress-bar").removeClass("progress-bar-success"),$(".progress-bar").css("width","0%"),$(".progress-bar").text("0%"),$(".modal").modal("hide")},submit:function(){}}}return c.prototype.firmwareLoader=function(){var b,c,d,e,f,g,h=this,i=$(event.target),j=(i.find("i.fa"),$(".modal.firmwareLoader")),k=j.find(".btnSubmit"),l=this.modal;j.modal(),h.firmwareFiles=a.observableArray([]),h.selectedFile=a.observable(),h.progressMessage=a.observable(""),h.progressPercent=a.observable(0),console.log(this),$(".progressmsgtxt").text(""),$(".afterLoad").hide(),$(".beforeLoad").show(),h.uploadFile=function(a){console.log("file",a),g=a},h.start=function(){var a={model:h.model,devices:[],remotes:[],upi:h.data._id(),logData:{user:h.utility.workspace.user(),point:{_id:h.data._id(),Security:h.data.Security(),Name:h.data.Name(),name1:h.data.name1(),name2:h.data.name2(),name3:h.data.name3(),name4:h.data.name4(),"Point Type":{eValue:h.data["Point Type"].eValue()},"Firmware Version":h.data["Firmware Version"].Value()}}},b=new FileReader,c=function(a){console.log("response",h.selectedFile()),h.selectedFile(h.firmwareFiles()[0]),f.show(),d.show(),void 0!==a.percent?(h.progressPercent(parseInt(a.percent,10)),$(".progress-bar").removeClass("progress-bar-danger"),$(".progress-bar").removeClass("progress-bar-success"),$(".progress-bar").css("width",h.progressPercent()+"%"),$(".progress-bar").text(h.progressPercent()+"%")):void 0!==a.err?($(".progress-bar").addClass("progress-bar-danger"),$(".progress-bar").css("width","100%"),$(".progressmsgtxt").text(a.err),k.prop("disabled",!1),h.modal.isDownloading(!1)):("DeviceLoader session Done"===a.msg&&($(".progress-bar").addClass("progress-bar-success"),$(".beforeLoad").hide(),$(".afterLoad").show(),k.prop("disabled",!1),h.modal.isDownloading(!1)),d.hide(),$(".progressmsgtxt").text(a.msg))};8===h.data["Point Type"].eValue()?a.devices=[h.data._id()]:144===h.data["Point Type"].eValue()&&(a.devices=[this.root.utility.getPointRefProperty("Device Point").data.Value()],a.remotes=[h.data._id()]),void 0!==g?(b.onload=function(){a.uploadFile=b.result,a.fileName=g.name,a.saveFile=h.saveCheck()},b.readAsText(g)):a.fileName=h.selectedFile(),h.sendToFirmwareLoader(a,c)},h.sendToFirmwareLoader=function(a,b){h.socket.emit("firmwareLoader",a),h.socket.on("returnFromLoader",function(a){"function"==typeof b&&b.call(void 0,a)})},j.one("hide.bs.modal",function(a){b.hide(),h.progressMessage("")}),j.one("shown.bs.modal",function(a){console.log("shown",h.modal.isDownloading()),h.modal.isDownloading()?(f.show(),d.show()):e.show(),$.getJSON("/api/firmwareLoader/get/"+h.model,function(a){a.err?(console.log(a.err),k.prop("disabled",!0),h.firmwareFiles(["No files found"])):a.files.length?(h.selectedFile(a.files[0]),console.log("selected",h.selectedFile()),k.prop("disabled",!1),h.firmwareFiles(a.files)):(h.firmwareFiles(["No files found"]),k.prop("disabled",!0))})}),l.template("read"),l.value(""),l.title("Load Firmware"),l.submitText("Start"),l.finishedText("Finished"),b=j.find(".modalScene"),c=j.find(".modalError"),d=j.find(".modalWait"),e=j.find(".modalLoad"),f=j.find(".modalProgress"),l.submit=function(){h.modal.isDownloading(!0),b.hide(),f.show(),d.show(),k.prop("disabled",!0),h.start()},l.showModal(!0)},c.prototype.dispose=function(){},{viewModel:c,template:b}});
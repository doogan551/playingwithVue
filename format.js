{"parentLocId":0, "parentMechId":0, "type":"Building", "display":"4220", "item":"Location"}
{"parentLocId":1, "parentMechId":0, "type":"Floor", "display":"First", "item":"Location"}
{"parentLocId":2, "parentMechId":0, "type":"Room", "display":"1000", "item":"Location"}
{"parentLocId":2, "parentMechId":0, "type":"VAV", "display":"VAV 1000", "item":"Mechanical"}
{"parentLocId":3, "parentMechId":4, "type":"Space", "display":"Space", "item":"Mechanical"}
{"parentLocId":3, "parentMechId":5, "type":"Temperature", "display":"SPT", "item":"Mechanical"}

{"parentLocId":0, "parentMechId":0, "type":"Building", "display":"4220", "item":"Location", "id":"a"},
{"parentLocId":"a", "parentMechId":0, "type":"Area", "display":"a1", "item":"Location", "id":"b"},
{"parentLocId":"a", "parentMechId":0, "type":"Area", "display":"a2", "item":"Location", "id":"f"},
{"parentLocId":"b", "parentMechId":0, "type":"Floor", "display":"f1", "item":"Location", "id":"c"},
{"parentLocId":"f", "parentMechId":0, "type":"Floor", "display":"f2", "item":"Location", "id":"g"},
{"parentLocId":"c", "parentMechId":0, "type":"Room", "display":"r11", "item":"Location", "id":"d"},
{"parentLocId":"c", "parentMechId":0, "type":"Room", "display":"r12", "item":"Location", "id":"e"},
{"parentLocId":"g", "parentMechId":0, "type":"Room", "display":"r21", "item":"Location", "id":"h"},
{"parentLocId":"g", "parentMechId":0, "type":"Room", "display":"r22", "item":"Location", "id":"i"}

{"parentLocId":0, "parentMechId":0, "type":"Building", "display":"4220", "item":"Location", "id":"a"},
{"parentLocId":"a", "parentMechId":0, "type":"Floor", "display":"f1", "item":"Location", "id":"b"},
{"parentLocId":"a", "parentMechId":0, "type":"Floor", "display":"f2", "item":"Location", "id":"c"},
{"parentLocId":"a", "parentMechId":0, "type":"Floor", "display":"f3", "item":"Location", "id":"d"},
{"parentLocId":"a", "parentMechId":0, "type":"Floor", "display":"f4", "item":"Location", "id":"e"},
{"parentLocId":"a", "parentMechId":0, "type":"Floor", "display":"f5", "item":"Location", "id":"f"},
{"parentLocId":"b", "parentMechId":0, "type":"Room", "display":"r1001", "item":"Location", "id":"g"},
{"parentLocId":"b", "parentMechId":0, "type":"Room", "display":"r1002", "item":"Location", "id":"h"},
{"parentLocId":"b", "parentMechId":0, "type":"Room", "display":"r1003", "item":"Location", "id":"i"},
{"parentLocId":"b", "parentMechId":0, "type":"Room", "display":"r1004", "item":"Location", "id":"j"},
{"parentLocId":"b", "parentMechId":0, "type":"Room", "display":"r1005", "item":"Location", "id":"k"},
{"parentLocId":"b", "parentMechId":0, "type":"Room", "display":"r1006", "item":"Location", "id":"l"},
{"parentLocId":"b", "parentMechId":0, "type":"Room", "display":"r1007", "item":"Location", "id":"m"},
{"parentLocId":"b", "parentMechId":0, "type":"Room", "display":"r1008", "item":"Location", "id":"n"},
{"parentLocId":"b", "parentMechId":0, "type":"Room", "display":"r1009", "item":"Location", "id":"o"},
{"parentLocId":"b", "parentMechId":0, "type":"Room", "display":"r1010", "item":"Location", "id":"p"},
{"parentLocId":"c", "parentMechId":0, "type":"Room", "display":"r2001", "item":"Location", "id":"q"},
{"parentLocId":"c", "parentMechId":0, "type":"Room", "display":"r2002", "item":"Location", "id":"r"},
{"parentLocId":"c", "parentMechId":0, "type":"Room", "display":"r2003", "item":"Location", "id":"s"},
{"parentLocId":"c", "parentMechId":0, "type":"Room", "display":"r2004", "item":"Location", "id":"t"},
{"parentLocId":"c", "parentMechId":0, "type":"Room", "display":"r2005", "item":"Location", "id":"u"},
{"parentLocId":"c", "parentMechId":0, "type":"Room", "display":"r2006", "item":"Location", "id":"v"},
{"parentLocId":"c", "parentMechId":0, "type":"Room", "display":"r2007", "item":"Location", "id":"w"},
{"parentLocId":"c", "parentMechId":0, "type":"Room", "display":"r2008", "item":"Location", "id":"x"},
{"parentLocId":"c", "parentMechId":0, "type":"Room", "display":"r2009", "item":"Location", "id":"y"},
{"parentLocId":"c", "parentMechId":0, "type":"Room", "display":"r2010", "item":"Location", "id":"z"},
{"parentLocId":"d", "parentMechId":0, "type":"Room", "display":"r3001", "item":"Location", "id":"aaa"},
{"parentLocId":"d", "parentMechId":0, "type":"Room", "display":"r3002", "item":"Location", "id":"aab"},
{"parentLocId":"d", "parentMechId":0, "type":"Room", "display":"r3003", "item":"Location", "id":"aac"},
{"parentLocId":"d", "parentMechId":0, "type":"Room", "display":"r3004", "item":"Location", "id":"aad"},
{"parentLocId":"d", "parentMechId":0, "type":"Room", "display":"r3005", "item":"Location", "id":"aae"},
{"parentLocId":"d", "parentMechId":0, "type":"Room", "display":"r3006", "item":"Location", "id":"aaf"},
{"parentLocId":"d", "parentMechId":0, "type":"Room", "display":"r3007", "item":"Location", "id":"aag"},
{"parentLocId":"d", "parentMechId":0, "type":"Room", "display":"r3008", "item":"Location", "id":"aah"},
{"parentLocId":"d", "parentMechId":0, "type":"Room", "display":"r3009", "item":"Location", "id":"aai"},
{"parentLocId":"d", "parentMechId":0, "type":"Room", "display":"r3010", "item":"Location", "id":"aaj"},
{"parentLocId":"e", "parentMechId":0, "type":"Room", "display":"r4001", "item":"Location", "id":"aak"},
{"parentLocId":"e", "parentMechId":0, "type":"Room", "display":"r4002", "item":"Location", "id":"aal"},
{"parentLocId":"e", "parentMechId":0, "type":"Room", "display":"r4003", "item":"Location", "id":"aam"},
{"parentLocId":"e", "parentMechId":0, "type":"Room", "display":"r4004", "item":"Location", "id":"aan"},
{"parentLocId":"e", "parentMechId":0, "type":"Room", "display":"r4005", "item":"Location", "id":"aao"},
{"parentLocId":"e", "parentMechId":0, "type":"Room", "display":"r4006", "item":"Location", "id":"aap"},
{"parentLocId":"e", "parentMechId":0, "type":"Room", "display":"r4007", "item":"Location", "id":"aaq"},
{"parentLocId":"e", "parentMechId":0, "type":"Room", "display":"r4008", "item":"Location", "id":"aar"},
{"parentLocId":"e", "parentMechId":0, "type":"Room", "display":"r4009", "item":"Location", "id":"aas"},
{"parentLocId":"e", "parentMechId":0, "type":"Room", "display":"r4010", "item":"Location", "id":"aat"},
{"parentLocId":"f", "parentMechId":0, "type":"Room", "display":"r5001", "item":"Location", "id":"aau"},
{"parentLocId":"f", "parentMechId":0, "type":"Room", "display":"r5002", "item":"Location", "id":"aav"},
{"parentLocId":"f", "parentMechId":0, "type":"Room", "display":"r5003", "item":"Location", "id":"aaw"},
{"parentLocId":"f", "parentMechId":0, "type":"Room", "display":"r5004", "item":"Location", "id":"aax"},
{"parentLocId":"f", "parentMechId":0, "type":"Room", "display":"r5005", "item":"Location", "id":"aay"},
{"parentLocId":"f", "parentMechId":0, "type":"Room", "display":"r5006", "item":"Location", "id":"aaz"},
{"parentLocId":"f", "parentMechId":0, "type":"Room", "display":"r5007", "item":"Location", "id":"aa"},
{"parentLocId":"f", "parentMechId":0, "type":"Room", "display":"r5008", "item":"Location", "id":"ab"},
{"parentLocId":"f", "parentMechId":0, "type":"Room", "display":"r5009", "item":"Location", "id":"ac"},
{"parentLocId":"f", "parentMechId":0, "type":"Room", "display":"r5010", "item":"Location", "id":"ad"}


var tags = ['Space','4220','Temperature'];

db.hierarchy.aggregate([
    {$graphLookup:{
        from: 'hierarchy',
        startWith: '$hierarchyRefs.value',
        connectFromField: 'hierarchyRefs.value',
        connectToField: '_id',
        as: 'path'
    }},
    {$unwind:{
       path:"$path"
    }},
    {$project:{
      'tags':{$concatArrays:["$tags", "$path.tags"]},
      'display':1,
      'item':1,
      'type':1
    }},
    {$unwind:{
       path:"$tags"
    }},
    {$group:{
      _id:"$_id",
      display:{$first:"$display"},
      type:{$first:"$type"},
      item:{$first:"$item"},
      tags:{$addToSet:"$tags"}
    }},
    {$match:{
      tags:{$all:tags}
    }}
]);

{ 
    "_id" : NumberInt(500), 
    "item" : "Location", 
    "display" : "a5004", 
    "hierarchyRefs" : [
        {
            "isReadOnly" : false, 
            "display" : "r5004", 
            "value" : NumberInt(50), 
            "type" : "Room", 
            "isDisplayable" : true, 
            "item" : "Location"
        }, 
        {
            "isReadOnly" : false, 
            "display" : "", 
            "value" : NumberInt(0), 
            "type" : "", 
            "isDisplayable" : false, 
            "item" : "Mechanical"
        }
    ], 
    "type" : "Area", 
    "meta" : {
        "coords" : {
            "lat" : NumberInt(0), 
            "long" : NumberInt(0)
        }, 
        "address" : {
            "street" : "", 
            "city" : "", 
            "zip" : ""
        }, 
        "description" : "", 
        "tz" : ""
    }, 
    "tags" : [
        "Location", 
        "a5004", 
        "Area"
    ]
}
